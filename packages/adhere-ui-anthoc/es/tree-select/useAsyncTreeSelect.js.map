{"version":3,"file":"useAsyncTreeSelect.js","sources":["tree-select/useAsyncTreeSelect.js"],"sourcesContent":["var __rest = this && this.__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nvar __spreadArray = this && this.__spreadArray || function (to, from, pack) {\n  if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n    if (ar || !(i in from)) {\n      if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n      ar[i] = from[i];\n    }\n  }\n  return to.concat(ar || Array.prototype.slice.call(from));\n};\nimport { useMount, useUpdateEffect } from 'ahooks';\nimport { useRef, useState } from 'react';\n/**\n * useAsyncTreeSelect\n * @param dictName\n * @param cascadeParams\n * @param onDataSourceChange\n * @param fetchBranch\n * @param defaultId\n * @param value\n * @param treeDataSimpleMode\n */\nvar useAsyncTreeSelect = function (_a) {\n  var cascadeParams = _a.cascadeParams,\n    onDataSourceChange = _a.onDataSourceChange,\n    fetchBranch = _a.fetchBranch,\n    fetchData = _a.fetchData,\n    defaultId = _a.defaultId,\n    value = _a.value,\n    treeDataSimpleMode = _a.treeDataSimpleMode;\n  var _b = useState([]),\n    treeData = _b[0],\n    setTreeData = _b[1];\n  var changeValue = useRef();\n  /**\n   * findNodeById\n   * @description 通过id寻找节点\n   * @param treeData\n   * @param {string} id\n   * @return object\n   */\n  var findNodeById = function (treeData, id) {\n    function loop(_treeData) {\n      var result;\n      for (var i = 0; i < _treeData.length; i++) {\n        if (Object.is(_treeData[i].value, id)) {\n          result = _treeData[i];\n          break;\n        } else {\n          result = loop(_treeData[i].children || []);\n          if (result) {\n            break;\n          }\n        }\n      }\n      return result;\n    }\n    return loop(treeData);\n  };\n  /**\n   * loadDefaultData\n   * @description 加载初始化的数据\n   */\n  var loadDefaultData = function () {\n    fetchData(defaultId !== null && defaultId !== void 0 ? defaultId : '', cascadeParams).then(function (treeData) {\n      setTreeData(treeData);\n    });\n  };\n  /**\n   * loadDefaultBranchData\n   * @description 加载回显的数据\n   */\n  var loadDefaultBranchData = function () {\n    // const treeBranchNode = Util.arrayToAntdTreeSelect(data, {\n    //   keyAttr: 'id',\n    //   titleAttr: 'title',\n    //   rootParentId: '0',\n    //   parentIdAttr: 'pid',\n    // });\n    if (!fetchBranch) return;\n    // 回显 回显数据 并集 topLevel\n    Promise.all([loadData(defaultId, cascadeParams), fetchBranch === null || fetchBranch === void 0 ? void 0 : fetchBranch(value, cascadeParams)]).then(function (_a) {\n      var _b = _a[0],\n        rootNodes = _b === void 0 ? [] : _b,\n        _c = _a[1],\n        treeBranchNode = _c === void 0 ? [] : _c;\n      setTreeData(__spreadArray(__spreadArray([], treeBranchNode !== null && treeBranchNode !== void 0 ? treeBranchNode : [], true), (rootNodes !== null && rootNodes !== void 0 ? rootNodes : []).filter(function (_node) {\n        return !(treeBranchNode !== null && treeBranchNode !== void 0 ? treeBranchNode : []).map(function (t) {\n          return t.value;\n        }).includes(_node.value);\n      }), true));\n    });\n  };\n  /**\n   * loadData\n   * @description Async加载数据\n   * @param {string} id\n   * @param cascadeParams\n   */\n  var loadData = function (id, cascadeParams) {\n    return fetchData(id, cascadeParams).then(function (data) {\n      return data;\n    });\n  };\n  /**\n   * onLoadData\n   * @return {Promise<undefined>}\n   * @param nodeData\n   */\n  var onLoadData = function (nodeData) {\n    return new Promise(function (resolve) {\n      setTimeout(function () {\n        var id = nodeData.value,\n          cascadeParams = __rest(nodeData, [\"value\"]);\n        loadData(id, cascadeParams).then(function (data) {\n          setTreeData(function (_treeData) {\n            var _a, _b, _c, _d;\n            // 拉平数据处理\n            if (!!treeDataSimpleMode) {\n              return __spreadArray(__spreadArray([], data !== null && data !== void 0 ? data : [], true), (_b = (_a = _treeData === null || _treeData === void 0 ? void 0 : _treeData.filter) === null || _a === void 0 ? void 0 : _a.call(_treeData, function (t) {\n                return t.pId !== id;\n              })) !== null && _b !== void 0 ? _b : [], true);\n            }\n            // 正常数据处理\n            var node = findNodeById(_treeData, id);\n            // children中可能有回显数据，需要分情况处理\n            if (node.children && Array.isArray(node.children)) {\n              if (!node.children.length) {\n                node.children = data;\n              } else {\n                node.children = __spreadArray(__spreadArray([], node.children, true), (_d = (_c = data === null || data === void 0 ? void 0 : data.filter) === null || _c === void 0 ? void 0 : _c.call(data, function (t) {\n                  return node.children.find(function (n) {\n                    return n.value !== t.value;\n                  });\n                })) !== null && _d !== void 0 ? _d : [], true);\n              }\n            } else {\n              node.children = data;\n            }\n            return __spreadArray([], _treeData !== null && _treeData !== void 0 ? _treeData : [], true);\n          });\n        });\n        resolve(undefined);\n      }, 300);\n    });\n  };\n  var onChange = function (callback, params) {\n    changeValue.current = params;\n    callback === null || callback === void 0 ? void 0 : callback.apply(void 0, params);\n  };\n  useMount(function () {\n    if (value) {\n      if (Array.isArray(value)) {\n        if (!!value.length) {\n          loadDefaultBranchData();\n        } else {\n          loadDefaultData();\n        }\n      } else {\n        loadDefaultBranchData();\n      }\n    } else {\n      loadDefaultData();\n    }\n  });\n  useUpdateEffect(function () {\n    if (!changeValue.current) {\n      loadDefaultBranchData();\n    }\n  }, [value]);\n  useUpdateEffect(function () {\n    if (value) {\n      loadDefaultBranchData();\n    } else {\n      loadDefaultData();\n    }\n  }, [JSON.stringify(cascadeParams)]);\n  useUpdateEffect(function () {\n    onDataSourceChange === null || onDataSourceChange === void 0 ? void 0 : onDataSourceChange(treeData);\n  }, [treeData]);\n  return {\n    treeData: treeData,\n    onLoadData: onLoadData,\n    onChange: onChange\n  };\n};\nexport default useAsyncTreeSelect;"],"names":["__rest","this","s","e","t","p","Object","prototype","hasOwnProperty","call","indexOf","getOwnPropertySymbols","i","length","propertyIsEnumerable","__spreadArray","to","from","pack","arguments","ar","l","Array","slice","concat","useMount","useUpdateEffect","useRef","useState","useAsyncTreeSelect","_a","findNodeById","treeData","id","loop","_treeData","result","is","value","children","loadDefaultData","fetchData","defaultId","cascadeParams","then","setTreeData","loadDefaultBranchData","fetchBranch","Promise","all","loadData","_b","rootNodes","_c","treeBranchNode","filter","_node","map","includes","data","onDataSourceChange","treeDataSimpleMode","changeValue","isArray","current","JSON","stringify","onLoadData","nodeData","resolve","setTimeout","_d","node","pId","find","n","undefined","onChange","callback","params","apply"],"mappings":"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"}