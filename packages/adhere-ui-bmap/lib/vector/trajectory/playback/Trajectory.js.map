{"version":3,"file":"Trajectory.js","sources":["vector/trajectory/playback/Trajectory.js"],"sourcesContent":["\"use strict\";\r\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n}));\r\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o[\"default\"] = v;\r\n});\r\nvar __importStar = (this && this.__importStar) || function (mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n};\r\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar turf = __importStar(require(\"@turf/turf\"));\r\n// @ts-ignore\r\nvar adhere_util_1 = __importDefault(require(\"@baifendian/adhere-util\"));\r\nvar types_1 = require(\"../../types\");\r\n/**\r\n * Trajectory\r\n * @class Trajectory\r\n * @classdesc 一个轨迹\r\n */\r\nvar Trajectory = /** @class */ (function () {\r\n    function Trajectory(_a) {\r\n        var context = _a.context, id = _a.id, coordinates = _a.coordinates, renderPosition = _a.renderPosition, renderStep = _a.renderStep, renderCap = _a.renderCap, duration = _a.duration;\r\n        // 主键\r\n        this.id = '';\r\n        // 上下文\r\n        this.context = null;\r\n        // 轨迹的数据\r\n        this.coordinates = [];\r\n        // 完成轨迹播放的时长(单位秒)\r\n        this.duration = 0;\r\n        // 状态\r\n        this.status = types_1.TrajectoryStatus.UnInit;\r\n        // 总的回合数\r\n        this.boutTotal = 0;\r\n        // 已经进行的回合数\r\n        this.bout = 1;\r\n        // loop的句柄\r\n        this.loopHeader = -1;\r\n        // loop的数据\r\n        this.loopPointEntitys = [];\r\n        // step的数组\r\n        this.stepEntityIndexes = [];\r\n        // 之前的loopPixel\r\n        this.preLoopPixel = null;\r\n        // 箭头的mark\r\n        this.arrowMarker = null;\r\n        this.context = context;\r\n        this.id = id;\r\n        this.coordinates = coordinates;\r\n        this.duration = duration;\r\n        this.renderPosition = renderPosition;\r\n        this.renderStep = renderStep;\r\n        this.renderCap = renderCap;\r\n    }\r\n    /**\r\n     * drawDefaultPosition\r\n     * @description - 默认的点位绘制\r\n     * @protected\r\n     * @param coordinate\r\n     * @param index\r\n     */\r\n    Trajectory.prototype.drawDefaultPosition = function (coordinate, index) {\r\n        var context = this.context;\r\n        if (!context)\r\n            return;\r\n        var ctx = context.getCtx();\r\n        if (!ctx)\r\n            return;\r\n        // 需要转换\r\n        var pixel = context.pointToPixel({ x: coordinate.lng, y: coordinate.lat });\r\n        // 绘制圆圈\r\n        ctx.beginPath();\r\n        ctx.strokeStyle = 'red';\r\n        ctx.fillStyle = '#fff';\r\n        ctx.lineWidth = 3;\r\n        ctx.ellipse(pixel.x, pixel.y, 6, 6, (45 * Math.PI) / 180, 0, 2 * Math.PI);\r\n        ctx.stroke();\r\n        ctx.fill();\r\n        // 绘制文字\r\n        ctx.beginPath();\r\n        ctx.font = '8px sans-serif';\r\n        ctx.textAlign = 'center';\r\n        ctx.textBaseline = 'middle';\r\n        ctx.fillStyle = '#000';\r\n        ctx.fillText(\"\" + (index + 1), pixel.x, pixel.y, 10);\r\n    };\r\n    /**\r\n     * createDefaultCap\r\n     * @description - 创建缺省的箭头\r\n     * @protected\r\n     // * @param toPixel\r\n     */\r\n    Trajectory.prototype.createDefaultCap = function ( /*toPixel: IPixel*/) {\r\n        var context = this.context;\r\n        if (!context)\r\n            return;\r\n        // const map = context.getMap();\r\n        // const prePoint = context.pixelToPoint(preLoopPixel);\r\n        // const point = context.pixelToPoint(toPixel);\r\n        // const angle = MathUtil.radianToAngle(MathUtil.slope(preLoopPixel, toPixel));\r\n        // const angle1 =\r\n        //   (Math.atan2(preLoopPixel.y - toPixel.y, preLoopPixel.x - toPixel.x) * 180) / Math.PI;\r\n        // const a1 = turf.point([prePoint.x, prePoint.y], { 'marker-color': '#F00' });\r\n        // const a2 = turf.point([point.x, point.y], { 'marker-color': '#F00' });\r\n        // console.log('angle', angle1, angle);\r\n        // console.log('rhumbBearing', turf.rhumbBearing(a1, a2));\r\n        // console.log('bearing', turf.bearing(a1, a2));\r\n        // @ts-ignore\r\n        var myIcon = new BMap.Icon('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNjMxNDU2MzQ2NjYxIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjQxMzYiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTc4OC40OCA1MTJMMzEyLjMyIDc4Ni45MjM1MlYyMzcuMDk2OTZ6IiBwLWlkPSI0MTM3IiBmaWxsPSIjRkZBNTAwIj48L3BhdGg+PC9zdmc+', \r\n        // @ts-ignore\r\n        new BMap.Size(16, 16));\r\n        // @ts-ignore\r\n        // const pt = new BMap.Point(point.x, point.y);\r\n        // @ts-ignore\r\n        return new BMap.Marker(new BMap.Point(90, 90), {\r\n            icon: myIcon,\r\n        });\r\n    };\r\n    /**\r\n     * updateCap\r\n     * @param toPixel\r\n     * @protected\r\n     * @description - 更新arrow的位置和旋转角度\r\n     */\r\n    Trajectory.prototype.updateCap = function (toPixel) {\r\n        var _a = this, preLoopPixel = _a.preLoopPixel, context = _a.context, arrowMarker = _a.arrowMarker;\r\n        if (!context || !preLoopPixel || !arrowMarker)\r\n            return;\r\n        var toPoint = context.pixelToPoint(toPixel);\r\n        var dx = toPixel.x - preLoopPixel.x;\r\n        var dy = toPixel.y - preLoopPixel.y;\r\n        var rotation = Math.atan2(dy, dx);\r\n        var degrees1 = rotation * (180 / Math.PI);\r\n        var degrees = adhere_util_1.default.slopToAngle(preLoopPixel, toPixel, 'geographic');\r\n        // const angle = MathUtil.radianToAngle(MathUtil.slope(preLoopPixel, toPixel));\r\n        // @ts-ignore\r\n        arrowMarker.setPosition(new BMap.Point(toPoint.x, toPoint.y));\r\n        arrowMarker.setRotation(degrees);\r\n        // const angle1 =\r\n        //   (Math.atan2(preLoopPixel.y - toPixel.y, preLoopPixel.x - toPixel.x) * 180) / Math.PI;\r\n        // const a1 = turf.point([prePoint.x, prePoint.y], { 'marker-color': '#F00' });\r\n        // const a2 = turf.point([point.x, point.y], { 'marker-color': '#F00' });\r\n        // console.log('angle', angle1, angle);\r\n        // console.log('rhumbBearing', turf.rhumbBearing(a1, a2));\r\n        // console.log('bearing', turf.bearing(a1, a2));\r\n    };\r\n    /**\r\n     * drawPosition\r\n     * @description - 绘制位置节点\r\n     * @protected\r\n     */\r\n    Trajectory.prototype.drawPosition = function () {\r\n        var _this = this;\r\n        var _a = this, renderPosition = _a.renderPosition, coordinates = _a.coordinates, context = _a.context;\r\n        if (!context)\r\n            return;\r\n        var ctx = context.getCtx();\r\n        if (!ctx)\r\n            return;\r\n        coordinates.forEach(function (coordinate, index) {\r\n            // 用户自定义绘制\r\n            if (renderPosition) {\r\n                renderPosition({ ctx: ctx, coordinate: coordinate });\r\n            }\r\n            // 默认绘制\r\n            else {\r\n                _this.drawDefaultPosition(coordinate, index);\r\n            }\r\n        });\r\n    };\r\n    /**\r\n     * drawTrajectory\r\n     * @description - 绘制历史轨迹\r\n     * @protected\r\n     */\r\n    Trajectory.prototype.drawTrajectory = function () {\r\n        this.drawPosition();\r\n        this.prepareLoopData();\r\n        for (var i = 1; i < this.boutTotal; i++) {\r\n            this.loopBout(i);\r\n        }\r\n        this.drawLastFrame();\r\n        this.finishDeal();\r\n    };\r\n    /**\r\n     * drawLastFrame\r\n     * @description - 绘制最后一帧\r\n     * @protected\r\n     */\r\n    Trajectory.prototype.drawLastFrame = function () {\r\n        var _a = this, loopPointEntitys = _a.loopPointEntitys, context = _a.context, renderStep = _a.renderStep, renderCap = _a.renderCap;\r\n        if (!context)\r\n            return;\r\n        var ctx = context.getCtx();\r\n        if (!ctx)\r\n            return;\r\n        var lastPoint = loopPointEntitys[loopPointEntitys.length - 1];\r\n        var lastPixel = context.pointToPixel({ x: lastPoint.point.lng, y: lastPoint.point.lat });\r\n        ctx.beginPath();\r\n        if (renderStep) {\r\n            renderStep(ctx, lastPixel);\r\n        }\r\n        else {\r\n            this.setDrawLoopStyle();\r\n            ctx.lineTo(lastPixel.x, lastPixel.y);\r\n            ctx.stroke();\r\n            this.preLoopPixel = null;\r\n        }\r\n        this.updateCap(lastPixel);\r\n    };\r\n    /**\r\n     * setDrawLoopStyle\r\n     * @description - 设置loop绘制的上下文样式\r\n     * @protected\r\n     */\r\n    Trajectory.prototype.setDrawLoopStyle = function () {\r\n        var context = this.context;\r\n        if (!context)\r\n            return;\r\n        var ctx = context.getCtx();\r\n        if (!ctx)\r\n            return;\r\n        ctx.strokeStyle = 'orange';\r\n        ctx.lineWidth = 3;\r\n        // ctx.lineCap = 'round';\r\n    };\r\n    /**\r\n     * finishDeal\r\n     * @protected - End后的清理工作\r\n     * @protected\r\n     */\r\n    Trajectory.prototype.finishDeal = function () {\r\n        var context = this.context;\r\n        if (!context)\r\n            return;\r\n        var map = context.getMap();\r\n        if (!map)\r\n            return;\r\n        if (this.loopHeader !== -1) {\r\n            typeof window !== 'undefined' && window.cancelAnimationFrame(this.loopHeader);\r\n        }\r\n        this.loopHeader = -1;\r\n        this.bout = 1;\r\n        this.boutTotal = 0;\r\n        this.loopPointEntitys = [];\r\n        this.stepEntityIndexes = [];\r\n        this.preLoopPixel = null;\r\n        if (this.arrowMarker) {\r\n            map.removeOverlay(this.arrowMarker);\r\n        }\r\n        this.arrowMarker = null;\r\n    };\r\n    /**\r\n     * loopBout\r\n     * @description - 绘制一个回合\r\n     * @param bout\r\n     * @protected\r\n     */\r\n    Trajectory.prototype.loopBout = function (bout) {\r\n        var _a = this, context = _a.context, loopPointEntitys = _a.loopPointEntitys, stepEntityIndexes = _a.stepEntityIndexes, renderStep = _a.renderStep, renderCap = _a.renderCap;\r\n        if (!context)\r\n            return;\r\n        var ctx = context.getCtx();\r\n        if (!ctx)\r\n            return;\r\n        var map = context.getMap();\r\n        // 先执行一次\r\n        var curStartStepIndex = bout === 1 ? 0 : stepEntityIndexes[bout - 2];\r\n        var curEndStepIndex = stepEntityIndexes[bout - 1];\r\n        for (var i = curStartStepIndex; i < curEndStepIndex; i++) {\r\n            var point = loopPointEntitys[i].point;\r\n            var pixel = context.pointToPixel({ x: point.lng, y: point.lat });\r\n            if (this.preLoopPixel) {\r\n                this.updateCap(pixel);\r\n            }\r\n            else {\r\n                // 创建\r\n                if (renderCap) {\r\n                    this.arrowMarker = renderCap();\r\n                }\r\n                else {\r\n                    this.arrowMarker = this.createDefaultCap();\r\n                }\r\n                map.addOverlay(this.arrowMarker);\r\n            }\r\n            if (renderStep) {\r\n                renderStep(ctx, pixel);\r\n            }\r\n            else {\r\n                if (!this.preLoopPixel) {\r\n                    ctx.beginPath();\r\n                    this.setDrawLoopStyle();\r\n                    ctx.moveTo(pixel.x, pixel.y);\r\n                    this.preLoopPixel = pixel;\r\n                }\r\n                else {\r\n                    ctx.lineTo(pixel.x, pixel.y);\r\n                    ctx.stroke();\r\n                    ctx.beginPath();\r\n                    this.setDrawLoopStyle();\r\n                    ctx.moveTo(pixel.x, pixel.y);\r\n                    // 0 1 2 3 4 5\r\n                }\r\n            }\r\n        }\r\n    };\r\n    /**\r\n     * loop\r\n     * @description - loop的迭代\r\n     * @protected\r\n     */\r\n    Trajectory.prototype.loop = function () {\r\n        // 2 5\r\n        // 0 1   (2)     3 4    (5)\r\n        var _this = this;\r\n        if (typeof window === 'undefined')\r\n            return;\r\n        this.loopHeader = window.requestAnimationFrame(function () {\r\n            // 暂停则不执行其他操作\r\n            if (_this.status === types_1.TrajectoryStatus.Pause) {\r\n                _this.loop();\r\n                return;\r\n            }\r\n            var context = _this.context;\r\n            if (!context)\r\n                return;\r\n            var ctx = context.getCtx();\r\n            if (!ctx)\r\n                return;\r\n            _this.loopBout(_this.bout);\r\n            // 回合++\r\n            _this.bout++;\r\n            // 结束了\r\n            if (_this.bout >= _this.boutTotal) {\r\n                // 绘制最后一个点\r\n                _this.drawLastFrame();\r\n                _this.finishDeal();\r\n                _this.status = types_1.TrajectoryStatus.End;\r\n                return;\r\n            }\r\n            else {\r\n                _this.loop();\r\n            }\r\n        });\r\n    };\r\n    /**\r\n     * prepareLoopData\r\n     * @description - 准备loop的数据\r\n     * @protected\r\n     */\r\n    Trajectory.prototype.prepareLoopData = function () {\r\n        // 计算沿线的点\r\n        var _this = this;\r\n        /**\r\n         * 整体的思路\r\n         * 1. 将所有原始点生成一个结构 {\r\n         *   point: {x,y},\r\n         *   distance: 沿线的距离(第一个点为0)单位为m\r\n         *   isStep: boolean(是否为步进的点) false\r\n         * }\r\n         *\r\n         * 2.总的距离 / (duration * 60) 获取步进\r\n         * 计算每一次的步进 生成 {\r\n         *   point: {x,y},\r\n         *   distance: 沿线的距离(第一个点为0)单位为m\r\n         *   isStep: boolean(是否为步进的点) true\r\n         * }\r\n         *\r\n         * 3.将1,2按照distance从小到大整合到一起\r\n         *\r\n         * 4.开始播放\r\n         */\r\n        var _a = this, duration = _a.duration, coordinates = _a.coordinates;\r\n        // 1.origin\r\n        var origin = [];\r\n        coordinates.reduce(function (total, coordinate, index) {\r\n            var distance = index === 0\r\n                ? 0\r\n                : turf.convertLength(turf.distance(turf.point([coordinates[index - 1].lng, coordinates[index - 1].lat]), turf.point([coordinate.lng, coordinate.lat]), {\r\n                    units: 'kilometers',\r\n                }), 'kilometers', 'meters');\r\n            origin.push({\r\n                point: coordinate,\r\n                distance: total + distance,\r\n                isStep: false,\r\n            });\r\n            return total + distance;\r\n        }, 0);\r\n        // 2.target\r\n        var line = turf.lineString(coordinates.map(function (coordinate) { return [coordinate.lng, coordinate.lat]; }));\r\n        // 总长(m)\r\n        var length = turf.convertLength(turf.length(line, { units: 'kilometers' }), 'kilometers', 'meters');\r\n        // 总的回合数\r\n        this.boutTotal = duration * 60;\r\n        // 步进(m)\r\n        var step = length / this.boutTotal;\r\n        // target\r\n        var target = [];\r\n        for (var i = 0; i < this.boutTotal; i++) {\r\n            // 每一步的距离\r\n            var stepDistance = (i + 1) * step;\r\n            var turfPoint = turf.along(line, turf.convertLength(stepDistance, 'meters', 'kilometers'), {\r\n                units: 'kilometers',\r\n            });\r\n            target.push({\r\n                point: { lng: turfPoint.geometry.coordinates[0], lat: turfPoint.geometry.coordinates[1] },\r\n                distance: stepDistance,\r\n                isStep: true,\r\n            });\r\n        }\r\n        // 3.sortMerge(按距离从小到大进行排序)\r\n        this.loopPointEntitys = __spreadArrays(origin, target);\r\n        this.loopPointEntitys.sort(function (p1, p2) {\r\n            if (p1.distance > p2.distance)\r\n                return 1;\r\n            else if (p1.distance < p2.distance)\r\n                return -1;\r\n            else\r\n                return 0;\r\n        });\r\n        this.stepEntityIndexes = [];\r\n        this.loopPointEntitys.forEach(function (pointEntity, index) {\r\n            if (pointEntity.isStep) {\r\n                _this.stepEntityIndexes.push(index);\r\n            }\r\n        });\r\n    };\r\n    /**\r\n     * init\r\n     * @description - 初始化轨迹\r\n     */\r\n    Trajectory.prototype.init = function () {\r\n        if (this.status !== types_1.TrajectoryStatus.UnInit)\r\n            return;\r\n        // 初始化就是先把轨迹点绘制上\r\n        this.drawPosition();\r\n        // 修改状态为初始化完成\r\n        this.status = types_1.TrajectoryStatus.Init;\r\n    };\r\n    /**\r\n     * start\r\n     * @description - 开始\r\n     */\r\n    Trajectory.prototype.start = function () {\r\n        var context = this.context;\r\n        if (!context)\r\n            return;\r\n        var ctx = context.getCtx();\r\n        if (!ctx)\r\n            return;\r\n        if (![types_1.TrajectoryStatus.Init, types_1.TrajectoryStatus.End, types_1.TrajectoryStatus.Pause].includes(this.status)) {\r\n            return;\r\n        }\r\n        if ([types_1.TrajectoryStatus.Pause, types_1.TrajectoryStatus.End].includes(this.status)) {\r\n            if (types_1.TrajectoryStatus.Pause === this.status) {\r\n                this.finishDeal();\r\n            }\r\n            context.clear();\r\n            // 画历史\r\n            context.drawHistory();\r\n        }\r\n        // 修改状态为运行状态\r\n        this.status = types_1.TrajectoryStatus.Running;\r\n        // 准备loop数据\r\n        this.prepareLoopData();\r\n        // execute\r\n        this.loop();\r\n    };\r\n    /**\r\n     * pause\r\n     * @description - 暂停\r\n     */\r\n    Trajectory.prototype.pause = function () {\r\n        this.status = types_1.TrajectoryStatus.Pause;\r\n    };\r\n    /**\r\n     * resume\r\n     * @description -恢复\r\n     */\r\n    Trajectory.prototype.resume = function () {\r\n        this.status = types_1.TrajectoryStatus.Running;\r\n    };\r\n    /**\r\n     * finish\r\n     * @description - 结束\r\n     */\r\n    Trajectory.prototype.finish = function () {\r\n        var context = this.context;\r\n        if (!context)\r\n            return;\r\n        if ([types_1.TrajectoryStatus.End, types_1.TrajectoryStatus.Destroy].includes(this.status))\r\n            return;\r\n        // 如果没画完画完\r\n        this.finishDeal();\r\n        this.status = types_1.TrajectoryStatus.End;\r\n    };\r\n    /**\r\n     * description\r\n     * @description - 销毁\r\n     */\r\n    Trajectory.prototype.destroy = function () {\r\n        if (this.status === types_1.TrajectoryStatus.Destroy)\r\n            return;\r\n        var context = this.context;\r\n        if (!context)\r\n            return;\r\n        this.finishDeal();\r\n        context.clear();\r\n        // 画历史\r\n        // context.drawHistory();\r\n        this.status = types_1.TrajectoryStatus.Destroy;\r\n        context.removeTrajectoryById(this.id);\r\n    };\r\n    Trajectory.prototype.getId = function () {\r\n        return this.id;\r\n    };\r\n    Trajectory.prototype.getStatus = function () {\r\n        return this.status;\r\n    };\r\n    /**\r\n     * drawHistory\r\n     * @description - 绘制clear之后的历史轨迹\r\n     */\r\n    Trajectory.prototype.drawHistory = function () {\r\n        var status = this.status;\r\n        if (types_1.TrajectoryStatus.Init === status) {\r\n            this.drawPosition();\r\n        }\r\n        else if (types_1.TrajectoryStatus.End === status) {\r\n            this.drawTrajectory();\r\n        }\r\n        if ([types_1.TrajectoryStatus.Pause, types_1.TrajectoryStatus.Running].includes(status)) {\r\n            this.drawPosition();\r\n            // 绘制历史\r\n            for (var i = 1; i < this.bout; i++) {\r\n                this.loopBout(i);\r\n            }\r\n        }\r\n    };\r\n    return Trajectory;\r\n}());\r\nexports.default = Trajectory;\r\n"],"names":["__createBinding","this","Object","create","o","m","k","k2","undefined","defineProperty","enumerable","get","__setModuleDefault","v","value","__importStar","mod","__esModule","result","hasOwnProperty","call","__spreadArrays","s","i","il","arguments","length","r","Array","a","j","jl","__importDefault","default","exports","turf","require","adhere_util_1","types_1","Trajectory","_a","context","id","coordinates","renderPosition","renderStep","renderCap","duration","status","TrajectoryStatus","UnInit","boutTotal","bout","loopHeader","loopPointEntitys","stepEntityIndexes","preLoopPixel","arrowMarker","prototype","drawDefaultPosition","coordinate","index","ctx","getCtx","pixel","pointToPixel","x","lng","y","lat","beginPath","strokeStyle","fillStyle","lineWidth","ellipse","Math","PI","stroke","fill","font","textAlign","textBaseline","fillText","createDefaultCap","myIcon","BMap","Icon","Size","Marker","Point","icon","updateCap","toPixel","toPoint","pixelToPoint","dx","dy","atan2","degrees","slopToAngle","setPosition","setRotation","drawPosition","_this","forEach","drawTrajectory","prepareLoopData","loopBout","drawLastFrame","finishDeal","lastPoint","lastPixel","point","setDrawLoopStyle","lineTo","map","getMap","window","cancelAnimationFrame","removeOverlay","curStartStepIndex","curEndStepIndex","addOverlay","moveTo","loop","requestAnimationFrame","Pause","End","origin","reduce","total","distance","convertLength","units","push","isStep","line","lineString","step","target","stepDistance","turfPoint","along","geometry","sort","p1","p2","pointEntity","init","Init","start","includes","clear","drawHistory","Running","pause","resume","finish","Destroy","destroy","removeTrajectoryById","getId","getStatus"],"mappings":"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"}