var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}(),__spreadArray=this&&this.__spreadArray||function(t,e,n){if(n||2===arguments.length)for(var i,a=0,s=e.length;a<s;a++)!i&&a in e||((i=i||Array.prototype.slice.call(e,0,a))[a]=e[a]);return t.concat(i||Array.prototype.slice.call(e))};import MathUtil from"@baifendian/adhere-util";import Emitter from"@baifendian/adhere-util-emitter";import Util from"../../util";import CircleDrawAction from"./draw/CircleDrawAction";import DiamondDrawAction from"./draw/DiamondDrawAction";import DistanceDrawAction from"./draw/DistanceDrawAction";import FreeDrawAction from"./draw/FreeDrawAction";import PolygonDrawAction from"./draw/PolygonDrawAction";import RectangleDrawAction from"./draw/RectangleDrawAction";import StartDrawAction from"./draw/StartDrawAction";import TriangleDrawAction from"./draw/TriangleDrawAction";import{ActionStatus,InteractionLayerActions,SelectType}from"./types";var selectorPrefix="adhere-ui-interactionlayer",zIndex=19999,InteractionLayer=function(a){function t(t,e,n){var i=this;return i.update=i.update.bind(i),(i=a.call(this,{update:i.update,paneName:"markerPane",zIndex:zIndex})||this).map=null,i.el=null,i.listeners=null,i.curAction=null,i.canvasEl=null,i.ctx=null,i.assistCanvasEl=null,i.assistCtx=null,i.canvasData=[],i.emitter=new Emitter.Events,i.isLoad=!1,i.canvasObserver=null,i.typeActionMap=new Map([[SelectType.Polygon,PolygonDrawAction],[SelectType.Distance,DistanceDrawAction],[SelectType.Circle,CircleDrawAction],[SelectType.Rectangle,RectangleDrawAction],[SelectType.Triangle,TriangleDrawAction],[SelectType.Diamond,DiamondDrawAction],[SelectType.Start,StartDrawAction],[SelectType.Free,FreeDrawAction]]),i.map=t,i.listeners=n,e&&(i.canvasData=e),i.initListeners(),i}return __extends(t,a),t.prototype.update=function(){this.isLoad?(this.curAction&&this.curAction.destroy(),this.clearDraw(),this.clearAssistDraw(),this.drawHistoryData()):(this.initCanvas(),this.initEvents(),this.clearDraw(),this.clearAssistDraw(),this.drawHistoryData(),this.isLoad=!0)},t.prototype.initListeners=function(){var e=this,n=this.listeners;n&&Object.keys(n).forEach(function(t){e.emitter.on(t,n[t])})},t.prototype.initEvents=function(){var o=this;this.el.addEventListener("mouseup",function(t){if(t&&!(2<=t.detail)){for(var e=o.getHistoryData(),n=MathUtil.clientToCtxPoint({event:t,rect:o.getCanvasEl().getBoundingClientRect()}),i=[],a=0;a<e.length;a++){var s=e[a],r=o.typeActionMap.get(s.type);"booleanPointInData"in r&&(null==r?void 0:r.booleanPointInData(o,n,s))&&i.push({index:a,data:s})}i.length?o.emitter.trigger(InteractionLayerActions.CanvasClickGeometry,JSON.parse(JSON.stringify(i[i.length-1].data))):e.length&&o.emitter.trigger(InteractionLayerActions.CanvasClickEmpty)}})},t.prototype.initCanvas=function(){var s=this;this.el=this.canvas.parentElement,this.canvasEl=this.canvas,this.el.style.width="".concat(this.canvasEl.width,"px"),this.el.style.height="".concat(this.canvasEl.height,"px"),this.canvasEl.className="".concat(selectorPrefix),this.ctx=this.canvasEl.getContext("2d"),this.assistCanvasEl=document.createElement("canvas"),this.assistCanvasEl.className="".concat(selectorPrefix,"-assist"),this.assistCanvasEl.style.zIndex="".concat(parseInt(this.canvasEl.style.zIndex)-1),this.assistCanvasEl.width=this.canvasEl.width,this.assistCanvasEl.height=this.canvasEl.height,this.assistCtx=this.assistCanvasEl.getContext("2d"),this.canvasObserver=new MutationObserver(function(t,e){for(var n=0,i=t;n<i.length;n++){var a=i[n];"attributes"===a.type&&"style"===a.attributeName&&(s.assistCanvasEl.style.left=s.canvasEl.style.left,s.assistCanvasEl.style.top=s.canvasEl.style.top)}}),this.canvasObserver.observe(this.canvasEl,{attributes:!0}),this.el.appendChild(this.assistCanvasEl),this.emitter.trigger(InteractionLayerActions.CanvasMount)},t.prototype.enableMap=function(){this.map.enableDoubleClickZoom()},t.prototype.disableMap=function(){this.map.disableDoubleClickZoom()},t.prototype.pixelToPoint=function(t){t=this.map.pixelToPoint(t);return{x:t.lng,y:t.lat}},t.prototype.pointToPixel=function(t){return this.map.pointToPixel(new BMap.Point(t.x,t.y))},t.prototype.distanceToActual=function(t){return t/Util.getScale(this.map)},t.prototype.actualToDistance=function(t){return Util.getScale(this.map)*t},t.prototype.getCtx=function(){return this.ctx},t.prototype.getCanvasEl=function(){return this.canvasEl},t.prototype.getAssistCanvasEl=function(){return this.assistCanvasEl},t.prototype.getAssistCtx=function(){return this.assistCtx},t.prototype.getWidth=function(){var t;return null==(t=null==this?void 0:this.getCanvasEl())?void 0:t.width},t.prototype.getHeight=function(){var t;return null==(t=null==this?void 0:this.getCanvasEl())?void 0:t.height},t.prototype.addHistoryData=function(t){this.canvasData.push(t)},t.prototype.removeHistoryDataById=function(e){var t=this.canvasData.findIndex(function(t){return t.id===e});return-1===t?[]:this.canvasData.splice(t,1)},t.prototype.drawHistoryData=function(){var i=this;this.canvasData.forEach(function(t){var e,n=i.ctx;n&&t&&(t.style&&(n.lineWidth=t.style.lineWidth,n.lineJoin=t.style.lineJoin,n.lineCap=t.style.lineCap,n.setLineDash(t.style.lineDash),n.lineDashOffset=t.style.lineDashOffset,n.strokeStyle=t.style.strokeStyle,n.fillStyle=t.style.fillStyle),null!=(e=i.typeActionMap.get(t.type))&&e.drawHistoryPath(i,n,t.data))})},t.prototype.getHistoryDataById=function(e){return this.canvasData.find(function(t){return t.id===e})},t.prototype.getHistoryData=function(){return __spreadArray([],this.canvasData,!0)},t.prototype.setHistoryData=function(t){this.canvasData=t},t.prototype.changeAction=function(t){t===this.curAction||t&&t.getStatus()!==ActionStatus.UnStart||(this.disableMap(),this.curAction&&this.curAction.destroy(),null!=t&&t.setContext(this),this.curAction=t)},t.prototype.getCurAction=function(){return this.curAction},t.prototype.start=function(t){this.curAction&&this.curAction.start(t)},t.prototype.end=function(){this.curAction&&this.curAction.end()},t.prototype.clearDraw=function(){var t=this.ctx;t&&t.clearRect(0,0,this.getWidth(),this.getHeight())},t.prototype.clearAssistDraw=function(){var t=this.assistCtx;t&&t.clearRect(0,0,this.getWidth(),this.getHeight())},t.prototype.setFrontCanvas=function(t){t.style.zIndex="".concat(zIndex+1)},t.prototype.setBackCanvas=function(t){t.style.zIndex="".concat(zIndex-1)},t.prototype.destroy=function(){this.curAction&&this.curAction.destroy(),this.canvasObserver&&this.canvasObserver.disconnect()},t.prototype.getMap=function(){return this.map},t}(BMap.CanvasLayer);export default InteractionLayer;
//# sourceMappingURL=InteractionLayer.js.map
