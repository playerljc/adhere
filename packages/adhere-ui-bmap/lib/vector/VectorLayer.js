var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},__spreadArrays=this&&this.__spreadArrays||function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;for(var i=Array(t),r=0,e=0;e<n;e++)for(var a=arguments[e],o=0,s=a.length;o<s;o++,r++)i[r]=a[o];return i};import Emitter from"@baifendian/adhere-util-emitter/lib/events";import MathUtil from"@baifendian/adhere-util/lib/math";import ClientDetectionUtil from"@baifendian/adhere-util/lib/clientDetection";import{VectorActions,VectorEventActions}from"./types";var VectorLayer=function(i){function t(t,e){var n=this;return n.update=n.update.bind(n),(n=i.call(this,{update:n.update,paneName:e.paneName,zIndex:e.zIndex})||this).isLoad=!1,n.emitter=new Emitter,n.cacheCanvas=null,n.isStart=!1,n.isMove=!1,n.startTime=0,n.endTime=0,n.map=t,n.config=__assign({},e),n.source=e.source,n.source&&n.source.setContext(n),n.onUpdate=n.onUpdate.bind(n),n.initEvents(),n}return __extends(t,i),t.prototype.getSource=function(){return this.source},t.prototype.getZIndex=function(){return this.config.zIndex},t.prototype.setSource=function(t){this.source=t,this.source&&this.source.setContext(this),this.update()},t.prototype.drawCache=function(){this.cacheCanvas||(this.cacheCanvas=document.createElement("canvas"),this.cacheCanvas.width=this.canvas.width,this.cacheCanvas.height=this.canvas.height);var t=this.source.getFeatures();t.sort(function(t,e){return t.getZIndex()>e.getZIndex()?1:t.getZIndex()<e.getZIndex()?-1:0});var e=this.cacheCanvas.getContext("2d");e&&(e.clearRect(0,0,this.cacheCanvas.width,this.cacheCanvas.height),(t||[]).forEach(function(t){t.draw(e)}))},t.prototype.update=function(){var t=this.canvas.getContext("2d");t&&(this.isLoad||this.initCanvasEvents(),this.isLoad=!0,this.drawCache(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(this.cacheCanvas,0,0,t.canvas.width,t.canvas.height))},t.prototype.getMap=function(){return this.map},t.prototype.getEmitter=function(){return this.emitter},t.prototype.addEventListener=function(t,e){this.emitter.on(t,e)},t.prototype.removeEventListener=function(t,e){this.emitter.remove(t,e)},t.prototype.initCanvasEvents=function(){var n=this,i=this;function r(t){var e=MathUtil.clientToCtxPoint({event:t,rect:i.canvas.getBoundingClientRect()}),t=i.source.getFeatures().filter(function(t){return t.isPointInFeature(e,t.getStyle())});t.length?i.emitter.trigger(VectorEventActions.FEATURE_CLICK,{features:__spreadArrays(t),pixel:e}):i.emitter.trigger(VectorEventActions.VECTOR_CLICK)}ClientDetectionUtil.isTouch()?(this.canvas.addEventListener("touchstart",function(){n.isStart=!0,n.startTime=(new Date).getTime()}),this.canvas.addEventListener("touchmove",function(){n.isMove=!0}),this.canvas.addEventListener("touchend",function(t){n.endTime=(new Date).getTime();var e=n.endTime-n.startTime;(n.isStart&&!n.isMove||n.isStart&&n.isMove&&e<=200)&&r(t),n.isStart=n.isMove=!1,n.endTime=n.startTime=0})):this.canvas.addEventListener("click",function(t){r(t)})},t.prototype.initEvents=function(){this.emitter.on(VectorActions.UPDATE,this.onUpdate)},t.prototype.onUpdate=function(){this.update()},t}(BMap.CanvasLayer);export default VectorLayer;
//# sourceMappingURL=VectorLayer.js.map
