{"version":3,"file":"heatmap.js","sources":["heatmap.js"],"sourcesContent":["\"use strict\";\r\n/*\r\n * heatmap.js v2.0.0 | JavaScript Heatmap Library\r\n *\r\n * Copyright 2008-2014 Patrick Wied <heatmapjs@patrick-wied.at> - All rights reserved.\r\n * Dual licensed under MIT and Beerware license\r\n *\r\n * :: 2014-10-31 21:16\r\n */\r\n(function (name, context, factory) {\r\n    // Supports UMD. AMD, CommonJS/Node.js and browser context\r\n    if (typeof module !== 'undefined' && module.exports) {\r\n        module.exports = factory();\r\n    }\r\n    else if (typeof define === 'function' && define.amd) {\r\n        define(factory);\r\n    }\r\n    else {\r\n        context[name] = factory();\r\n    }\r\n    // context[name] = factory();\r\n})('h337', this, function () {\r\n    // Heatmap Config stores default values and will be merged with instance config\r\n    var HeatmapConfig = {\r\n        defaultRadius: 40,\r\n        defaultRenderer: 'canvas2d',\r\n        defaultGradient: {\r\n            0.45: 'rgb(0,0,255)',\r\n            0.55: 'rgb(0,255,255)',\r\n            0.65: 'rgb(0,255,0)',\r\n            0.95: 'yellow',\r\n            1.0: 'rgb(255,0,0)',\r\n        },\r\n        defaultMaxOpacity: 1,\r\n        defaultMinOpacity: 0,\r\n        defaultBlur: 0.85,\r\n        defaultXField: 'x',\r\n        defaultYField: 'y',\r\n        defaultValueField: 'value',\r\n        plugins: {},\r\n    };\r\n    var Store = (function StoreClosure() {\r\n        var Store = function Store(config) {\r\n            this._coordinator = {};\r\n            this._data = [];\r\n            this._radi = [];\r\n            this._min = 0;\r\n            this._max = 1;\r\n            this._xField = config['xField'] || config.defaultXField;\r\n            this._yField = config['yField'] || config.defaultYField;\r\n            this._valueField = config['valueField'] || config.defaultValueField;\r\n            if (config['radius']) {\r\n                this._cfgRadius = config['radius'];\r\n            }\r\n        };\r\n        var defaultRadius = HeatmapConfig.defaultRadius;\r\n        Store.prototype = {\r\n            // when forceRender = false -> called from setData, omits renderall event\r\n            _organiseData: function (dataPoint, forceRender) {\r\n                var x = dataPoint[this._xField];\r\n                var y = dataPoint[this._yField];\r\n                var radi = this._radi;\r\n                var store = this._data;\r\n                var max = this._max;\r\n                var min = this._min;\r\n                var value = dataPoint[this._valueField] || 1;\r\n                var radius = dataPoint.radius || this._cfgRadius || defaultRadius;\r\n                if (!store[x]) {\r\n                    store[x] = [];\r\n                    radi[x] = [];\r\n                }\r\n                if (!store[x][y]) {\r\n                    store[x][y] = value;\r\n                    radi[x][y] = radius;\r\n                }\r\n                else {\r\n                    store[x][y] += value;\r\n                }\r\n                if (store[x][y] > max) {\r\n                    if (!forceRender) {\r\n                        this._max = store[x][y];\r\n                    }\r\n                    else {\r\n                        this.setDataMax(store[x][y]);\r\n                    }\r\n                    return false;\r\n                }\r\n                else {\r\n                    return {\r\n                        x: x,\r\n                        y: y,\r\n                        value: value,\r\n                        radius: radius,\r\n                        min: min,\r\n                        max: max,\r\n                    };\r\n                }\r\n            },\r\n            _unOrganizeData: function () {\r\n                var unorganizedData = [];\r\n                var data = this._data;\r\n                var radi = this._radi;\r\n                for (var x in data) {\r\n                    for (var y in data[x]) {\r\n                        unorganizedData.push({\r\n                            x: x,\r\n                            y: y,\r\n                            radius: radi[x][y],\r\n                            value: data[x][y],\r\n                        });\r\n                    }\r\n                }\r\n                return {\r\n                    min: this._min,\r\n                    max: this._max,\r\n                    data: unorganizedData,\r\n                };\r\n            },\r\n            _onExtremaChange: function () {\r\n                this._coordinator.emit('extremachange', {\r\n                    min: this._min,\r\n                    max: this._max,\r\n                });\r\n            },\r\n            addData: function () {\r\n                if (arguments[0].length > 0) {\r\n                    var dataArr = arguments[0];\r\n                    var dataLen = dataArr.length;\r\n                    while (dataLen--) {\r\n                        this.addData.call(this, dataArr[dataLen]);\r\n                    }\r\n                }\r\n                else {\r\n                    // add to store\r\n                    var organisedEntry = this._organiseData(arguments[0], true);\r\n                    if (organisedEntry) {\r\n                        this._coordinator.emit('renderpartial', {\r\n                            min: this._min,\r\n                            max: this._max,\r\n                            data: [organisedEntry],\r\n                        });\r\n                    }\r\n                }\r\n                return this;\r\n            },\r\n            setData: function (data) {\r\n                var dataPoints = data.data;\r\n                var pointsLen = dataPoints.length;\r\n                // reset data arrays\r\n                this._data = [];\r\n                this._radi = [];\r\n                for (var i = 0; i < pointsLen; i++) {\r\n                    this._organiseData(dataPoints[i], false);\r\n                }\r\n                this._max = data.max;\r\n                this._min = data.min || 0;\r\n                this._onExtremaChange();\r\n                this._coordinator.emit('renderall', this._getInternalData());\r\n                return this;\r\n            },\r\n            removeData: function () {\r\n                // TODO: implement\r\n            },\r\n            setDataMax: function (max) {\r\n                this._max = max;\r\n                this._onExtremaChange();\r\n                this._coordinator.emit('renderall', this._getInternalData());\r\n                return this;\r\n            },\r\n            setDataMin: function (min) {\r\n                this._min = min;\r\n                this._onExtremaChange();\r\n                this._coordinator.emit('renderall', this._getInternalData());\r\n                return this;\r\n            },\r\n            setCoordinator: function (coordinator) {\r\n                this._coordinator = coordinator;\r\n            },\r\n            _getInternalData: function () {\r\n                return {\r\n                    max: this._max,\r\n                    min: this._min,\r\n                    data: this._data,\r\n                    radi: this._radi,\r\n                };\r\n            },\r\n            getData: function () {\r\n                return this._unOrganizeData();\r\n            } /*,\r\n      \r\n            TODO: rethink.\r\n      \r\n          getValueAt: function(point) {\r\n            var value;\r\n            var radius = 100;\r\n            var x = point.x;\r\n            var y = point.y;\r\n            var data = this._data;\r\n      \r\n            if (data[x] && data[x][y]) {\r\n              return data[x][y];\r\n            } else {\r\n              var values = [];\r\n              // radial search for datapoints based on default radius\r\n              for(var distance = 1; distance < radius; distance++) {\r\n                var neighbors = distance * 2 +1;\r\n                var startX = x - distance;\r\n                var startY = y - distance;\r\n      \r\n                for(var i = 0; i < neighbors; i++) {\r\n                  for (var o = 0; o < neighbors; o++) {\r\n                    if ((i == 0 || i == neighbors-1) || (o == 0 || o == neighbors-1)) {\r\n                      if (data[startY+i] && data[startY+i][startX+o]) {\r\n                        values.push(data[startY+i][startX+o]);\r\n                      }\r\n                    } else {\r\n                      continue;\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n              if (values.length > 0) {\r\n                return Math.max.apply(Math, values);\r\n              }\r\n            }\r\n            return false;\r\n          }*/,\r\n        };\r\n        return Store;\r\n    })();\r\n    var Canvas2dRenderer = (function Canvas2dRendererClosure() {\r\n        var _getColorPalette = function (config) {\r\n            var gradientConfig = config.gradient || config.defaultGradient;\r\n            var paletteCanvas = document.createElement('canvas');\r\n            var paletteCtx = paletteCanvas.getContext('2d');\r\n            paletteCanvas.width = 256;\r\n            paletteCanvas.height = 1;\r\n            var gradient = paletteCtx.createLinearGradient(0, 0, 256, 1);\r\n            for (var key in gradientConfig) {\r\n                gradient.addColorStop(key, gradientConfig[key]);\r\n            }\r\n            paletteCtx.fillStyle = gradient;\r\n            paletteCtx.fillRect(0, 0, 256, 1);\r\n            return paletteCtx.getImageData(0, 0, 256, 1).data;\r\n        };\r\n        var _getPointTemplate = function (radius, blurFactor) {\r\n            var tplCanvas = document.createElement('canvas');\r\n            var tplCtx = tplCanvas.getContext('2d');\r\n            var x = radius;\r\n            var y = radius;\r\n            tplCanvas.width = tplCanvas.height = radius * 2;\r\n            if (blurFactor == 1) {\r\n                tplCtx.beginPath();\r\n                tplCtx.arc(x, y, radius, 0, 2 * Math.PI, false);\r\n                tplCtx.fillStyle = 'rgba(0,0,0,1)';\r\n                tplCtx.fill();\r\n            }\r\n            else {\r\n                var gradient = tplCtx.createRadialGradient(x, y, radius * blurFactor, x, y, radius);\r\n                gradient.addColorStop(0, 'rgba(0,0,0,1)');\r\n                gradient.addColorStop(1, 'rgba(0,0,0,0)');\r\n                tplCtx.fillStyle = gradient;\r\n                tplCtx.fillRect(0, 0, 2 * radius, 2 * radius);\r\n            }\r\n            return tplCanvas;\r\n        };\r\n        var _prepareData = function (data) {\r\n            var renderData = [];\r\n            var min = data.min;\r\n            var max = data.max;\r\n            var radi = data.radi;\r\n            var data = data.data;\r\n            var xValues = Object.keys(data);\r\n            var xValuesLen = xValues.length;\r\n            while (xValuesLen--) {\r\n                var xValue = xValues[xValuesLen];\r\n                var yValues = Object.keys(data[xValue]);\r\n                var yValuesLen = yValues.length;\r\n                while (yValuesLen--) {\r\n                    var yValue = yValues[yValuesLen];\r\n                    var value = data[xValue][yValue];\r\n                    var radius = radi[xValue][yValue];\r\n                    renderData.push({\r\n                        x: xValue,\r\n                        y: yValue,\r\n                        value: value,\r\n                        radius: radius,\r\n                    });\r\n                }\r\n            }\r\n            return {\r\n                min: min,\r\n                max: max,\r\n                data: renderData,\r\n            };\r\n        };\r\n        function Canvas2dRenderer(config) {\r\n            var container = config.element;\r\n            var shadowCanvas = (this.shadowCanvas = document.createElement('canvas'));\r\n            var canvas = (this.canvas = config.canvas || document.createElement('canvas'));\r\n            var renderBoundaries = (this._renderBoundaries = [10000, 10000, 0, 0]);\r\n            var computed = getComputedStyle(config.element) || {};\r\n            canvas.className = 'heatmap-canvas';\r\n            this._width = canvas.width = shadowCanvas.width = +computed.width.replace(/px/, '');\r\n            this._height = canvas.height = shadowCanvas.height = +computed.height.replace(/px/, '');\r\n            this.shadowCtx = shadowCanvas.getContext('2d');\r\n            this.ctx = canvas.getContext('2d');\r\n            // @TODO:\r\n            // conditional wrapper\r\n            canvas.style.cssText = shadowCanvas.style.cssText = 'position:absolute;left:0;top:0;';\r\n            container.style.position = 'relative';\r\n            container.appendChild(canvas);\r\n            this._palette = _getColorPalette(config);\r\n            this._templates = {};\r\n            this._setStyles(config);\r\n        }\r\n        Canvas2dRenderer.prototype = {\r\n            renderPartial: function (data) {\r\n                this._drawAlpha(data);\r\n                this._colorize();\r\n            },\r\n            renderAll: function (data) {\r\n                // reset render boundaries\r\n                this._clear();\r\n                this._drawAlpha(_prepareData(data));\r\n                this._colorize();\r\n            },\r\n            _updateGradient: function (config) {\r\n                this._palette = _getColorPalette(config);\r\n            },\r\n            updateConfig: function (config) {\r\n                if (config['gradient']) {\r\n                    this._updateGradient(config);\r\n                }\r\n                this._setStyles(config);\r\n            },\r\n            setDimensions: function (width, height) {\r\n                this._width = width;\r\n                this._height = height;\r\n                this.canvas.width = this.shadowCanvas.width = width;\r\n                this.canvas.height = this.shadowCanvas.height = height;\r\n            },\r\n            _clear: function () {\r\n                this.shadowCtx.clearRect(0, 0, this._width, this._height);\r\n                this.ctx.clearRect(0, 0, this._width, this._height);\r\n            },\r\n            _setStyles: function (config) {\r\n                this._blur = config.blur == 0 ? 0 : config.blur || config.defaultBlur;\r\n                if (config.backgroundColor) {\r\n                    this.canvas.style.backgroundColor = config.backgroundColor;\r\n                }\r\n                this._opacity = (config.opacity || 0) * 255;\r\n                this._maxOpacity = (config.maxOpacity || config.defaultMaxOpacity) * 255;\r\n                this._minOpacity = (config.minOpacity || config.defaultMinOpacity) * 255;\r\n                this._useGradientOpacity = !!config.useGradientOpacity;\r\n            },\r\n            _drawAlpha: function (data) {\r\n                var min = (this._min = data.min);\r\n                var max = (this._max = data.max);\r\n                var data = data.data || [];\r\n                var dataLen = data.length;\r\n                // on a point basis?\r\n                var blur = 1 - this._blur;\r\n                while (dataLen--) {\r\n                    var point = data[dataLen];\r\n                    var x = point.x;\r\n                    var y = point.y;\r\n                    var radius = point.radius;\r\n                    // if value is bigger than max\r\n                    // use max as value\r\n                    var value = Math.min(point.value, max);\r\n                    var rectX = x - radius;\r\n                    var rectY = y - radius;\r\n                    var shadowCtx = this.shadowCtx;\r\n                    var tpl;\r\n                    if (!this._templates[radius]) {\r\n                        this._templates[radius] = tpl = _getPointTemplate(radius, blur);\r\n                    }\r\n                    else {\r\n                        tpl = this._templates[radius];\r\n                    }\r\n                    // value from minimum / value range\r\n                    // => [0, 1]\r\n                    shadowCtx.globalAlpha = (value - min) / (max - min);\r\n                    shadowCtx.drawImage(tpl, rectX, rectY);\r\n                    // update renderBoundaries\r\n                    if (rectX < this._renderBoundaries[0]) {\r\n                        this._renderBoundaries[0] = rectX;\r\n                    }\r\n                    if (rectY < this._renderBoundaries[1]) {\r\n                        this._renderBoundaries[1] = rectY;\r\n                    }\r\n                    if (rectX + 2 * radius > this._renderBoundaries[2]) {\r\n                        this._renderBoundaries[2] = rectX + 2 * radius;\r\n                    }\r\n                    if (rectY + 2 * radius > this._renderBoundaries[3]) {\r\n                        this._renderBoundaries[3] = rectY + 2 * radius;\r\n                    }\r\n                }\r\n            },\r\n            _colorize: function () {\r\n                var x = this._renderBoundaries[0];\r\n                var y = this._renderBoundaries[1];\r\n                var width = this._renderBoundaries[2] - x;\r\n                var height = this._renderBoundaries[3] - y;\r\n                var maxWidth = this._width;\r\n                var maxHeight = this._height;\r\n                var opacity = this._opacity;\r\n                var maxOpacity = this._maxOpacity;\r\n                var minOpacity = this._minOpacity;\r\n                var useGradientOpacity = this._useGradientOpacity;\r\n                if (x < 0) {\r\n                    x = 0;\r\n                }\r\n                if (y < 0) {\r\n                    y = 0;\r\n                }\r\n                if (x + width > maxWidth) {\r\n                    width = maxWidth - x;\r\n                }\r\n                if (y + height > maxHeight) {\r\n                    height = maxHeight - y;\r\n                }\r\n                var img = this.shadowCtx.getImageData(x, y, width, height);\r\n                var imgData = img.data;\r\n                var len = imgData.length;\r\n                var palette = this._palette;\r\n                for (var i = 3; i < len; i += 4) {\r\n                    var alpha = imgData[i];\r\n                    var offset = alpha * 4;\r\n                    if (!offset) {\r\n                        continue;\r\n                    }\r\n                    var finalAlpha;\r\n                    if (opacity > 0) {\r\n                        finalAlpha = opacity;\r\n                    }\r\n                    else {\r\n                        if (alpha < maxOpacity) {\r\n                            if (alpha < minOpacity) {\r\n                                finalAlpha = minOpacity;\r\n                            }\r\n                            else {\r\n                                finalAlpha = alpha;\r\n                            }\r\n                        }\r\n                        else {\r\n                            finalAlpha = maxOpacity;\r\n                        }\r\n                    }\r\n                    imgData[i - 3] = palette[offset];\r\n                    imgData[i - 2] = palette[offset + 1];\r\n                    imgData[i - 1] = palette[offset + 2];\r\n                    imgData[i] = useGradientOpacity ? palette[offset + 3] : finalAlpha;\r\n                }\r\n                img.data = imgData;\r\n                this.ctx.putImageData(img, x, y);\r\n                this._renderBoundaries = [1000, 1000, 0, 0];\r\n            },\r\n            getValueAt: function (point) {\r\n                var value;\r\n                var shadowCtx = this.shadowCtx;\r\n                var img = shadowCtx.getImageData(point.x, point.y, 1, 1);\r\n                var data = img.data[3];\r\n                var max = this._max;\r\n                var min = this._min;\r\n                value = (Math.abs(max - min) * (data / 255)) >> 0;\r\n                return value;\r\n            },\r\n            getDataURL: function () {\r\n                return this.canvas.toDataURL();\r\n            },\r\n        };\r\n        return Canvas2dRenderer;\r\n    })();\r\n    var Renderer = (function RendererClosure() {\r\n        var rendererFn = false;\r\n        if (HeatmapConfig['defaultRenderer'] === 'canvas2d') {\r\n            rendererFn = Canvas2dRenderer;\r\n        }\r\n        return rendererFn;\r\n    })();\r\n    var Util = {\r\n        merge: function () {\r\n            var merged = {};\r\n            var argsLen = arguments.length;\r\n            for (var i = 0; i < argsLen; i++) {\r\n                var obj = arguments[i];\r\n                for (var key in obj) {\r\n                    merged[key] = obj[key];\r\n                }\r\n            }\r\n            return merged;\r\n        },\r\n    };\r\n    // Heatmap Constructor\r\n    var Heatmap = (function HeatmapClosure() {\r\n        var Coordinator = (function CoordinatorClosure() {\r\n            function Coordinator() {\r\n                this.cStore = {};\r\n            }\r\n            Coordinator.prototype = {\r\n                on: function (evtName, callback, scope) {\r\n                    var cStore = this.cStore;\r\n                    if (!cStore[evtName]) {\r\n                        cStore[evtName] = [];\r\n                    }\r\n                    cStore[evtName].push(function (data) {\r\n                        return callback.call(scope, data);\r\n                    });\r\n                },\r\n                emit: function (evtName, data) {\r\n                    var cStore = this.cStore;\r\n                    if (cStore[evtName]) {\r\n                        var len = cStore[evtName].length;\r\n                        for (var i = 0; i < len; i++) {\r\n                            var callback = cStore[evtName][i];\r\n                            callback(data);\r\n                        }\r\n                    }\r\n                },\r\n            };\r\n            return Coordinator;\r\n        })();\r\n        var _connect = function (scope) {\r\n            var renderer = scope._renderer;\r\n            var coordinator = scope._coordinator;\r\n            var store = scope._store;\r\n            coordinator.on('renderpartial', renderer.renderPartial, renderer);\r\n            coordinator.on('renderall', renderer.renderAll, renderer);\r\n            coordinator.on('extremachange', function (data) {\r\n                scope._config.onExtremaChange &&\r\n                    scope._config.onExtremaChange({\r\n                        min: data.min,\r\n                        max: data.max,\r\n                        gradient: scope._config['gradient'] || scope._config['defaultGradient'],\r\n                    });\r\n            });\r\n            store.setCoordinator(coordinator);\r\n        };\r\n        function Heatmap() {\r\n            var config = (this._config = Util.merge(HeatmapConfig, arguments[0] || {}));\r\n            this._coordinator = new Coordinator();\r\n            if (config['plugin']) {\r\n                var pluginToLoad = config['plugin'];\r\n                if (!HeatmapConfig.plugins[pluginToLoad]) {\r\n                    throw new Error(\"Plugin '\" + pluginToLoad + \"' not found. Maybe it was not registered.\");\r\n                }\r\n                else {\r\n                    var plugin = HeatmapConfig.plugins[pluginToLoad];\r\n                    // set plugin renderer and store\r\n                    this._renderer = new plugin.renderer(config);\r\n                    this._store = new plugin.store(config);\r\n                }\r\n            }\r\n            else {\r\n                this._renderer = new Renderer(config);\r\n                this._store = new Store(config);\r\n            }\r\n            _connect(this);\r\n        }\r\n        // @TODO:\r\n        // add API documentation\r\n        Heatmap.prototype = {\r\n            addData: function () {\r\n                this._store.addData.apply(this._store, arguments);\r\n                return this;\r\n            },\r\n            removeData: function () {\r\n                this._store.removeData && this._store.removeData.apply(this._store, arguments);\r\n                return this;\r\n            },\r\n            setData: function () {\r\n                this._store.setData.apply(this._store, arguments);\r\n                return this;\r\n            },\r\n            setDataMax: function () {\r\n                this._store.setDataMax.apply(this._store, arguments);\r\n                return this;\r\n            },\r\n            setDataMin: function () {\r\n                this._store.setDataMin.apply(this._store, arguments);\r\n                return this;\r\n            },\r\n            configure: function (config) {\r\n                this._config = Util.merge(this._config, config);\r\n                this._renderer.updateConfig(this._config);\r\n                this._coordinator.emit('renderall', this._store._getInternalData());\r\n                return this;\r\n            },\r\n            repaint: function () {\r\n                this._coordinator.emit('renderall', this._store._getInternalData());\r\n                return this;\r\n            },\r\n            getData: function () {\r\n                return this._store.getData();\r\n            },\r\n            getDataURL: function () {\r\n                return this._renderer.getDataURL();\r\n            },\r\n            getValueAt: function (point) {\r\n                if (this._store.getValueAt) {\r\n                    return this._store.getValueAt(point);\r\n                }\r\n                else if (this._renderer.getValueAt) {\r\n                    return this._renderer.getValueAt(point);\r\n                }\r\n                else {\r\n                    return null;\r\n                }\r\n            },\r\n        };\r\n        return Heatmap;\r\n    })();\r\n    // core\r\n    var heatmapFactory = {\r\n        create: function (config) {\r\n            return new Heatmap(config);\r\n        },\r\n        register: function (pluginKey, plugin) {\r\n            HeatmapConfig.plugins[pluginKey] = plugin;\r\n        },\r\n    };\r\n    return heatmapFactory;\r\n});\r\n/*==============================以上部分为heatmap.js的核心代码,只负责热力图的展现====================================*/\r\n/*==============================以下部分为专为百度地图打造的覆盖物===================================================*/\r\n/**\r\n * @fileoverview 百度地图的热力图功能,对外开放。\r\n * 主要基于http://www.patrick-wied.at/static/heatmapjs/index.html 修改而得\r\n\r\n * 主入口类是<a href=\"symbols/BMapLib.Heatmap.html\">Heatmap</a>，\r\n * 基于Baidu Map API 2.0。\r\n *\r\n * @author Baidu Map Api Group\r\n * @version 1.0\r\n */\r\n/**\r\n * @namespace BMap的所有library类均放在BMapLib命名空间下\r\n */\r\nvar BMapLib = (window.BMapLib = BMapLib || {});\r\n(function () {\r\n    /**\r\n     * @exports HeatmapOverlay as BMapLib.HeatmapOverlay\r\n     */\r\n    var HeatmapOverlay = \r\n    /**\r\n     * 热力图的覆盖物\r\n     * @class 热力图的覆盖物\r\n     * 实例化该类后，使用map.addOverlay即可以添加热力图\r\n     *\r\n     * @constructor\r\n     * @param {Json Object} opts 可选的输入参数，非必填项。可输入选项包括：<br />\r\n     * {\"<b>radius</b>\" : {String} 热力图的半径,\r\n     * <br />\"<b>visible</b>\" : {Number} 热力图是否显示,\r\n     * <br />\"<b>gradient</b>\" : {JSON} 热力图的渐变区间,\r\n     * <br />\"<b>opacity</b>\" : {Number} 热力的透明度,\r\n     *\r\n     * @example <b>参考示例：</b><br />\r\n     * var map = new BMap.Map(\"container\");<br />map.centerAndZoom(new BMap.Point(116.404, 39.915), 15);<br />var heatmapOverlay = new BMapLib.HeatmapOverlay({\"radius\":10, \"visible\":true, \"opacity\":70});<br />heatmapOverlay.setDataSet(data);//data是热力图的详细数据\r\n     */\r\n    (BMapLib.HeatmapOverlay = function (opts) {\r\n        this.conf = opts;\r\n        this.conf.visible = opts.visible === undefined ? true : opts.visible;\r\n        this.heatmap = null;\r\n        this.latlngs = [];\r\n        this.bounds = null;\r\n    });\r\n    HeatmapOverlay.prototype = new BMap.Overlay();\r\n    HeatmapOverlay.prototype.initialize = function (map) {\r\n        this._map = map;\r\n        var el = document.createElement('div');\r\n        el.style.position = 'absolute';\r\n        el.style.top = 0;\r\n        el.style.left = 0;\r\n        el.style.border = 0;\r\n        el.style.width = this._map.getSize().width + 'px';\r\n        el.style.height = this._map.getSize().height + 'px';\r\n        this.conf.element = el;\r\n        if (!isSupportCanvas()) {\r\n            // 判断是否支持Canvas.\r\n            return el;\r\n        }\r\n        map.getPanes().mapPane.appendChild(el);\r\n        this.conf.valueField = this.conf.valueField || 'count';\r\n        if (typeof module !== 'undefined' && module.exports) {\r\n            this.heatmap = module.exports.create(this.conf);\r\n        }\r\n        else {\r\n            this.heatmap = h337.create(this.conf);\r\n        }\r\n        var that = this;\r\n        map.addEventListener('resize', function (e) {\r\n            var size = e.size;\r\n            el.style.width = size.width + 'px';\r\n            el.style.height = size.height + 'px';\r\n            that.heatmap._renderer.setDimensions(size.width, size.height);\r\n            that.draw();\r\n        });\r\n        this._div = el;\r\n        return el;\r\n    };\r\n    HeatmapOverlay.prototype.draw = function () {\r\n        if (!isSupportCanvas()) {\r\n            //判断是否支持Canvas.\r\n            return;\r\n        }\r\n        var currentBounds = this._map.getBounds();\r\n        if (currentBounds.equals(this.bounds)) {\r\n            return;\r\n        }\r\n        this.bounds = currentBounds;\r\n        var ne = this._map.pointToOverlayPixel(currentBounds.getNorthEast()), sw = this._map.pointToOverlayPixel(currentBounds.getSouthWest()), topY = ne.y, leftX = sw.x, h = sw.y - ne.y, w = ne.x - sw.x;\r\n        this.conf.element.style.left = leftX + 'px';\r\n        this.conf.element.style.top = topY + 'px';\r\n        this.conf.element.style.width = w + 'px';\r\n        this.conf.element.style.height = h + 'px';\r\n        //this.heatmap.store.get(\"heatmap\").resize();\r\n        if (this.latlngs.length > 0) {\r\n            this.heatmap.removeData();\r\n            var len = this.latlngs.length;\r\n            d = {\r\n                max: this.heatmap._store.getData().max,\r\n                data: [],\r\n            };\r\n            while (len--) {\r\n                var latlng = this.latlngs[len].latlng;\r\n                if (!currentBounds.containsPoint(latlng)) {\r\n                    continue;\r\n                }\r\n                var divPixel = this._map.pointToOverlayPixel(latlng), leftX = this._map.pointToOverlayPixel(currentBounds.getSouthWest()).x, topY = this._map.pointToOverlayPixel(currentBounds.getNorthEast()).y, screenPixel = new BMap.Pixel(divPixel.x - leftX, divPixel.y - topY);\r\n                var roundedPoint = this.pixelTransform(screenPixel);\r\n                d.data.push({\r\n                    x: roundedPoint.x,\r\n                    y: roundedPoint.y,\r\n                    count: this.latlngs[len].c,\r\n                });\r\n            }\r\n            if (this.conf.radiusChangeByZoom) {\r\n                this.heatmap._store._cfgRadius = this.conf.radiusChangeByZoom(this._map.getZoom());\r\n            }\r\n            this.heatmap.setData(d);\r\n        }\r\n    };\r\n    //内部使用的坐标转化\r\n    HeatmapOverlay.prototype.pixelTransform = function (p) {\r\n        var w = this.heatmap.width, h = this.heatmap.height;\r\n        while (p.x < 0) {\r\n            p.x += w;\r\n        }\r\n        while (p.x > w) {\r\n            p.x -= w;\r\n        }\r\n        while (p.y < 0) {\r\n            p.y += h;\r\n        }\r\n        while (p.y > h) {\r\n            p.y -= h;\r\n        }\r\n        p.x = p.x >> 0;\r\n        p.y = p.y >> 0;\r\n        return p;\r\n    };\r\n    /**\r\n     * 设置热力图展现的详细数据, 实现之后,即可以立刻展现\r\n     * @param {Json Object } data\r\n     * {\"<b>max</b>\" : {Number} 权重的最大值,\r\n     * <br />\"<b>data</b>\" : {Array} 坐标详细数据,格式如下 <br/>\r\n     * {\"lng\":116.421969,\"lat\":39.913527,\"count\":3}, 其中<br/>\r\n     * lng lat分别为经纬度, count权重值\r\n     */\r\n    HeatmapOverlay.prototype.setDataSet = function (data) {\r\n        this.data = data;\r\n        if (!isSupportCanvas()) {\r\n            //判断是否支持Canvas.\r\n            return;\r\n        }\r\n        var currentBounds = this._map.getBounds();\r\n        var mapdata = {\r\n            max: data.max,\r\n            data: [],\r\n        };\r\n        var d = data.data, dlen = d.length;\r\n        this.latlngs = [];\r\n        this.heatmap.removeData();\r\n        if (this.conf.radiusChangeByZoom) {\r\n            this.heatmap._store._cfgRadius = this.conf.radiusChangeByZoom(this._map.getZoom());\r\n        }\r\n        while (dlen--) {\r\n            var latlng = new BMap.Point(d[dlen].lng, d[dlen].lat);\r\n            this.latlngs.push({\r\n                latlng: latlng,\r\n                c: d[dlen].count,\r\n            });\r\n            if (!currentBounds.containsPoint(latlng)) {\r\n                continue;\r\n            }\r\n            var divPixel = this._map.pointToOverlayPixel(latlng), leftX = this._map.pointToOverlayPixel(currentBounds.getSouthWest()).x, topY = this._map.pointToOverlayPixel(currentBounds.getNorthEast()).y, screenPixel = new BMap.Pixel(divPixel.x - leftX, divPixel.y - topY);\r\n            var point = this.pixelTransform(screenPixel);\r\n            mapdata.data.push({\r\n                x: point.x,\r\n                y: point.y,\r\n                count: d[dlen].count,\r\n            });\r\n        }\r\n        this.heatmap.setData(mapdata);\r\n    };\r\n    /**\r\n     * 添加热力图的详细坐标点\r\n     * @param {Number} lng 经度坐标\r\n     * @param {Number} lat 纬度坐标\r\n     * @param {Number} count 权重\r\n     */\r\n    HeatmapOverlay.prototype.addDataPoint = function (lng, lat, count) {\r\n        if (!isSupportCanvas()) {\r\n            return;\r\n        }\r\n        if (this.data && this.data.data) {\r\n            this.data.data.push({\r\n                lng: lng,\r\n                lat: lat,\r\n                count: count,\r\n            });\r\n        }\r\n        var latlng = new BMap.Point(lng, lat), point = this.pixelTransform(this._map.pointToOverlayPixel(latlng));\r\n        this.heatmap.store.addDataPoint(point.x, point.y, count);\r\n        this.latlngs.push({\r\n            latlng: latlng,\r\n            c: count,\r\n        });\r\n    };\r\n    /**\r\n     * 更改热力图的展现或者关闭\r\n     */\r\n    HeatmapOverlay.prototype.toggle = function () {\r\n        if (!isSupportCanvas()) {\r\n            //判断是否支持Canvas.\r\n            return;\r\n        }\r\n        if (this.conf.visible === true) {\r\n            this.conf.visible = false;\r\n        }\r\n        else {\r\n            this.conf.visible = true;\r\n        }\r\n        if (this.conf.visible) {\r\n            this.conf.element.style.display = 'block';\r\n        }\r\n        else {\r\n            this.conf.element.style.display = 'none';\r\n        }\r\n    };\r\n    /**\r\n     * 设置热力图展现的配置\r\n     * @param {Json Object} options 可选的输入参数，非必填项。可输入选项包括：<br />\r\n     * {\"<b>radius</b>\" : {String} 热力图的半径,\r\n     * <br />\"<b>visible</b>\" : {Number} 热力图是否显示,\r\n     * <br />\"<b>gradient</b>\" : {JSON} 热力图的渐变区间,\r\n     * <br />\"<b>opacity</b>\" : {Number} 热力的透明度,}\r\n     */\r\n    HeatmapOverlay.prototype.setOptions = function (options) {\r\n        if (!isSupportCanvas()) {\r\n            // 判断是否支持Canvas.\r\n            return;\r\n        }\r\n        for (var key in options) {\r\n            if (key == 'radius') {\r\n                this.heatmap._store._cfgRadius = options[key];\r\n            }\r\n            if (key == 'opacity') {\r\n                options[key] = options[key] / 100;\r\n            }\r\n        }\r\n        this.heatmap.configure(options);\r\n        if (this.data) {\r\n            this.setDataSet(this.data); // 重新渲染\r\n        }\r\n    };\r\n    function isSupportCanvas() {\r\n        var elem = document.createElement('canvas');\r\n        return !!(elem.getContext && elem.getContext('2d'));\r\n    }\r\n})();\r\n"],"names":["context","factory","module","exports","define","amd","this","defaultRadius","HeatmapConfig","defaultRenderer","defaultGradient","0.45","0.55","0.65","0.95","1","defaultMaxOpacity","defaultMinOpacity","defaultBlur","defaultXField","defaultYField","defaultValueField","plugins","Store","prototype","_organiseData","dataPoint","forceRender","x","_xField","y","_yField","radi","_radi","store","_data","max","_max","min","_min","value","_valueField","radius","_cfgRadius","setDataMax","_unOrganizeData","unorganizedData","data","push","_onExtremaChange","_coordinator","emit","addData","arguments","length","dataArr","dataLen","call","organisedEntry","setData","dataPoints","pointsLen","i","_getInternalData","removeData","setDataMin","setCoordinator","coordinator","getData","config","Canvas2dRenderer","renderPartial","_drawAlpha","_colorize","renderAll","_clear","renderData","xValues","Object","keys","xValuesLen","xValue","yValues","yValuesLen","yValue","_prepareData","_updateGradient","_palette","_getColorPalette","updateConfig","_setStyles","setDimensions","width","height","_width","_height","canvas","shadowCanvas","shadowCtx","clearRect","ctx","_blur","blur","backgroundColor","style","_opacity","opacity","_maxOpacity","maxOpacity","_minOpacity","minOpacity","_useGradientOpacity","useGradientOpacity","blurFactor","tplCanvas","tpl","point","Math","rectX","rectY","_templates","tplCtx","document","createElement","getContext","beginPath","arc","PI","fillStyle","fill","gradient","createRadialGradient","addColorStop","fillRect","globalAlpha","drawImage","_renderBoundaries","maxWidth","maxHeight","img","getImageData","imgData","len","palette","alpha","offset","finalAlpha","putImageData","getValueAt","abs","getDataURL","toDataURL","gradientConfig","paletteCanvas","paletteCtx","key","createLinearGradient","container","element","computed","getComputedStyle","className","replace","cssText","position","appendChild","rendererFn","Coordinator","Renderer","Util","merged","argsLen","obj","Heatmap","on","evtName","callback","scope","cStore","_store","apply","configure","_config","_renderer","repaint","pluginToLoad","Error","plugin","renderer","onExtremaChange","create","register","pluginKey","BMapLib","window","HeatmapOverlay","opts","conf","visible","undefined","heatmap","latlngs","bounds","isSupportCanvas","elem","BMap","Overlay","initialize","map","_map","el","top","left","border","getSize","getPanes","mapPane","valueField","h337","that","addEventListener","e","size","draw","_div","currentBounds","getBounds","equals","ne","pointToOverlayPixel","getNorthEast","sw","getSouthWest","topY","leftX","h","w","d","latlng","containsPoint","divPixel","screenPixel","Pixel","roundedPoint","pixelTransform","count","c","radiusChangeByZoom","getZoom","p","setDataSet","mapdata","dlen","Point","lng","lat","addDataPoint","toggle","display","setOptions","options"],"mappings":"cASA,SAAiBA,EAASC,GAEA,oBAAXC,QAA0BA,OAAOC,QACxCD,OAAOC,QAAUF,IAEM,mBAAXG,QAAyBA,OAAOC,IAC5CD,OAAOH,GAGPD,EAAY,KAAIC,IATxB,CAYWK,KAAM,WAEb,IAgCQC,EAhCJC,EAAgB,CAChBD,cAAe,GACfE,gBAAiB,WACjBC,gBAAiB,CACbC,IAAM,eACNC,IAAM,iBACNC,IAAM,eACNC,IAAM,SACNC,EAAK,gBAETC,kBAAmB,EACnBC,kBAAmB,EACnBC,YAAa,IACbC,cAAe,IACfC,cAAe,IACfC,kBAAmB,QACnBC,QAAS,IAETC,GAcIhB,EAAgBC,EAAcD,cAClCgB,EAAMC,UAAY,CAEdC,cAAe,SAAUC,EAAWC,GAChC,IAAIC,EAAIF,EAAUpB,KAAKuB,SACnBC,EAAIJ,EAAUpB,KAAKyB,SACnBC,EAAO1B,KAAK2B,MACZC,EAAQ5B,KAAK6B,MACbC,EAAM9B,KAAK+B,KACXC,EAAMhC,KAAKiC,KACXC,EAAQd,EAAUpB,KAAKmC,cAAgB,EACvCC,EAAShB,EAAUgB,QAAUpC,KAAKqC,YAAcpC,EAYpD,OAXK2B,EAAMN,KACPM,EAAMN,GAAK,GACXI,EAAKJ,GAAK,IAETM,EAAMN,GAAGE,GAKVI,EAAMN,GAAGE,IAAMU,GAJfN,EAAMN,GAAGE,GAAKU,EACdR,EAAKJ,GAAGE,GAAKY,GAKbR,EAAMN,GAAGE,GAAKM,GACTT,EAIDrB,KAAKsC,WAAWV,EAAMN,GAAGE,IAHzBxB,KAAK+B,KAAOH,EAAMN,GAAGE,IAKlB,GAGA,CACHF,EAAGA,EACHE,EAAGA,EACHU,MAAOA,EACPE,OAAQA,EACRJ,IAAKA,EACLF,IAAKA,IAIjBS,gBAAiB,WACb,IAGSjB,EAHLkB,EAAkB,GAClBC,EAAOzC,KAAK6B,MACZH,EAAO1B,KAAK2B,MAChB,IAASL,KAAKmB,EACV,IAAK,IAAIjB,KAAKiB,EAAKnB,GACfkB,EAAgBE,KAAK,CACjBpB,EAAGA,EACHE,EAAGA,EACHY,OAAQV,EAAKJ,GAAGE,GAChBU,MAAOO,EAAKnB,GAAGE,KAI3B,MAAO,CACHQ,IAAKhC,KAAKiC,KACVH,IAAK9B,KAAK+B,KACVU,KAAMD,IAGdG,iBAAkB,WACd3C,KAAK4C,aAAaC,KAAK,gBAAiB,CACpCb,IAAKhC,KAAKiC,KACVH,IAAK9B,KAAK+B,QAGlBe,QAAS,WACL,GAA0B,EAAtBC,UAAU,GAAGC,OAGb,IAFA,IAAIC,EAAUF,UAAU,GACpBG,EAAUD,EAAQD,OACfE,KACHlD,KAAK8C,QAAQK,KAAKnD,KAAMiD,EAAQC,QAGnC,CAED,IAAIE,EAAiBpD,KAAKmB,cAAc4B,UAAU,IAAI,GAClDK,GACApD,KAAK4C,aAAaC,KAAK,gBAAiB,CACpCb,IAAKhC,KAAKiC,KACVH,IAAK9B,KAAK+B,KACVU,KAAM,CAACW,KAInB,OAAOpD,MAEXqD,QAAS,SAAUZ,GACf,IAAIa,EAAab,EAAKA,KAClBc,EAAYD,EAAWN,OAE3BhD,KAAK6B,MAAQ,GACb7B,KAAK2B,MAAQ,GACb,IAAK,IAAI6B,EAAI,EAAGA,EAAID,EAAWC,IAC3BxD,KAAKmB,cAAcmC,EAAWE,IAAI,GAMtC,OAJAxD,KAAK+B,KAAOU,EAAKX,IACjB9B,KAAKiC,KAAOQ,EAAKT,KAAO,EACxBhC,KAAK2C,mBACL3C,KAAK4C,aAAaC,KAAK,YAAa7C,KAAKyD,oBAClCzD,MAEX0D,WAAY,aAGZpB,WAAY,SAAUR,GAIlB,OAHA9B,KAAK+B,KAAOD,EACZ9B,KAAK2C,mBACL3C,KAAK4C,aAAaC,KAAK,YAAa7C,KAAKyD,oBAClCzD,MAEX2D,WAAY,SAAU3B,GAIlB,OAHAhC,KAAKiC,KAAOD,EACZhC,KAAK2C,mBACL3C,KAAK4C,aAAaC,KAAK,YAAa7C,KAAKyD,oBAClCzD,MAEX4D,eAAgB,SAAUC,GACtB7D,KAAK4C,aAAeiB,GAExBJ,iBAAkB,WACd,MAAO,CACH3B,IAAK9B,KAAK+B,KACVC,IAAKhC,KAAKiC,KACVQ,KAAMzC,KAAK6B,MACXH,KAAM1B,KAAK2B,QAGnBmC,QAAS,WACL,OAAO9D,KAAKuC,oBAyCbtB,GA1LK,SAARA,EAAuB8C,GACvB/D,KAAK4C,aAAe,GACpB5C,KAAK6B,MAAQ,GACb7B,KAAK2B,MAAQ,GACb3B,KAAKiC,KAAO,EACZjC,KAAK+B,KAAO,EACZ/B,KAAKuB,QAAUwC,EAAe,QAAKA,EAAOlD,cAC1Cb,KAAKyB,QAAUsC,EAAe,QAAKA,EAAOjD,cAC1Cd,KAAKmC,YAAc4B,EAAmB,YAAKA,EAAOhD,kBAC9CgD,EAAe,SACf/D,KAAKqC,WAAa0B,EAAe,QAkL7C,IAAIC,GAsFAA,EAAiB9C,UAAY,CACzB+C,cAAe,SAAUxB,GACrBzC,KAAKkE,WAAWzB,GAChBzC,KAAKmE,aAETC,UAAW,SAAU3B,GAEjBzC,KAAKqE,SACLrE,KAAKkE,WA1DM,SAAUzB,GAQzB,IAPA,IAAI6B,EAAa,GACbtC,EAAMS,EAAKT,IACXF,EAAMW,EAAKX,IACXJ,EAAOe,EAAKf,KACZe,EAAOA,EAAKA,KACZ8B,EAAUC,OAAOC,KAAKhC,GACtBiC,EAAaH,EAAQvB,OAClB0B,KAIH,IAHA,IAAIC,EAASJ,EAAQG,GACjBE,EAAUJ,OAAOC,KAAKhC,EAAKkC,IAC3BE,EAAaD,EAAQ5B,OAClB6B,KAAc,CACjB,IAAIC,EAASF,EAAQC,GACjB3C,EAAQO,EAAKkC,GAAQG,GACrB1C,EAASV,EAAKiD,GAAQG,GAC1BR,EAAW5B,KAAK,CACZpB,EAAGqD,EACHnD,EAAGsD,EACH5C,MAAOA,EACPE,OAAQA,IAIpB,MAAO,CACHJ,IAAKA,EACLF,IAAKA,EACLW,KAAM6B,GA+BUS,CAAatC,IAC7BzC,KAAKmE,aAETa,gBAAiB,SAAUjB,GACvB/D,KAAKiF,SAAWC,EAAiBnB,IAErCoB,aAAc,SAAUpB,GAChBA,EAAiB,UACjB/D,KAAKgF,gBAAgBjB,GAEzB/D,KAAKoF,WAAWrB,IAEpBsB,cAAe,SAAUC,EAAOC,GAC5BvF,KAAKwF,OAASF,EACdtF,KAAKyF,QAAUF,EACfvF,KAAK0F,OAAOJ,MAAQtF,KAAK2F,aAAaL,MAAQA,EAC9CtF,KAAK0F,OAAOH,OAASvF,KAAK2F,aAAaJ,OAASA,GAEpDlB,OAAQ,WACJrE,KAAK4F,UAAUC,UAAU,EAAG,EAAG7F,KAAKwF,OAAQxF,KAAKyF,SACjDzF,KAAK8F,IAAID,UAAU,EAAG,EAAG7F,KAAKwF,OAAQxF,KAAKyF,UAE/CL,WAAY,SAAUrB,GAClB/D,KAAK+F,MAAuB,GAAfhC,EAAOiC,KAAY,EAAIjC,EAAOiC,MAAQjC,EAAOnD,YACtDmD,EAAOkC,kBACPjG,KAAK0F,OAAOQ,MAAMD,gBAAkBlC,EAAOkC,iBAE/CjG,KAAKmG,SAAmC,KAAvBpC,EAAOqC,SAAW,GACnCpG,KAAKqG,YAAgE,KAAjDtC,EAAOuC,YAAcvC,EAAOrD,mBAChDV,KAAKuG,YAAgE,KAAjDxC,EAAOyC,YAAczC,EAAOpD,mBAChDX,KAAKyG,sBAAwB1C,EAAO2C,oBAExCxC,WAAY,SAAUzB,GAOlB,IANA,IAhH0BL,EAAQuE,EAClCC,EA+GI5E,EAAOhC,KAAKiC,KAAOQ,EAAKT,IACxBF,EAAO9B,KAAK+B,KAAOU,EAAKX,IAExBoB,GADAT,EAAOA,EAAKA,MAAQ,IACLO,OAEfgD,EAAO,EAAIhG,KAAK+F,MACb7C,KAAW,CACd,IAUI2D,EAVAC,EAAQrE,EAAKS,GACb5B,EAAIwF,EAAMxF,EACVE,EAAIsF,EAAMtF,EACVY,EAAS0E,EAAM1E,OAGfF,EAAQ6E,KAAK/E,IAAI8E,EAAM5E,MAAOJ,GAC9BkF,EAAQ1F,EAAIc,EACZ6E,EAAQzF,EAAIY,EACZwD,EAAY5F,KAAK4F,UAEhB5F,KAAKkH,WAAW9E,GAIjByE,EAAM7G,KAAKkH,WAAW9E,GAHtBpC,KAAKkH,WAAW9E,IAnIEA,EAmIgCA,EAnIxBuE,EAmIgCX,EA/HlExE,EADAF,EADA6F,EADAP,OAAAA,EAAAA,EAAYQ,SAASC,cAAc,UACnCF,EAASP,EAAUU,WAAW,MAE9B9F,EADAF,EAAIc,EAERwE,EAAUtB,MAAQsB,EAAUrB,OAAkB,EAATnD,EACnB,GAAduE,GACAQ,EAAOI,YACPJ,EAAOK,IAAIlG,EAAGE,EAAGY,EAAQ,EAAG,EAAI2E,KAAKU,IAAI,GACzCN,EAAOO,UAAY,gBACnBP,EAAOQ,UAGHC,EAAWT,EAAOU,qBAAqBvG,EAAGE,EAAGY,EAASuE,EAAYrF,EAAGE,EAAGY,IACnE0F,aAAa,EAAG,iBACzBF,EAASE,aAAa,EAAG,iBACzBX,EAAOO,UAAYE,EACnBT,EAAOY,SAAS,EAAG,EAAG,EAAI3F,EAAQ,EAAIA,IAkHJyE,EAhH/BD,GAuHChB,EAAUoC,aAAe9F,EAAQF,IAAQF,EAAME,GAC/C4D,EAAUqC,UAAUpB,EAAKG,EAAOC,GAE5BD,EAAQhH,KAAKkI,kBAAkB,KAC/BlI,KAAKkI,kBAAkB,GAAKlB,GAE5BC,EAAQjH,KAAKkI,kBAAkB,KAC/BlI,KAAKkI,kBAAkB,GAAKjB,GAE5BD,EAAQ,EAAI5E,EAASpC,KAAKkI,kBAAkB,KAC5ClI,KAAKkI,kBAAkB,GAAKlB,EAAQ,EAAI5E,GAExC6E,EAAQ,EAAI7E,EAASpC,KAAKkI,kBAAkB,KAC5ClI,KAAKkI,kBAAkB,GAAKjB,EAAQ,EAAI7E,KAIpD+B,UAAW,WA2BP,IA1BA,IAAI7C,EAAItB,KAAKkI,kBAAkB,GAC3B1G,EAAIxB,KAAKkI,kBAAkB,GAC3B5C,EAAQtF,KAAKkI,kBAAkB,GAAK5G,EACpCiE,EAASvF,KAAKkI,kBAAkB,GAAK1G,EACrC2G,EAAWnI,KAAKwF,OAChB4C,EAAYpI,KAAKyF,QACjBW,EAAUpG,KAAKmG,SACfG,EAAatG,KAAKqG,YAClBG,EAAaxG,KAAKuG,YAClBG,EAAqB1G,KAAKyG,oBAa1B4B,EAAMrI,KAAK4F,UAAU0C,aAXrBhH,EADAA,EAAI,EACA,EAW8BA,EARlCE,EADAA,EAAI,EACA,EAQiCA,EALrC8D,EADY6C,EAAZ7G,EAAIgE,EACI6C,EAAW7G,EAKqBgE,EAFxCC,EADa6C,EAAb5G,EAAI+D,EACK6C,EAAY5G,EAE0B+D,GAC/CgD,EAAUF,EAAI5F,KACd+F,EAAMD,EAAQvF,OACdyF,EAAUzI,KAAKiF,SACVzB,EAAI,EAAGA,EAAIgF,EAAKhF,GAAK,EAAG,CAC7B,IAAIkF,EAAQH,EAAQ/E,GAChBmF,EAAiB,EAARD,EACRC,IAKDC,EADU,EAAVxC,EACaA,EAGTsC,EAAQpC,EACJoC,EAAQlC,EACKA,EAGAkC,EAIJpC,EAGrBiC,EAAQ/E,EAAI,GAAKiF,EAAQE,GACzBJ,EAAQ/E,EAAI,GAAKiF,EAAiB,EAATE,GACzBJ,EAAQ/E,EAAI,GAAKiF,EAAiB,EAATE,GACzBJ,EAAQ/E,GAAKkD,EAAqB+B,EAAiB,EAATE,GAAcC,GAE5DP,EAAI5F,KAAO8F,EACXvI,KAAK8F,IAAI+C,aAAaR,EAAK/G,EAAGE,GAC9BxB,KAAKkI,kBAAoB,CAAC,IAAM,IAAM,EAAG,IAE7CY,WAAY,SAAUhC,GAClB,IAGIrE,EAFYzC,KAAK4F,UACD0C,aAAaxB,EAAMxF,EAAGwF,EAAMtF,EAAG,EAAG,GACvCiB,KAAK,GAChBX,EAAM9B,KAAK+B,KACXC,EAAMhC,KAAKiC,KAEf,OADS8E,KAAKgC,IAAIjH,EAAME,IAAQS,EAAO,MAAS,GAGpDuG,WAAY,WACR,OAAOhJ,KAAK0F,OAAOuD,cAGpBjF,GAlPgB,SAAnBkB,EAA6BnB,GAC7B,IAAImF,EAAiBnF,EAAO6D,UAAY7D,EAAO3D,gBAC3C+I,EAAgB/B,SAASC,cAAc,UACvC+B,EAAaD,EAAc7B,WAAW,MAC1C6B,EAAc7D,MAAQ,IACtB6D,EAAc5D,OAAS,EACvB,IACS8D,EADLzB,EAAWwB,EAAWE,qBAAqB,EAAG,EAAG,IAAK,GAC1D,IAASD,KAAOH,EACZtB,EAASE,aAAauB,EAAKH,EAAeG,IAI9C,OAFAD,EAAW1B,UAAYE,EACvBwB,EAAWrB,SAAS,EAAG,EAAG,IAAK,GACxBqB,EAAWd,aAAa,EAAG,EAAG,IAAK,GAAG7F,KAqDjD,SAASuB,EAAiBD,GACtB,IAAIwF,EAAYxF,EAAOyF,QACnB7D,EAAgB3F,KAAK2F,aAAeyB,SAASC,cAAc,UAC3D3B,EAAU1F,KAAK0F,OAAS3B,EAAO2B,QAAU0B,SAASC,cAAc,UAEhEoC,GADoBzJ,KAAKkI,kBAAoB,CAAC,IAAO,IAAO,EAAG,GACpDwB,iBAAiB3F,EAAOyF,UAAY,IACnD9D,EAAOiE,UAAY,iBACnB3J,KAAKwF,OAASE,EAAOJ,MAAQK,EAAaL,OAASmE,EAASnE,MAAMsE,QAAQ,KAAM,IAChF5J,KAAKyF,QAAUC,EAAOH,OAASI,EAAaJ,QAAUkE,EAASlE,OAAOqE,QAAQ,KAAM,IACpF5J,KAAK4F,UAAYD,EAAa2B,WAAW,MACzCtH,KAAK8F,IAAMJ,EAAO4B,WAAW,MAG7B5B,EAAOQ,MAAM2D,QAAUlE,EAAaO,MAAM2D,QAAU,kCACpDN,EAAUrD,MAAM4D,SAAW,WAC3BP,EAAUQ,YAAYrE,GACtB1F,KAAKiF,SAAWC,EAAiBnB,GACjC/D,KAAKkH,WAAa,GAClBlH,KAAKoF,WAAWrB,GAiKxB,IACQiG,EAqBAC,EAtBJC,GACIF,GAAa,EAEbA,EADqC,aAArC9J,EAA+B,gBAClB8D,EAEVgG,GAEPG,EACO,WAGH,IAFA,IAAIC,EAAS,GACTC,EAAUtH,UAAUC,OACfQ,EAAI,EAAGA,EAAI6G,EAAS7G,IAAK,CAC9B,IACS6F,EADLiB,EAAMvH,UAAUS,GACpB,IAAS6F,KAAOiB,EACZF,EAAOf,GAAOiB,EAAIjB,GAG1B,OAAOe,GAIXG,GAKIN,EAAY/I,UAAY,CACpBsJ,GAAI,SAAUC,EAASC,EAAUC,GAC7B,IAAIC,EAAS5K,KAAK4K,OACbA,EAAOH,KACRG,EAAOH,GAAW,IAEtBG,EAAOH,GAAS/H,KAAK,SAAUD,GAC3B,OAAOiI,EAASvH,KAAKwH,EAAOlI,MAGpCI,KAAM,SAAU4H,EAAShI,GACrB,IAAImI,EAAS5K,KAAK4K,OAClB,GAAIA,EAAOH,GAEP,IADA,IAAIjC,EAAMoC,EAAOH,GAASzH,OACjBQ,EAAI,EAAGA,EAAIgF,EAAKhF,KAErBkH,EADeE,EAAOH,GAASjH,IACtBf,KApBzBwH,EAyBOA,EAyCXM,EAAQrJ,UAAY,CAChB4B,QAAS,WAEL,OADA9C,KAAK6K,OAAO/H,QAAQgI,MAAM9K,KAAK6K,OAAQ9H,WAChC/C,MAEX0D,WAAY,WAER,OADA1D,KAAK6K,OAAOnH,YAAc1D,KAAK6K,OAAOnH,WAAWoH,MAAM9K,KAAK6K,OAAQ9H,WAC7D/C,MAEXqD,QAAS,WAEL,OADArD,KAAK6K,OAAOxH,QAAQyH,MAAM9K,KAAK6K,OAAQ9H,WAChC/C,MAEXsC,WAAY,WAER,OADAtC,KAAK6K,OAAOvI,WAAWwI,MAAM9K,KAAK6K,OAAQ9H,WACnC/C,MAEX2D,WAAY,WAER,OADA3D,KAAK6K,OAAOlH,WAAWmH,MAAM9K,KAAK6K,OAAQ9H,WACnC/C,MAEX+K,UAAW,SAAUhH,GAIjB,OAHA/D,KAAKgL,QAAUb,EAAWnK,KAAKgL,QAASjH,GACxC/D,KAAKiL,UAAU9F,aAAanF,KAAKgL,SACjChL,KAAK4C,aAAaC,KAAK,YAAa7C,KAAK6K,OAAOpH,oBACzCzD,MAEXkL,QAAS,WAEL,OADAlL,KAAK4C,aAAaC,KAAK,YAAa7C,KAAK6K,OAAOpH,oBACzCzD,MAEX8D,QAAS,WACL,OAAO9D,KAAK6K,OAAO/G,WAEvBkF,WAAY,WACR,OAAOhJ,KAAKiL,UAAUjC,cAE1BF,WAAY,SAAUhC,GAClB,OAAI9G,KAAK6K,OAAO/B,WACL9I,KAAK6K,OAAO/B,WAAWhC,GAEzB9G,KAAKiL,UAAUnC,WACb9I,KAAKiL,UAAUnC,WAAWhC,GAG1B,OAIZyD,GAlHH,SAASN,IACLjK,KAAK4K,OAAS,GAyCtB,SAASL,IACL,IAjBqBI,EAiBjB5G,EAAU/D,KAAKgL,QAAUb,EAAWjK,EAAe6C,UAAU,IAAM,IAEvE,GADA/C,KAAK4C,aAAe,IAAIqH,EACpBlG,EAAe,OAAG,CAClB,IAAIoH,EAAepH,EAAe,OAClC,IAAK7D,EAAcc,QAAQmK,GACvB,MAAM,IAAIC,MAAM,WAAaD,EAAe,6CAG5C,IAAIE,EAASnL,EAAcc,QAAQmK,GAEnCnL,KAAKiL,UAAY,IAAII,EAAOC,SAASvH,GACrC/D,KAAK6K,OAAS,IAAIQ,EAAOzJ,MAAMmC,QAInC/D,KAAKiL,UAAY,IAAIf,EAASnG,GAC9B/D,KAAK6K,OAAS,IAAI5J,EAAM8C,GAhCxBuH,GADiBX,EAmCZ3K,MAlCYiL,UACjBpH,EAAc8G,EAAM/H,aACpBhB,EAAQ+I,EAAME,OAClBhH,EAAY2G,GAAG,gBAAiBc,EAASrH,cAAeqH,GACxDzH,EAAY2G,GAAG,YAAac,EAASlH,UAAWkH,GAChDzH,EAAY2G,GAAG,gBAAiB,SAAU/H,GACtCkI,EAAMK,QAAQO,iBACVZ,EAAMK,QAAQO,gBAAgB,CAC1BvJ,IAAKS,EAAKT,IACVF,IAAKW,EAAKX,IACV8F,SAAU+C,EAAMK,QAAkB,UAAKL,EAAMK,QAAyB,oBAGlFpJ,EAAMgC,eAAeC,GAqF7B,MARqB,CACjB2H,OAAQ,SAAUzH,GACd,OAAO,IAAIwG,EAAQxG,IAEvB0H,SAAU,SAAUC,EAAWL,GAC3BnL,EAAcc,QAAQ0K,GAAaL,MAoB/C,IAAIM,QAAWC,OAAOD,QAAUA,SAAW,IAC3C,WAII,IAAIE,EAgBHF,QAAQE,eAAiB,SAAUC,GAChC9L,KAAK+L,KAAOD,EACZ9L,KAAK+L,KAAKC,aAA2BC,IAAjBH,EAAKE,SAA+BF,EAAKE,QAC7DhM,KAAKkM,QAAU,KACflM,KAAKmM,QAAU,GACfnM,KAAKoM,OAAS,MAoNlB,SAASC,IACL,IAAIC,EAAOlF,SAASC,cAAc,UAClC,OAAUiF,EAAKhF,YAAcgF,EAAKhF,WAAW,OApNjDuE,EAAe3K,UAAY,IAAIqL,KAAKC,SACXC,WAAa,SAAUC,GAC5C1M,KAAK2M,KAAOD,EACZ,IAAIE,EAAKxF,SAASC,cAAc,OAQhC,GAPAuF,EAAG1G,MAAM4D,SAAW,WACpB8C,EAAG1G,MAAM2G,IAAM,EACfD,EAAG1G,MAAM4G,KAAO,EAChBF,EAAG1G,MAAM6G,OAAS,EAClBH,EAAG1G,MAAMZ,MAAQtF,KAAK2M,KAAKK,UAAU1H,MAAQ,KAC7CsH,EAAG1G,MAAMX,OAASvF,KAAK2M,KAAKK,UAAUzH,OAAS,KAC/CvF,KAAK+L,KAAKvC,QAAUoD,GACfP,IAED,OAAOO,EAEXF,EAAIO,WAAWC,QAAQnD,YAAY6C,GACnC5M,KAAK+L,KAAKoB,WAAanN,KAAK+L,KAAKoB,YAAc,QACzB,oBAAXvN,QAA0BA,OAAOC,QACxCG,KAAKkM,QAAUtM,OAAOC,QAAQ2L,OAAOxL,KAAK+L,MAG1C/L,KAAKkM,QAAUkB,KAAK5B,OAAOxL,KAAK+L,MAEpC,IAAIsB,EAAOrN,KASX,OARA0M,EAAIY,iBAAiB,SAAU,SAAUC,GACjCC,EAAOD,EAAEC,KACbZ,EAAG1G,MAAMZ,MAAQkI,EAAKlI,MAAQ,KAC9BsH,EAAG1G,MAAMX,OAASiI,EAAKjI,OAAS,KAChC8H,EAAKnB,QAAQjB,UAAU5F,cAAcmI,EAAKlI,MAAOkI,EAAKjI,QACtD8H,EAAKI,SAETzN,KAAK0N,KAAOd,GAGhBf,EAAe3K,UAAUuM,KAAO,WAC5B,GAAKpB,IAAL,CAIA,IAAIsB,EAAgB3N,KAAK2M,KAAKiB,YAC9B,IAAID,EAAcE,OAAO7N,KAAKoM,QAA9B,CAGApM,KAAKoM,OAASuB,EACd,IAAIG,EAAK9N,KAAK2M,KAAKoB,oBAAoBJ,EAAcK,gBAAiBC,EAAKjO,KAAK2M,KAAKoB,oBAAoBJ,EAAcO,gBAAiBC,EAAOL,EAAGtM,EAAG4M,EAAQH,EAAG3M,EAAG+M,EAAIJ,EAAGzM,EAAIsM,EAAGtM,EAAG8M,EAAIR,EAAGxM,EAAI2M,EAAG3M,EAMlM,GALAtB,KAAK+L,KAAKvC,QAAQtD,MAAM4G,KAAOsB,EAAQ,KACvCpO,KAAK+L,KAAKvC,QAAQtD,MAAM2G,IAAMsB,EAAO,KACrCnO,KAAK+L,KAAKvC,QAAQtD,MAAMZ,MAAQgJ,EAAI,KACpCtO,KAAK+L,KAAKvC,QAAQtD,MAAMX,OAAS8I,EAAI,KAEX,EAAtBrO,KAAKmM,QAAQnJ,OAAY,CACzBhD,KAAKkM,QAAQxI,aACb,IAAI8E,EAAMxI,KAAKmM,QAAQnJ,OAKvB,IAJAuL,EAAI,CACAzM,IAAK9B,KAAKkM,QAAQrB,OAAO/G,UAAUhC,IACnCW,KAAM,IAEH+F,KAAO,CACV,IAAIgG,EAASxO,KAAKmM,QAAQ3D,GAAKgG,OAC1Bb,EAAcc,cAAcD,KAG7BE,EAAW1O,KAAK2M,KAAKoB,oBAAoBS,GAASJ,EAAQpO,KAAK2M,KAAKoB,oBAAoBJ,EAAcO,gBAAgB5M,EAAG6M,EAAOnO,KAAK2M,KAAKoB,oBAAoBJ,EAAcK,gBAAgBxM,EAAGmN,EAAc,IAAIpC,KAAKqC,MAAMF,EAASpN,EAAI8M,EAAOM,EAASlN,EAAI2M,GAC7PU,EAAe7O,KAAK8O,eAAeH,GACvCJ,EAAE9L,KAAKC,KAAK,CACRpB,EAAGuN,EAAavN,EAChBE,EAAGqN,EAAarN,EAChBuN,MAAO/O,KAAKmM,QAAQ3D,GAAKwG,KAG7BhP,KAAK+L,KAAKkD,qBACVjP,KAAKkM,QAAQrB,OAAOxI,WAAarC,KAAK+L,KAAKkD,mBAAmBjP,KAAK2M,KAAKuC,YAE5ElP,KAAKkM,QAAQ7I,QAAQkL,OAI7B1C,EAAe3K,UAAU4N,eAAiB,SAAUK,GAEhD,IADA,IAAIb,EAAItO,KAAKkM,QAAQ5G,MAAO+I,EAAIrO,KAAKkM,QAAQ3G,OACtC4J,EAAE7N,EAAI,GACT6N,EAAE7N,GAAKgN,EAEX,KAAOa,EAAE7N,EAAIgN,GACTa,EAAE7N,GAAKgN,EAEX,KAAOa,EAAE3N,EAAI,GACT2N,EAAE3N,GAAK6M,EAEX,KAAOc,EAAE3N,EAAI6M,GACTc,EAAE3N,GAAK6M,EAIX,OAFAc,EAAE7N,EAAI6N,EAAE7N,GAAK,EACb6N,EAAE3N,EAAI2N,EAAE3N,GAAK,EACN2N,GAUXtD,EAAe3K,UAAUkO,WAAa,SAAU3M,GAE5C,GADAzC,KAAKyC,KAAOA,EACP4J,IAAL,CAIA,IAAIsB,EAAgB3N,KAAK2M,KAAKiB,YAC1ByB,EAAU,CACVvN,IAAKW,EAAKX,IACVW,KAAM,IAEN8L,EAAI9L,EAAKA,KAAM6M,EAAOf,EAAEvL,OAM5B,IALAhD,KAAKmM,QAAU,GACfnM,KAAKkM,QAAQxI,aACT1D,KAAK+L,KAAKkD,qBACVjP,KAAKkM,QAAQrB,OAAOxI,WAAarC,KAAK+L,KAAKkD,mBAAmBjP,KAAK2M,KAAKuC,YAErEI,KAAQ,CACX,IAQIZ,EAAkDN,EARlDI,EAAS,IAAIjC,KAAKgD,MAAMhB,EAAEe,GAAME,IAAKjB,EAAEe,GAAMG,KACjDzP,KAAKmM,QAAQzJ,KAAK,CACd8L,OAAQA,EACRQ,EAAGT,EAAEe,GAAMP,QAEVpB,EAAcc,cAAcD,KAG7BE,EAAW1O,KAAK2M,KAAKoB,oBAAoBS,GAASJ,EAAQpO,KAAK2M,KAAKoB,oBAAoBJ,EAAcO,gBAAgB5M,EAAG6M,EAAOnO,KAAK2M,KAAKoB,oBAAoBJ,EAAcK,gBAAgBxM,EAAGmN,EAAc,IAAIpC,KAAKqC,MAAMF,EAASpN,EAAI8M,EAAOM,EAASlN,EAAI2M,GAC7PrH,EAAQ9G,KAAK8O,eAAeH,GAChCU,EAAQ5M,KAAKC,KAAK,CACdpB,EAAGwF,EAAMxF,EACTE,EAAGsF,EAAMtF,EACTuN,MAAOR,EAAEe,GAAMP,SAGvB/O,KAAKkM,QAAQ7I,QAAQgM,KAQzBxD,EAAe3K,UAAUwO,aAAe,SAAUF,EAAKC,EAAKV,GACnD1C,MAGDrM,KAAKyC,MAAQzC,KAAKyC,KAAKA,MACvBzC,KAAKyC,KAAKA,KAAKC,KAAK,CAChB8M,IAAKA,EACLC,IAAKA,EACLV,MAAOA,IAGXP,EAAS,IAAIjC,KAAKgD,MAAMC,EAAKC,GAAM3I,EAAQ9G,KAAK8O,eAAe9O,KAAK2M,KAAKoB,oBAAoBS,IACjGxO,KAAKkM,QAAQtK,MAAM8N,aAAa5I,EAAMxF,EAAGwF,EAAMtF,EAAGuN,GAClD/O,KAAKmM,QAAQzJ,KAAK,CACd8L,OAAQA,EACRQ,EAAGD,MAMXlD,EAAe3K,UAAUyO,OAAS,WACzBtD,OAIqB,IAAtBrM,KAAK+L,KAAKC,QACVhM,KAAK+L,KAAKC,SAAU,EAGpBhM,KAAK+L,KAAKC,SAAU,EAEpBhM,KAAK+L,KAAKC,QACVhM,KAAK+L,KAAKvC,QAAQtD,MAAM0J,QAAU,QAGlC5P,KAAK+L,KAAKvC,QAAQtD,MAAM0J,QAAU,SAW1C/D,EAAe3K,UAAU2O,WAAa,SAAUC,GAC5C,GAAKzD,IAAL,CAIA,IAAK,IAAIhD,KAAOyG,EACD,UAAPzG,IACArJ,KAAKkM,QAAQrB,OAAOxI,WAAayN,EAAQzG,IAElC,WAAPA,IACAyG,EAAQzG,GAAOyG,EAAQzG,GAAO,KAGtCrJ,KAAKkM,QAAQnB,UAAU+E,GACnB9P,KAAKyC,MACLzC,KAAKoP,WAAWpP,KAAKyC,QA1OjC"}