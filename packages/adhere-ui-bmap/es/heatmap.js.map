{"version":3,"file":"heatmap.js","sources":["heatmap.js"],"sourcesContent":["\"use strict\";\r\n/*\r\n * heatmap.js v2.0.0 | JavaScript Heatmap Library\r\n *\r\n * Copyright 2008-2014 Patrick Wied <heatmapjs@patrick-wied.at> - All rights reserved.\r\n * Dual licensed under MIT and Beerware license\r\n *\r\n * :: 2014-10-31 21:16\r\n */\r\n(function (name, context, factory) {\r\n    // Supports UMD. AMD, CommonJS/Node.js and browser context\r\n    if (typeof module !== 'undefined' && module.exports) {\r\n        module.exports = factory();\r\n    }\r\n    else if (typeof define === 'function' && define.amd) {\r\n        define(factory);\r\n    }\r\n    else {\r\n        context[name] = factory();\r\n    }\r\n    // context[name] = factory();\r\n})('h337', this, function () {\r\n    // Heatmap Config stores default values and will be merged with instance config\r\n    var HeatmapConfig = {\r\n        defaultRadius: 40,\r\n        defaultRenderer: 'canvas2d',\r\n        defaultGradient: {\r\n            0.45: 'rgb(0,0,255)',\r\n            0.55: 'rgb(0,255,255)',\r\n            0.65: 'rgb(0,255,0)',\r\n            0.95: 'yellow',\r\n            1.0: 'rgb(255,0,0)',\r\n        },\r\n        defaultMaxOpacity: 1,\r\n        defaultMinOpacity: 0,\r\n        defaultBlur: 0.85,\r\n        defaultXField: 'x',\r\n        defaultYField: 'y',\r\n        defaultValueField: 'value',\r\n        plugins: {},\r\n    };\r\n    var Store = (function StoreClosure() {\r\n        var Store = function Store(config) {\r\n            this._coordinator = {};\r\n            this._data = [];\r\n            this._radi = [];\r\n            this._min = 0;\r\n            this._max = 1;\r\n            this._xField = config['xField'] || config.defaultXField;\r\n            this._yField = config['yField'] || config.defaultYField;\r\n            this._valueField = config['valueField'] || config.defaultValueField;\r\n            if (config['radius']) {\r\n                this._cfgRadius = config['radius'];\r\n            }\r\n        };\r\n        var defaultRadius = HeatmapConfig.defaultRadius;\r\n        Store.prototype = {\r\n            // when forceRender = false -> called from setData, omits renderall event\r\n            _organiseData: function (dataPoint, forceRender) {\r\n                var x = dataPoint[this._xField];\r\n                var y = dataPoint[this._yField];\r\n                var radi = this._radi;\r\n                var store = this._data;\r\n                var max = this._max;\r\n                var min = this._min;\r\n                var value = dataPoint[this._valueField] || 1;\r\n                var radius = dataPoint.radius || this._cfgRadius || defaultRadius;\r\n                if (!store[x]) {\r\n                    store[x] = [];\r\n                    radi[x] = [];\r\n                }\r\n                if (!store[x][y]) {\r\n                    store[x][y] = value;\r\n                    radi[x][y] = radius;\r\n                }\r\n                else {\r\n                    store[x][y] += value;\r\n                }\r\n                if (store[x][y] > max) {\r\n                    if (!forceRender) {\r\n                        this._max = store[x][y];\r\n                    }\r\n                    else {\r\n                        this.setDataMax(store[x][y]);\r\n                    }\r\n                    return false;\r\n                }\r\n                else {\r\n                    return {\r\n                        x: x,\r\n                        y: y,\r\n                        value: value,\r\n                        radius: radius,\r\n                        min: min,\r\n                        max: max,\r\n                    };\r\n                }\r\n            },\r\n            _unOrganizeData: function () {\r\n                var unorganizedData = [];\r\n                var data = this._data;\r\n                var radi = this._radi;\r\n                for (var x in data) {\r\n                    for (var y in data[x]) {\r\n                        unorganizedData.push({\r\n                            x: x,\r\n                            y: y,\r\n                            radius: radi[x][y],\r\n                            value: data[x][y],\r\n                        });\r\n                    }\r\n                }\r\n                return {\r\n                    min: this._min,\r\n                    max: this._max,\r\n                    data: unorganizedData,\r\n                };\r\n            },\r\n            _onExtremaChange: function () {\r\n                this._coordinator.emit('extremachange', {\r\n                    min: this._min,\r\n                    max: this._max,\r\n                });\r\n            },\r\n            addData: function () {\r\n                if (arguments[0].length > 0) {\r\n                    var dataArr = arguments[0];\r\n                    var dataLen = dataArr.length;\r\n                    while (dataLen--) {\r\n                        this.addData.call(this, dataArr[dataLen]);\r\n                    }\r\n                }\r\n                else {\r\n                    // add to store\r\n                    var organisedEntry = this._organiseData(arguments[0], true);\r\n                    if (organisedEntry) {\r\n                        this._coordinator.emit('renderpartial', {\r\n                            min: this._min,\r\n                            max: this._max,\r\n                            data: [organisedEntry],\r\n                        });\r\n                    }\r\n                }\r\n                return this;\r\n            },\r\n            setData: function (data) {\r\n                var dataPoints = data.data;\r\n                var pointsLen = dataPoints.length;\r\n                // reset data arrays\r\n                this._data = [];\r\n                this._radi = [];\r\n                for (var i = 0; i < pointsLen; i++) {\r\n                    this._organiseData(dataPoints[i], false);\r\n                }\r\n                this._max = data.max;\r\n                this._min = data.min || 0;\r\n                this._onExtremaChange();\r\n                this._coordinator.emit('renderall', this._getInternalData());\r\n                return this;\r\n            },\r\n            removeData: function () {\r\n                // TODO: implement\r\n            },\r\n            setDataMax: function (max) {\r\n                this._max = max;\r\n                this._onExtremaChange();\r\n                this._coordinator.emit('renderall', this._getInternalData());\r\n                return this;\r\n            },\r\n            setDataMin: function (min) {\r\n                this._min = min;\r\n                this._onExtremaChange();\r\n                this._coordinator.emit('renderall', this._getInternalData());\r\n                return this;\r\n            },\r\n            setCoordinator: function (coordinator) {\r\n                this._coordinator = coordinator;\r\n            },\r\n            _getInternalData: function () {\r\n                return {\r\n                    max: this._max,\r\n                    min: this._min,\r\n                    data: this._data,\r\n                    radi: this._radi,\r\n                };\r\n            },\r\n            getData: function () {\r\n                return this._unOrganizeData();\r\n            } /*,\r\n      \r\n            TODO: rethink.\r\n      \r\n          getValueAt: function(point) {\r\n            var value;\r\n            var radius = 100;\r\n            var x = point.x;\r\n            var y = point.y;\r\n            var data = this._data;\r\n      \r\n            if (data[x] && data[x][y]) {\r\n              return data[x][y];\r\n            } else {\r\n              var values = [];\r\n              // radial search for datapoints based on default radius\r\n              for(var distance = 1; distance < radius; distance++) {\r\n                var neighbors = distance * 2 +1;\r\n                var startX = x - distance;\r\n                var startY = y - distance;\r\n      \r\n                for(var i = 0; i < neighbors; i++) {\r\n                  for (var o = 0; o < neighbors; o++) {\r\n                    if ((i == 0 || i == neighbors-1) || (o == 0 || o == neighbors-1)) {\r\n                      if (data[startY+i] && data[startY+i][startX+o]) {\r\n                        values.push(data[startY+i][startX+o]);\r\n                      }\r\n                    } else {\r\n                      continue;\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n              if (values.length > 0) {\r\n                return Math.max.apply(Math, values);\r\n              }\r\n            }\r\n            return false;\r\n          }*/,\r\n        };\r\n        return Store;\r\n    })();\r\n    var Canvas2dRenderer = (function Canvas2dRendererClosure() {\r\n        var _getColorPalette = function (config) {\r\n            var gradientConfig = config.gradient || config.defaultGradient;\r\n            var paletteCanvas = document.createElement('canvas');\r\n            var paletteCtx = paletteCanvas.getContext('2d');\r\n            paletteCanvas.width = 256;\r\n            paletteCanvas.height = 1;\r\n            var gradient = paletteCtx.createLinearGradient(0, 0, 256, 1);\r\n            for (var key in gradientConfig) {\r\n                gradient.addColorStop(key, gradientConfig[key]);\r\n            }\r\n            paletteCtx.fillStyle = gradient;\r\n            paletteCtx.fillRect(0, 0, 256, 1);\r\n            return paletteCtx.getImageData(0, 0, 256, 1).data;\r\n        };\r\n        var _getPointTemplate = function (radius, blurFactor) {\r\n            var tplCanvas = document.createElement('canvas');\r\n            var tplCtx = tplCanvas.getContext('2d');\r\n            var x = radius;\r\n            var y = radius;\r\n            tplCanvas.width = tplCanvas.height = radius * 2;\r\n            if (blurFactor == 1) {\r\n                tplCtx.beginPath();\r\n                tplCtx.arc(x, y, radius, 0, 2 * Math.PI, false);\r\n                tplCtx.fillStyle = 'rgba(0,0,0,1)';\r\n                tplCtx.fill();\r\n            }\r\n            else {\r\n                var gradient = tplCtx.createRadialGradient(x, y, radius * blurFactor, x, y, radius);\r\n                gradient.addColorStop(0, 'rgba(0,0,0,1)');\r\n                gradient.addColorStop(1, 'rgba(0,0,0,0)');\r\n                tplCtx.fillStyle = gradient;\r\n                tplCtx.fillRect(0, 0, 2 * radius, 2 * radius);\r\n            }\r\n            return tplCanvas;\r\n        };\r\n        var _prepareData = function (data) {\r\n            var renderData = [];\r\n            var min = data.min;\r\n            var max = data.max;\r\n            var radi = data.radi;\r\n            var data = data.data;\r\n            var xValues = Object.keys(data);\r\n            var xValuesLen = xValues.length;\r\n            while (xValuesLen--) {\r\n                var xValue = xValues[xValuesLen];\r\n                var yValues = Object.keys(data[xValue]);\r\n                var yValuesLen = yValues.length;\r\n                while (yValuesLen--) {\r\n                    var yValue = yValues[yValuesLen];\r\n                    var value = data[xValue][yValue];\r\n                    var radius = radi[xValue][yValue];\r\n                    renderData.push({\r\n                        x: xValue,\r\n                        y: yValue,\r\n                        value: value,\r\n                        radius: radius,\r\n                    });\r\n                }\r\n            }\r\n            return {\r\n                min: min,\r\n                max: max,\r\n                data: renderData,\r\n            };\r\n        };\r\n        function Canvas2dRenderer(config) {\r\n            var container = config.element;\r\n            var shadowCanvas = (this.shadowCanvas = document.createElement('canvas'));\r\n            var canvas = (this.canvas = config.canvas || document.createElement('canvas'));\r\n            var renderBoundaries = (this._renderBoundaries = [10000, 10000, 0, 0]);\r\n            var computed = getComputedStyle(config.element) || {};\r\n            canvas.className = 'heatmap-canvas';\r\n            this._width = canvas.width = shadowCanvas.width = +computed.width.replace(/px/, '');\r\n            this._height = canvas.height = shadowCanvas.height = +computed.height.replace(/px/, '');\r\n            this.shadowCtx = shadowCanvas.getContext('2d');\r\n            this.ctx = canvas.getContext('2d');\r\n            // @TODO:\r\n            // conditional wrapper\r\n            canvas.style.cssText = shadowCanvas.style.cssText = 'position:absolute;left:0;top:0;';\r\n            container.style.position = 'relative';\r\n            container.appendChild(canvas);\r\n            this._palette = _getColorPalette(config);\r\n            this._templates = {};\r\n            this._setStyles(config);\r\n        }\r\n        Canvas2dRenderer.prototype = {\r\n            renderPartial: function (data) {\r\n                this._drawAlpha(data);\r\n                this._colorize();\r\n            },\r\n            renderAll: function (data) {\r\n                // reset render boundaries\r\n                this._clear();\r\n                this._drawAlpha(_prepareData(data));\r\n                this._colorize();\r\n            },\r\n            _updateGradient: function (config) {\r\n                this._palette = _getColorPalette(config);\r\n            },\r\n            updateConfig: function (config) {\r\n                if (config['gradient']) {\r\n                    this._updateGradient(config);\r\n                }\r\n                this._setStyles(config);\r\n            },\r\n            setDimensions: function (width, height) {\r\n                this._width = width;\r\n                this._height = height;\r\n                this.canvas.width = this.shadowCanvas.width = width;\r\n                this.canvas.height = this.shadowCanvas.height = height;\r\n            },\r\n            _clear: function () {\r\n                this.shadowCtx.clearRect(0, 0, this._width, this._height);\r\n                this.ctx.clearRect(0, 0, this._width, this._height);\r\n            },\r\n            _setStyles: function (config) {\r\n                this._blur = config.blur == 0 ? 0 : config.blur || config.defaultBlur;\r\n                if (config.backgroundColor) {\r\n                    this.canvas.style.backgroundColor = config.backgroundColor;\r\n                }\r\n                this._opacity = (config.opacity || 0) * 255;\r\n                this._maxOpacity = (config.maxOpacity || config.defaultMaxOpacity) * 255;\r\n                this._minOpacity = (config.minOpacity || config.defaultMinOpacity) * 255;\r\n                this._useGradientOpacity = !!config.useGradientOpacity;\r\n            },\r\n            _drawAlpha: function (data) {\r\n                var min = (this._min = data.min);\r\n                var max = (this._max = data.max);\r\n                var data = data.data || [];\r\n                var dataLen = data.length;\r\n                // on a point basis?\r\n                var blur = 1 - this._blur;\r\n                while (dataLen--) {\r\n                    var point = data[dataLen];\r\n                    var x = point.x;\r\n                    var y = point.y;\r\n                    var radius = point.radius;\r\n                    // if value is bigger than max\r\n                    // use max as value\r\n                    var value = Math.min(point.value, max);\r\n                    var rectX = x - radius;\r\n                    var rectY = y - radius;\r\n                    var shadowCtx = this.shadowCtx;\r\n                    var tpl;\r\n                    if (!this._templates[radius]) {\r\n                        this._templates[radius] = tpl = _getPointTemplate(radius, blur);\r\n                    }\r\n                    else {\r\n                        tpl = this._templates[radius];\r\n                    }\r\n                    // value from minimum / value range\r\n                    // => [0, 1]\r\n                    shadowCtx.globalAlpha = (value - min) / (max - min);\r\n                    shadowCtx.drawImage(tpl, rectX, rectY);\r\n                    // update renderBoundaries\r\n                    if (rectX < this._renderBoundaries[0]) {\r\n                        this._renderBoundaries[0] = rectX;\r\n                    }\r\n                    if (rectY < this._renderBoundaries[1]) {\r\n                        this._renderBoundaries[1] = rectY;\r\n                    }\r\n                    if (rectX + 2 * radius > this._renderBoundaries[2]) {\r\n                        this._renderBoundaries[2] = rectX + 2 * radius;\r\n                    }\r\n                    if (rectY + 2 * radius > this._renderBoundaries[3]) {\r\n                        this._renderBoundaries[3] = rectY + 2 * radius;\r\n                    }\r\n                }\r\n            },\r\n            _colorize: function () {\r\n                var x = this._renderBoundaries[0];\r\n                var y = this._renderBoundaries[1];\r\n                var width = this._renderBoundaries[2] - x;\r\n                var height = this._renderBoundaries[3] - y;\r\n                var maxWidth = this._width;\r\n                var maxHeight = this._height;\r\n                var opacity = this._opacity;\r\n                var maxOpacity = this._maxOpacity;\r\n                var minOpacity = this._minOpacity;\r\n                var useGradientOpacity = this._useGradientOpacity;\r\n                if (x < 0) {\r\n                    x = 0;\r\n                }\r\n                if (y < 0) {\r\n                    y = 0;\r\n                }\r\n                if (x + width > maxWidth) {\r\n                    width = maxWidth - x;\r\n                }\r\n                if (y + height > maxHeight) {\r\n                    height = maxHeight - y;\r\n                }\r\n                var img = this.shadowCtx.getImageData(x, y, width, height);\r\n                var imgData = img.data;\r\n                var len = imgData.length;\r\n                var palette = this._palette;\r\n                for (var i = 3; i < len; i += 4) {\r\n                    var alpha = imgData[i];\r\n                    var offset = alpha * 4;\r\n                    if (!offset) {\r\n                        continue;\r\n                    }\r\n                    var finalAlpha;\r\n                    if (opacity > 0) {\r\n                        finalAlpha = opacity;\r\n                    }\r\n                    else {\r\n                        if (alpha < maxOpacity) {\r\n                            if (alpha < minOpacity) {\r\n                                finalAlpha = minOpacity;\r\n                            }\r\n                            else {\r\n                                finalAlpha = alpha;\r\n                            }\r\n                        }\r\n                        else {\r\n                            finalAlpha = maxOpacity;\r\n                        }\r\n                    }\r\n                    imgData[i - 3] = palette[offset];\r\n                    imgData[i - 2] = palette[offset + 1];\r\n                    imgData[i - 1] = palette[offset + 2];\r\n                    imgData[i] = useGradientOpacity ? palette[offset + 3] : finalAlpha;\r\n                }\r\n                img.data = imgData;\r\n                this.ctx.putImageData(img, x, y);\r\n                this._renderBoundaries = [1000, 1000, 0, 0];\r\n            },\r\n            getValueAt: function (point) {\r\n                var value;\r\n                var shadowCtx = this.shadowCtx;\r\n                var img = shadowCtx.getImageData(point.x, point.y, 1, 1);\r\n                var data = img.data[3];\r\n                var max = this._max;\r\n                var min = this._min;\r\n                value = (Math.abs(max - min) * (data / 255)) >> 0;\r\n                return value;\r\n            },\r\n            getDataURL: function () {\r\n                return this.canvas.toDataURL();\r\n            },\r\n        };\r\n        return Canvas2dRenderer;\r\n    })();\r\n    var Renderer = (function RendererClosure() {\r\n        var rendererFn = false;\r\n        if (HeatmapConfig['defaultRenderer'] === 'canvas2d') {\r\n            rendererFn = Canvas2dRenderer;\r\n        }\r\n        return rendererFn;\r\n    })();\r\n    var Util = {\r\n        merge: function () {\r\n            var merged = {};\r\n            var argsLen = arguments.length;\r\n            for (var i = 0; i < argsLen; i++) {\r\n                var obj = arguments[i];\r\n                for (var key in obj) {\r\n                    merged[key] = obj[key];\r\n                }\r\n            }\r\n            return merged;\r\n        },\r\n    };\r\n    // Heatmap Constructor\r\n    var Heatmap = (function HeatmapClosure() {\r\n        var Coordinator = (function CoordinatorClosure() {\r\n            function Coordinator() {\r\n                this.cStore = {};\r\n            }\r\n            Coordinator.prototype = {\r\n                on: function (evtName, callback, scope) {\r\n                    var cStore = this.cStore;\r\n                    if (!cStore[evtName]) {\r\n                        cStore[evtName] = [];\r\n                    }\r\n                    cStore[evtName].push(function (data) {\r\n                        return callback.call(scope, data);\r\n                    });\r\n                },\r\n                emit: function (evtName, data) {\r\n                    var cStore = this.cStore;\r\n                    if (cStore[evtName]) {\r\n                        var len = cStore[evtName].length;\r\n                        for (var i = 0; i < len; i++) {\r\n                            var callback = cStore[evtName][i];\r\n                            callback(data);\r\n                        }\r\n                    }\r\n                },\r\n            };\r\n            return Coordinator;\r\n        })();\r\n        var _connect = function (scope) {\r\n            var renderer = scope._renderer;\r\n            var coordinator = scope._coordinator;\r\n            var store = scope._store;\r\n            coordinator.on('renderpartial', renderer.renderPartial, renderer);\r\n            coordinator.on('renderall', renderer.renderAll, renderer);\r\n            coordinator.on('extremachange', function (data) {\r\n                scope._config.onExtremaChange &&\r\n                    scope._config.onExtremaChange({\r\n                        min: data.min,\r\n                        max: data.max,\r\n                        gradient: scope._config['gradient'] || scope._config['defaultGradient'],\r\n                    });\r\n            });\r\n            store.setCoordinator(coordinator);\r\n        };\r\n        function Heatmap() {\r\n            var config = (this._config = Util.merge(HeatmapConfig, arguments[0] || {}));\r\n            this._coordinator = new Coordinator();\r\n            if (config['plugin']) {\r\n                var pluginToLoad = config['plugin'];\r\n                if (!HeatmapConfig.plugins[pluginToLoad]) {\r\n                    throw new Error(\"Plugin '\" + pluginToLoad + \"' not found. Maybe it was not registered.\");\r\n                }\r\n                else {\r\n                    var plugin = HeatmapConfig.plugins[pluginToLoad];\r\n                    // set plugin renderer and store\r\n                    this._renderer = new plugin.renderer(config);\r\n                    this._store = new plugin.store(config);\r\n                }\r\n            }\r\n            else {\r\n                this._renderer = new Renderer(config);\r\n                this._store = new Store(config);\r\n            }\r\n            _connect(this);\r\n        }\r\n        // @TODO:\r\n        // add API documentation\r\n        Heatmap.prototype = {\r\n            addData: function () {\r\n                this._store.addData.apply(this._store, arguments);\r\n                return this;\r\n            },\r\n            removeData: function () {\r\n                this._store.removeData && this._store.removeData.apply(this._store, arguments);\r\n                return this;\r\n            },\r\n            setData: function () {\r\n                this._store.setData.apply(this._store, arguments);\r\n                return this;\r\n            },\r\n            setDataMax: function () {\r\n                this._store.setDataMax.apply(this._store, arguments);\r\n                return this;\r\n            },\r\n            setDataMin: function () {\r\n                this._store.setDataMin.apply(this._store, arguments);\r\n                return this;\r\n            },\r\n            configure: function (config) {\r\n                this._config = Util.merge(this._config, config);\r\n                this._renderer.updateConfig(this._config);\r\n                this._coordinator.emit('renderall', this._store._getInternalData());\r\n                return this;\r\n            },\r\n            repaint: function () {\r\n                this._coordinator.emit('renderall', this._store._getInternalData());\r\n                return this;\r\n            },\r\n            getData: function () {\r\n                return this._store.getData();\r\n            },\r\n            getDataURL: function () {\r\n                return this._renderer.getDataURL();\r\n            },\r\n            getValueAt: function (point) {\r\n                if (this._store.getValueAt) {\r\n                    return this._store.getValueAt(point);\r\n                }\r\n                else if (this._renderer.getValueAt) {\r\n                    return this._renderer.getValueAt(point);\r\n                }\r\n                else {\r\n                    return null;\r\n                }\r\n            },\r\n        };\r\n        return Heatmap;\r\n    })();\r\n    // core\r\n    var heatmapFactory = {\r\n        create: function (config) {\r\n            return new Heatmap(config);\r\n        },\r\n        register: function (pluginKey, plugin) {\r\n            HeatmapConfig.plugins[pluginKey] = plugin;\r\n        },\r\n    };\r\n    return heatmapFactory;\r\n});\r\n/*==============================以上部分为heatmap.js的核心代码,只负责热力图的展现====================================*/\r\n/*==============================以下部分为专为百度地图打造的覆盖物===================================================*/\r\n/**\r\n * @fileoverview 百度地图的热力图功能,对外开放。\r\n * 主要基于http://www.patrick-wied.at/static/heatmapjs/index.html 修改而得\r\n\r\n * 主入口类是<a href=\"symbols/BMapLib.Heatmap.html\">Heatmap</a>，\r\n * 基于Baidu Map API 2.0。\r\n *\r\n * @author Baidu Map Api Group\r\n * @version 1.0\r\n */\r\n/**\r\n * @namespace BMap的所有library类均放在BMapLib命名空间下\r\n */\r\nvar BMapLib = (window.BMapLib = BMapLib || {});\r\n(function () {\r\n    /**\r\n     * @exports HeatmapOverlay as BMapLib.HeatmapOverlay\r\n     */\r\n    var HeatmapOverlay = \r\n    /**\r\n     * 热力图的覆盖物\r\n     * @class 热力图的覆盖物\r\n     * 实例化该类后，使用map.addOverlay即可以添加热力图\r\n     *\r\n     * @constructor\r\n     * @param {Json Object} opts 可选的输入参数，非必填项。可输入选项包括：<br />\r\n     * {\"<b>radius</b>\" : {String} 热力图的半径,\r\n     * <br />\"<b>visible</b>\" : {Number} 热力图是否显示,\r\n     * <br />\"<b>gradient</b>\" : {JSON} 热力图的渐变区间,\r\n     * <br />\"<b>opacity</b>\" : {Number} 热力的透明度,\r\n     *\r\n     * @example <b>参考示例：</b><br />\r\n     * var map = new BMap.Map(\"container\");<br />map.centerAndZoom(new BMap.Point(116.404, 39.915), 15);<br />var heatmapOverlay = new BMapLib.HeatmapOverlay({\"radius\":10, \"visible\":true, \"opacity\":70});<br />heatmapOverlay.setDataSet(data);//data是热力图的详细数据\r\n     */\r\n    (BMapLib.HeatmapOverlay = function (opts) {\r\n        this.conf = opts;\r\n        this.conf.visible = opts.visible === undefined ? true : opts.visible;\r\n        this.heatmap = null;\r\n        this.latlngs = [];\r\n        this.bounds = null;\r\n    });\r\n    HeatmapOverlay.prototype = new BMap.Overlay();\r\n    HeatmapOverlay.prototype.initialize = function (map) {\r\n        this._map = map;\r\n        var el = document.createElement('div');\r\n        el.style.position = 'absolute';\r\n        el.style.top = 0;\r\n        el.style.left = 0;\r\n        el.style.border = 0;\r\n        el.style.width = this._map.getSize().width + 'px';\r\n        el.style.height = this._map.getSize().height + 'px';\r\n        this.conf.element = el;\r\n        if (!isSupportCanvas()) {\r\n            // 判断是否支持Canvas.\r\n            return el;\r\n        }\r\n        map.getPanes().mapPane.appendChild(el);\r\n        this.conf.valueField = this.conf.valueField || 'count';\r\n        if (typeof module !== 'undefined' && module.exports) {\r\n            this.heatmap = module.exports.create(this.conf);\r\n        }\r\n        else {\r\n            this.heatmap = h337.create(this.conf);\r\n        }\r\n        var that = this;\r\n        map.addEventListener('resize', function (e) {\r\n            var size = e.size;\r\n            el.style.width = size.width + 'px';\r\n            el.style.height = size.height + 'px';\r\n            that.heatmap._renderer.setDimensions(size.width, size.height);\r\n            that.draw();\r\n        });\r\n        this._div = el;\r\n        return el;\r\n    };\r\n    HeatmapOverlay.prototype.draw = function () {\r\n        if (!isSupportCanvas()) {\r\n            //判断是否支持Canvas.\r\n            return;\r\n        }\r\n        var currentBounds = this._map.getBounds();\r\n        if (currentBounds.equals(this.bounds)) {\r\n            return;\r\n        }\r\n        this.bounds = currentBounds;\r\n        var ne = this._map.pointToOverlayPixel(currentBounds.getNorthEast()), sw = this._map.pointToOverlayPixel(currentBounds.getSouthWest()), topY = ne.y, leftX = sw.x, h = sw.y - ne.y, w = ne.x - sw.x;\r\n        this.conf.element.style.left = leftX + 'px';\r\n        this.conf.element.style.top = topY + 'px';\r\n        this.conf.element.style.width = w + 'px';\r\n        this.conf.element.style.height = h + 'px';\r\n        //this.heatmap.store.get(\"heatmap\").resize();\r\n        if (this.latlngs.length > 0) {\r\n            this.heatmap.removeData();\r\n            var len = this.latlngs.length;\r\n            d = {\r\n                max: this.heatmap._store.getData().max,\r\n                data: [],\r\n            };\r\n            while (len--) {\r\n                var latlng = this.latlngs[len].latlng;\r\n                if (!currentBounds.containsPoint(latlng)) {\r\n                    continue;\r\n                }\r\n                var divPixel = this._map.pointToOverlayPixel(latlng), leftX = this._map.pointToOverlayPixel(currentBounds.getSouthWest()).x, topY = this._map.pointToOverlayPixel(currentBounds.getNorthEast()).y, screenPixel = new BMap.Pixel(divPixel.x - leftX, divPixel.y - topY);\r\n                var roundedPoint = this.pixelTransform(screenPixel);\r\n                d.data.push({\r\n                    x: roundedPoint.x,\r\n                    y: roundedPoint.y,\r\n                    count: this.latlngs[len].c,\r\n                });\r\n            }\r\n            if (this.conf.radiusChangeByZoom) {\r\n                this.heatmap._store._cfgRadius = this.conf.radiusChangeByZoom(this._map.getZoom());\r\n            }\r\n            this.heatmap.setData(d);\r\n        }\r\n    };\r\n    //内部使用的坐标转化\r\n    HeatmapOverlay.prototype.pixelTransform = function (p) {\r\n        var w = this.heatmap.width, h = this.heatmap.height;\r\n        while (p.x < 0) {\r\n            p.x += w;\r\n        }\r\n        while (p.x > w) {\r\n            p.x -= w;\r\n        }\r\n        while (p.y < 0) {\r\n            p.y += h;\r\n        }\r\n        while (p.y > h) {\r\n            p.y -= h;\r\n        }\r\n        p.x = p.x >> 0;\r\n        p.y = p.y >> 0;\r\n        return p;\r\n    };\r\n    /**\r\n     * 设置热力图展现的详细数据, 实现之后,即可以立刻展现\r\n     * @param {Json Object } data\r\n     * {\"<b>max</b>\" : {Number} 权重的最大值,\r\n     * <br />\"<b>data</b>\" : {Array} 坐标详细数据,格式如下 <br/>\r\n     * {\"lng\":116.421969,\"lat\":39.913527,\"count\":3}, 其中<br/>\r\n     * lng lat分别为经纬度, count权重值\r\n     */\r\n    HeatmapOverlay.prototype.setDataSet = function (data) {\r\n        this.data = data;\r\n        if (!isSupportCanvas()) {\r\n            //判断是否支持Canvas.\r\n            return;\r\n        }\r\n        var currentBounds = this._map.getBounds();\r\n        var mapdata = {\r\n            max: data.max,\r\n            data: [],\r\n        };\r\n        var d = data.data, dlen = d.length;\r\n        this.latlngs = [];\r\n        this.heatmap.removeData();\r\n        if (this.conf.radiusChangeByZoom) {\r\n            this.heatmap._store._cfgRadius = this.conf.radiusChangeByZoom(this._map.getZoom());\r\n        }\r\n        while (dlen--) {\r\n            var latlng = new BMap.Point(d[dlen].lng, d[dlen].lat);\r\n            this.latlngs.push({\r\n                latlng: latlng,\r\n                c: d[dlen].count,\r\n            });\r\n            if (!currentBounds.containsPoint(latlng)) {\r\n                continue;\r\n            }\r\n            var divPixel = this._map.pointToOverlayPixel(latlng), leftX = this._map.pointToOverlayPixel(currentBounds.getSouthWest()).x, topY = this._map.pointToOverlayPixel(currentBounds.getNorthEast()).y, screenPixel = new BMap.Pixel(divPixel.x - leftX, divPixel.y - topY);\r\n            var point = this.pixelTransform(screenPixel);\r\n            mapdata.data.push({\r\n                x: point.x,\r\n                y: point.y,\r\n                count: d[dlen].count,\r\n            });\r\n        }\r\n        this.heatmap.setData(mapdata);\r\n    };\r\n    /**\r\n     * 添加热力图的详细坐标点\r\n     * @param {Number} lng 经度坐标\r\n     * @param {Number} lat 纬度坐标\r\n     * @param {Number} count 权重\r\n     */\r\n    HeatmapOverlay.prototype.addDataPoint = function (lng, lat, count) {\r\n        if (!isSupportCanvas()) {\r\n            return;\r\n        }\r\n        if (this.data && this.data.data) {\r\n            this.data.data.push({\r\n                lng: lng,\r\n                lat: lat,\r\n                count: count,\r\n            });\r\n        }\r\n        var latlng = new BMap.Point(lng, lat), point = this.pixelTransform(this._map.pointToOverlayPixel(latlng));\r\n        this.heatmap.store.addDataPoint(point.x, point.y, count);\r\n        this.latlngs.push({\r\n            latlng: latlng,\r\n            c: count,\r\n        });\r\n    };\r\n    /**\r\n     * 更改热力图的展现或者关闭\r\n     */\r\n    HeatmapOverlay.prototype.toggle = function () {\r\n        if (!isSupportCanvas()) {\r\n            //判断是否支持Canvas.\r\n            return;\r\n        }\r\n        if (this.conf.visible === true) {\r\n            this.conf.visible = false;\r\n        }\r\n        else {\r\n            this.conf.visible = true;\r\n        }\r\n        if (this.conf.visible) {\r\n            this.conf.element.style.display = 'block';\r\n        }\r\n        else {\r\n            this.conf.element.style.display = 'none';\r\n        }\r\n    };\r\n    /**\r\n     * 设置热力图展现的配置\r\n     * @param {Json Object} options 可选的输入参数，非必填项。可输入选项包括：<br />\r\n     * {\"<b>radius</b>\" : {String} 热力图的半径,\r\n     * <br />\"<b>visible</b>\" : {Number} 热力图是否显示,\r\n     * <br />\"<b>gradient</b>\" : {JSON} 热力图的渐变区间,\r\n     * <br />\"<b>opacity</b>\" : {Number} 热力的透明度,}\r\n     */\r\n    HeatmapOverlay.prototype.setOptions = function (options) {\r\n        if (!isSupportCanvas()) {\r\n            // 判断是否支持Canvas.\r\n            return;\r\n        }\r\n        for (var key in options) {\r\n            if (key == 'radius') {\r\n                this.heatmap._store._cfgRadius = options[key];\r\n            }\r\n            if (key == 'opacity') {\r\n                options[key] = options[key] / 100;\r\n            }\r\n        }\r\n        this.heatmap.configure(options);\r\n        if (this.data) {\r\n            this.setDataSet(this.data); // 重新渲染\r\n        }\r\n    };\r\n    function isSupportCanvas() {\r\n        var elem = document.createElement('canvas');\r\n        return !!(elem.getContext && elem.getContext('2d'));\r\n    }\r\n})();\r\n"],"names":["context","factory","module","exports","define","amd","this","defaultRadius","HeatmapConfig","defaultRenderer","defaultGradient","0.45","0.55","0.65","0.95","1","defaultMaxOpacity","defaultMinOpacity","defaultBlur","defaultXField","defaultYField","defaultValueField","plugins","Store","prototype","_organiseData","dataPoint","forceRender","x","_xField","y","_yField","radi","_radi","store","_data","max","_max","min","_min","value","_valueField","radius","_cfgRadius","setDataMax","_unOrganizeData","unorganizedData","data","push","_onExtremaChange","_coordinator","emit","addData","arguments","length","dataArr","dataLen","call","organisedEntry","setData","dataPoints","pointsLen","i","_getInternalData","removeData","setDataMin","setCoordinator","coordinator","getData","config","_getColorPalette","key","gradientConfig","gradient","paletteCtx","paletteCanvas","document","createElement","getContext","width","height","createLinearGradient","addColorStop","fillStyle","fillRect","getImageData","Canvas2dRenderer","container","element","shadowCanvas","canvas","computed","_renderBoundaries","getComputedStyle","className","_width","replace","_height","shadowCtx","ctx","style","cssText","position","appendChild","_palette","_templates","_setStyles","rendererFn","renderPartial","_drawAlpha","_colorize","renderAll","_clear","renderData","xValues","Object","keys","xValuesLen","xValue","yValues","yValuesLen","yValue","_updateGradient","updateConfig","setDimensions","clearRect","_blur","blur","backgroundColor","_opacity","opacity","_maxOpacity","maxOpacity","_minOpacity","minOpacity","_useGradientOpacity","useGradientOpacity","blurFactor","tplCanvas","tplCtx","tpl","point","Math","rectX","rectY","beginPath","arc","PI","fill","createRadialGradient","globalAlpha","drawImage","maxWidth","maxHeight","img","imgData","len","palette","alpha","offset","finalAlpha","putImageData","getValueAt","abs","getDataURL","toDataURL","Coordinator","Renderer","Util","merged","argsLen","obj","Heatmap","on","evtName","callback","scope","cStore","_store","apply","configure","_config","_renderer","repaint","pluginToLoad","Error","plugin","renderer","onExtremaChange","create","register","pluginKey","BMapLib","window","HeatmapOverlay","opts","conf","visible","undefined","heatmap","latlngs","bounds","isSupportCanvas","elem","BMap","Overlay","initialize","map","_map","that","el","top","left","border","getSize","getPanes","mapPane","valueField","h337","addEventListener","e","size","draw","_div","currentBounds","getBounds","equals","ne","pointToOverlayPixel","getNorthEast","sw","getSouthWest","topY","leftX","h","w","d","latlng","containsPoint","divPixel","screenPixel","Pixel","roundedPoint","pixelTransform","count","c","radiusChangeByZoom","getZoom","p","setDataSet","mapdata","dlen","Point","lng","lat","addDataPoint","toggle","display","setOptions","options"],"mappings":"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"}