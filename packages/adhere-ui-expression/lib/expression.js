"use strict";var __createBinding=Object.create?function(e,t,n,r){void 0===r&&(r=n);var l=Object.getOwnPropertyDescriptor(t,n);l&&("get"in l?t.__esModule:!l.writable&&!l.configurable)||(l={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,l)}:function(e,t,n,r){e[r=void 0===r?n:r]=t[n]},__setModuleDefault=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t},__importStar=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=function(e){return e&&e.__esModule?e:{default:e}},ahooks_1=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.selectorPrefix=void 0,require("ahooks")),antd_1=require("antd"),classnames_1=__importDefault(require("classnames")),react_1=__importStar(require("react")),icons_1=require("@ant-design/icons"),adhere_ui_hooks_1=__importDefault(require("@baifendian/adhere-ui-hooks")),adhere_util_1=__importDefault(require("@baifendian/adhere-util")),adhere_util_intl_1=__importDefault(require("@baifendian/adhere-util-intl")),View_1=__importDefault(require("./View")),ElasticSearch_1=__importDefault(require("./operators/ElasticSearch")),getCurrentParentElementWithCursor=adhere_util_1.default.getCurrentParentElementWithCursor,getCurrentElementWithCursor=adhere_util_1.default.getCurrentElementWithCursor,setCursorToEnd=adhere_util_1.default.setCursorToEnd,setCursorPositionToNode=adhere_util_1.default.setCursorPositionToNode,setCursorPosition=adhere_util_1.default.setCursorPosition,getCursorIndex=adhere_util_1.default.getCursorIndex,getCursorRectByDocument=adhere_util_1.default.getCursorRectByDocument,isString=adhere_util_1.default.isString,isFunction=adhere_util_1.default.isFunction,defaultTriggerCharCode=32,htmlSpace="&nbsp;",modalWidth=300,useSetState=adhere_ui_hooks_1.default.useSetState,Expression=(exports.selectorPrefix="adhere-ui-expression",function(e,t){var n=e.className,r=e.style,l=e.editorClassName,u=e.editorStyle,a=e.operatorWrapClassName,R=e.operatorWrapStyle,O=e.quickTipWrapClassName,j=e.quickTipWrapStyle,o=e.textClassName,i=e.operatorClassName,c=e.value,F=e.placeholder,d=e.triggerCharCode,I=e.quickTipProp,s=e.quickTipDataSource,f=e.disableQuickTip,p=e.operators,B=e.allowClear,m=e.onChange,v=e.onContinuousTextChange,V=e.onEditorInputEnd,A=e.onEditorBlurEnd,_=e.onEditorKeyDownEnd,Q=e.onEditorPasteEnd,e=(0,react_1.useMemo)(function(){return null!=p?p:ElasticSearch_1.default},[p]),C=(0,react_1.useRef)(null),h=(0,react_1.useRef)(null),K=(0,react_1.useRef)(null),U=(0,react_1.useRef)(null),z=(0,react_1.useRef)(null),x=(0,react_1.useRef)(null),g=(0,react_1.useRef)(null),E=(0,react_1.useRef)(-1),y=(0,react_1.useRef)(0),T=(0,react_1.useRef)(null),P=(0,react_1.useRef)(""),b=(0,react_1.useRef)(!1),S=useSetState(!1),G=S[0],J=S[1],S=useSetState(!1),X=S[0],Y=S[1],S=useSetState(!0),Z=S[0],$=S[1],S=useSetState(!1),ee=S[0],te=S[1],ne=(0,react_1.useMemo)(function(){return String.fromCharCode(null!=d?d:defaultTriggerCharCode)},[d]);function k(){(M()?w:H)()}function N(){var e,t;return"font"===(null==(t=null==(e=null==(e=null==(e=null==h?void 0:h.current)?void 0:e.firstElementChild)?void 0:e.tagName)?void 0:e.toLowerCase)?void 0:t.call(e))?null==(t=null==h?void 0:h.current)?void 0:t.firstElementChild:null==h?void 0:h.current}function M(){var e,t;return""===(null==(t=null==(e=null==(e=N())?void 0:e.innerHTML)?void 0:e.trim)?void 0:t.call(e))}function re(){var e=N();e&&(e.innerHTML="",D(),L(),w(),te(!1))}function le(e,t){var n,r,l,u,a=getCursorRectByDocument();a&&e&&(r=null==(r=C.current)?void 0:r.offsetWidth,l=null==(l=null==C?void 0:C.current)?void 0:l.offsetHeight,u=null==(u=null==(n=C.current)?void 0:n.getBoundingClientRect)?void 0:u.call(n),r)&&l&&C&&e&&u&&(0===(null==a?void 0:a.x)&&0===(null==a?void 0:a.y)?(e.style.left="".concat(u.x+20,"px"),e.style.top="".concat(u.y+l-2,"px")):((null==u?void 0:u.x)+r-(null==a?void 0:a.x)<modalWidth?e.style.left="".concat(u.x+r-modalWidth-10,"px"):e.style.left="".concat(a.x+10,"px"),e.style.top="".concat(a.y+25,"px"))),null!=t&&t()}function ue(){le(K.current,function(){return J(!0,function(){})})}function D(){J(!1)}function ae(){le(U.current,function(){return Y(!0)})}function L(){Y(!1)}function w(){$(!0)}function H(){$(!1)}function W(e){var t="",n=(isString(o)?t=o:isFunction(o)&&(t=o(e)),document.createElement("span"));return n.className=(0,classnames_1.default)("text",null!=t?t:""),n.innerHTML=e,n}function q(e){var t="",n=(isString(i)?t=i:isFunction(i)&&(t=i(e)),document.createElement("span"));return n.className=(0,classnames_1.default)("operator",null!=t?t:""),n.setAttribute("contenteditable","false"),n.innerHTML=e,n}function oe(e){var t;console.log("Input"),b.current||(g&&(g.current=getCurrentElementWithCursor()),x&&(x.current=getCurrentParentElementWithCursor()),E.current=getCursorIndex(),(M()?w:H)(),null!==(e=e.nativeEvent.data)?(t=e,!T.current||T.current===g.current&&y.current+1===E.current?(y.current=E.current,T.current=g.current,P.current+=t):(y.current=E.current,T.current=g.current,P.current=t),f||null!=v&&v(P.current)):f||null!=v&&v(null==(t=null==g?void 0:g.current)?void 0:t.textContent),f||e!==ne&&ae(),e!==ne&&null!=V&&V(e,P.current),null!=m&&m(null==(e=null==h?void 0:h.current)?void 0:e.innerHTML),te(!M()))}return(0,ahooks_1.useMount)(function(){var e=N();e&&(e.innerHTML=null!=c?c:""),setCursorToEnd(e),k()}),(0,ahooks_1.useUpdateLayoutEffect)(function(){k()},[c]),(0,react_1.useImperativeHandle)(t,function(){return{setValue:function(e){var t=N();t&&(t.innerHTML=null!=e?e:""),setCursorToEnd(t),k()},getValue:function(){var e;return null==(e=N())?void 0:e.innerHTML},isEditorEmpty:M,showOperators:ue,hideOperators:D,showQuickTip:ae,hideQuickTip:L,clear:re}}),react_1.default.createElement("div",{ref:C,className:(0,classnames_1.default)(exports.selectorPrefix,null!=n?n:""),style:null!=r?r:{}},react_1.default.createElement("div",{ref:h,className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-editor"),null!=l?l:"",((S={})["".concat(exports.selectorPrefix,"-editor--show-clear")]=!!B,S)),style:null!=u?u:{},contentEditable:"true",onInput:oe,onKeyDown:function(e){return e.keyCode===(null!=d?d:defaultTriggerCharCode)?(L(),ue(),null!=_&&_(e),!1):13===e.keyCode?(D(),e.stopPropagation(),e.preventDefault(),null!=_&&_(e),!1):(D(),void(null!=_&&_(e)))},onBlur:function(e){e.stopPropagation(),e.preventDefault(),(M()?w:H)(),null!=A&&A(e)},onCompositionStart:function(){b.current=!0},onCompositionEnd:function(e){b.current=!1,oe(e)},onPaste:function(e){e.preventDefault(),null!=Q&&Q(e)}}),!!B&&ee&&react_1.default.createElement("div",{className:"".concat(exports.selectorPrefix,"-editor-clear")},react_1.default.createElement(icons_1.CloseCircleOutlined,{rev:null,onClick:function(){var e;re(),null!=(e=N())&&e.focus()}})),react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-editor-placeholder"),((t={})["".concat(exports.selectorPrefix,"-editor-placeholder--show")]=Z,t)),ref:z},null!=F?F:adhere_util_intl_1.default.v("请输入关键词")),react_1.default.createElement("div",{ref:K,className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-operators"),null!=a?a:"",((n={})["".concat(exports.selectorPrefix,"-operators--show")]=G,n)),style:null!=R?R:{}},react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-operators-header"))},react_1.default.createElement("i",{onClick:D},react_1.default.createElement(icons_1.CloseCircleOutlined,{rev:null}))),react_1.default.createElement("ul",{className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-operators-main"))},e.map(function(e){var t=e.label,d=e.value,s=e.type;return react_1.default.createElement("li",{key:d,onClick:function(){var e,t,n,r,l,u,a,o,i,c;t=s,(e=d)&&(n=N(),"brackets"===t?(t=e[0],u=e[1],/^&#\d+;/gim.test(e)&&(t=(r=e.split(";").filter(function(e){return e}))[0],u=r[1]),r=q(t),t=q(u),u=W("".concat(htmlSpace).concat(htmlSpace)),x.current===n?(o=W(null==(o=null==(a=null==(a=null==g?void 0:g.current)?void 0:a.textContent)?void 0:a.substring)?void 0:o.call(a,0,E.current+1)),i=W(null==(i=null==a?void 0:a.substring)?void 0:i.call(a,E.current+1)),(c=document.createDocumentFragment()).appendChild(o),c.appendChild(r),c.appendChild(u),c.appendChild(t),i&&i.textContent&&0!==i.textContent.length&&c.appendChild(i),null!=(l=null==n?void 0:n.replaceChild)&&l.call(n,c,g.current)):(o=W(null==(l=null==(a=null==(l=null==g?void 0:g.current)?void 0:l.textContent)?void 0:a.substring)?void 0:l.call(a,0,E.current)),i=W(null==(l=null==a?void 0:a.substring)?void 0:l.call(a,E.current)),(c=document.createDocumentFragment()).appendChild(o),c.appendChild(o),c.appendChild(r),c.appendChild(u),c.appendChild(t),i&&i.textContent&&0!==i.textContent.length&&c.appendChild(i),null!=(t=null==(r=null==(l=null==x?void 0:x.current)?void 0:l.parentElement)?void 0:r.replaceChild)&&t.call(r,c,x.current)),setCursorPosition(u,1)):(l=q(e),u=W(htmlSpace),x.current===n?(o=W(null==(r=null==(a=null==(t=null==g?void 0:g.current)?void 0:t.textContent)?void 0:a.substring)?void 0:r.call(a,0,E.current+1)),i=W(null==(e=null==a?void 0:a.substring)?void 0:e.call(a,E.current+1)),(c=document.createDocumentFragment()).appendChild(o),c.appendChild(l),c.appendChild(u),i&&i.textContent&&0!==i.textContent.length&&c.appendChild(i),null!=n&&n.replaceChild(c,g.current),setCursorPosition(u,0)):null!=(e=null==(r=null==(t=null==x?void 0:x.current)?void 0:t.classList)?void 0:r.contains)&&e.call(r,"text")&&(o=W(null==(t=null==(a=null==(n=null==g?void 0:g.current)?void 0:n.textContent)?void 0:a.substring)?void 0:t.call(a,0,E.current)),i=W(null==(e=null==a?void 0:a.substring)?void 0:e.call(a,E.current)),(c=document.createDocumentFragment()).appendChild(o),c.appendChild(l),c.appendChild(u),i&&i.textContent&&0!==i.textContent.length&&c.appendChild(i),null!=(t=null==(n=null==(r=null==x?void 0:x.current)?void 0:r.parentElement)?void 0:n.replaceChild)&&t.call(n,c,x.current),setCursorPosition(u,0))),null!=m)&&m(null==(e=null==h?void 0:h.current)?void 0:e.innerHTML),D()},dangerouslySetInnerHTML:{__html:t}})}))),react_1.default.createElement("div",{ref:U,className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-quick-tips"),null!=O?O:"",((r={})["".concat(exports.selectorPrefix,"-quick-tips--show")]=X,r)),style:null!=j?j:{}},react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-quick-tips-header"))},react_1.default.createElement("i",{onClick:L},react_1.default.createElement(icons_1.CloseCircleOutlined,{rev:null}))),!(s||[]).length&&react_1.default.createElement("div",null,react_1.default.createElement(antd_1.Empty,null)),react_1.default.createElement("ul",{className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-quick-tips-main"))},!!(s||[]).length&&(s||[]).map(function(o,e){return react_1.default.createElement("li",{key:o.value,onClick:function(e){return t=(t=o)[null!=I?I:"value"],a=N(),t&&(u=(r=(l=(null==(l=g.current)?void 0:l.textContent)||"").lastIndexOf(P.current,y.current))+P.current.length,n=document.createDocumentFragment(),r=document.createTextNode(l.substring(0,r)),l=document.createTextNode(l.substring(u)),(u=document.createElement("div")).innerHTML=t,n.appendChild(r),Array.from(u.childNodes).forEach(function(e){n.appendChild(e)}),n.appendChild(l),C.current===x.current?(a.innerHTML="",a.appendChild(n)):a===x.current?null!=(t=null==g?void 0:g.current)&&t.parentElement&&g.current.parentElement.replaceChild(n,g.current):null!=(r=null==x?void 0:x.current)&&r.parentElement&&x.current.parentElement.replaceChild(n,x.current),setCursorPositionToNode(l,0),null!=m)&&m(null==(u=null==h?void 0:h.current)?void 0:u.innerHTML),L(),void H();var t,n,r,l,u,a}},o.label)}))))}),Wrap=(0,react_1.memo)((0,react_1.forwardRef)(Expression));Wrap.View=View_1.default,Wrap.parse=function(e,n){var t;return e?((t=document.createElement("div")).innerHTML=e,"font"===(null==(e=null==(e=null==t?void 0:t.firstElementChild)?void 0:e.tagName)?void 0:e.toLowerCase())&&(t.innerHTML=t.firstElementChild.innerHTML),Array.from(t.childNodes).map(function(e){var t;if(1===e.nodeType){if(e.classList.contains("text"))return null!=(t=null==n?void 0:n({nodeType:3,value:e.textContent}))?t:"";if(e.classList.contains("operator"))return null!=(t=null==n?void 0:n({nodeType:1,value:e.textContent}))?t:""}else if(3===e.nodeType)return null!=(t=null==n?void 0:n({nodeType:3,value:e.textContent}))?t:"";return""}).join("")):""},Wrap.validator=function(){return{validator:function(e,t){var n=document.createElement("div");return n.innerHTML=t,n.innerText?Promise.resolve():Promise.reject(new Error(adhere_util_intl_1.default.v("请输入关键字")))}}},exports.default=Wrap;
//# sourceMappingURL=expression.js.map
