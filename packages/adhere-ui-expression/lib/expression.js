"use strict";var __createBinding=Object.create?function(e,t,n,r){void 0===r&&(r=n);var l=Object.getOwnPropertyDescriptor(t,n);l&&("get"in l?t.__esModule:!l.writable&&!l.configurable)||(l={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,l)}:function(e,t,n,r){e[r=void 0===r?n:r]=t[n]},__setModuleDefault=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t},__importStar=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=function(e){return e&&e.__esModule?e:{default:e}},ahooks_1=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.selectorPrefix=void 0,require("ahooks")),antd_1=require("antd"),classnames_1=__importDefault(require("classnames")),react_1=__importStar(require("react")),icons_1=require("@ant-design/icons"),adhere_ui_hooks_1=__importDefault(require("@baifendian/adhere-ui-hooks")),adhere_util_1=__importDefault(require("@baifendian/adhere-util")),adhere_util_intl_1=__importDefault(require("@baifendian/adhere-util-intl")),View_1=__importDefault(require("./View")),getCurrentParentElementWithCursor=adhere_util_1.default.getCurrentParentElementWithCursor,getCurrentElementWithCursor=adhere_util_1.default.getCurrentElementWithCursor,setCursorToEnd=adhere_util_1.default.setCursorToEnd,setCursorPositionToNode=adhere_util_1.default.setCursorPositionToNode,setCursorPosition=adhere_util_1.default.setCursorPosition,getCursorIndex=adhere_util_1.default.getCursorIndex,defaultTriggerCharCode=32,htmlSpace="&nbsp;",useSetState=adhere_ui_hooks_1.default.useSetState,Expression=(exports.selectorPrefix="adhere-ui-expression",function(e,t){var n=e.className,r=e.style,l=e.editorClassName,u=e.editorStyle,a=e.operatorWrapClassName,o=e.operatorWrapStyle,i=e.quickTipWrapClassName,c=e.quickTipWrapStyle,d=e.textClassName,H=e.operatorClassName,s=e.value,W=e.placeholder,p=e.triggerCharCode,j=e.quickTipProp,f=e.quickTipDataSource,I=e.disableQuickTip,v=e.operators,m=e.onChange,A=e.onContinuousTextChange,V=e.onEditorInputEnd,B=e.onEditorBlurEnd,_=e.onEditorKeyDownEnd,F=e.onEditorPasteEnd,e=(0,react_1.useMemo)(function(){return null!=v?v:[{label:"()",value:"()",type:"brackets"},{label:"AND",value:"AND",type:"binary"},{label:"OR",value:"OR",type:"binary"},{label:"NOT",value:"NOT",type:"unary"}]},[v]),Q=(0,react_1.useRef)(null),C=(0,react_1.useRef)(null),h=(0,react_1.useRef)(null),K=(0,react_1.useRef)(null),U=(0,react_1.useRef)(null),g=(0,react_1.useRef)(null),E=(0,react_1.useRef)(null),x=(0,react_1.useRef)(-1),T=(0,react_1.useRef)(0),y=(0,react_1.useRef)(null),b=(0,react_1.useRef)(""),P=(0,react_1.useRef)(!1),k=useSetState(!1),z=k[0],G=k[1],k=useSetState(!1),J=k[0],X=k[1],k=useSetState(!0),Y=k[0],Z=k[1],$=(0,react_1.useMemo)(function(){return String.fromCharCode(null!=p?p:defaultTriggerCharCode)},[p]);function N(){(M()?L:O)()}function S(){var e,t;return"font"===(null==(t=null==(e=null==(e=null==(e=null==C?void 0:C.current)?void 0:e.firstElementChild)?void 0:e.tagName)?void 0:e.toLowerCase)?void 0:t.call(e))?null==(t=null==C?void 0:C.current)?void 0:t.firstElementChild:null==C?void 0:C.current}function M(){var e,t;return""===(null==(t=null==(e=null==(e=S())?void 0:e.innerHTML)?void 0:e.trim)?void 0:t.call(e))}function ee(){t=e=0,window.getSelection&&(n=window.getSelection())&&0<n.rangeCount&&(e=(n=n.getRangeAt(0).getBoundingClientRect()).left,t=n.top);var e,t,n={x:e,y:t};h.current&&(h.current.style.left="".concat(n.x+10,"px"),h.current.style.top="".concat(n.y+25,"px")),G(!0,function(){})}function w(){G(!1)}function te(){X(!0)}function D(){X(!1)}function L(){Z(!0)}function O(){Z(!1)}function R(e){var t=document.createElement("span");return t.className=(0,classnames_1.default)("text",null!=d?d:""),t.innerHTML=e,t}function q(e){var t=document.createElement("span");return t.className=(0,classnames_1.default)("operator",null!=H?H:""),t.setAttribute("contenteditable","false"),t.innerText=e,t}function ne(e){var t;P.current||(E&&(E.current=getCurrentElementWithCursor()),g&&(g.current=getCurrentParentElementWithCursor()),x.current=getCursorIndex(),(M()?L:O)(),null!==(e=e.nativeEvent.data)&&(t=e,!y.current||y.current===E.current&&T.current+1===x.current?(T.current=x.current,y.current=E.current,b.current+=t):(T.current=x.current,y.current=E.current,b.current=t),I||null!=A&&A(b.current)),I||e!==$&&te(),e!==$&&null!=V&&V(e,b.current),null!=m&&m(null==(t=null==C?void 0:C.current)?void 0:t.innerHTML))}return(0,ahooks_1.useUpdateLayoutEffect)(function(){N()},[s]),(0,ahooks_1.useMount)(function(){var e=S();e&&(e.innerHTML=null!=s?s:""),setCursorToEnd(e),N()}),(0,react_1.useImperativeHandle)(t,function(){return{setValue:function(e){var t=S();t&&(t.innerHTML=null!=e?e:""),setCursorToEnd(t),N()},getValue:function(){var e;return null==(e=S())?void 0:e.innerHTML},isEditorEmpty:M,showQuickTip:te,showOperators:ee,hideQuickTip:D,hideOperators:w}}),react_1.default.createElement("div",{ref:Q,className:(0,classnames_1.default)(exports.selectorPrefix,null!=n?n:""),style:null!=r?r:{}},react_1.default.createElement("div",{ref:C,className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-editor"),null!=l?l:""),style:null!=u?u:{},contentEditable:"true",onInput:ne,onKeyDown:function(e){return e.keyCode===(null!=p?p:defaultTriggerCharCode)?(D(),ee(),null!=_&&_(e),!1):13===e.keyCode?(w(),e.stopPropagation(),e.preventDefault(),null!=_&&_(e),!1):(w(),void(null!=_&&_(e)))},onBlur:function(e){e.stopPropagation(),e.preventDefault(),(M()?L:O)(),null!=B&&B(e)},onCompositionStart:function(){P.current=!0},onCompositionEnd:function(e){P.current=!1,ne(e)},onPaste:function(e){e.preventDefault(),null!=F&&F(e)}}),react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-editor-placeholder"),((k={})["".concat(exports.selectorPrefix,"-editor-placeholder--show")]=Y,k)),ref:U},null!=W?W:adhere_util_intl_1.default.v("请输入关键词")),react_1.default.createElement("ul",{ref:h,className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-operators"),null!=a?a:"",((t={})["".concat(exports.selectorPrefix,"-operators--show")]=z,t)),style:null!=o?o:{}},react_1.default.createElement("li",null,react_1.default.createElement("i",{onClick:w},react_1.default.createElement(icons_1.CloseCircleOutlined,{rev:null}))),e.map(function(e){var t=e.label,d=e.value,s=e.type;return react_1.default.createElement("li",{key:d,onClick:function(){var e,t,n,r,l,u,a,o,i,c;t=s,(e=d)&&(n=S(),"brackets"===t?(t=e[0],r=e[1],t=q(t),r=q(r),u=R("".concat(htmlSpace).concat(htmlSpace)),g.current===n?(o=R(null==(o=null==(a=null==(a=null==E?void 0:E.current)?void 0:a.textContent)?void 0:a.substring)?void 0:o.call(a,0,x.current+1)),i=R(null==(i=null==a?void 0:a.substring)?void 0:i.call(a,x.current+1)),(c=document.createDocumentFragment()).appendChild(o),c.appendChild(t),c.appendChild(u),c.appendChild(r),i&&i.textContent&&0!==i.textContent.length&&c.appendChild(i),null!=(l=null==n?void 0:n.replaceChild)&&l.call(n,c,E.current)):(o=R(null==(l=null==(a=null==(l=null==E?void 0:E.current)?void 0:l.textContent)?void 0:a.substring)?void 0:l.call(a,0,x.current)),i=R(null==(l=null==a?void 0:a.substring)?void 0:l.call(a,x.current)),(c=document.createDocumentFragment()).appendChild(o),c.appendChild(o),c.appendChild(t),c.appendChild(u),c.appendChild(r),i&&i.textContent&&0!==i.textContent.length&&c.appendChild(i),null!=(r=null==(t=null==(l=null==g?void 0:g.current)?void 0:l.parentElement)?void 0:t.replaceChild)&&r.call(t,c,g.current)),setCursorPosition(u,1)):(l=q(e),u=R(htmlSpace),g.current===n?(o=R(null==(t=null==(a=null==(r=null==E?void 0:E.current)?void 0:r.textContent)?void 0:a.substring)?void 0:t.call(a,0,x.current+1)),i=R(null==(e=null==a?void 0:a.substring)?void 0:e.call(a,x.current+1)),(c=document.createDocumentFragment()).appendChild(o),c.appendChild(l),c.appendChild(u),i&&i.textContent&&0!==i.textContent.length&&c.appendChild(i),null!=n&&n.replaceChild(c,E.current),setCursorPosition(u,0)):null!=(e=null==(t=null==(r=null==g?void 0:g.current)?void 0:r.classList)?void 0:t.contains)&&e.call(t,"text")&&(o=R(null==(r=null==(a=null==(n=null==E?void 0:E.current)?void 0:n.textContent)?void 0:a.substring)?void 0:r.call(a,0,x.current)),i=R(null==(e=null==a?void 0:a.substring)?void 0:e.call(a,x.current)),(c=document.createDocumentFragment()).appendChild(o),c.appendChild(l),c.appendChild(u),i&&i.textContent&&0!==i.textContent.length&&c.appendChild(i),null!=(r=null==(n=null==(t=null==g?void 0:g.current)?void 0:t.parentElement)?void 0:n.replaceChild)&&r.call(n,c,g.current),setCursorPosition(u,0))),null!=m)&&m(null==(e=null==C?void 0:C.current)?void 0:e.innerHTML),w()}},t)})),react_1.default.createElement("ul",{ref:K,className:(0,classnames_1.default)("".concat(exports.selectorPrefix,"-quick-tips"),null!=i?i:"",((n={})["".concat(exports.selectorPrefix,"-quick-tips--show")]=J,n)),style:null!=c?c:{}},react_1.default.createElement("li",null,react_1.default.createElement("i",{onClick:D},react_1.default.createElement(icons_1.CloseCircleOutlined,{rev:null}))),!(f||[]).length&&react_1.default.createElement("li",null,react_1.default.createElement(antd_1.Empty,null)),!!(f||[]).length&&(f||[]).map(function(o,e){return react_1.default.createElement("li",{key:o.value,onClick:function(e){return t=(t=o)[null!=j?j:"value"],a=S(),t&&(u=(r=(l=(null==(l=E.current)?void 0:l.textContent)||"").lastIndexOf(b.current,T.current))+b.current.length,n=document.createDocumentFragment(),r=document.createTextNode(l.substring(0,r)),l=document.createTextNode(l.substring(u)),(u=document.createElement("div")).innerHTML=t,n.appendChild(r),Array.from(u.childNodes).forEach(function(e){n.appendChild(e)}),n.appendChild(l),Q.current===g.current?(a.innerHTML="",a.appendChild(n)):a===g.current?null!=(t=null==E?void 0:E.current)&&t.parentElement&&E.current.parentElement.replaceChild(n,E.current):null!=(r=null==g?void 0:g.current)&&r.parentElement&&g.current.parentElement.replaceChild(n,g.current),setCursorPositionToNode(l,0),null!=m)&&m(null==(u=null==C?void 0:C.current)?void 0:u.innerHTML),D(),void O();var t,n,r,l,u,a}},o.label)})))}),Wrap=(0,react_1.memo)((0,react_1.forwardRef)(Expression));Wrap.View=View_1.default,Wrap.parse=function(e,n){var t;return e?((t=document.createElement("div")).innerHTML=e,"font"===(null==(e=null==(e=null==t?void 0:t.firstElementChild)?void 0:e.tagName)?void 0:e.toLowerCase())&&(t.innerHTML=t.firstElementChild.innerHTML),Array.from(t.childNodes).map(function(e){var t;if(1===e.nodeType){if(e.classList.contains("text"))return null!=(t=null==n?void 0:n({nodeType:3,value:e.textContent}))?t:"";if(e.classList.contains("operator"))return null!=(t=null==n?void 0:n({nodeType:1,value:e.textContent}))?t:""}else if(3===e.nodeType)return null!=(t=null==n?void 0:n({nodeType:3,value:e.textContent}))?t:"";return""}).join("")):""},Wrap.validator=function(){return{validator:function(e,t){var n=document.createElement("div");return n.innerHTML=t,n.innerText?Promise.resolve():Promise.reject(new Error(adhere_util_intl_1.default.v("请输入关键字")))}}},exports.default=Wrap;
//# sourceMappingURL=expression.js.map
