import _Empty from"antd/es/empty";import _CloseCircleOutlined from"@ant-design/icons/es/icons/CloseCircleOutlined";import{useMount,useUpdateLayoutEffect}from"ahooks";import classNames from"classnames";import React,{forwardRef,memo,useImperativeHandle,useMemo,useRef}from"react";import Hooks from"@baifendian/adhere-ui-hooks";import Util from"@baifendian/adhere-util";import Intl from"@baifendian/adhere-util-intl";import View from"./View";var getCurrentParentElementWithCursor=Util.getCurrentParentElementWithCursor,getCurrentElementWithCursor=Util.getCurrentElementWithCursor,setCursorToEnd=Util.setCursorToEnd,setCursorPositionToNode=Util.setCursorPositionToNode,setCursorPosition=Util.setCursorPosition,getCursorIndex=Util.getCursorIndex,defaultTriggerCharCode=32,htmlSpace="&nbsp;",useSetState=Hooks.useSetState,selectorPrefix="adhere-ui-expression",Expression=function(e,n){var t=e.className,r=e.style,l=e.editorClassName,u=e.editorStyle,o=e.operatorWrapClassName,i=e.operatorWrapStyle,a=e.quickTipWrapClassName,c=e.quickTipWrapStyle,s=e.textClassName,O=e.operatorClassName,d=e.value,U=e.placeholder,p=e.triggerCharCode,q=e.quickTipProp,m=e.quickTipDataSource,A=e.disableQuickTip,C=e.operators,v=e.onChange,V=e.onContinuousTextChange,F=e.onEditorInputEnd,_=e.onEditorBlurEnd,f=e.onEditorKeyDownEnd,B=e.onEditorPasteEnd,e=useMemo(function(){return null!=C?C:[{label:"()",value:"()",type:"brackets"},{label:"AND",value:"AND",type:"binary"},{label:"OR",value:"OR",type:"binary"},{label:"NOT",value:"NOT",type:"unary"}]},[C]),Q=useRef(null),h=useRef(null),E=useRef(null),j=useRef(null),K=useRef(null),g=useRef(null),x=useRef(null),T=useRef(-1),y=useRef(0),R=useRef(null),N=useRef(""),b=useRef(!1),P=useSetState(!1),z=P[0],G=P[1],P=useSetState(!1),J=P[0],X=P[1],P=useSetState(!0),Y=P[0],Z=P[1],$=useMemo(function(){return String.fromCharCode(null!=p?p:defaultTriggerCharCode)},[p]);function k(){(L()?H:W)()}function S(){var e,n;return"font"===(null==(n=null==(e=null==(e=null==(e=null==h?void 0:h.current)?void 0:e.firstElementChild)?void 0:e.tagName)?void 0:e.toLowerCase)?void 0:n.call(e))?null==(n=null==h?void 0:h.current)?void 0:n.firstElementChild:null==h?void 0:h.current}function L(){var e,n;return""===(null==(n=null==(e=null==(e=S())?void 0:e.innerHTML)?void 0:e.trim)?void 0:n.call(e))}function ee(){n=e=0,window.getSelection&&(t=window.getSelection())&&0<t.rangeCount&&(e=(t=t.getRangeAt(0).getBoundingClientRect()).left,n=t.top);var e,n,t={x:e,y:n};E.current&&(E.current.style.left="".concat(t.x+10,"px"),E.current.style.top="".concat(t.y+25,"px")),G(!0,function(){})}function w(){G(!1)}function ne(){X(!0)}function M(){X(!1)}function H(){Z(!0)}function W(){Z(!1)}function D(e){var n=document.createElement("span");return n.className=classNames("text",null!=s?s:""),n.innerHTML=e,n}function I(e){var n=document.createElement("span");return n.className=classNames("operator",null!=O?O:""),n.setAttribute("contenteditable","false"),n.innerText=e,n}function te(e){var n;b.current||(x&&(x.current=getCurrentElementWithCursor()),g&&(g.current=getCurrentParentElementWithCursor()),T.current=getCursorIndex(),(L()?H:W)(),null!==(e=e.nativeEvent.data)&&(n=e,!R.current||R.current===x.current&&y.current+1===T.current?(y.current=T.current,R.current=x.current,N.current+=n):(y.current=T.current,R.current=x.current,N.current=n),A||null!=V&&V(N.current)),A||e!==$&&ne(),e!==$&&null!=F&&F(e,N.current),null!=v&&v(null==(n=null==h?void 0:h.current)?void 0:n.innerHTML))}return useUpdateLayoutEffect(function(){k()},[d]),useMount(function(){var e=S();e&&(e.innerHTML=null!=d?d:""),setCursorToEnd(e),k()}),useImperativeHandle(n,function(){return{setValue:function(e){var n=S();n&&(n.innerHTML=null!=e?e:""),setCursorToEnd(n),k()},getValue:function(){var e;return null==(e=S())?void 0:e.innerHTML},isEditorEmpty:L,showQuickTip:ne,showOperators:ee,hideQuickTip:M,hideOperators:w}}),React.createElement("div",{ref:Q,className:classNames(selectorPrefix,null!=t?t:""),style:null!=r?r:{}},React.createElement("div",{ref:h,className:classNames("".concat(selectorPrefix,"-editor"),null!=l?l:""),style:null!=u?u:{},contentEditable:"true",onInput:te,onKeyDown:function(e){return e.keyCode===(null!=p?p:defaultTriggerCharCode)?(M(),ee(),null!=f&&f(e),!1):13===e.keyCode?(w(),e.stopPropagation(),e.preventDefault(),null!=f&&f(e),!1):(w(),void(null!=f&&f(e)))},onBlur:function(e){e.stopPropagation(),e.preventDefault(),(L()?H:W)(),null!=_&&_(e)},onCompositionStart:function(){b.current=!0},onCompositionEnd:function(e){b.current=!1,te(e)},onPaste:function(e){e.preventDefault(),null!=B&&B(e)}}),React.createElement("div",{className:classNames("".concat(selectorPrefix,"-editor-placeholder"),((P={})["".concat(selectorPrefix,"-editor-placeholder--show")]=Y,P)),ref:K},null!=U?U:Intl.v("请输入关键词")),React.createElement("ul",{ref:E,className:classNames("".concat(selectorPrefix,"-operators"),null!=o?o:"",((n={})["".concat(selectorPrefix,"-operators--show")]=z,n)),style:null!=i?i:{}},React.createElement("li",null,React.createElement("i",{onClick:w},React.createElement(_CloseCircleOutlined,{rev:null}))),e.map(function(e){var n=e.label,s=e.value,d=e.type;return React.createElement("li",{key:s,onClick:function(){var e,n,t,r,l,u,o,i,a,c;n=d,(e=s)&&(t=S(),"brackets"===n?(n=e[0],r=e[1],n=I(n),r=I(r),u=D("".concat(htmlSpace).concat(htmlSpace)),g.current===t?(i=D(null==(i=null==(o=null==(o=null==x?void 0:x.current)?void 0:o.textContent)?void 0:o.substring)?void 0:i.call(o,0,T.current+1)),a=D(null==(a=null==o?void 0:o.substring)?void 0:a.call(o,T.current+1)),(c=document.createDocumentFragment()).appendChild(i),c.appendChild(n),c.appendChild(u),c.appendChild(r),a&&a.textContent&&0!==a.textContent.length&&c.appendChild(a),null!=(l=null==t?void 0:t.replaceChild)&&l.call(t,c,x.current)):(i=D(null==(l=null==(o=null==(l=null==x?void 0:x.current)?void 0:l.textContent)?void 0:o.substring)?void 0:l.call(o,0,T.current)),a=D(null==(l=null==o?void 0:o.substring)?void 0:l.call(o,T.current)),(c=document.createDocumentFragment()).appendChild(i),c.appendChild(i),c.appendChild(n),c.appendChild(u),c.appendChild(r),a&&a.textContent&&0!==a.textContent.length&&c.appendChild(a),null!=(r=null==(n=null==(l=null==g?void 0:g.current)?void 0:l.parentElement)?void 0:n.replaceChild)&&r.call(n,c,g.current)),setCursorPosition(u,1)):(l=I(e),u=D(htmlSpace),g.current===t?(i=D(null==(n=null==(o=null==(r=null==x?void 0:x.current)?void 0:r.textContent)?void 0:o.substring)?void 0:n.call(o,0,T.current+1)),a=D(null==(e=null==o?void 0:o.substring)?void 0:e.call(o,T.current+1)),(c=document.createDocumentFragment()).appendChild(i),c.appendChild(l),c.appendChild(u),a&&a.textContent&&0!==a.textContent.length&&c.appendChild(a),null!=t&&t.replaceChild(c,x.current),setCursorPosition(u,0)):null!=(e=null==(n=null==(r=null==g?void 0:g.current)?void 0:r.classList)?void 0:n.contains)&&e.call(n,"text")&&(i=D(null==(r=null==(o=null==(t=null==x?void 0:x.current)?void 0:t.textContent)?void 0:o.substring)?void 0:r.call(o,0,T.current)),a=D(null==(e=null==o?void 0:o.substring)?void 0:e.call(o,T.current)),(c=document.createDocumentFragment()).appendChild(i),c.appendChild(l),c.appendChild(u),a&&a.textContent&&0!==a.textContent.length&&c.appendChild(a),null!=(r=null==(t=null==(n=null==g?void 0:g.current)?void 0:n.parentElement)?void 0:t.replaceChild)&&r.call(t,c,g.current),setCursorPosition(u,0))),null!=v)&&v(null==(e=null==h?void 0:h.current)?void 0:e.innerHTML),w()}},n)})),React.createElement("ul",{ref:j,className:classNames("".concat(selectorPrefix,"-quick-tips"),null!=a?a:"",((t={})["".concat(selectorPrefix,"-quick-tips--show")]=J,t)),style:null!=c?c:{}},React.createElement("li",null,React.createElement("i",{onClick:M},React.createElement(_CloseCircleOutlined,{rev:null}))),!(m||[]).length&&React.createElement("li",null,React.createElement(_Empty,null)),!!(m||[]).length&&(m||[]).map(function(i,e){return React.createElement("li",{key:i.value,onClick:function(e){return n=(n=i)[null!=q?q:"value"],o=S(),n&&(u=(r=(l=(null==(l=x.current)?void 0:l.textContent)||"").lastIndexOf(N.current,y.current))+N.current.length,t=document.createDocumentFragment(),r=document.createTextNode(l.substring(0,r)),l=document.createTextNode(l.substring(u)),(u=document.createElement("div")).innerHTML=n,t.appendChild(r),Array.from(u.childNodes).forEach(function(e){t.appendChild(e)}),t.appendChild(l),Q.current===g.current?(o.innerHTML="",o.appendChild(t)):o===g.current?null!=(n=null==x?void 0:x.current)&&n.parentElement&&x.current.parentElement.replaceChild(t,x.current):null!=(r=null==g?void 0:g.current)&&r.parentElement&&g.current.parentElement.replaceChild(t,g.current),setCursorPositionToNode(l,0),null!=v)&&v(null==(u=null==h?void 0:h.current)?void 0:u.innerHTML),M(),void W();var n,t,r,l,u,o}},i.label)})))},Wrap=memo(forwardRef(Expression));Wrap.View=View,Wrap.parse=function(e,t){var n;return e?((n=document.createElement("div")).innerHTML=e,"font"===(null==(e=null==(e=null==n?void 0:n.firstElementChild)?void 0:e.tagName)?void 0:e.toLowerCase())&&(n.innerHTML=n.firstElementChild.innerHTML),Array.from(n.childNodes).map(function(e){var n;if(1===e.nodeType){if(e.classList.contains("text"))return null!=(n=null==t?void 0:t({nodeType:3,value:e.textContent}))?n:"";if(e.classList.contains("operator"))return null!=(n=null==t?void 0:t({nodeType:1,value:e.textContent}))?n:""}else if(3===e.nodeType)return null!=(n=null==t?void 0:t({nodeType:3,value:e.textContent}))?n:"";return""}).join("")):""},Wrap.validator=function(){return{validator:function(e,n){var t=document.createElement("div");return t.innerHTML=n,t.innerText?Promise.resolve():Promise.reject(new Error(Intl.v("请输入关键字")))}}};export default Wrap;export{selectorPrefix};
//# sourceMappingURL=expression.js.map
