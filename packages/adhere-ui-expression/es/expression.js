import _Empty from"antd/es/empty";import _CloseCircleOutlined from"@ant-design/icons/es/icons/CloseCircleOutlined";import{useMount,useUpdateLayoutEffect}from"ahooks";import classNames from"classnames";import React,{forwardRef,memo,useImperativeHandle,useMemo,useRef}from"react";import Hooks from"@baifendian/adhere-ui-hooks";import Util from"@baifendian/adhere-util";import Intl from"@baifendian/adhere-util-intl";import View from"./View";import{ElasticSearch,Math,Sql}from"./operators";var getCurrentParentElementWithCursor=Util.getCurrentParentElementWithCursor,getCurrentElementWithCursor=Util.getCurrentElementWithCursor,setCursorToEnd=Util.setCursorToEnd,setCursorPositionToNode=Util.setCursorPositionToNode,setCursorPosition=Util.setCursorPosition,getCursorIndex=Util.getCursorIndex,getCursorRectByDocument=Util.getCursorRectByDocument,isString=Util.isString,isFunction=Util.isFunction,defaultTriggerCharCode=32,htmlSpace="&nbsp;",modalWidth=300,useSetState=Hooks.useSetState,selectorPrefix="adhere-ui-expression",InternalExpression=memo(forwardRef(function(e,t){var n=e.className,r=e.style,l=e.editorClassName,o=e.editorStyle,i=e.operatorWrapClassName,U=e.operatorWrapStyle,q=e.quickTipWrapClassName,O=e.quickTipWrapStyle,u=e.textClassName,a=e.operatorClassName,c=e.value,F=e.placeholder,s=e.triggerCharCode,_=e.quickTipProp,d=e.quickTipDataSource,p=e.disableQuickTip,m=e.operators,B=e.allowClear,f=e.onChange,v=e.onContinuousTextChange,V=e.onEditorInputEnd,A=e.onEditorBlurEnd,C=e.onEditorKeyDownEnd,Q=e.onEditorPasteEnd,e=useMemo(function(){return null!=m?m:ElasticSearch},[m]),h=useRef(null),E=useRef(null),j=useRef(null),K=useRef(null),z=useRef(null),x=useRef(null),g=useRef(null),T=useRef(-1),y=useRef(0),N=useRef(null),R=useRef(""),P=useRef(!1),S=useSetState(!1),G=S[0],J=S[1],S=useSetState(!1),X=S[0],Y=S[1],S=useSetState(!0),Z=S[0],$=S[1],S=useSetState(!1),ee=S[0],te=S[1],ne=useMemo(function(){return String.fromCharCode(null!=s?s:defaultTriggerCharCode)},[s]);function k(){(L()?w:D)()}function M(){var e,t;return"font"===(null==(t=null==(e=null==(e=null==(e=null==E?void 0:E.current)?void 0:e.firstElementChild)?void 0:e.tagName)?void 0:e.toLowerCase)?void 0:t.call(e))?null==(t=null==E?void 0:E.current)?void 0:t.firstElementChild:null==E?void 0:E.current}function L(){var e,t;return""===(null==(t=null==(e=null==(e=M())?void 0:e.innerHTML)?void 0:e.trim)?void 0:t.call(e))}function re(){var e=M();e&&(e.innerHTML="",H(),b(),w(),te(!1))}function le(e,t){var n,r,l,o,i=getCursorRectByDocument();i&&e&&(r=null==(r=h.current)?void 0:r.offsetWidth,l=null==(l=null==h?void 0:h.current)?void 0:l.offsetHeight,o=null==(o=null==(n=h.current)?void 0:n.getBoundingClientRect)?void 0:o.call(n),r)&&l&&h&&e&&o&&(0===(null==i?void 0:i.x)&&0===(null==i?void 0:i.y)?(e.style.left="".concat(o.x+20,"px"),e.style.top="".concat(o.y+l-2,"px")):((null==o?void 0:o.x)+r-(null==i?void 0:i.x)<modalWidth?e.style.left="".concat(o.x+r-modalWidth-10,"px"):e.style.left="".concat(i.x+10,"px"),e.style.top="".concat(i.y+25,"px"))),null!=t&&t()}function oe(){le(j.current,function(){return J(!0,function(){})})}function H(){J(!1)}function ie(){le(K.current,function(){return Y(!0)})}function b(){Y(!1)}function w(){$(!0)}function D(){$(!1)}function I(e){var t="",n=(isString(u)?t=u:isFunction(u)&&(t=u(e)),document.createElement("span"));return n.className=classNames("text",null!=t?t:""),n.innerHTML=e,n}function W(e){var t="",n=(isString(a)?t=a:isFunction(a)&&(t=a(e)),document.createElement("span"));return n.className=classNames("operator",null!=t?t:""),n.setAttribute("contenteditable","false"),n.innerHTML=e,n}function ue(e){var t;P.current||(g&&(g.current=getCurrentElementWithCursor()),x&&(x.current=getCurrentParentElementWithCursor()),T.current=getCursorIndex(),(L()?w:D)(),null!==(e=e.nativeEvent.data)?(t=e,!N.current||N.current===g.current&&y.current+1===T.current?(y.current=T.current,N.current=g.current,R.current+=t):(y.current=T.current,N.current=g.current,R.current=t),p||null!=v&&v(R.current)):p||null!=v&&v(null==(t=null==g?void 0:g.current)?void 0:t.textContent),p||e!==ne&&ie(),e!==ne&&null!=V&&V(e,R.current),null!=f&&f(null==(e=null==E?void 0:E.current)?void 0:e.innerHTML),te(!L()))}return useMount(function(){var e=M();e&&(e.innerHTML=null!=c?c:""),setCursorToEnd(e),k()}),useUpdateLayoutEffect(function(){k()},[c]),useImperativeHandle(t,function(){return{setValue:function(e){var t=M();t&&(t.innerHTML=null!=e?e:""),setCursorToEnd(t),k()},getValue:function(){var e;return null==(e=M())?void 0:e.innerHTML},isEditorEmpty:L,showOperators:oe,hideOperators:H,showQuickTip:ie,hideQuickTip:b,clear:re}}),React.createElement("div",{ref:h,className:classNames(selectorPrefix,null!=n?n:""),style:null!=r?r:{}},React.createElement("div",{ref:E,className:classNames("".concat(selectorPrefix,"-editor"),null!=l?l:"",((S={})["".concat(selectorPrefix,"-editor--show-clear")]=!!B,S)),style:null!=o?o:{},contentEditable:"true",onInput:ue,onKeyDown:function(e){return e.keyCode===(null!=s?s:defaultTriggerCharCode)?(b(),oe(),null!=C&&C(e),!1):13===e.keyCode?(H(),e.stopPropagation(),e.preventDefault(),null!=C&&C(e),!1):(H(),void(null!=C&&C(e)))},onBlur:function(e){e.stopPropagation(),e.preventDefault(),(L()?w:D)(),null!=A&&A(e)},onCompositionStart:function(){P.current=!0},onCompositionEnd:function(e){P.current=!1,ue(e)},onPaste:function(e){e.preventDefault(),null!=Q&&Q(e)}}),!!B&&ee.current&&React.createElement("div",{className:"".concat(selectorPrefix,"-editor-clear")},React.createElement(_CloseCircleOutlined,{onClick:function(){var e;re(),null!=(e=M())&&e.focus()}})),React.createElement("div",{className:classNames("".concat(selectorPrefix,"-editor-placeholder"),((t={})["".concat(selectorPrefix,"-editor-placeholder--show")]=Z.current,t)),ref:z},null!=F?F:Intl.v("请输入关键词")),React.createElement("div",{ref:j,className:classNames("".concat(selectorPrefix,"-operators"),null!=i?i:"",((n={})["".concat(selectorPrefix,"-operators--show")]=G.current,n)),style:null!=U?U:{}},React.createElement("div",{className:classNames("".concat(selectorPrefix,"-operators-header"))},React.createElement("i",{onClick:H},React.createElement(_CloseCircleOutlined,null))),React.createElement("ul",{className:classNames("".concat(selectorPrefix,"-operators-main"))},e.map(function(e){var t=e.label,s=e.value,d=e.type;return React.createElement("li",{key:s,onClick:function(){var e,t,n,r,l,o,i,u,a,c;t=d,(e=s)&&(n=M(),"brackets"===t?(t=e[0],o=e[1],/^&#\d+;/gim.test(e)&&(t=(r=e.split(";").filter(function(e){return e}))[0],o=r[1]),r=W(t),t=W(o),o=I("".concat(htmlSpace).concat(htmlSpace)),x.current===n?(u=I(null==(u=null==(i=null==(i=null==g?void 0:g.current)?void 0:i.textContent)?void 0:i.substring)?void 0:u.call(i,0,T.current+1)),a=I(null==(a=null==i?void 0:i.substring)?void 0:a.call(i,T.current+1)),(c=document.createDocumentFragment()).appendChild(u),c.appendChild(r),c.appendChild(o),c.appendChild(t),a&&a.textContent&&0!==a.textContent.length&&c.appendChild(a),null!=(l=null==n?void 0:n.replaceChild)&&l.call(n,c,g.current)):(u=I(null==(l=null==(i=null==(l=null==g?void 0:g.current)?void 0:l.textContent)?void 0:i.substring)?void 0:l.call(i,0,T.current)),a=I(null==(l=null==i?void 0:i.substring)?void 0:l.call(i,T.current)),(c=document.createDocumentFragment()).appendChild(u),c.appendChild(u),c.appendChild(r),c.appendChild(o),c.appendChild(t),a&&a.textContent&&0!==a.textContent.length&&c.appendChild(a),null!=(t=null==(r=null==(l=null==x?void 0:x.current)?void 0:l.parentElement)?void 0:r.replaceChild)&&t.call(r,c,x.current)),setCursorPosition(o,1)):(l=W(e),o=I(htmlSpace),x.current===n?(u=I(null==(r=null==(i=null==(t=null==g?void 0:g.current)?void 0:t.textContent)?void 0:i.substring)?void 0:r.call(i,0,T.current+1)),a=I(null==(e=null==i?void 0:i.substring)?void 0:e.call(i,T.current+1)),(c=document.createDocumentFragment()).appendChild(u),c.appendChild(l),c.appendChild(o),a&&a.textContent&&0!==a.textContent.length&&c.appendChild(a),null!=n&&n.replaceChild(c,g.current),setCursorPosition(o,0)):null!=(e=null==(r=null==(t=null==x?void 0:x.current)?void 0:t.classList)?void 0:r.contains)&&e.call(r,"text")&&(u=I(null==(t=null==(i=null==(n=null==g?void 0:g.current)?void 0:n.textContent)?void 0:i.substring)?void 0:t.call(i,0,T.current)),a=I(null==(e=null==i?void 0:i.substring)?void 0:e.call(i,T.current)),(c=document.createDocumentFragment()).appendChild(u),c.appendChild(l),c.appendChild(o),a&&a.textContent&&0!==a.textContent.length&&c.appendChild(a),null!=(t=null==(n=null==(r=null==x?void 0:x.current)?void 0:r.parentElement)?void 0:n.replaceChild)&&t.call(n,c,x.current),setCursorPosition(o,0))),null!=f)&&f(null==(e=null==E?void 0:E.current)?void 0:e.innerHTML),H()},dangerouslySetInnerHTML:{__html:t}})}))),React.createElement("div",{ref:K,className:classNames("".concat(selectorPrefix,"-quick-tips"),null!=q?q:"",((r={})["".concat(selectorPrefix,"-quick-tips--show")]=X.current,r)),style:null!=O?O:{}},React.createElement("div",{className:classNames("".concat(selectorPrefix,"-quick-tips-header"))},React.createElement("i",{onClick:b},React.createElement(_CloseCircleOutlined,null))),!(d||[]).length&&React.createElement("div",null,React.createElement(_Empty,null)),React.createElement("ul",{className:classNames("".concat(selectorPrefix,"-quick-tips-main"))},!!(d||[]).length&&(d||[]).map(function(u,e){return React.createElement("li",{key:u.value,onClick:function(e){return t=(t=u)[null!=_?_:"value"],i=M(),t&&(o=(r=(l=(null==(l=g.current)?void 0:l.textContent)||"").lastIndexOf(R.current,y.current))+R.current.length,n=document.createDocumentFragment(),r=document.createTextNode(l.substring(0,r)),l=document.createTextNode(l.substring(o)),(o=document.createElement("div")).innerHTML=t,n.appendChild(r),Array.from(o.childNodes).forEach(function(e){n.appendChild(e)}),n.appendChild(l),h.current===x.current?(i.innerHTML="",i.appendChild(n)):i===x.current?null!=(t=null==g?void 0:g.current)&&t.parentElement&&g.current.parentElement.replaceChild(n,g.current):null!=(r=null==x?void 0:x.current)&&r.parentElement&&x.current.parentElement.replaceChild(n,x.current),setCursorPositionToNode(l,0),null!=f)&&f(null==(o=null==E?void 0:E.current)?void 0:o.innerHTML),b(),void D();var t,n,r,l,o,i}},u.label)}))))})),Expression=InternalExpression;Expression.View=View,Expression.ElasticSearchOptions=ElasticSearch,Expression.SqlOptions=Sql,Expression.MathOptions=Math,Expression.parse=function(e,n){var t;return e?((t=document.createElement("div")).innerHTML=e,"font"===(null==(e=null==(e=null==t?void 0:t.firstElementChild)?void 0:e.tagName)?void 0:e.toLowerCase())&&(t.innerHTML=t.firstElementChild.innerHTML),Array.from(t.childNodes).map(function(e){var t;if(1===e.nodeType){if(e.classList.contains("text"))return null!=(t=null==n?void 0:n({nodeType:3,value:e.textContent}))?t:"";if(e.classList.contains("operator"))return null!=(t=null==n?void 0:n({nodeType:1,value:e.textContent}))?t:""}else if(3===e.nodeType)return null!=(t=null==n?void 0:n({nodeType:3,value:e.textContent}))?t:"";return""}).join("")):""},Expression.validator=function(){return{validator:function(e,t){var n=document.createElement("div");return n.innerHTML=t,n.innerText?Promise.resolve():Promise.reject(new Error(Intl.v("请输入关键字")))}}},Expression.displayName="Expression";export default Expression;export{selectorPrefix};
//# sourceMappingURL=Expression.js.map
