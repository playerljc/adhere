var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var n,r=1,t=arguments.length;r<t;r++)for(var a in n=arguments[r])Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,n){var r={};for(a in e)Object.prototype.hasOwnProperty.call(e,a)&&n.indexOf(a)<0&&(r[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var t=0,a=Object.getOwnPropertySymbols(e);t<a.length;t++)n.indexOf(a[t])<0&&Object.prototype.propertyIsEnumerable.call(e,a[t])&&(r[a[t]]=e[a[t]]);return r};import{useUpdateEffect}from"ahooks";import difference from"lodash/difference";import React,{memo,useMemo,useRef,useState}from"react";import{useImmer}from"use-immer";import Util from"@baifendian/adhere-util";import{treeTransformConfig}from"../TreeFilter";import InternalCascaderView from"./InternalCascaderView";var InternalAsyncCascader=memo(function(e){var l=e.loadData,n=e.onDataSourceChange,r=e.isEveryAsync,i=void 0!==r&&r,u=__rest(e,["loadData","onDataSourceChange","isEveryAsync"]),r=useImmer(u.options),t=r[0],c=r[1],e=useState(!1),r=e[0],s=e[1],f=useRef(null!=(e=u.value)?e:u.defaultValue),d=useMemo(function(){return u.treeDataSimpleMode?t:Util.treeToArray(null!=t?t:[],treeTransformConfig)},[t,u.treeDataSimpleMode]);function p(e,a){return u.treeDataSimpleMode?e.find(function(e){return e.value===a}):function e(n){for(var r=0;r<n.length;r++){var t=n[r];if(t.value===a)return t;if(t.children&&(t=e(t.children)))return t}}(e)}function m(a,e){var o=[];!function e(n){for(var r=0;r<a.length;r++){var t=a[r];t.pId===n&&(o.push(r),e(t.value))}}(e),o.forEach(function(e){a.splice(e,1)})}return useUpdateEffect(function(){c(u.options)},[u.options]),useUpdateEffect(function(){var e;f.current=null!=(e=u.value)?e:u.defaultValue},[u.defaultValue,u.value]),useUpdateEffect(function(){null!=n&&n(t)},[t]),React.createElement(InternalCascaderView,__assign({loading:r},u,{onChange:function(n,r){var e,t,a,o=difference(n,f.current);o.length<=0?(f.current=n,null!=(e=null==u?void 0:u.onChange)&&e.call(u,n,r)):(t=d.find(function(e){return e.value===o[0]}))?(f.current=n,(a=!i&&t.isLoaded?a:null==l?void 0:l(t.value))?(s(!0),a.then(function(r){s(!1),c(function(e){var n=p(e,t.value);n&&(n.isLoaded=!0,u.treeDataSimpleMode?(m(e,n.value),e.push.apply(e,r.map(function(e){return __assign(__assign({},e),{pId:n.value})}))):n.children=r)})}).catch(function(){s(!1)}).finally(function(){var e;null!=(e=null==u?void 0:u.onChange)&&e.call(u,n,r)})):null!=(e=null==u?void 0:u.onChange)&&e.call(u,n,r)):(f.current=n,null!=(a=null==u?void 0:u.onChange)&&a.call(u,n,r))},options:t}))}),AsyncCascaderView=InternalAsyncCascader;AsyncCascaderView.displayName="AsyncCascaderView";export default AsyncCascaderView;
//# sourceMappingURL=AsyncCascaderView.js.map
