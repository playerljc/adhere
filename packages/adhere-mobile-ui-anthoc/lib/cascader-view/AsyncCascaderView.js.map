{"version":3,"file":"AsyncCascaderView.js","sources":["cascader-view/AsyncCascaderView.js"],"sourcesContent":["\"use strict\";\n\nvar __assign = void 0 && (void 0).__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n    return t;\n  };\n  return __assign.apply(this, arguments);\n};\nvar __createBinding = void 0 && (void 0).__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = void 0 && (void 0).__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = void 0 && (void 0).__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __rest = void 0 && (void 0).__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nvar __importDefault = void 0 && (void 0).__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar ahooks_1 = require(\"ahooks\");\nvar difference_1 = __importDefault(require(\"lodash/difference\"));\nvar react_1 = __importStar(require(\"react\"));\nvar use_immer_1 = require(\"use-immer\");\nvar adhere_util_1 = __importDefault(require(\"@baifendian/adhere-util\"));\nvar TreeFilter_1 = require(\"../TreeFilter\");\nvar InternalCascaderView_1 = __importDefault(require(\"./InternalCascaderView\"));\n/**\n * InternalAsyncCascader\n */\nvar InternalAsyncCascader = (0, react_1.memo)(function (_a) {\n  var _b;\n  var loadData = _a.loadData,\n    onDataSourceChange = _a.onDataSourceChange,\n    _c = _a.isEveryAsync,\n    isEveryAsync = _c === void 0 ? false : _c,\n    internalCascaderViewProps = __rest(_a, [\"loadData\", \"onDataSourceChange\", \"isEveryAsync\"]);\n  var _d = (0, use_immer_1.useImmer)(\n    // internalCascaderViewProps.options,\n    []),\n    options = _d[0],\n    setOptions = _d[1];\n  // 加载状态\n  var _e = (0, react_1.useState)(false),\n    loading = _e[0],\n    setLoading = _e[1];\n  // 保存上一次的值\n  var preValue = (0, react_1.useRef)((_b = internalCascaderViewProps.value) !== null && _b !== void 0 ? _b : internalCascaderViewProps.defaultValue);\n  // 将树形数据转换为扁平数据\n  var flatOptions = (0, react_1.useMemo)(function () {\n    if (internalCascaderViewProps.treeDataSimpleMode) {\n      return options;\n    }\n    // @ts-ignore\n    return adhere_util_1.default.treeToArray(options !== null && options !== void 0 ? options : [], TreeFilter_1.treeTransformConfig);\n  }, [options, internalCascaderViewProps.treeDataSimpleMode]);\n  /**\n   * findTreeNodeByValue\n   * @description 根据 value 查找节点\n   * @param _treeData\n   * @param _value\n   */\n  function findTreeNodeByValue(_treeData, _value) {\n    // 如果是简单模式，直接查找\n    if (internalCascaderViewProps.treeDataSimpleMode) {\n      return _treeData.find(function (_option) {\n        return _option.value === _value;\n      });\n    }\n    // 递归查找\n    function loop(children) {\n      for (var i = 0; i < children.length; i++) {\n        var item = children[i];\n        if (item.value === _value) {\n          return item;\n        }\n        if (item.children) {\n          var result = loop(item.children);\n          if (result) {\n            return result;\n          }\n        }\n      }\n    }\n    // 如果是树形数据，递归查找\n    return loop(_treeData);\n  }\n  /**\n   * deleteChildrenByValue\n   * @description 根据 value 删除子节点\n   * @param draft 树形数据\n   * @param value\n   */\n  function deleteChildrenByValue(draft, value) {\n    var deleteIndexes = [];\n    function loop(parentId) {\n      for (var i = 0; i < draft.length; i++) {\n        var child = draft[i];\n        if (child.pId === parentId) {\n          deleteIndexes.push(i);\n          loop(child.value);\n        }\n      }\n    }\n    loop(value);\n    deleteIndexes.forEach(function (index) {\n      draft.splice(index, 1);\n    });\n  }\n  /**\n   * onChange\n   * @description onChange\n   * @param _values\n   * @param extend\n   */\n  function onChange(_values, extend) {\n    var _a, _b, _c;\n    // 使用 lodash 的 difference 函数来找出新增的元素\n    var addedItems = (0, difference_1.default)(_values, preValue.current);\n    // 如果没有新增的元素，直接返回\n    if (addedItems.length <= 0) {\n      preValue.current = _values;\n      (_a = internalCascaderViewProps === null || internalCascaderViewProps === void 0 ? void 0 : internalCascaderViewProps.onChange) === null || _a === void 0 ? void 0 : _a.call(internalCascaderViewProps, _values, extend);\n      return;\n    }\n    // 只处理第一个，因为只有一个\n    var addedItem = flatOptions.find(function (_option) {\n      return _option.value === addedItems[0];\n    });\n    // 如果没有找到，直接返回\n    if (!addedItem) {\n      preValue.current = _values;\n      (_b = internalCascaderViewProps === null || internalCascaderViewProps === void 0 ? void 0 : internalCascaderViewProps.onChange) === null || _b === void 0 ? void 0 : _b.call(internalCascaderViewProps, _values, extend);\n      return;\n    }\n    preValue.current = _values;\n    var promise;\n    // 如果是每次都异步加载，直接加载\n    if (isEveryAsync) {\n      promise = loadData === null || loadData === void 0 ? void 0 : loadData(addedItem.value);\n    } else {\n      // 如果没有加载过，加载\n      if (!addedItem.isLoaded) {\n        promise = loadData === null || loadData === void 0 ? void 0 : loadData(addedItem.value);\n      }\n    }\n    // 如果有 promise\n    if (promise) {\n      setLoading(true);\n      // 执行\n      promise.then(function (_options) {\n        setLoading(false);\n        // 更新 options\n        setOptions(function (_draft) {\n          // 找到当前的 item\n          var currentNode = findTreeNodeByValue(_draft, addedItem.value);\n          if (currentNode) {\n            currentNode.isLoaded = true;\n            // 如果不是简单模式，更新 children\n            if (!internalCascaderViewProps.treeDataSimpleMode) {\n              currentNode.children = _options;\n            }\n            // 如果是简单模式，需要先删除currentNode的所有子节点，然后再添加新的子节点\n            else {\n              // 删除当前节点的所有子节点\n              deleteChildrenByValue(_draft, currentNode.value);\n              // 添加新的子节点\n              _draft.push.apply(_draft, _options.map(function (_option) {\n                return __assign(__assign({}, _option), {\n                  pId: currentNode.value\n                });\n              }));\n            }\n          }\n        });\n      }).catch(function () {\n        setLoading(false);\n      }).finally(function () {\n        var _a;\n        (_a = internalCascaderViewProps === null || internalCascaderViewProps === void 0 ? void 0 : internalCascaderViewProps.onChange) === null || _a === void 0 ? void 0 : _a.call(internalCascaderViewProps, _values, extend);\n      });\n    } else {\n      (_c = internalCascaderViewProps === null || internalCascaderViewProps === void 0 ? void 0 : internalCascaderViewProps.onChange) === null || _c === void 0 ? void 0 : _c.call(internalCascaderViewProps, _values, extend);\n    }\n  }\n  (0, ahooks_1.useUpdateEffect)(function () {\n    setOptions(internalCascaderViewProps.options);\n  }, [internalCascaderViewProps.options]);\n  (0, ahooks_1.useUpdateEffect)(function () {\n    var _a;\n    preValue.current = (_a = internalCascaderViewProps.value) !== null && _a !== void 0 ? _a : internalCascaderViewProps.defaultValue;\n  }, [internalCascaderViewProps.defaultValue, internalCascaderViewProps.value]);\n  (0, ahooks_1.useUpdateEffect)(function () {\n    onDataSourceChange === null || onDataSourceChange === void 0 ? void 0 : onDataSourceChange(options);\n  }, [options]);\n  (0, ahooks_1.useMount)(function () {\n    var _a;\n    (_a = loadData === null || loadData === void 0 ? void 0 : loadData(undefined)) === null || _a === void 0 ? void 0 : _a.then(function (_options) {\n      setOptions(_options);\n    });\n  });\n  return react_1.default.createElement(InternalCascaderView_1.default, __assign({\n    loading: loading\n  }, internalCascaderViewProps, {\n    onChange: onChange,\n    options: options\n  }));\n});\nvar AsyncCascaderView = InternalAsyncCascader;\nAsyncCascaderView.displayName = 'AsyncCascaderView';\nexports.default = AsyncCascaderView;"],"names":["__assign","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","this","__createBinding","create","o","m","k","k2","undefined","desc","getOwnPropertyDescriptor","__esModule","writable","configurable","enumerable","get","defineProperty","__setModuleDefault","v","value","__importStar","mod","result","__rest","e","indexOf","getOwnPropertySymbols","propertyIsEnumerable","__importDefault","default","ahooks_1","exports","require","difference_1","react_1","use_immer_1","adhere_util_1","TreeFilter_1","InternalCascaderView_1","InternalAsyncCascader","memo","_a","loadData","onDataSourceChange","_c","isEveryAsync","internalCascaderViewProps","_d","useImmer","options","setOptions","_e","useState","loading","setLoading","preValue","useRef","_b","defaultValue","flatOptions","useMemo","treeDataSimpleMode","treeToArray","treeTransformConfig","findTreeNodeByValue","_treeData","_value","find","_option","loop","children","item","deleteChildrenByValue","draft","deleteIndexes","parentId","child","pId","push","forEach","index","splice","useUpdateEffect","current","useMount","then","_options","createElement","onChange","_values","extend","addedItem","promise","addedItems","isLoaded","_draft","currentNode","map","catch","finally","AsyncCascaderView","displayName"],"mappings":"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"}