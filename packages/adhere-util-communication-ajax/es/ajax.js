var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var n={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]]);return n};import{notification}from"antd";import Util from"@baifendian/adhere-util";import intl from"@baifendian/adhere-util-intl";import GlobalIndicator from"@baifendian/adhere-ui-globalindicator";var errorInfoHandler,warnInfoHandler,trigger402=!1,notificationThrottlingTime=2e3;function errorInfo(e,t){errorInfoHandler&&(clearTimeout(errorInfoHandler),errorInfoHandler=null),errorInfoHandler=setTimeout(function(){notification.error({message:e,description:t})},notificationThrottlingTime)}function warnInfo(e,t){warnInfoHandler&&(clearTimeout(warnInfoHandler),warnInfoHandler=null),warnInfoHandler=setTimeout(function(){notification.warn({message:e,description:t})},notificationThrottlingTime)}function createXHR(){return new XMLHttpRequest}function getDefaultConfig(){var t=this;return{timeout:Ajax.TIMEOUT,withCredentials:!0,onLoad:function(){},onLoadsStart:function(){},onLoadend:function(){},onProgress:function(){},onTimeout:function(){warnInfo(intl.v("提示"),intl.v("请求超时"))},onAbort:function(){warnInfo(intl.v("提示"),intl.v("请求终止"))},onError:function(){errorInfo(intl.v("提示"),intl.v("请求发生错误"))},interceptor:function(e){switch(e.status){case 401:deal401.call(t);break;case 402:deal402.call(t);break;default:errorInfo(intl.v("提示"),intl.v("已提出请求，但未收到任何回复"))}},mock:!1,loading:{show:!1,text:"",el:document.body},onBeforeResponse:function(){},dataKey:"data",messageKey:"message",codeKey:"code",codeSuccess:200,showWarn:!0}}function initXhrEvents(e,t){var n=t.onTimeout,o=t.onLoadsStart,r=t.onProgress,a=t.onAbort,i=t.onError,s=t.onLoad,t=t.onLoadend;n&&e.addEventListener("timeout",n),o&&e.addEventListener("loadstart",o),r&&e.addEventListener("progress",r),a&&e.addEventListener("abort",a),i&&e.addEventListener("error",i),s&&e.addEventListener("load",s),t&&e.addEventListener("loadend",t)}function resolveData(e){var t=e.show,n=e.data,o=e.indicator;return t?{data:n,hideIndicator:function(){GlobalIndicator.hide(o)}}:n}function onreadystatechange(e){var t=e.xhr,n=e.interceptor,o=e.loading,r=o.show,a=o.indicator,i=e.business,s=i.messageKey,d=i.codeKey,c=i.codeSuccess,l=i.showWarn,f=e.resolve,u=e.reject,T=t.status,_=t.readyState,p=t.statusText,o=t.response,i=t.responseText;_===Ajax.READY_STATE_DONE&&(200<=T&&T<300||304===T?-1!==(e=t.getResponseHeader("Content-type")).indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)?(_=JSON.parse(t.responseText),l&&d in _&&_[d]!==c&&warnInfo(intl.v("提示"),_[s]),f(resolveData({show:r,data:_,indicator:a}))):[Ajax.CONTENT_TYPE_TEXT_XML,Ajax.CONTENT_TYPE_TEXT_XML].includes(e)?f(resolveData({show:r,data:t.responseXML,indicator:a})):f(resolveData({show:r,data:t.response,indicator:a})):(n({status:T,statusText:p,response:o,responseText:i}),T&&u({status:T,statusText:p,response:o,responseText:i}),r&&a&&GlobalIndicator.hide(a)))}function sendPrepare(e,t){var n,o=t.resolve,r=t.reject,a=e.method,i=e.path,s=e.headers,d=e.data,c=e.mock,l=e.loading,f=(e.onBeforeResponse,e.dataKey),u=void 0===f?"data":f,T=e.messageKey,_=void 0===T?"message":T,p=e.codeKey,h=void 0===p?"code":p,t=e.codeSuccess,f=void 0===t?200:t,T=e.showWarn,p=void 0===T||T,t=__rest(e,["method","path","headers","data","mock","loading","onBeforeResponse","dataKey","messageKey","codeKey","codeSuccess","showWarn"]),T=intl.v("加载中")+"...",e=l.show,E=void 0!==e&&e,e=l.text,e=void 0===e?T:e,l=l.el,l=void 0===l?document.body:l;if(E&&(n=GlobalIndicator.show(l||document.body,e||T)),c)return setTimeout(function(){o(E?{data:i,hideIndicator:function(){GlobalIndicator.hide(n)}}:i)},200),{xhr:null,contentType:""};var l=this.baseURL,e=this.config,T=Object.assign(getDefaultConfig.call(this),e,t),c=T.timeout,e=T.withCredentials,t=T.interceptor,T=__rest(T,["timeout","withCredentials","interceptor"]),m=createXHR();m.open(a,l+"/"+i,!0),m.timeout=c,m.withCredentials=e;e="";if(!Util.isEmpty(s)&&Util.isObject(s))for(var g in"Content-type"in s||"get"===a||(s["Content-Type"]=Ajax.CONTENT_TYPE_APPLICATION_JSON+";charset=utf-8",e=s["Content-Type"]),s)m.setRequestHeader(g,s[g]);else!Util.isEmpty(d)&&Util.isRef(d)&&"get"!==a&&("form"in d&&"data"in d&&!Util.isEmpty(d.form)&&!Util.isEmpty(d.data)&&d.form instanceof HTMLFormElement?e=Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA:(e=Ajax.CONTENT_TYPE_APPLICATION_JSON+";charset=utf-8",m.setRequestHeader("Content-Type",Ajax.CONTENT_TYPE_APPLICATION_JSON+";charset=utf-8")));return initXhrEvents(m,T),m.onreadystatechange=onreadystatechange.bind(this,{xhr:m,interceptor:t,loading:{show:E,indicator:n},business:{dataKey:u,messageKey:_,codeKey:h,codeSuccess:f,showWarn:p},resolve:o,reject:r}),{xhr:m,contentType:e}}function getSendParams(e){var t=e.data,e=e.contentType;if((e=e||"").startsWith(Ajax.CONTENT_TYPE_APPLICATION_JSON)&&Util.isRef(t))return JSON.stringify(t);if(e.startsWith(Ajax.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED)&&Util.isObject(t))return Array.from(Object.keys(t)).map(function(e){return encodeURIComponent(e+"="+t[e])}).join("&");if(e.startsWith(Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA)&&Util.isObject(t)){var n=new FormData(t.form);return Array.from(Object.keys(t.data)).forEach(function(e){n.append(e,t.data[e])}),n}if(e.startsWith(Ajax.CONTENT_TYPE_TEXT_PLAIN)){if(Util.isString(t))return t;if(Util.isObject(t))return JSON.stringify(t)}return t.toString()}function complexRequest(n,o){var r=this;return new Promise(function(e,t){e=sendPrepare.call(r,__assign(__assign(__assign(__assign({},getDefaultConfig.call(r)),r.config),{method:n}),o),{resolve:e,reject:t}),t=e.xhr,e=e.contentType;t&&t.send(getSendParams.call(r,{data:o.data,contentType:e}))})}function deal401(){if("undefined"!=typeof window){if(window.top&&window.top!==window&&window.top.postMessage("http_status_401","*"),trigger402)return!1;window.location.href=Util.casUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href})}}function deal402(){if(trigger402=!0,"undefined"!=typeof window)return window.parent&&window.parent!==window?(window.parent.postMessage("http_status_402","*"),!1):void(window.location.href=Util.casLogoutUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href,params:"&code=402"}))}var Ajax=function(){function e(e,t,n){this.baseURL=e||"",this.systemManagerBaseURL=t||"",this.config=n||{}}return e.prototype.get=function(e){var n=this,o=(e.data,__rest(e,["data"]));return new Promise(function(e,t){t=sendPrepare.call(n,__assign(__assign(__assign(__assign({},getDefaultConfig.call(n)),n.config),{method:"get"}),o),{resolve:e,reject:t}).xhr;t&&t.send(null)})},e.prototype.post=function(e){return complexRequest.call(this,"post",e)},e.prototype.path=function(e){return complexRequest.call(this,"path",e)},e.prototype.put=function(e){return complexRequest.call(this,"put",e)},e.prototype.delete=function(e){return complexRequest.call(this,"delete",e)},e.TIMEOUT=1e6,e.STATUS_SUCCESS_CODES=[200,201,202,203,204,205,206,207,208,226],e.STATUS_REDIRECT_CODES=[300,301,302,303,304,305,306,307,308],e.READY_STATE_UNSENT=0,e.READY_STATE_OPENED=1,e.READY_STATE_HEADERS_RECEIVED=2,e.READY_STATE_LOADING=3,e.READY_STATE_DONE=4,e.CONTENT_TYPE_APPLICATION_JSON="application/json",e.CONTENT_TYPE_MULTIPART_FORM_DATA="multipart/form-data",e.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED="application/x-www-form-urlencoded",e.CONTENT_TYPE_TEXT_XML="text/xml",e.CONTENT_TYPE_APPLICATION_XML="application/xml",e.CONTENT_TYPE_TEXT_PLAIN="text/plain",e}();export default Ajax;
//# sourceMappingURL=ajax.js.map
