import _notification from"antd/es/notification";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},__rest=this&&this.__rest||function(t,e){var n={};for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]]);return n};import MobileGlobalIndicator from"@baifendian/adhere-mobile-ui-globalindicator";import GlobalIndicator from"@baifendian/adhere-ui-globalindicator";import Util from"@baifendian/adhere-util";import intl from"@baifendian/adhere-util-intl";var errorInfoHandler,warnInfoHandler,trigger402=!1,notificationThrottlingTime=300,Ajax=function(){function t(t,e,n){this.baseURL=t||"",this.systemManagerBaseURL=e||"",this.config=null!=n?n:{}}return t.prototype.get=function(t){var n=this,o=(t.data,__rest(t,["data"])),r={},t=new Promise(function(t,e){t=(r=sendPrepare.call(n,__assign(__assign(__assign(__assign({},getDefaultConfig.call(n)),n.config),{method:"get"}),o),{resolve:t,reject:e})).xhr;t&&t.send(null)});return __assign(__assign({},r),{promise:t})},t.prototype.post=function(t){return complexRequest.call(this,"post",t)},t.prototype.path=function(t){return complexRequest.call(this,"path",t)},t.prototype.put=function(t){return complexRequest.call(this,"put",t)},t.prototype.delete=function(t){return complexRequest.call(this,"delete",t)},t.TIMEOUT=1e6,t.STATUS_SUCCESS_CODES=[200,201,202,203,204,205,206,207,208,226],t.STATUS_REDIRECT_CODES=[300,301,302,303,304,305,306,307,308],t.READY_STATE_UNSENT=0,t.READY_STATE_OPENED=1,t.READY_STATE_HEADERS_RECEIVED=2,t.READY_STATE_LOADING=3,t.READY_STATE_DONE=4,t.CONTENT_TYPE_APPLICATION_JSON="application/json",t.CONTENT_TYPE_MULTIPART_FORM_DATA="multipart/form-data",t.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED="application/x-www-form-urlencoded",t.CONTENT_TYPE_TEXT_XML="text/xml",t.CONTENT_TYPE_APPLICATION_XML="application/xml",t.CONTENT_TYPE_TEXT_PLAIN="text/plain",t}();function errorInfo(t,e){errorInfoHandler&&(clearTimeout(errorInfoHandler),errorInfoHandler=null),errorInfoHandler=setTimeout(function(){_notification.error({message:t,description:e})},notificationThrottlingTime)}function warnInfo(t,e){warnInfoHandler&&(clearTimeout(warnInfoHandler),warnInfoHandler=null),warnInfoHandler=setTimeout(function(){_notification.warning({message:t,description:e})},notificationThrottlingTime)}function createXHR(){return new XMLHttpRequest}function getDefaultConfig(){var e=this;return{timeout:Ajax.TIMEOUT,withCredentials:!0,onLoad:function(){},onLoadsStart:function(){},onLoadend:function(){},onProgress:function(){},onTimeout:function(){warnInfo(intl.v("提示"),intl.v("请求超时"))},onAbort:function(){warnInfo(intl.v("提示"),intl.v("请求终止"))},onError:function(){errorInfo(intl.v("提示"),intl.v("请求发生错误"))},interceptor:function(t){switch(t.status){case 401:deal401.call(e);break;case 402:deal402.call(e);break;default:errorInfo(intl.v("提示"),intl.v("已提出请求，但未收到任何回复"))}},mock:!1,loading:{show:!1,text:"",el:document.body,zIndex:19999,size:"default"},onBeforeResponse:function(){},dataKey:"data",messageKey:"message",codeKey:"code",codeSuccess:200,showWarn:!0,responseType:""}}function initXhrEvents(t){var e=t.xhr,n=t.events,o=t.reject,r=n.onTimeout,t=n.onLoadsStart,a=n.onProgress,i=n.onAbort,s=n.onError,l=n.onLoad,n=n.onLoadend;r&&e.addEventListener("timeout",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];r.apply(void 0,null!=t?t:{}),o.apply(void 0,null!=t?t:{})}),i&&e.addEventListener("abort",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];i.apply(void 0,null!=t?t:{}),o.apply(void 0,null!=t?t:{})}),s&&e.addEventListener("error",function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];s.apply(void 0,null!=t?t:{}),o.apply(void 0,null!=t?t:{})}),t&&e.addEventListener("loadstart",t),a&&e.addEventListener("progress",a),l&&e.addEventListener("load",l),n&&e.addEventListener("loadend",n)}function resolveData(t){var e=t.show,n=t.terminal,o=t.data,r=t.indicator,t=t.xhr,a=getGlobalIndicator(n);return __assign({xhr:t,data:o},e?{hideIndicator:function(){return a.hide(r)}}:{})}function onreadystatechange(t){var e,n,o=t.xhr,r=t.interceptor,a=t.loading,i=a.show,s=a.indicator,a=a.terminal,l=t.business,c=l.messageKey,d=l.codeKey,u=l.codeSuccess,l=l.showWarn,f=t.resolve,t=t.reject,p=getGlobalIndicator(a);o.readyState===Ajax.READY_STATE_DONE&&(200<=o.status&&o.status<300||304===o.status?-1!==(e=o.getResponseHeader("Content-type")).indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)?(n=JSON.parse(o.responseText),l&&d in n&&n[d]!==u&&warnInfo(intl.v("提示"),n[c]),f(resolveData({show:i,terminal:a,data:n,indicator:s,xhr:o}))):[Ajax.CONTENT_TYPE_TEXT_XML,Ajax.CONTENT_TYPE_TEXT_XML].includes(e)?f(resolveData({show:i,terminal:a,data:o.responseXML,indicator:s,xhr:o})):f(resolveData({show:i,terminal:a,data:o.response,indicator:s,xhr:o})):(r({status:o.status,statusText:o.statusText,response:o.response,responseText:o.responseText}),t({status:o.status,statusText:o.statusText,response:o.response,responseText:o.responseText}),i&&s&&p.hide(s)))}function isMultipartFormData(t){return t&&"form"in t&&"data"in t&&!Util.isEmpty(t.form)&&!Util.isEmpty(t.data)&&t.form instanceof HTMLFormElement}function getGlobalIndicator(t){return"PC"===t?GlobalIndicator:MobileGlobalIndicator}function sendPrepare(t,e){var n,o=t.method,r=t.path,a=t.headers,i=t.data,s=t.mock,l=t.loading,c=(t.onBeforeResponse,t.dataKey),c=void 0===c?"data":c,d=t.messageKey,d=void 0===d?"message":d,u=t.codeKey,u=void 0===u?"code":u,f=t.codeSuccess,f=void 0===f?200:f,p=t.showWarn,p=void 0===p||p,t=__rest(t,["method","path","headers","data","mock","loading","onBeforeResponse","dataKey","messageKey","codeKey","codeSuccess","showWarn"]),T=e.resolve,e=e.reject,_="".concat(intl.v("加载中"),"..."),h=l.show,m=void 0!==h&&h,h=l.text,h=void 0===h?_:h,g=l.el,g=void 0===g?document.body:g,E=l.zIndex,E=void 0===E?19999:E,y=l.size,y=void 0===y?"default":y,l=l.terminal,l=void 0===l?"PC":l,O=getGlobalIndicator(l);if(m&&(n=O.show(g||document.body,h||_,E,y)),s)return setTimeout(function(){T(m?{data:r,hideIndicator:function(){O.hide(n)}}:r)},200),{xhr:null,contentType:""};var g=this.baseURL,h=this.config,_=Object.assign(getDefaultConfig.call(this),h,t),E=_.timeout,y=_.withCredentials,s=_.responseType,h=_.interceptor,t=__rest(_,["timeout","withCredentials","responseType","interceptor"]),v=createXHR(),_=(v.open(o,"".concat(g,"/").concat(r),!0),v.timeout=E,v.withCredentials=y,v.responseType=s||"","");if(!Util.isEmpty(a)&&Util.isObject(a))for(var w in"Content-Type"in a||isMultipartFormData(i)||(a["Content-Type"]="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8")),_=null!=(g=a["Content-Type"])?g:"",a)v.setRequestHeader(w,a[w]);else!Util.isEmpty(i)&&Util.isRef(i)&&"get"!==o&&(isMultipartFormData(i)?_=Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA:(_="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"),v.setRequestHeader("Content-Type","".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"))));return initXhrEvents({xhr:v,events:t,reject:e}),v.onreadystatechange=onreadystatechange.bind(this,{xhr:v,interceptor:h,loading:{show:m,terminal:l,indicator:n},business:{dataKey:c,messageKey:d,codeKey:u,codeSuccess:f,showWarn:p},resolve:T,reject:e}),{xhr:v,contentType:_}}function getSendParams(t){var n,o=t.data,e=t.contentType,e=void 0===e?"":e,t=t.customSendJSONStringify;if(e.startsWith(Ajax.CONTENT_TYPE_APPLICATION_JSON)&&Util.isRef(o))return t?JSON.stringify(o,t):JSON.stringify(o);if(e.startsWith(Ajax.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED)&&Util.isObject(o))return Array.from(Object.keys(o)).map(function(t){return"".concat(t,"=").concat(encodeURIComponent(o[t]))}).join("&");if(Util.isObject(o)&&isMultipartFormData(o))return n=new FormData(o.form),Array.from(Object.keys(o.data)).forEach(function(e){var t=o.data[e];t instanceof Function?n.append(e,t()):Array.isArray(t)?t.forEach(function(t){n.append(e,t)}):n.append(e,t)}),n;if(e.startsWith(Ajax.CONTENT_TYPE_TEXT_PLAIN)){if(Util.isString(o))return o;if(Util.isObject(o))return t?JSON.stringify(o,t):JSON.stringify(o)}return null==(e=null==o?void 0:o.toString)?void 0:e.call(o)}function complexRequest(n,o){var r=this,a={},t=new Promise(function(t,e){t=(a=sendPrepare.call(r,__assign(__assign(__assign(__assign({},getDefaultConfig.call(r)),r.config),{method:n}),o),{resolve:t,reject:e})).xhr,e=a.contentType;t&&t.send(getSendParams.call(r,{data:o.data,contentType:e,customSendJSONStringify:o.customSendJSONStringify}))});return __assign(__assign({},a),{promise:t})}function deal401(){if("undefined"!=typeof window){if(window.top&&window.top!==window&&window.top.postMessage("http_status_401","*"),trigger402)return!1;window.location.href=Util.casUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href,defaultLocal:"zh_CN"})}}function deal402(){if(trigger402=!0,"undefined"!=typeof window)return window.parent&&window.parent!==window?(window.parent.postMessage("http_status_402","*"),!1):void(window.location.href=Util.casLogoutUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href,params:"&code=402"}))}export default Ajax;
//# sourceMappingURL=ajax.js.map
