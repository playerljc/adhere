import _notification from"antd/es/notification";import"core-js/modules/es.object.assign.js";import"core-js/modules/es.array.index-of.js";import"core-js/modules/es.symbol.js";import"core-js/modules/es.object.to-string.js";import"core-js/modules/es.promise.js";import"core-js/modules/es.array.includes.js";import"core-js/modules/es.string.includes.js";import"core-js/modules/es.array.concat.js";import"core-js/modules/es.string.starts-with.js";import"core-js/modules/es.array.map.js";import"core-js/modules/es.array.from.js";import"core-js/modules/es.string.iterator.js";import"core-js/modules/es.object.keys.js";import"core-js/modules/web.dom-collections.for-each.js";import"core-js/modules/es.regexp.to-string.js";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var r in t=arguments[o])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var o={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(o[r[n]]=e[r[n]]);return o};import GlobalIndicator from"@baifendian/adhere-ui-globalindicator";import Util from"@baifendian/adhere-util";import intl from"@baifendian/adhere-util-intl";var errorInfoHandler,warnInfoHandler,trigger402=!1,notificationThrottlingTime=300,Ajax=function(){function e(e,t,o){this.baseURL=e||"",this.systemManagerBaseURL=t||"",this.config=o||{}}return e.prototype.get=function(e){var o=this,n=(e.data,__rest(e,["data"]));return new Promise(function(e,t){e=sendPrepare.call(o,__assign(__assign(__assign(__assign({},getDefaultConfig.call(o)),o.config),{method:"get"}),n),{resolve:e,reject:t}).xhr;e&&e.send(null)})},e.prototype.post=function(e){return complexRequest.call(this,"post",e)},e.prototype.path=function(e){return complexRequest.call(this,"path",e)},e.prototype.put=function(e){return complexRequest.call(this,"put",e)},e.prototype.delete=function(e){return complexRequest.call(this,"delete",e)},e.TIMEOUT=1e6,e.STATUS_SUCCESS_CODES=[200,201,202,203,204,205,206,207,208,226],e.STATUS_REDIRECT_CODES=[300,301,302,303,304,305,306,307,308],e.READY_STATE_UNSENT=0,e.READY_STATE_OPENED=1,e.READY_STATE_HEADERS_RECEIVED=2,e.READY_STATE_LOADING=3,e.READY_STATE_DONE=4,e.CONTENT_TYPE_APPLICATION_JSON="application/json",e.CONTENT_TYPE_MULTIPART_FORM_DATA="multipart/form-data",e.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED="application/x-www-form-urlencoded",e.CONTENT_TYPE_TEXT_XML="text/xml",e.CONTENT_TYPE_APPLICATION_XML="application/xml",e.CONTENT_TYPE_TEXT_PLAIN="text/plain",e}();function errorInfo(e,t){errorInfoHandler&&(clearTimeout(errorInfoHandler),errorInfoHandler=null),errorInfoHandler=setTimeout(function(){_notification.error({message:e,description:t})},notificationThrottlingTime)}function warnInfo(e,t){warnInfoHandler&&(clearTimeout(warnInfoHandler),warnInfoHandler=null),warnInfoHandler=setTimeout(function(){_notification.warn({message:e,description:t})},notificationThrottlingTime)}function createXHR(){return new XMLHttpRequest}function getDefaultConfig(){var t=this;return{timeout:Ajax.TIMEOUT,withCredentials:!0,onLoad:function(){},onLoadsStart:function(){},onLoadend:function(){},onProgress:function(){},onTimeout:function(){warnInfo(intl.v("提示"),intl.v("请求超时"))},onAbort:function(){warnInfo(intl.v("提示"),intl.v("请求终止"))},onError:function(){errorInfo(intl.v("提示"),intl.v("请求发生错误"))},interceptor:function(e){switch(e.status){case 401:deal401.call(t);break;case 402:deal402.call(t);break;default:errorInfo(intl.v("提示"),intl.v("已提出请求，但未收到任何回复"))}},mock:!1,loading:{show:!1,text:"",el:document.body},onBeforeResponse:function(){},dataKey:"data",messageKey:"message",codeKey:"code",codeSuccess:200,showWarn:!0,responseType:""}}function initXhrEvents(e,t){var o=t.onTimeout,n=t.onLoadsStart,r=t.onProgress,s=t.onAbort,a=t.onError,i=t.onLoad,t=t.onLoadend;o&&e.addEventListener("timeout",o),n&&e.addEventListener("loadstart",n),r&&e.addEventListener("progress",r),s&&e.addEventListener("abort",s),a&&e.addEventListener("error",a),i&&e.addEventListener("load",i),t&&e.addEventListener("loadend",t)}function resolveData(e){var t=e.show,o=e.data,n=e.indicator,e=e.xhr;return __assign({xhr:e,data:o},t?{hideIndicator:function(){return GlobalIndicator.hide(n)}}:{})}function onreadystatechange(e){var t,o,n=e.xhr,r=e.interceptor,s=e.loading,a=s.show,s=s.indicator,i=e.business,c=i.messageKey,d=i.codeKey,l=i.codeSuccess,i=i.showWarn,u=e.resolve,e=e.reject;n.readyState===Ajax.READY_STATE_DONE&&(200<=n.status&&n.status<300||304===n.status?-1!==(t=n.getResponseHeader("Content-type")).indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)?(o=JSON.parse(n.responseText),i&&d in o&&o[d]!==l&&warnInfo(intl.v("提示"),o[c]),u(resolveData({show:a,data:o,indicator:s,xhr:n}))):[Ajax.CONTENT_TYPE_TEXT_XML,Ajax.CONTENT_TYPE_TEXT_XML].includes(t)?u(resolveData({show:a,data:n.responseXML,indicator:s,xhr:n})):u(resolveData({show:a,data:n.response,indicator:s,xhr:n})):(r({status:n.status,statusText:n.statusText,response:n.response,responseText:n.responseText}),n.status&&e({status:n.status,statusText:n.statusText,response:n.response,responseText:n.responseText}),a&&s&&GlobalIndicator.hide(s)))}function isMultipartFormData(e){return e&&"form"in e&&"data"in e&&!Util.isEmpty(e.form)&&!Util.isEmpty(e.data)&&e.form instanceof HTMLFormElement}function sendPrepare(e,t){var o,n=e.method,r=e.path,s=e.headers,a=e.data,i=e.mock,c=e.loading,d=(e.onBeforeResponse,e.dataKey),d=void 0===d?"data":d,l=e.messageKey,l=void 0===l?"message":l,u=e.codeKey,u=void 0===u?"code":u,p=e.codeSuccess,p=void 0===p?200:p,f=e.showWarn,f=void 0===f||f,e=__rest(e,["method","path","headers","data","mock","loading","onBeforeResponse","dataKey","messageKey","codeKey","codeSuccess","showWarn"]),T=t.resolve,t=t.reject,m="".concat(intl.v("加载中"),"..."),_=c.show,h=void 0!==_&&_,_=c.text,c=c.el,c=void 0===c?document.body:c;if(h&&(o=GlobalIndicator.show(c||document.body,(void 0===_?m:_)||m)),i)return setTimeout(function(){T(h?{data:r,hideIndicator:function(){GlobalIndicator.hide(o)}}:r)},200),{xhr:null,contentType:""};var c=this.baseURL,_=this.config,m=Object.assign(getDefaultConfig.call(this),_,e),i=m.timeout,_=m.withCredentials,e=m.responseType,E=m.interceptor,m=__rest(m,["timeout","withCredentials","responseType","interceptor"]),g=createXHR(),c=(g.open(n,"".concat(c,"/").concat(r),!0),g.timeout=i,g.withCredentials=_,g.responseType=e||"","");if(!Util.isEmpty(s)&&Util.isObject(s))for(var y in"Content-Type"in s||isMultipartFormData(a)||(s["Content-Type"]="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8")),c=null!=(i=s["Content-Type"])?i:"",s)g.setRequestHeader(y,s[y]);else!Util.isEmpty(a)&&Util.isRef(a)&&"get"!==n&&(isMultipartFormData(a)?c=Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA:(c="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"),g.setRequestHeader("Content-Type","".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"))));return initXhrEvents(g,m),g.onreadystatechange=onreadystatechange.bind(this,{xhr:g,interceptor:E,loading:{show:h,indicator:o},business:{dataKey:d,messageKey:l,codeKey:u,codeSuccess:p,showWarn:f},resolve:T,reject:t}),{xhr:g,contentType:c}}function getSendParams(e){var t,o=e.data,e=e.contentType,e=void 0===e?"":e;if(e.startsWith(Ajax.CONTENT_TYPE_APPLICATION_JSON)&&Util.isRef(o))return JSON.stringify(o);if(e.startsWith(Ajax.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED)&&Util.isObject(o))return Array.from(Object.keys(o)).map(function(e){return"".concat(e,"=").concat(encodeURIComponent(o[e]))}).join("&");if(Util.isObject(o)&&isMultipartFormData(o))return t=new FormData(o.form),Array.from(Object.keys(o.data)).forEach(function(e){t.append(e,o.data[e])}),t;if(e.startsWith(Ajax.CONTENT_TYPE_TEXT_PLAIN)){if(Util.isString(o))return o;if(Util.isObject(o))return JSON.stringify(o)}return o.toString()}function complexRequest(o,n){var r=this;return new Promise(function(e,t){e=sendPrepare.call(r,__assign(__assign(__assign(__assign({},getDefaultConfig.call(r)),r.config),{method:o}),n),{resolve:e,reject:t}),t=e.xhr,e=e.contentType;t&&t.send(getSendParams.call(r,{data:n.data,contentType:e}))})}function deal401(){if("undefined"!=typeof window){if(window.top&&window.top!==window&&window.top.postMessage("http_status_401","*"),trigger402)return!1;window.location.href=Util.casUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href})}}function deal402(){if(trigger402=!0,"undefined"!=typeof window)return window.parent&&window.parent!==window?(window.parent.postMessage("http_status_402","*"),!1):void(window.location.href=Util.casLogoutUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href,params:"&code=402"}))}export default Ajax;
//# sourceMappingURL=ajax.js.map
