import _notification from"antd/es/notification";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var n={};for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]]);return n};import MobileGlobalIndicator from"@baifendian/adhere-mobile-ui-globalindicator";import GlobalIndicator from"@baifendian/adhere-ui-globalindicator";import Util from"@baifendian/adhere-util";import intl from"@baifendian/adhere-util-intl";var errorInfoHandler,warnInfoHandler,trigger402=!1,notificationThrottlingTime=300,Interceptors=function(){function e(){this.requestInterceptors=new Set,this.responseInterceptors=new Set}return e.prototype.addRequest=function(e){var t=this;return Array.isArray(e)?(e.forEach(function(e){t.requestInterceptors.add(e)}),this.requestInterceptors):this.requestInterceptors.add(e)},e.prototype.addResponse=function(e){var t=this;return Array.isArray(e)?(e.forEach(function(e){t.responseInterceptors.add(e)}),this.responseInterceptors):this.responseInterceptors.add(e)},e.prototype.remove=function(e){this.requestInterceptors.has(e)?this.requestInterceptors.delete(e):this.responseInterceptors.has(e)&&this.responseInterceptors.delete(e)},e.prototype.requestReducer=function(e){return Array.from(this.requestInterceptors).reduce(function(e,t){return t(e)},e)},e.prototype.responseReducer=function(e){return Array.from(this.responseInterceptors).reduce(function(e,t){return t(e)},e)},e}(),Ajax=function(){function e(e,t,n){this.baseURL=e||"",this.systemManagerBaseURL=t||"",this.config=null!=n?n:{}}return e.prototype.get=function(e){var n=this,r=(e.data,__rest(e,["data"])),o={},e=new Promise(function(e,t){e=(o=sendPrepare.call(n,__assign(__assign(__assign(__assign({},getDefaultConfig.call(n)),n.config),{method:"get"}),r),{resolve:e,reject:t})).xhr;e&&e.send(null)});return __assign(__assign({},o),{promise:e})},e.prototype.post=function(e){return complexRequest.call(this,"post",e)},e.prototype.path=function(e){return complexRequest.call(this,"path",e)},e.prototype.put=function(e){return complexRequest.call(this,"put",e)},e.prototype.delete=function(e){return complexRequest.call(this,"delete",e)},e.TIMEOUT=1e6,e.STATUS_SUCCESS_CODES=[200,201,202,203,204,205,206,207,208,226],e.STATUS_REDIRECT_CODES=[300,301,302,303,304,305,306,307,308],e.READY_STATE_UNSENT=0,e.READY_STATE_OPENED=1,e.READY_STATE_HEADERS_RECEIVED=2,e.READY_STATE_LOADING=3,e.READY_STATE_DONE=4,e.CONTENT_TYPE_APPLICATION_JSON="application/json",e.CONTENT_TYPE_MULTIPART_FORM_DATA="multipart/form-data",e.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED="application/x-www-form-urlencoded",e.CONTENT_TYPE_TEXT_XML="text/xml",e.CONTENT_TYPE_APPLICATION_XML="application/xml",e.CONTENT_TYPE_TEXT_PLAIN="text/plain",e.interceptors=new Interceptors,e}();function errorInfo(e,t){errorInfoHandler&&(clearTimeout(errorInfoHandler),errorInfoHandler=null),errorInfoHandler=setTimeout(function(){_notification.error({message:e,description:t})},notificationThrottlingTime)}function warnInfo(e,t){warnInfoHandler&&(clearTimeout(warnInfoHandler),warnInfoHandler=null),warnInfoHandler=setTimeout(function(){_notification.warning({message:e,description:t})},notificationThrottlingTime)}function createXHR(){return new XMLHttpRequest}function getDefaultConfig(){var t=this;return{timeout:Ajax.TIMEOUT,withCredentials:!0,onLoad:function(){},onLoadsStart:function(){},onLoadend:function(){},onProgress:function(){},onTimeout:function(){warnInfo(intl.v("提示"),intl.v("请求超时"))},onAbort:function(){warnInfo(intl.v("提示"),intl.v("请求终止"))},onError:function(){errorInfo(intl.v("提示"),intl.v("请求发生错误"))},interceptor:function(e){switch(e.status){case 401:deal401.call(t);break;case 402:deal402.call(t);break;default:errorInfo(intl.v("提示"),intl.v("已提出请求，但未收到任何回复"))}},mock:!1,loading:{show:!1,text:"",el:document.body,zIndex:19999,size:"default"},onBeforeResponse:function(){},dataKey:"data",messageKey:"message",codeKey:"code",codeSuccess:200,showWarn:!0,responseType:""}}function initXhrEvents(e){var t=e.xhr,n=e.events,r=e.reject,o=n.onTimeout,e=n.onLoadsStart,a=n.onProgress,i=n.onAbort,s=n.onError,c=n.onLoad,n=n.onLoadend;o&&t.addEventListener("timeout",function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];o.apply(void 0,null!=e?e:{}),r.apply(void 0,null!=e?e:{})}),i&&t.addEventListener("abort",function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i.apply(void 0,null!=e?e:{}),r.apply(void 0,null!=e?e:{})}),s&&t.addEventListener("error",function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];s.apply(void 0,null!=e?e:{}),r.apply(void 0,null!=e?e:{})}),e&&t.addEventListener("loadstart",e),a&&t.addEventListener("progress",a),c&&t.addEventListener("load",c),n&&t.addEventListener("loadend",n)}function resolveData(e){var e=Ajax.interceptors.responseReducer(e),t=e.show,n=e.terminal,r=e.data,o=e.indicator,e=e.xhr,a=getGlobalIndicator(n);return __assign({xhr:e,data:r},t?{hideIndicator:function(){return a.hide(o)}}:{})}function onreadystatechange(e){var t,n,r=e.xhr,o=e.interceptor,a=e.loading,i=a.show,s=a.indicator,a=a.terminal,c=e.business,d=c.messageKey,l=c.codeKey,u=c.codeSuccess,c=c.showWarn,p=e.resolve,e=e.reject,f=getGlobalIndicator(a);r.readyState===Ajax.READY_STATE_DONE&&(200<=r.status&&r.status<300||304===r.status?-1!==(t=r.getResponseHeader("Content-type")).indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)?(n=JSON.parse(r.responseText),c&&l in n&&n[l]!==u&&warnInfo(intl.v("提示"),n[d]),p(resolveData({show:i,terminal:a,data:n,indicator:s,xhr:r}))):[Ajax.CONTENT_TYPE_TEXT_XML,Ajax.CONTENT_TYPE_TEXT_XML].includes(t)?p(resolveData({show:i,terminal:a,data:r.responseXML,indicator:s,xhr:r})):p(resolveData({show:i,terminal:a,data:r.response,indicator:s,xhr:r})):(o({status:r.status,statusText:r.statusText,response:r.response,responseText:r.responseText}),e({status:r.status,statusText:r.statusText,response:r.response,responseText:r.responseText}),i&&s&&f.hide(s)))}function isMultipartFormData(e){return e&&"form"in e&&"data"in e&&!Util.isEmpty(e.form)&&!Util.isEmpty(e.data)&&e.form instanceof HTMLFormElement}function getGlobalIndicator(e){return"pc"===e?GlobalIndicator:MobileGlobalIndicator}function sendPrepare(e,t){var n,r=e.method,e=__rest(e,["method"]),o=t.resolve,t=t.reject,e=Ajax.interceptors.requestReducer(e),a=e.path,i=e.headers,s=e.data,c=e.mock,d=e.loading,l=(e.onBeforeResponse,e.dataKey),l=void 0===l?"data":l,u=e.messageKey,u=void 0===u?"message":u,p=e.codeKey,p=void 0===p?"code":p,f=e.codeSuccess,f=void 0===f?200:f,T=e.showWarn,T=void 0===T||T,e=__rest(e,["path","headers","data","mock","loading","onBeforeResponse","dataKey","messageKey","codeKey","codeSuccess","showWarn"]),_="".concat(intl.v("加载中"),"..."),h=d.show,m=void 0!==h&&h,h=d.text,h=void 0===h?_:h,g=d.el,g=void 0===g?document.body:g,y=d.zIndex,y=void 0===y?19999:y,E=d.size,E=void 0===E?"default":E,d=d.terminal,d=void 0===d?"pc":d,v=getGlobalIndicator(d);if(m&&(n=v.show(g||document.body,h||_,y,E)),c)return setTimeout(function(){o(m?{data:a,hideIndicator:function(){v.hide(n)}}:a)},200),{xhr:null,contentType:""};var g=this.baseURL,h=this.config,_=Object.assign(getDefaultConfig.call(this),h,e),y=_.timeout,E=_.withCredentials,c=_.responseType,h=_.interceptor,e=__rest(_,["timeout","withCredentials","responseType","interceptor"]),I=createXHR(),_=(I.open(r,"".concat(g,"/").concat(a),!0),I.timeout=y,I.withCredentials=E,I.responseType=c||"","");if(!Util.isEmpty(i)&&Util.isObject(i))for(var O in"Content-Type"in i||isMultipartFormData(s)||(i["Content-Type"]="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8")),_=null!=(g=i["Content-Type"])?g:"",i)I.setRequestHeader(O,i[O]);else!Util.isEmpty(s)&&Util.isRef(s)&&"get"!==r&&(isMultipartFormData(s)?_=Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA:(_="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"),I.setRequestHeader("Content-Type","".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"))));return initXhrEvents({xhr:I,events:e,reject:t}),I.onreadystatechange=onreadystatechange.bind(this,{xhr:I,interceptor:h,loading:{show:m,terminal:d,indicator:n},business:{dataKey:l,messageKey:u,codeKey:p,codeSuccess:f,showWarn:T},resolve:o,reject:t}),{xhr:I,contentType:_}}function getSendParams(e){var n,r=e.data,t=e.contentType,t=void 0===t?"":t,e=e.customSendJSONStringify;if(t.startsWith(Ajax.CONTENT_TYPE_APPLICATION_JSON)&&Util.isRef(r))return e?JSON.stringify(r,e):JSON.stringify(r);if(t.startsWith(Ajax.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED)&&Util.isObject(r))return Array.from(Object.keys(r)).map(function(e){return"".concat(e,"=").concat(encodeURIComponent(r[e]))}).join("&");if(Util.isObject(r)&&isMultipartFormData(r))return n=new FormData(r.form),Array.from(Object.keys(r.data)).forEach(function(t){var e=r.data[t];e instanceof Function?n.append(t,e()):Array.isArray(e)?e.forEach(function(e){n.append(t,e)}):n.append(t,e)}),n;if(t.startsWith(Ajax.CONTENT_TYPE_TEXT_PLAIN)){if(Util.isString(r))return r;if(Util.isObject(r))return e?JSON.stringify(r,e):JSON.stringify(r)}return null==(t=null==r?void 0:r.toString)?void 0:t.call(r)}function complexRequest(n,r){var o=this,a={},e=new Promise(function(e,t){e=(a=sendPrepare.call(o,__assign(__assign(__assign(__assign({},getDefaultConfig.call(o)),o.config),{method:n}),r),{resolve:e,reject:t})).xhr,t=a.contentType;e&&e.send(getSendParams.call(o,{data:r.data,contentType:t,customSendJSONStringify:r.customSendJSONStringify}))});return __assign(__assign({},a),{promise:e})}function deal401(){if("undefined"!=typeof window){if(window.top&&window.top!==window&&window.top.postMessage("http_status_401","*"),trigger402)return!1;window.location.href=Util.casUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href,defaultLocal:"zh_CN"})}}function deal402(){if(trigger402=!0,"undefined"!=typeof window)return window.parent&&window.parent!==window?(window.parent.postMessage("http_status_402","*"),!1):void(window.location.href=Util.casLogoutUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href,params:"&code=402"}))}export default Ajax;
//# sourceMappingURL=ajax.js.map
