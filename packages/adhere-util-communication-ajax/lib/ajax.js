"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var o in t=arguments[a])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var a={};for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(a[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(a[o[n]]=e[o[n]]);return a},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var antd_1=require("antd"),adhere_util_1=__importDefault(require("@baifendian/adhere-util")),adhere_util_intl_1=__importDefault(require("@baifendian/adhere-util-intl")),adhere_ui_globalindicator_1=__importDefault(require("@baifendian/adhere-ui-globalindicator")),trigger402=!1;function errorInfo(e,t){antd_1.notification.error({message:e,description:t})}function warnInfo(e,t){antd_1.notification.warn({message:e,description:t})}function createXHR(){return new XMLHttpRequest}function getDefaultConfig(){var t=this;return{timeout:Ajax.TIMEOUT,withCredentials:!0,onLoad:function(){},onLoadsStart:function(){},onLoadend:function(){},onProgress:function(){},onTimeout:function(){warnInfo(adhere_util_intl_1.default.v("提示"),adhere_util_intl_1.default.v("请求超时"))},onAbort:function(){warnInfo(adhere_util_intl_1.default.v("提示"),adhere_util_intl_1.default.v("请求终止"))},onError:function(){errorInfo(adhere_util_intl_1.default.v("提示"),adhere_util_intl_1.default.v("请求发生错误"))},interceptor:function(e){switch(e.status){case 401:deal401.call(t);break;case 402:deal402.call(t)}},loading:{show:!1,text:"",el:document.body}}}function initXhrEvents(e,t){var a=t.onTimeout,n=t.onLoadsStart,o=t.onProgress,r=t.onAbort,i=t.onError,s=t.onLoad,t=t.onLoadend;a&&e.addEventListener("timeout",a),n&&e.addEventListener("loadstart",n),o&&e.addEventListener("progress",o),r&&e.addEventListener("abort",r),i&&e.addEventListener("error",i),s&&e.addEventListener("load",s),t&&e.addEventListener("loadend",t)}function resolveData(e){var t=e.show,a=e.data,n=e.indicator;return t?{data:a,hideIndicator:function(){adhere_ui_globalindicator_1.default.hide(n)}}:a}function onreadystatechange(e){var t=e.xhr,a=e.interceptor,n=e.loading,o=n.show,r=n.indicator,i=e.business,s=i.messageKey,d=i.codeKey,l=i.codeSuccess,_=i.showWarn,u=e.resolve,c=e.reject,f=t.status,T=t.readyState,p=t.statusText,n=t.response,i=t.responseText;T===Ajax.READY_STATE_DONE&&(200<=f&&f<300||304===f?-1!==(e=t.getResponseHeader("Content-type")).indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)?(T=JSON.parse(t.responseText),_&&T[d]!==l&&warnInfo(adhere_util_intl_1.default.v("提示"),T[s]),u(resolveData({show:o,data:T,indicator:r}))):[Ajax.CONTENT_TYPE_TEXT_XML,Ajax.CONTENT_TYPE_TEXT_XML].includes(e)?u(resolveData({show:o,data:t.responseXML,indicator:r})):u(resolveData({show:o,data:t.response,indicator:r})):(errorInfo(adhere_util_intl_1.default.v("提示"),adhere_util_intl_1.default.v("已提出请求，但未收到任何回复")),a({status:f,statusText:p,response:n,responseText:i}),f&&c({status:f,statusText:p,response:n,responseText:i}),o&&r&&adhere_ui_globalindicator_1.default.hide(r)))}function sendPrepare(e,t){var a,n=t.resolve,o=t.reject,r=e.method,i=e.path,s=e.headers,d=e.data,l=e.mock,_=e.loading,u=(e.onBeforeResponse,e.dataKey),c=void 0===u?"data":u,f=e.messageKey,T=void 0===f?"message":f,p=e.codeKey,h=void 0===p?"code":p,t=e.codeSuccess,u=void 0===t?200:t,f=e.showWarn,p=void 0===f||f,t=__rest(e,["method","path","headers","data","mock","loading","onBeforeResponse","dataKey","messageKey","codeKey","codeSuccess","showWarn"]),f=adhere_util_intl_1.default.v("加载中")+"...",e=_.show,E=void 0!==e&&e,e=_.text,e=void 0===e?f:e,_=_.el,_=void 0===_?document.body:_;if(E&&(a=adhere_ui_globalindicator_1.default.show(_||document.body,e||f)),l)return setTimeout(function(){n(E?{data:i,hideIndicator:function(){adhere_ui_globalindicator_1.default.hide(a)}}:i)},200),{xhr:null,contentType:""};var _=this.baseURL,e=this.config,f=Object.assign(getDefaultConfig.call(this),e,t),l=f.timeout,e=f.withCredentials,t=f.interceptor,f=__rest(f,["timeout","withCredentials","interceptor"]),g=createXHR();g.open(r,_+"/"+i,!0),g.timeout=l,g.withCredentials=e;e="";if(!adhere_util_1.default.isEmpty(s)&&adhere_util_1.default.isObject(s))for(var O in"Content-type"in s||"get"===r||(s["Content-Type"]=Ajax.CONTENT_TYPE_APPLICATION_JSON+";charset=utf-8",e=s["Content-Type"],console.log("设置了header，但是没有设置Content-Type",Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA)),s)g.setRequestHeader(O,s[O]);else!adhere_util_1.default.isEmpty(d)&&adhere_util_1.default.isRef(d)&&"get"!==r&&("form"in d&&"data"in d&&!adhere_util_1.default.isEmpty(d.form)&&!adhere_util_1.default.isEmpty(d.data)&&d.form instanceof HTMLFormElement?(console.log("有formData不需要设置Content-Type"),e=Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA):(console.log("默认设置Content-Type",Ajax.CONTENT_TYPE_APPLICATION_JSON+";charset=utf-8"),e=Ajax.CONTENT_TYPE_APPLICATION_JSON+";charset=utf-8",g.setRequestHeader("Content-Type",Ajax.CONTENT_TYPE_APPLICATION_JSON+";charset=utf-8")));return initXhrEvents(g,f),g.onreadystatechange=onreadystatechange.bind(this,{xhr:g,interceptor:t,loading:{show:E,indicator:a},business:{dataKey:c,messageKey:T,codeKey:h,codeSuccess:u,showWarn:p},resolve:n,reject:o}),{xhr:g,contentType:e}}function getSendParams(e){var t=e.data,e=(e=e.contentType)||"";if(console.log("getSendParams",t,e),0===e.indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)&&adhere_util_1.default.isRef(t))return console.log("数据需要被转换成JSON字符串",JSON.stringify(t)),JSON.stringify(t);if(0===e.indexOf(Ajax.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED)&&adhere_util_1.default.isObject(t))return console.log("application/x-www-form-urlencoded转换",JSON.stringify(t)),Array.from(Object.keys(t)).map(function(e){return encodeURIComponent(e+"="+t[e])}).join("&");if(0===e.indexOf(Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA)&&adhere_util_1.default.isObject(t)){console.log("multipart/form-data转换"),console.log("form",t.form);var a=new FormData(t.form);return Array.from(Object.keys(t.data)).forEach(function(e){a.append(e,t.data[e]),console.log(e,t.data[e])}),a}}function complexRequest(a,n){var o=this;return new Promise(function(e,t){e=sendPrepare.call(o,__assign(__assign(__assign({},getDefaultConfig.call(o)),{method:a}),n),{resolve:e,reject:t}),t=e.xhr,e=e.contentType;t&&t.send(getSendParams.call(o,{data:n.data,contentType:e}))})}function deal401(){if(window.top&&window.top!==window&&window.top.postMessage("http_status_401","*"),trigger402)return!1;window.location.href=adhere_util_1.default.casUrl({baseUrl:this.systemManagerBaseUrl,enterUrl:window.location.href})}function deal402(){if(trigger402=!0,window.parent&&window.parent!==window)return window.parent.postMessage("http_status_402","*"),!1;window.location.href=adhere_util_1.default.casLogoutUrl({baseUrl:this.systemManagerBaseUrl,enterUrl:window.location.href,params:"&code=402"})}var Ajax=function(){function e(e,t,a){this.baseURL=e||"",this.systemManagerBaseURL=t||"",this.config=a||{}}return e.prototype.get=function(e){var a=this,n=(e.data,__rest(e,["data"]));return new Promise(function(e,t){t=sendPrepare.call(a,__assign(__assign(__assign({},getDefaultConfig.call(a)),{method:"get"}),n),{resolve:e,reject:t}).xhr;t&&t.send(null)})},e.prototype.post=function(e){return complexRequest.call(this,"post",e)},e.prototype.path=function(e){return complexRequest.call(this,"path",e)},e.prototype.put=function(e){return complexRequest.call(this,"put",e)},e.prototype.delete=function(e){return complexRequest.call(this,"delete",e)},e.TIMEOUT=1e6,e.STATUS_SUCCESS_CODES=[200,201,202,203,204,205,206,207,208,226],e.STATUS_REDIRECT_CODES=[300,301,302,303,304,305,306,307,308],e.READY_STATE_UNSENT=0,e.READY_STATE_OPENED=1,e.READY_STATE_HEADERS_RECEIVED=2,e.READY_STATE_LOADING=3,e.READY_STATE_DONE=4,e.CONTENT_TYPE_APPLICATION_JSON="application/json",e.CONTENT_TYPE_MULTIPART_FORM_DATA="multipart/form-data",e.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED="application/x-www-form-urlencoded",e.CONTENT_TYPE_TEXT_XML="text/xml",e.CONTENT_TYPE_APPLICATION_XML="application/xml",e.CONTENT_TYPE_TEXT_PLAIN="text/plain",e}();exports.default=Ajax;
//# sourceMappingURL=ajax.js.map
