"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var l in t=arguments[n])Object.prototype.hasOwnProperty.call(t,l)&&(e[l]=t[l]);return e}).apply(this,arguments)},__createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){e[r=void 0===r?n:r]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var react_1=__importStar(require("react")),prop_types_1=__importDefault(require("prop-types")),classnames_1=__importDefault(require("classnames")),debounce_1=__importDefault(require("lodash/debounce")),resize_observer_1=require("@juggle/resize-observer"),types_1=require("./types"),selectorPrefix="adhere-ui-writingboard";function WritingBoard(n,e){var r=react_1.useRef(null),i=react_1.useRef(null),u=react_1.useRef(null),l=react_1.useRef(null),o=react_1.useRef(null),d=react_1.useRef(null),c=react_1.useRef(n.defaultMode),v=react_1.useRef(n.defaultLineWidth),a=react_1.useRef(n.defaultStrokeStyle),s=react_1.useRef([]),t=react_1.useRef(0),h=react_1.useRef(new Map([[types_1.Mode.FREE,{draw:function(e){var t=e.sourcePoint,n=e.targetPoint;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.moveTo(t.x,t.y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.lineTo(n.x,n.y),s.current.push({shape:c.current,sourcePoint:t,targetPoint:n}),f({lineWidth:null==v?void 0:v.current,strokeStyle:null==a?void 0:a.current}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},drawStack:function(e){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(e.sourcePoint.x,e.sourcePoint.y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(e.targetPoint.x,e.targetPoint.y),f({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.stroke()},mouseup:function(e){x({sourcePoint:d.current,targetPoint:e})}}],[types_1.Mode.LINE,{draw:function(e){var t,n,r=e.targetPoint;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.clearRect(0,0,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.width,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.height),g(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.x,null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.y),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.lineTo(r.x,r.y),f({lineWidth:null==v?void 0:v.current,strokeStyle:null==a?void 0:a.current}),null!==(r=null==u?void 0:u.current)&&void 0!==r&&r.stroke()},drawStack:function(e){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(e.sourcePoint.x,e.sourcePoint.y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(e.targetPoint.x,e.targetPoint.y),f({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.stroke()},mouseup:function(e){var t;s.current.push({shape:c.current,lineWidth:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.lineWidth,strokeStyle:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.strokeStyle,sourcePoint:o.current,targetPoint:e})}}],[types_1.Mode.RECTANGLE,{draw:function(e){var t,n,r=e.targetPoint;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.clearRect(0,0,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.width,null===(l=null==i?void 0:i.current)||void 0===l?void 0:l.height),g(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath();var l=P({startPoint:o.current,targetPoint:r});null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.rect(l.x,l.y,Math.abs(r.x-(null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.x)),Math.abs(r.y-(null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.y))),f({lineWidth:null==v?void 0:v.current,strokeStyle:null==a?void 0:a.current}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},drawStack:function(e){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.rect(e.x,e.y,e.width,e.height),f({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.stroke()},mouseup:function(e){var t,n=P({startPoint:o.current,targetPoint:e});s.current.push({shape:c.current,lineWidth:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.lineWidth,strokeStyle:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.strokeStyle,x:n.x,y:n.y,width:Math.abs(e.x-(null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.x)),height:Math.abs(e.y-(null===(e=null==o?void 0:o.current)||void 0===e?void 0:e.y))})}}],[types_1.Mode.CIRCLE,{draw:function(e){var t=e.targetPoint;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.clearRect(0,0,null===(r=null==i?void 0:i.current)||void 0===r?void 0:r.width,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.height),g(),null!==(r=null==u?void 0:u.current)&&void 0!==r&&r.beginPath();var n=P({startPoint:o.current,targetPoint:t}),r=_({p2:t,p1:o.current});null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.ellipse(n.x,n.y,r,r,45*Math.PI/180,0,2*Math.PI),f({lineWidth:null==v?void 0:v.current,strokeStyle:null==a?void 0:a.current}),null!==(r=null==u?void 0:u.current)&&void 0!==r&&r.stroke()},drawStack:function(e){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.ellipse(e.x,e.y,e.radiusX,e.radiusY,e.rotation,e.startAngle,e.endAngle),f({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.stroke()},mouseup:function(e){var t=P({startPoint:o.current,targetPoint:e}),n=_({p2:e,p1:null==o?void 0:o.current});s.current.push({shape:c.current,lineWidth:null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.lineWidth,strokeStyle:null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.strokeStyle,x:t.x,y:t.y,radiusX:n,radiusY:n,rotation:45*Math.PI/180,startAngle:0,endAngle:2*Math.PI})}}],[types_1.Mode.TRIANGLE,{draw:function(e){var t=e.targetPoint;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.clearRect(0,0,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.width,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.height),g(),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.beginPath();var n=y({startPoint:o.current,targetPoint:t});null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(n[0].x,n[0].y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(n[1].x,n[1].y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(n[2].x,n[2].y),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.closePath(),f({lineWidth:null==v?void 0:v.current,strokeStyle:null==a?void 0:a.current}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},drawStack:function(e){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(e.points[0].x,e.points[0].y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(e.points[1].x,e.points[1].y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(e.points[2].x,e.points[2].y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.closePath(),f({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.stroke()},mouseup:function(e){var t=y({startPoint:o.current,targetPoint:e});s.current.push({shape:c.current,lineWidth:null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.lineWidth,strokeStyle:null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.strokeStyle,points:t})}}],[types_1.Mode.RUBBER,{draw:function(e){var t=e.sourcePoint,n=e.targetPoint;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.moveTo(t.x,t.y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.lineTo(n.x,n.y),s.current.push({shape:c.current,sourcePoint:t,targetPoint:n}),u.current.lineWidth=15,u.current.strokeStyle="#fff",u.current.lineCap="round",u.current.lineJoin="round",null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},drawStack:function(e){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(e.sourcePoint.x,e.sourcePoint.y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(e.targetPoint.x,e.targetPoint.y),u.current.lineWidth=15,u.current.strokeStyle="#fff",u.current.lineCap="round",u.current.lineJoin="round",null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.stroke()},mouseup:function(e){x({sourcePoint:d.current,targetPoint:e})}}]]));function f(e){var t=e.lineWidth,e=e.strokeStyle;u.current.lineWidth=t,u.current.strokeStyle=e,u.current.lineCap="round",u.current.lineJoin="round"}function y(e){var t=e.startPoint,n=e.targetPoint,r=P({startPoint:t,targetPoint:n}),e=Math.abs(n.x-t.x),t=Math.abs(n.y-t.y);return[{x:r.x,y:r.y+t},{x:r.x+e/2,y:r.y},{x:r.x+e,y:r.y+t}]}function p(e){var t=e.clientX,n=e.clientY,e=null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.getBoundingClientRect();return{x:t-e.x,y:n-e.y}}function _(e){var t=e.p1,n=e.p2,r=t.x,e=t.y,t=n.x,n=n.y;return Math.sqrt(Math.pow(t-r,2)+Math.pow(n-e,2))}function g(){for(var e=0;e<s.current.length;e++){var t=s.current[e];h.current.get(t.shape).drawStack(t)}}function P(e){var t=e.startPoint,e=e.targetPoint;return e.x<=t.x&&e.y<=t.y?e:e.x<=t.x&&e.y>=t.y?{x:e.x,y:t.y}:e.x>=t.x&&e.y<=t.y?{x:t.x,y:e.y}:e.x>=t.x&&e.y>=t.y?t:void 0}function x(e){var t=e.sourcePoint,n=e.targetPoint;(null===(e=null==h?void 0:h.current)||void 0===e?void 0:e.get(c.current)).draw({sourcePoint:t,targetPoint:n})}function m(e){R(e)}function k(e){R(__assign(__assign({},e),{clientX:e.targetTouches[0].clientX,clientY:e.targetTouches[0].clientY}))}function S(e){w(e)}function b(e){w(__assign(__assign({},e),{clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY}))}function W(e){var t=e.clientX,e=e.clientY;o.current=d.current=p({clientX:t,clientY:e}),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.addEventListener("mousemove",m),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.addEventListener("mouseup",S),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.addEventListener("touchmove",k),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.addEventListener("touchend",b)}function R(e){e=p({clientX:e.clientX,clientY:e.clientY});x({sourcePoint:d.current,targetPoint:e}),d.current=e}function w(e){var t=p({clientX:e.clientX,clientY:e.clientY});null!==(e=null==h?void 0:h.current.get(c.current))&&void 0!==e&&e.mouseup(t),o.current=null,(d.current=null)!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("mousemove",m),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("mouseup",S),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("touchmove",k),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("touchend",b)}function M(){var e;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.clearRect(0,0,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.width,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.height),d.current=o.current=null,s.current=[],t.current=0}return react_1.useImperativeHandle(e,function(){return{setMode:function(e){c.current=e},setStrokeStyle:function(e){a.current=e},setLineWidth:function(e){v.current=e},clear:M,toDataURL:function(){var e;return null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.toDataURL("image/png",1)}}}),react_1.useLayoutEffect(function(){var e;u.current=null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.getContext("2d");var t=debounce_1.default(function(){var e;i.current.width=null===(e=null==r?void 0:r.current)||void 0===e?void 0:e.offsetWidth,i.current.height=null===(e=null==r?void 0:r.current)||void 0===e?void 0:e.offsetHeight,null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.clearRect(0,0,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.width,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.height),g()},n.resizeTime);return l.current=new resize_observer_1.ResizeObserver(t),null!==(t=null===(e=null==l?void 0:l.current)||void 0===e?void 0:e.observe)&&void 0!==t&&t.call(e,document.body),function(){var e;return null===(e=null==l?void 0:l.current)||void 0===e?void 0:e.disconnect()}},[]),react_1.useLayoutEffect(function(){var e;function t(e){W(e)}function n(e){W(__assign(__assign({},e),{clientX:e.targetTouches[0].clientX,clientY:e.targetTouches[0].clientY}))}return null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.addEventListener("mousedown",t),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.addEventListener("touchstart",n),function(){var e;null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("mousedown",t),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("touchstart",n)}},[]),react_1.default.createElement("div",{ref:r,className:classnames_1.default(selectorPrefix,n.className||""),style:n.style||{}},react_1.default.createElement("canvas",{ref:i}))}var Wrap=react_1.forwardRef(WritingBoard);Wrap.defaultProps={className:"",style:{},defaultMode:types_1.Mode.FREE,defaultStrokeStyle:"#000",defaultLineWidth:2,resizeTime:300},Wrap.propTypes={className:prop_types_1.default.string,style:prop_types_1.default.object,defaultMode:prop_types_1.default.string.isRequired,defaultStrokeStyle:prop_types_1.default.string.isRequired,defaultLineWidth:prop_types_1.default.number.isRequired,resizeTime:prop_types_1.default.number.isRequired},exports.default=Wrap;
//# sourceMappingURL=writingboard.js.map
