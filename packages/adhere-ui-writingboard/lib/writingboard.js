"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var l in e=arguments[n])Object.prototype.hasOwnProperty.call(e,l)&&(t[l]=e[l]);return t}).apply(this,arguments)},__createBinding=this&&this.__createBinding||(Object.create?function(t,e,n,r){void 0===r&&(r=n),Object.defineProperty(t,r,{enumerable:!0,get:function(){return e[n]}})}:function(t,e,n,r){t[r=void 0===r?n:r]=e[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)"default"!==n&&Object.hasOwnProperty.call(t,n)&&__createBinding(e,t,n);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});var react_1=__importStar(require("react")),prop_types_1=__importDefault(require("prop-types")),classnames_1=__importDefault(require("classnames")),types_1=require("./types"),selectorPrefix="adhere-ui-writingboard";function WritingBoard(t,e){var r=react_1.useRef(null),u=react_1.useRef(null),i=react_1.useRef(null),o=react_1.useRef(null),n=react_1.useRef(null),l=react_1.useRef(t.defaultMode),d=react_1.useRef(t.defaultLineWidth),c=react_1.useRef(t.defaultStrokeStyle),v=react_1.useRef([]),a=react_1.useRef(0),s=react_1.useRef(new Map([[types_1.Mode.FREE,{draw:function(t){var e=t.sourcePoint,n=t.targetPoint;null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.beginPath(),null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.moveTo(e.x,e.y),null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.lineTo(n.x,n.y),v.current.push({shape:l.current,sourcePoint:e,targetPoint:n}),console.log("Draw Mode.Free",null==d?void 0:d.current,null==c?void 0:c.current),h({lineWidth:null==d?void 0:d.current,strokeStyle:null==c?void 0:c.current}),null!==(n=null==i?void 0:i.current)&&void 0!==n&&n.stroke()},drawStack:function(t){var e;null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.beginPath(),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.moveTo(t.sourcePoint.x,t.sourcePoint.y),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.lineTo(t.targetPoint.x,t.targetPoint.y),console.log("DrawStack Mode.Free",t.lineWidth,t.strokeStyle),h({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.stroke()},mouseup:function(t){P({sourcePoint:n.current,targetPoint:t})}}],[types_1.Mode.LINE,{draw:function(t){var e,n,r=t.targetPoint;null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.clearRect(0,0,null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.width,null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.height),g(),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.beginPath(),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.moveTo(null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.x,null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.y),null!==(n=null==i?void 0:i.current)&&void 0!==n&&n.lineTo(r.x,r.y),h({lineWidth:null==d?void 0:d.current,strokeStyle:null==c?void 0:c.current}),null!==(r=null==i?void 0:i.current)&&void 0!==r&&r.stroke()},drawStack:function(t){var e;null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.beginPath(),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.moveTo(t.sourcePoint.x,t.sourcePoint.y),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.lineTo(t.targetPoint.x,t.targetPoint.y),h({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.stroke()},mouseup:function(t){var e;v.current.push({shape:l.current,lineWidth:null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.lineWidth,strokeStyle:null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.strokeStyle,sourcePoint:o.current,targetPoint:t})}}],[types_1.Mode.RECTANGLE,{draw:function(t){var e,n,r=t.targetPoint;null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.clearRect(0,0,null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.width,null===(l=null==u?void 0:u.current)||void 0===l?void 0:l.height),g(),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.beginPath();var l=_({startPoint:o.current,targetPoint:r});null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.rect(l.x,l.y,Math.abs(r.x-(null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.x)),Math.abs(r.y-(null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.y))),h({lineWidth:null==d?void 0:d.current,strokeStyle:null==c?void 0:c.current}),null!==(n=null==i?void 0:i.current)&&void 0!==n&&n.stroke()},drawStack:function(t){var e;null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.beginPath(),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.rect(t.x,t.y,t.width,t.height),h({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.stroke()},mouseup:function(t){var e,n=_({startPoint:o.current,targetPoint:t});v.current.push({shape:l.current,lineWidth:null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.lineWidth,strokeStyle:null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.strokeStyle,x:n.x,y:n.y,width:Math.abs(t.x-(null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.x)),height:Math.abs(t.y-(null===(t=null==o?void 0:o.current)||void 0===t?void 0:t.y))})}}],[types_1.Mode.CIRCLE,{draw:function(t){var e=t.targetPoint;null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.clearRect(0,0,null===(r=null==u?void 0:u.current)||void 0===r?void 0:r.width,null===(n=null==u?void 0:u.current)||void 0===n?void 0:n.height),g(),null!==(r=null==i?void 0:i.current)&&void 0!==r&&r.beginPath();var n=_({startPoint:o.current,targetPoint:e}),r=p({p2:e,p1:o.current});null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.ellipse(n.x,n.y,r,r,45*Math.PI/180,0,2*Math.PI),h({lineWidth:null==d?void 0:d.current,strokeStyle:null==c?void 0:c.current}),null!==(r=null==i?void 0:i.current)&&void 0!==r&&r.stroke()},drawStack:function(t){var e;null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.beginPath(),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.ellipse(t.x,t.y,t.radiusX,t.radiusY,t.rotation,t.startAngle,t.endAngle),h({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.stroke()},mouseup:function(t){var e=_({startPoint:o.current,targetPoint:t}),n=p({p2:t,p1:null==o?void 0:o.current});v.current.push({shape:l.current,lineWidth:null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.lineWidth,strokeStyle:null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.strokeStyle,x:e.x,y:e.y,radiusX:n,radiusY:n,rotation:45*Math.PI/180,startAngle:0,endAngle:2*Math.PI})}}],[types_1.Mode.TRIANGLE,{draw:function(t){var e=t.targetPoint;null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.clearRect(0,0,null===(n=null==u?void 0:u.current)||void 0===n?void 0:n.width,null===(n=null==u?void 0:u.current)||void 0===n?void 0:n.height),g(),null!==(n=null==i?void 0:i.current)&&void 0!==n&&n.beginPath();var n=f({startPoint:o.current,targetPoint:e});null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.moveTo(n[0].x,n[0].y),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.lineTo(n[1].x,n[1].y),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.lineTo(n[2].x,n[2].y),null!==(n=null==i?void 0:i.current)&&void 0!==n&&n.closePath(),h({lineWidth:null==d?void 0:d.current,strokeStyle:null==c?void 0:c.current}),null!==(n=null==i?void 0:i.current)&&void 0!==n&&n.stroke()},drawStack:function(t){var e;null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.beginPath(),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.moveTo(t.points[0].x,t.points[0].y),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.lineTo(t.points[1].x,t.points[1].y),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.lineTo(t.points[2].x,t.points[2].y),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.closePath(),h({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.stroke()},mouseup:function(t){var e=f({startPoint:o.current,targetPoint:t});v.current.push({shape:l.current,lineWidth:null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.lineWidth,strokeStyle:null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.strokeStyle,points:e})}}],[types_1.Mode.RUBBER,{draw:function(t){var e=t.sourcePoint,n=t.targetPoint;null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.beginPath(),null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.moveTo(e.x,e.y),null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.lineTo(n.x,n.y),v.current.push({shape:l.current,sourcePoint:e,targetPoint:n}),i.current.lineWidth=15,i.current.strokeStyle="#fff",i.current.lineCap="round",i.current.lineJoin="round",null!==(n=null==i?void 0:i.current)&&void 0!==n&&n.stroke()},drawStack:function(t){var e;null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.beginPath(),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.moveTo(t.sourcePoint.x,t.sourcePoint.y),null!==(e=null==i?void 0:i.current)&&void 0!==e&&e.lineTo(t.targetPoint.x,t.targetPoint.y),i.current.lineWidth=15,i.current.strokeStyle="#fff",i.current.lineCap="round",i.current.lineJoin="round",null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.stroke()},mouseup:function(t){P({sourcePoint:n.current,targetPoint:t})}}]]));function h(t){var e=t.lineWidth,t=t.strokeStyle;console.log("callStylelineWidth",e),console.log("callStylestrokeStyle",t),i.current.lineWidth=e,i.current.strokeStyle=t,i.current.lineCap="round",i.current.lineJoin="round"}function f(t){var e=t.startPoint,n=t.targetPoint,r=_({startPoint:e,targetPoint:n}),t=Math.abs(n.x-e.x),e=Math.abs(n.y-e.y);return[{x:r.x,y:r.y+e},{x:r.x+t/2,y:r.y},{x:r.x+t,y:r.y+e}]}function y(t){var e=t.clientX,n=t.clientY,t=null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.getBoundingClientRect();return{x:e-t.x,y:n-t.y}}function p(t){var e=t.p1,n=t.p2,r=e.x,t=e.y,e=n.x,n=n.y;return Math.sqrt(Math.pow(e-r,2)+Math.pow(n-t,2))}function g(){for(var t=0;t<v.current.length;t++){var e=v.current[t];s.current.get(e.shape).drawStack(e)}}function _(t){var e=t.startPoint,t=t.targetPoint;return t.x<=e.x&&t.y<=e.y?t:t.x<=e.x&&t.y>=e.y?{x:t.x,y:e.y}:t.x>=e.x&&t.y<=e.y?{x:e.x,y:t.y}:t.x>=e.x&&t.y>=e.y?e:void 0}function P(t){var e=t.sourcePoint,n=t.targetPoint;(null===(t=null==s?void 0:s.current)||void 0===t?void 0:t.get(l.current)).draw({sourcePoint:e,targetPoint:n})}function x(t){w(t)}function k(t){w(__assign(__assign({},t),{clientX:t.targetTouches[0].clientX,clientY:t.targetTouches[0].clientY}))}function m(t){M(t)}function S(t){M(__assign(__assign({},t),{clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY}))}function W(t){var e=t.clientX,t=t.clientY;o.current=n.current=y({clientX:e,clientY:t}),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("mousemove",x),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("mouseup",m),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("touchmove",k),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("touchend",S)}function w(t){t=y({clientX:t.clientX,clientY:t.clientY});P({sourcePoint:n.current,targetPoint:t}),n.current=t}function M(t){var e=y({clientX:t.clientX,clientY:t.clientY});null!==(t=null==s?void 0:s.current.get(l.current))&&void 0!==t&&t.mouseup(e),o.current=null,(n.current=null)!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("mousemove",x),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("mouseup",m),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("touchmove",k),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("touchend",S)}return react_1.useImperativeHandle(e,function(){return{setMode:function(t){l.current=t},setStrokeStyle:function(t){c.current=t},setLineWidth:function(t){d.current=t},clear:function(){var t;null!==(t=null==i?void 0:i.current)&&void 0!==t&&t.clearRect(0,0,null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.width,null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.height),n.current=o.current=null,v.current=[],a.current=0},toDataURL:function(){var t;return null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.toDataURL("image/png",1)}}}),react_1.useEffect(function(){console.log("lineWidth?.current",null==d?void 0:d.current),console.log("strokeStyle?.current",null==c?void 0:c.current)},[null==d?void 0:d.current,null==c?void 0:c.current]),react_1.useLayoutEffect(function(){var t;i.current=null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.getContext("2d"),u.current.width=null===(t=null==r?void 0:r.current)||void 0===t?void 0:t.offsetWidth,u.current.height=null===(t=null==r?void 0:r.current)||void 0===t?void 0:t.offsetHeight},[]),react_1.useLayoutEffect(function(){var t;function e(t){W(t)}function n(t){W(__assign(__assign({},t),{clientX:t.targetTouches[0].clientX,clientY:t.targetTouches[0].clientY}))}return null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("mousedown",e),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("touchstart",n),function(){var t;null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("mousedown",e),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("touchstart",n)}},[]),react_1.default.createElement("div",{ref:r,className:classnames_1.default(selectorPrefix,t.className||""),style:t.style||{}},react_1.default.createElement("canvas",{ref:u}))}var Wrap=react_1.forwardRef(WritingBoard);Wrap.defaultProps={className:"",style:{},defaultMode:types_1.Mode.FREE,defaultStrokeStyle:"#000",defaultLineWidth:2},Wrap.propTypes={className:prop_types_1.default.string,style:prop_types_1.default.object,defaultMode:prop_types_1.default.string,defaultStrokeStyle:prop_types_1.default.string,defaultLineWidth:prop_types_1.default.number},exports.default=Wrap;
//# sourceMappingURL=writingboard.js.map
