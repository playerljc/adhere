"use strict";var __assign=function(){return(__assign=Object.assign||function(n){for(var t,e=1,r=arguments.length;e<r;e++)for(var l in t=arguments[e])Object.prototype.hasOwnProperty.call(t,l)&&(n[l]=t[l]);return n}).apply(this,arguments)},__createBinding=Object.create?function(n,t,e,r){void 0===r&&(r=e);var l=Object.getOwnPropertyDescriptor(t,e);l&&("get"in l?t.__esModule:!l.writable&&!l.configurable)||(l={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(n,r,l)}:function(n,t,e,r){n[r=void 0===r?e:r]=t[e]},__setModuleDefault=Object.create?function(n,t){Object.defineProperty(n,"default",{enumerable:!0,value:t})}:function(n,t){n.default=t},__importStar=function(n){if(n&&n.__esModule)return n;var t={};if(null!=n)for(var e in n)"default"!==e&&Object.prototype.hasOwnProperty.call(n,e)&&__createBinding(t,n,e);return __setModuleDefault(t,n),t},__importDefault=function(n){return n&&n.__esModule?n:{default:n}},classnames_1=(Object.defineProperty(exports,"__esModule",{value:!0}),__importDefault(require("classnames"))),lodash_debounce_1=__importDefault(require("lodash.debounce")),react_1=__importStar(require("react")),adhere_util_1=__importDefault(require("@baifendian/adhere-util")),resize_observer_1=require("@juggle/resize-observer"),signature_1=__importDefault(require("./signature")),types_1=require("./types"),selectorPrefix="adhere-ui-writing-board",InternalWritingBoard=(0,react_1.memo)((0,react_1.forwardRef)(function(n,t){var e=n.defaultMode,e=void 0===e?types_1.Mode.FREE:e,r=n.defaultLineWidth,r=void 0===r?2:r,l=n.defaultStrokeStyle,l=void 0===l?"#000":l,u=n.resizeTime,i=void 0===u?300:u,o=(0,react_1.useRef)(null),v=(0,react_1.useRef)(null),s=(0,react_1.useRef)(null),c=(0,react_1.useRef)(null),d=(0,react_1.useRef)(null),a=(0,react_1.useRef)(null),h=(0,react_1.useRef)(e),f=(0,react_1.useRef)(r),g=(0,react_1.useRef)(l),y=(0,react_1.useRef)([]),_=(0,react_1.useRef)(0),p=(0,react_1.useRef)(new Map([[types_1.Mode.FREE,{draw:function(n){var t,e=n.sourcePoint,n=n.targetPoint;null!=(t=null==s?void 0:s.current)&&t.beginPath(),null!=(t=null==s?void 0:s.current)&&t.moveTo(e.x,e.y),null!=(t=null==s?void 0:s.current)&&t.lineTo(n.x,n.y),y.current.push({shape:h.current,sourcePoint:e,targetPoint:n}),P({lineWidth:null==f?void 0:f.current,strokeStyle:null==g?void 0:g.current}),null!=(t=null==s?void 0:s.current)&&t.stroke()},drawStack:function(n){var t;null!=(t=null==s?void 0:s.current)&&t.beginPath(),null!=(t=null==s?void 0:s.current)&&t.moveTo(n.sourcePoint.x,n.sourcePoint.y),null!=(t=null==s?void 0:s.current)&&t.lineTo(n.targetPoint.x,n.targetPoint.y),P({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!=(t=null==s?void 0:s.current)&&t.stroke()},mouseup:function(n){w({sourcePoint:a.current,targetPoint:n})}}],[types_1.Mode.LINE,{draw:function(n){var t,n=n.targetPoint;null!=(t=null==s?void 0:s.current)&&t.clearRect(0,0,null==(t=null==v?void 0:v.current)?void 0:t.width,null==(t=null==v?void 0:v.current)?void 0:t.height),b(),null!=(t=null==s?void 0:s.current)&&t.beginPath(),null!=(t=null==s?void 0:s.current)&&t.moveTo(null==(t=null==d?void 0:d.current)?void 0:t.x,null==(t=null==d?void 0:d.current)?void 0:t.y),null!=(t=null==s?void 0:s.current)&&t.lineTo(n.x,n.y),P({lineWidth:null==f?void 0:f.current,strokeStyle:null==g?void 0:g.current}),null!=(t=null==s?void 0:s.current)&&t.stroke()},drawStack:function(n){var t;null!=(t=null==s?void 0:s.current)&&t.beginPath(),null!=(t=null==s?void 0:s.current)&&t.moveTo(n.sourcePoint.x,n.sourcePoint.y),null!=(t=null==s?void 0:s.current)&&t.lineTo(n.targetPoint.x,n.targetPoint.y),P({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!=(t=null==s?void 0:s.current)&&t.stroke()},mouseup:function(n){var t;y.current.push({shape:h.current,lineWidth:null==(t=null==s?void 0:s.current)?void 0:t.lineWidth,strokeStyle:null==(t=null==s?void 0:s.current)?void 0:t.strokeStyle,sourcePoint:d.current,targetPoint:n})}}],[types_1.Mode.RECTANGLE,{draw:function(n){var t,n=n.targetPoint,e=(null!=(e=null==s?void 0:s.current)&&e.clearRect(0,0,null==(e=null==v?void 0:v.current)?void 0:e.width,null==(e=null==v?void 0:v.current)?void 0:e.height),b(),null!=(e=null==s?void 0:s.current)&&e.beginPath(),S({startPoint:d.current,targetPoint:n}));null!=(t=null==s?void 0:s.current)&&t.rect(e.x,e.y,Math.abs(n.x-(null==(t=null==d?void 0:d.current)?void 0:t.x)),Math.abs(n.y-(null==(e=null==d?void 0:d.current)?void 0:e.y))),P({lineWidth:null==f?void 0:f.current,strokeStyle:null==g?void 0:g.current}),null!=(t=null==s?void 0:s.current)&&t.stroke()},drawStack:function(n){var t;null!=(t=null==s?void 0:s.current)&&t.beginPath(),null!=(t=null==s?void 0:s.current)&&t.rect(n.x,n.y,n.width,n.height),P({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!=(t=null==s?void 0:s.current)&&t.stroke()},mouseup:function(n){var t,e=S({startPoint:d.current,targetPoint:n});y.current.push({shape:h.current,lineWidth:null==(t=null==s?void 0:s.current)?void 0:t.lineWidth,strokeStyle:null==(t=null==s?void 0:s.current)?void 0:t.strokeStyle,x:e.x,y:e.y,width:Math.abs(n.x-(null==(t=null==d?void 0:d.current)?void 0:t.x)),height:Math.abs(n.y-(null==(e=null==d?void 0:d.current)?void 0:e.y))})}}],[types_1.Mode.CIRCLE,{draw:function(n){var t,n=n.targetPoint,e=(null!=(e=null==s?void 0:s.current)&&e.clearRect(0,0,null==(e=null==v?void 0:v.current)?void 0:e.width,null==(e=null==v?void 0:v.current)?void 0:e.height),b(),null!=(e=null==s?void 0:s.current)&&e.beginPath(),S({startPoint:d.current,targetPoint:n})),n=k({p2:n,p1:d.current});null!=(t=null==s?void 0:s.current)&&t.ellipse(e.x,e.y,n,n,45*Math.PI/180,0,2*Math.PI),P({lineWidth:null==f?void 0:f.current,strokeStyle:null==g?void 0:g.current}),null!=(t=null==s?void 0:s.current)&&t.stroke()},drawStack:function(n){var t;null!=(t=null==s?void 0:s.current)&&t.beginPath(),null!=(t=null==s?void 0:s.current)&&t.ellipse(n.x,n.y,n.radiusX,n.radiusY,n.rotation,n.startAngle,n.endAngle),P({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!=(t=null==s?void 0:s.current)&&t.stroke()},mouseup:function(n){var t,e=S({startPoint:d.current,targetPoint:n}),n=k({p2:n,p1:null==d?void 0:d.current});y.current.push({shape:h.current,lineWidth:null==(t=null==s?void 0:s.current)?void 0:t.lineWidth,strokeStyle:null==(t=null==s?void 0:s.current)?void 0:t.strokeStyle,x:e.x,y:e.y,radiusX:n,radiusY:n,rotation:45*Math.PI/180,startAngle:0,endAngle:2*Math.PI})}}],[types_1.Mode.TRIANGLE,{draw:function(n){var n=n.targetPoint,t=(null!=(t=null==s?void 0:s.current)&&t.clearRect(0,0,null==(t=null==v?void 0:v.current)?void 0:t.width,null==(t=null==v?void 0:v.current)?void 0:t.height),b(),null!=(t=null==s?void 0:s.current)&&t.beginPath(),m({startPoint:d.current,targetPoint:n}));null!=(n=null==s?void 0:s.current)&&n.moveTo(t[0].x,t[0].y),null!=(n=null==s?void 0:s.current)&&n.lineTo(t[1].x,t[1].y),null!=(n=null==s?void 0:s.current)&&n.lineTo(t[2].x,t[2].y),null!=(n=null==s?void 0:s.current)&&n.closePath(),P({lineWidth:null==f?void 0:f.current,strokeStyle:null==g?void 0:g.current}),null!=(t=null==s?void 0:s.current)&&t.stroke()},drawStack:function(n){var t;null!=(t=null==s?void 0:s.current)&&t.beginPath(),null!=(t=null==s?void 0:s.current)&&t.moveTo(n.points[0].x,n.points[0].y),null!=(t=null==s?void 0:s.current)&&t.lineTo(n.points[1].x,n.points[1].y),null!=(t=null==s?void 0:s.current)&&t.lineTo(n.points[2].x,n.points[2].y),null!=(t=null==s?void 0:s.current)&&t.closePath(),P({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!=(t=null==s?void 0:s.current)&&t.stroke()},mouseup:function(n){var t,n=m({startPoint:d.current,targetPoint:n});y.current.push({shape:h.current,lineWidth:null==(t=null==s?void 0:s.current)?void 0:t.lineWidth,strokeStyle:null==(t=null==s?void 0:s.current)?void 0:t.strokeStyle,points:n})}}],[types_1.Mode.RUBBER,{draw:function(n){var t,e=n.sourcePoint,n=n.targetPoint;null!=(t=null==s?void 0:s.current)&&t.beginPath(),null!=(t=null==s?void 0:s.current)&&t.moveTo(e.x,e.y),null!=(t=null==s?void 0:s.current)&&t.lineTo(n.x,n.y),y.current.push({shape:h.current,sourcePoint:e,targetPoint:n}),s.current.lineWidth=15,s.current.strokeStyle="#fff",s.current.lineCap="round",s.current.lineJoin="round",null!=(t=null==s?void 0:s.current)&&t.stroke()},drawStack:function(n){var t;null!=(t=null==s?void 0:s.current)&&t.beginPath(),null!=(t=null==s?void 0:s.current)&&t.moveTo(n.sourcePoint.x,n.sourcePoint.y),null!=(t=null==s?void 0:s.current)&&t.lineTo(n.targetPoint.x,n.targetPoint.y),s.current.lineWidth=15,s.current.strokeStyle="#fff",s.current.lineCap="round",s.current.lineJoin="round",null!=(t=null==s?void 0:s.current)&&t.stroke()},mouseup:function(n){w({sourcePoint:a.current,targetPoint:n})}}]]));function P(n){var t=n.lineWidth,n=n.strokeStyle;s.current.lineWidth=t,s.current.strokeStyle=n,s.current.lineCap="round",s.current.lineJoin="round"}function m(n){var t=n.startPoint,n=n.targetPoint,e=S({startPoint:t,targetPoint:n}),r=Math.abs(n.x-t.x),n=Math.abs(n.y-t.y);return[{x:e.x,y:e.y+n},{x:e.x+r/2,y:e.y},{x:e.x+r,y:e.y+n}]}function x(n){var t=n.clientX,n=n.clientY,e=null==(e=null==v?void 0:v.current)?void 0:e.getBoundingClientRect(),r=e.x,e=e.y,l=adhere_util_1.default.getZoom();return{x:t/l-r,y:n/l-e}}function k(n){var t=n.p1,n=n.p2,e=t.x,t=t.y,r=n.x,n=n.y;return Math.sqrt(Math.pow(r-e,2)+Math.pow(n-t,2))}function b(){for(var n=0;n<y.current.length;n++){var t=y.current[n];p.current.get(t.shape).drawStack(t)}}function S(n){var t=n.startPoint,n=n.targetPoint;return n.x<=t.x&&n.y<=t.y?n:n.x<=t.x&&n.y>=t.y?{x:n.x,y:t.y}:n.x>=t.x&&n.y<=t.y?{x:t.x,y:n.y}:n.x>=t.x&&n.y>=t.y?t:void 0}function w(n){var t,e=n.sourcePoint,n=n.targetPoint;(null==(t=null==p?void 0:p.current)?void 0:t.get(h.current)).draw({sourcePoint:e,targetPoint:n})}function W(n){L(n)}function R(n){L(__assign(__assign({},n),{clientX:n.targetTouches[0].clientX,clientY:n.targetTouches[0].clientY}))}function M(n){D(n)}function E(n){D(__assign(__assign({},n),{clientX:n.changedTouches[0].clientX,clientY:n.changedTouches[0].clientY}))}function T(n){var t=n.clientX,n=n.clientY;d.current=a.current=x({clientX:t,clientY:n}),null!=(t=null==o?void 0:o.current)&&t.addEventListener("mousemove",W),null!=(n=null==o?void 0:o.current)&&n.addEventListener("mouseup",M),null!=(t=null==o?void 0:o.current)&&t.addEventListener("touchmove",R),null!=(n=null==o?void 0:o.current)&&n.addEventListener("touchend",E)}function L(n){n=x({clientX:n.clientX,clientY:n.clientY});w({sourcePoint:a.current,targetPoint:n}),a.current=n}function D(n){var t,n=x({clientX:n.clientX,clientY:n.clientY});null!=(t=null==p?void 0:p.current.get(h.current))&&t.mouseup(n),d.current=null,(a.current=null)!=(t=null==o?void 0:o.current)&&t.removeEventListener("mousemove",W),null!=(n=null==o?void 0:o.current)&&n.removeEventListener("mouseup",M),null!=(t=null==o?void 0:o.current)&&t.removeEventListener("touchmove",R),null!=(n=null==o?void 0:o.current)&&n.removeEventListener("touchend",E)}function I(){var n;null!=(n=null==s?void 0:s.current)&&n.clearRect(0,0,null==(n=null==v?void 0:v.current)?void 0:n.width,null==(n=null==v?void 0:v.current)?void 0:n.height),a.current=d.current=null,y.current=[],_.current=0}function X(n,t,e){var r,l;if(n){for(var n=adhere_util_1.default.colorToRgb(n),u=n[0],i=n[1],o=n[2],c=[],d=null==(n=null==s?void 0:s.current)?void 0:n.getImageData(0,0,null==(n=null==v?void 0:v.current)?void 0:n.width,null==(n=null==v?void 0:v.current)?void 0:n.height),a=0;a<(null==(r=null==d?void 0:d.data)?void 0:r.length);a+=4)0===d.data[a+3]&&(d.data[a]=u,d.data[a+1]=i,d.data[a+2]=o,d.data[a+3]=255,c.push(a),c.push(a+1),c.push(a+2),c.push(a+3));null!=(n=null==s?void 0:s.current)&&n.putImageData(d,0,0);n=null==(n=null==v?void 0:v.current)?void 0:n.toDataURL(t||"image/png",e),d=null==(l=null==s?void 0:s.current)?void 0:l.getImageData(0,0,null==(l=null==v?void 0:v.current)?void 0:l.width,null==(l=null==v?void 0:v.current)?void 0:l.height);return c.forEach(function(n){d.data[n]=0}),null!=(l=null==s?void 0:s.current)&&l.putImageData(d,0,0),n}return null==(l=null==v?void 0:v.current)?void 0:l.toDataURL(t||"image/png",e)}function Y(){var n,t=null==(n=null==s?void 0:s.current)?void 0:n.getImageData(0,0,null==(n=null==v?void 0:v.current)?void 0:n.width,null==(n=null==v?void 0:v.current)?void 0:n.height);return!t.data.length||!t.data.some(function(n){return n!==t.data[0]})}return(0,react_1.useImperativeHandle)(t,function(){return{setMode:function(n){h.current=n},setStrokeStyle:function(n){g.current=n},setLineWidth:function(n){f.current=n},clear:I,toDataURL:X,isEmpty:Y}}),(0,react_1.useLayoutEffect)(function(){s.current=null==(t=null==v?void 0:v.current)?void 0:t.getContext("2d");var n,t=(0,lodash_debounce_1.default)(function(){var n;v.current.width=null==(n=null==o?void 0:o.current)?void 0:n.offsetWidth,v.current.height=null==(n=null==o?void 0:o.current)?void 0:n.offsetHeight,null!=(n=null==s?void 0:s.current)&&n.clearRect(0,0,null==(n=null==v?void 0:v.current)?void 0:n.width,null==(n=null==v?void 0:v.current)?void 0:n.height),b()},i);return c.current=new resize_observer_1.ResizeObserver(t),null!=(n=null==(t=null==c?void 0:c.current)?void 0:t.observe)&&n.call(t,document.body),function(){var n;return null==(n=null==c?void 0:c.current)?void 0:n.disconnect()}},[]),(0,react_1.useLayoutEffect)(function(){var n;function t(n){T(n)}function e(n){T(__assign(__assign({},n),{clientX:n.targetTouches[0].clientX,clientY:n.targetTouches[0].clientY}))}return null!=(n=null==o?void 0:o.current)&&n.addEventListener("mousedown",t),null!=(n=null==o?void 0:o.current)&&n.addEventListener("touchstart",e),function(){var n;null!=(n=null==o?void 0:o.current)&&n.removeEventListener("mousedown",t),null!=(n=null==o?void 0:o.current)&&n.removeEventListener("touchstart",e)}},[]),react_1.default.createElement("div",{ref:o,className:(0,classnames_1.default)(selectorPrefix,null!=(u=n.className)?u:""),style:null!=(e=n.style)?e:{}},react_1.default.createElement("canvas",{ref:v}))})),WritingBoard=InternalWritingBoard;WritingBoard.displayName="WritingBoard",WritingBoard.Signature=signature_1.default,exports.default=WritingBoard;
//# sourceMappingURL=WritingBoard.js.map
