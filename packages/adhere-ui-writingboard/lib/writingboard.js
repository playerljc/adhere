"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var l in e=arguments[n])Object.prototype.hasOwnProperty.call(e,l)&&(t[l]=e[l]);return t}).apply(this,arguments)},__createBinding=this&&this.__createBinding||(Object.create?function(t,e,n,r){void 0===r&&(r=n),Object.defineProperty(t,r,{enumerable:!0,get:function(){return e[n]}})}:function(t,e,n,r){t[r=void 0===r?n:r]=e[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)"default"!==n&&Object.hasOwnProperty.call(t,n)&&__createBinding(e,t,n);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});var classnames_1=__importDefault(require("classnames")),prop_types_1=__importDefault(require("prop-types")),react_1=__importStar(require("react")),types_1=require("./types"),selectorPrefix="adhere-ui-writingboard";function WritingBoard(o,t){var r=react_1.useRef(null),i=react_1.useRef(null),u=react_1.useRef(null),l=react_1.useRef(null),d=react_1.useRef(null),n=react_1.useRef(null),v=react_1.useRef(o.mode),a=react_1.useRef([]),e=react_1.useRef(0),c=react_1.useRef(new Map([[types_1.Mode.FREE,{draw:function(t){var e=t.sourcePoint,n=t.targetPoint;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(e.x,e.y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(n.x,n.y),a.current.push({shape:v.current,sourcePoint:e,targetPoint:n}),s({lineWidth:o.lineWidth,strokeStyle:o.strokeStyle}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},drawStack:function(t){var e;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.moveTo(t.sourcePoint.x,t.sourcePoint.y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.lineTo(t.targetPoint.x,t.targetPoint.y),s({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.stroke()},mouseup:function(t){_({sourcePoint:n,targetPoint:t})}}],[types_1.Mode.LINE,{draw:function(t){var e,n,r=t.targetPoint;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.clearRect(0,0,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.width,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.height),g(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.moveTo(null===(n=null==d?void 0:d.current)||void 0===n?void 0:n.x,null===(n=null==d?void 0:d.current)||void 0===n?void 0:n.y),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.lineTo(r.x,r.y),s({lineWidth:o.lineWidth,strokeStyle:o.strokeStyle}),null!==(r=null==u?void 0:u.current)&&void 0!==r&&r.stroke()},drawStack:function(t){var e;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.moveTo(t.sourcePoint.x,t.sourcePoint.y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.lineTo(t.targetPoint.x,t.targetPoint.y),s({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.stroke()},mouseup:function(t){var e;a.current.push({shape:v.current,lineWidth:null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.lineWidth,strokeStyle:null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.strokeStyle,sourcePoint:d,targetPoint:t})}}],[types_1.Mode.RECTANGLE,{draw:function(t){var e,n,r=t.targetPoint;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.clearRect(0,0,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.width,null===(l=null==i?void 0:i.current)||void 0===l?void 0:l.height),g(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath();var l=f({startPoint:d,targetPoint:r});null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.rect(l.x,l.y,Math.abs(r.x-(null===(n=null==d?void 0:d.current)||void 0===n?void 0:n.x)),Math.abs(r.y-(null===(n=null==d?void 0:d.current)||void 0===n?void 0:n.y))),s({lineWidth:o.lineWidth,strokeStyle:o.strokeStyle}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},drawStack:function(t){var e;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.rect(t.x,t.y,t.width,t.height),s({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.stroke()},mouseup:function(t){var e,n=f({startPoint:d,targetPoint:t});a.current.push({shape:v.current,lineWidth:null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.lineWidth,strokeStyle:null===(e=null==u?void 0:u.current)||void 0===e?void 0:e.strokeStyle,x:n.x,y:n.y,width:Math.abs(t.x-(null===(n=null==d?void 0:d.current)||void 0===n?void 0:n.x)),height:Math.abs(t.y-(null===(t=null==d?void 0:d.current)||void 0===t?void 0:t.y))})}}],[types_1.Mode.CIRCLE,{draw:function(t){var e=t.targetPoint;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.clearRect(0,0,null===(r=null==i?void 0:i.current)||void 0===r?void 0:r.width,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.height),g(),null!==(r=null==u?void 0:u.current)&&void 0!==r&&r.beginPath();var n=f({startPoint:d,targetPoint:e}),r=y({p2:e,p1:d});null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.ellipse(n.x,n.y,r,r,45*Math.PI/180,0,2*Math.PI),s({lineWidth:o.lineWidth,strokeStyle:o.strokeStyle}),null!==(r=null==u?void 0:u.current)&&void 0!==r&&r.stroke()},drawStack:function(t){var e;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.ellipse(t.x,t.y,t.radiusX,t.radiusY,t.rotation,t.startAngle,t.endAngle),s({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.stroke()},mouseup:function(t){var e=f({startPoint:d,targetPoint:t}),n=y({p2:t,p1:d});a.current.push({shape:v.current,lineWidth:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.lineWidth,strokeStyle:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.strokeStyle,x:e.x,y:e.y,radiusX:n,radiusY:n,rotation:45*Math.PI/180,startAngle:0,endAngle:2*Math.PI})}}],[types_1.Mode.TRIANGLE,{draw:function(t){var e=t.targetPoint;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.clearRect(0,0,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.width,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.height),g(),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.beginPath();var n=h({startPoint:d,targetPoint:e});null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.moveTo(n[0].x,n[0].y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.lineTo(n[1].x,n[1].y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.lineTo(n[2].x,n[2].y),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.closePath(),s({lineWidth:o.lineWidth,strokeStyle:o.strokeStyle}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},drawStack:function(t){var e;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.moveTo(t.points[0].x,t.points[0].y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.lineTo(t.points[1].x,t.points[1].y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.lineTo(t.points[2].x,t.points[2].y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.closePath(),s({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.stroke()},mouseup:function(t){var e=h({startPoint:d,targetPoint:t});a.current.push({shape:v.current,lineWidth:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.lineWidth,strokeStyle:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.strokeStyle,points:e})}}],[types_1.Mode.RUBBER,{draw:function(t){var e=t.sourcePoint,n=t.targetPoint;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(e.x,e.y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(n.x,n.y),a.current.push({shape:v.current,sourcePoint:e,targetPoint:n}),u.current.lineWidth=15,u.current.strokeStyle="#fff",u.current.lineCap="round",u.current.lineJoin="round",null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},drawStack:function(t){var e;null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.moveTo(t.sourcePoint.x,t.sourcePoint.y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.lineTo(t.targetPoint.x,t.targetPoint.y),u.current.lineWidth=15,u.current.strokeStyle="#fff",u.current.lineCap="round",u.current.lineJoin="round",null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.stroke()},mouseup:function(t){_({sourcePoint:n,targetPoint:t})}}]]));function s(t){var e=t.lineWidth,t=t.strokeStyle;u.current.lineWidth=e,u.current.strokeStyle=t,u.current.lineCap="round",u.current.lineJoin="round"}function h(t){var e=t.startPoint,n=t.targetPoint,r=f({startPoint:e,targetPoint:n}),t=Math.abs(n.x-e.x),e=Math.abs(n.y-e.y);return[{x:r.x,y:r.y+e},{x:r.x+t/2,y:r.y},{x:r.x+t,y:r.y+e}]}function p(t){var e=t.pageX,n=t.pageY,t=l.current;return{x:e-t.x,y:n-t.y}}function y(t){var e=t.p1,n=t.p2,r=e.x,t=e.y,e=n.x,n=n.y;return Math.sqrt(Math.pow(e-r,2)+Math.pow(n-t,2))}function g(){for(var t=0;t<a.current.length;t++){var e=a[t];c.current.get(e.shape).drawStack(e)}}function f(t){var e=t.startPoint,t=t.targetPoint;return t.x<=e.x&&t.y<=e.y?t:t.x<=e.x&&t.y>=e.y?{x:t.x,y:e.y}:t.x>=e.x&&t.y<=e.y?{x:e.x,y:t.y}:t.x>=e.x&&t.y>=e.y?e:void 0}function _(t){var e=t.sourcePoint,n=t.targetPoint;(null===(t=null==c?void 0:c.current)||void 0===t?void 0:t.get(v.current)).draw({sourcePoint:e,targetPoint:n})}function P(t){W(t)}function x(t){W(__assign(__assign({},t),{pageX:t.targetTouches[0].pageX,pageY:t.targetTouches[0].pageY}))}function m(t){b(t)}function k(t){b(__assign(__assign({},t),{pageX:t.targetTouches[0].pageX,pageY:t.targetTouches[0].pageY}))}function S(t){var e=t.pageX,t=t.pageY;d.current=n.current=p({pageX:e,pageY:t}),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("mousemove",P),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("mouseup",m),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("touchmove",x),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("touchend",k)}function W(t){t=p({pageX:t.pageX,pageY:t.pageY});_({sourcePoint:n,targetPoint:t}),n.current=t}function b(t){var e=p({pageX:t.pageX,pageY:t.pageY});null!==(t=null==c?void 0:c.current.get(v.current))&&void 0!==t&&t.mouseup(e),d.current=null,(n.current=null)!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("mousemove",P),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("mouseup",m),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("touchmove",x),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("touchend",k)}return react_1.useImperativeHandle(t,function(){return{clear:function(){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.clearRect(0,0,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.width,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.height),n.current=d.current=null,a.current=[],e.current=0},toDataURL:function(){var t;return null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.toDataURL("image/png",1)}}}),react_1.useLayoutEffect(function(){var t;u.current=null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.getContext("2d"),l.current=null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.getBoundingClientRect(),i.current.width=null===(t=null==r?void 0:r.current)||void 0===t?void 0:t.offsetWidth,i.current.height=null===(t=null==r?void 0:r.current)||void 0===t?void 0:t.offsetHeight},[]),react_1.useLayoutEffect(function(){var t;function e(t){S(t)}function n(t){S(__assign(__assign({},t),{pageX:t.targetTouches[0].pageX,pageY:t.targetTouches[0].pageY}))}return null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("mousedown",e),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.addEventListener("touchstart",n),function(){var t;null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("mousedown",e),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("touchstart",n)}},[]),react_1.default.createElement("div",{ref:r,className:classnames_1.default(selectorPrefix,o.className||""),style:o.style||{}},react_1.default.createElement("canvas",{ref:i}))}var Wrap=react_1.forwardRef(WritingBoard);Wrap.defaultProps={className:"",style:{},mode:types_1.Mode.FREE,strokeStyle:"#000",lineWidth:2},Wrap.propTypes={className:prop_types_1.default.string,style:prop_types_1.default.object,mode:prop_types_1.default.string,strokeStyle:prop_types_1.default.string,lineWidth:prop_types_1.default.number},exports.default=Wrap;
//# sourceMappingURL=writingboard.js.map
