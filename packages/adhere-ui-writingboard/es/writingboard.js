var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(n){for(var t,e=1,r=arguments.length;e<r;e++)for(var l in t=arguments[e])Object.prototype.hasOwnProperty.call(t,l)&&(n[l]=t[l]);return n}).apply(this,arguments)};import React,{forwardRef,useImperativeHandle,useLayoutEffect,useRef}from"react";import PropTypes from"prop-types";import classNames from"classnames";import{Mode}from"./types";var selectorPrefix="adhere-ui-writingboard";function WritingBoard(o,n){var r=useRef(null),i=useRef(null),u=useRef(null),l=useRef(null),d=useRef(null),e=useRef(null),v=useRef(o.mode),c=useRef([]),t=useRef(0),a=useRef(new Map([[Mode.FREE,{draw:function(n){var t=n.sourcePoint,e=n.targetPoint;null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.beginPath(),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.moveTo(t.x,t.y),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.lineTo(e.x,e.y),c.current.push({shape:v.current,sourcePoint:t,targetPoint:e}),s({lineWidth:o.lineWidth,strokeStyle:o.strokeStyle}),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.stroke()},drawStack:function(n){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(n.sourcePoint.x,n.sourcePoint.y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(n.targetPoint.x,n.targetPoint.y),s({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},mouseup:function(n){P({sourcePoint:e.current,targetPoint:n})}}],[Mode.LINE,{draw:function(n){var t,e,r=n.targetPoint;null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.clearRect(0,0,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.width,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.height),p(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(null===(e=null==d?void 0:d.current)||void 0===e?void 0:e.x,null===(e=null==d?void 0:d.current)||void 0===e?void 0:e.y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.lineTo(r.x,r.y),s({lineWidth:o.lineWidth,strokeStyle:o.strokeStyle}),null!==(r=null==u?void 0:u.current)&&void 0!==r&&r.stroke()},drawStack:function(n){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(n.sourcePoint.x,n.sourcePoint.y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(n.targetPoint.x,n.targetPoint.y),s({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},mouseup:function(n){var t;c.current.push({shape:v.current,lineWidth:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.lineWidth,strokeStyle:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.strokeStyle,sourcePoint:d.current,targetPoint:n})}}],[Mode.RECTANGLE,{draw:function(n){var t,e,r=n.targetPoint;null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.clearRect(0,0,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.width,null===(l=null==i?void 0:i.current)||void 0===l?void 0:l.height),p(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath();var l=f({startPoint:d.current,targetPoint:r});null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.rect(l.x,l.y,Math.abs(r.x-(null===(e=null==d?void 0:d.current)||void 0===e?void 0:e.x)),Math.abs(r.y-(null===(e=null==d?void 0:d.current)||void 0===e?void 0:e.y))),s({lineWidth:o.lineWidth,strokeStyle:o.strokeStyle}),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.stroke()},drawStack:function(n){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.rect(n.x,n.y,n.width,n.height),s({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},mouseup:function(n){var t,e=f({startPoint:d.current,targetPoint:n});c.current.push({shape:v.current,lineWidth:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.lineWidth,strokeStyle:null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.strokeStyle,x:e.x,y:e.y,width:Math.abs(n.x-(null===(e=null==d?void 0:d.current)||void 0===e?void 0:e.x)),height:Math.abs(n.y-(null===(n=null==d?void 0:d.current)||void 0===n?void 0:n.y))})}}],[Mode.CIRCLE,{draw:function(n){var t=n.targetPoint;null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.clearRect(0,0,null===(r=null==i?void 0:i.current)||void 0===r?void 0:r.width,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.height),p(),null!==(r=null==u?void 0:u.current)&&void 0!==r&&r.beginPath();var e=f({startPoint:d.current,targetPoint:t}),r=y({p2:t,p1:d.current});null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.ellipse(e.x,e.y,r,r,45*Math.PI/180,0,2*Math.PI),s({lineWidth:o.lineWidth,strokeStyle:o.strokeStyle}),null!==(r=null==u?void 0:u.current)&&void 0!==r&&r.stroke()},drawStack:function(n){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.ellipse(n.x,n.y,n.radiusX,n.radiusY,n.rotation,n.startAngle,n.endAngle),s({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},mouseup:function(n){var t=f({startPoint:d.current,targetPoint:n}),e=y({p2:n,p1:null==d?void 0:d.current});c.current.push({shape:v.current,lineWidth:null===(n=null==u?void 0:u.current)||void 0===n?void 0:n.lineWidth,strokeStyle:null===(n=null==u?void 0:u.current)||void 0===n?void 0:n.strokeStyle,x:t.x,y:t.y,radiusX:e,radiusY:e,rotation:45*Math.PI/180,startAngle:0,endAngle:2*Math.PI})}}],[Mode.TRIANGLE,{draw:function(n){var t=n.targetPoint;null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.clearRect(0,0,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.width,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.height),p(),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.beginPath();var e=h({startPoint:d.current,targetPoint:t});null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(e[0].x,e[0].y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(e[1].x,e[1].y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(e[2].x,e[2].y),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.closePath(),s({lineWidth:o.lineWidth,strokeStyle:o.strokeStyle}),null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.stroke()},drawStack:function(n){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(n.points[0].x,n.points[0].y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(n.points[1].x,n.points[1].y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(n.points[2].x,n.points[2].y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.closePath(),s({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},mouseup:function(n){var t=h({startPoint:d.current,targetPoint:n});c.current.push({shape:v.current,lineWidth:null===(n=null==u?void 0:u.current)||void 0===n?void 0:n.lineWidth,strokeStyle:null===(n=null==u?void 0:u.current)||void 0===n?void 0:n.strokeStyle,points:t})}}],[Mode.RUBBER,{draw:function(n){var t=n.sourcePoint,e=n.targetPoint;null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.beginPath(),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.moveTo(t.x,t.y),null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.lineTo(e.x,e.y),c.current.push({shape:v.current,sourcePoint:t,targetPoint:e}),u.current.lineWidth=15,u.current.strokeStyle="#fff",u.current.lineCap="round",u.current.lineJoin="round",null!==(e=null==u?void 0:u.current)&&void 0!==e&&e.stroke()},drawStack:function(n){var t;null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.beginPath(),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.moveTo(n.sourcePoint.x,n.sourcePoint.y),null!==(t=null==u?void 0:u.current)&&void 0!==t&&t.lineTo(n.targetPoint.x,n.targetPoint.y),u.current.lineWidth=15,u.current.strokeStyle="#fff",u.current.lineCap="round",u.current.lineJoin="round",null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.stroke()},mouseup:function(n){P({sourcePoint:e.current,targetPoint:n})}}]]));function s(n){var t=n.lineWidth,n=n.strokeStyle;u.current.lineWidth=t,u.current.strokeStyle=n,u.current.lineCap="round",u.current.lineJoin="round"}function h(n){var t=n.startPoint,e=n.targetPoint,r=f({startPoint:t,targetPoint:e}),n=Math.abs(e.x-t.x),t=Math.abs(e.y-t.y);return[{x:r.x,y:r.y+t},{x:r.x+n/2,y:r.y},{x:r.x+n,y:r.y+t}]}function g(n){var t=n.pageX,e=n.pageY,n=l.current;return{x:t-n.x,y:e-n.y}}function y(n){var t=n.p1,e=n.p2,r=t.x,n=t.y,t=e.x,e=e.y;return Math.sqrt(Math.pow(t-r,2)+Math.pow(e-n,2))}function p(){for(var n=0;n<c.current.length;n++){var t=c.current[n];a.current.get(t.shape).drawStack(t)}}function f(n){var t=n.startPoint,n=n.targetPoint;return n.x<=t.x&&n.y<=t.y?n:n.x<=t.x&&n.y>=t.y?{x:n.x,y:t.y}:n.x>=t.x&&n.y<=t.y?{x:t.x,y:n.y}:n.x>=t.x&&n.y>=t.y?t:void 0}function P(n){var t=n.sourcePoint,e=n.targetPoint;(null===(n=null==a?void 0:a.current)||void 0===n?void 0:n.get(v.current)).draw({sourcePoint:t,targetPoint:e})}function x(n){T(n)}function m(n){T(__assign(__assign({},n),{pageX:n.targetTouches[0].pageX,pageY:n.targetTouches[0].pageY}))}function k(n){w(n)}function S(n){w(__assign(__assign({},n),{pageX:n.changedTouches[0].pageX,pageY:n.changedTouches[0].pageY}))}function W(n){var t=n.pageX,n=n.pageY;d.current=e.current=g({pageX:t,pageY:n}),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("mousemove",x),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("mouseup",k),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("touchmove",m),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("touchend",S)}function T(n){n=g({pageX:n.pageX,pageY:n.pageY});P({sourcePoint:e.current,targetPoint:n}),e.current=n}function w(n){var t=g({pageX:n.pageX,pageY:n.pageY});null!==(n=null==a?void 0:a.current.get(v.current))&&void 0!==n&&n.mouseup(t),d.current=null,(e.current=null)!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("mousemove",x),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("mouseup",k),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("touchmove",m),null!==(t=null==r?void 0:r.current)&&void 0!==t&&t.removeEventListener("touchend",S)}return useImperativeHandle(n,function(){return{clear:function(){var n;null!==(n=null==u?void 0:u.current)&&void 0!==n&&n.clearRect(0,0,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.width,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.height),e.current=d.current=null,c.current=[],t.current=0},toDataURL:function(){var n;return null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.toDataURL("image/png",1)}}}),useLayoutEffect(function(){var n;u.current=null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.getContext("2d"),l.current=null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.getBoundingClientRect(),i.current.width=null===(n=null==r?void 0:r.current)||void 0===n?void 0:n.offsetWidth,i.current.height=null===(n=null==r?void 0:r.current)||void 0===n?void 0:n.offsetHeight},[]),useLayoutEffect(function(){var n;function t(n){W(n)}function e(n){W(__assign(__assign({},n),{pageX:n.targetTouches[0].pageX,pageY:n.targetTouches[0].pageY}))}return null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("mousedown",t),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("touchstart",e),function(){var n;null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.removeEventListener("mousedown",t),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.removeEventListener("touchstart",e)}},[]),React.createElement("div",{ref:r,className:classNames(selectorPrefix,o.className||""),style:o.style||{}},React.createElement("canvas",{ref:i}))}var Wrap=forwardRef(WritingBoard);Wrap.defaultProps={className:"",style:{},mode:Mode.FREE,strokeStyle:"#000",lineWidth:2},Wrap.propTypes={className:PropTypes.string,style:PropTypes.object,mode:PropTypes.string,strokeStyle:PropTypes.string,lineWidth:PropTypes.number};export default Wrap;
//# sourceMappingURL=writingboard.js.map
