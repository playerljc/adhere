var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(n){for(var e,t=1,r=arguments.length;t<r;t++)for(var l in e=arguments[t])Object.prototype.hasOwnProperty.call(e,l)&&(n[l]=e[l]);return n}).apply(this,arguments)};import React,{forwardRef,useImperativeHandle,useLayoutEffect,useRef}from"react";import PropTypes from"prop-types";import classNames from"classnames";import debounce from"lodash/debounce";import{ResizeObserver}from"@juggle/resize-observer";import{Mode}from"./types";var selectorPrefix="adhere-ui-writingboard";function WritingBoard(t,n){var r=useRef(null),i=useRef(null),o=useRef(null),l=useRef(null),u=useRef(null),d=useRef(null),v=useRef(t.defaultMode),c=useRef(t.defaultLineWidth),a=useRef(t.defaultStrokeStyle),s=useRef([]),e=useRef(0),h=useRef(new Map([[Mode.FREE,{draw:function(n){var e=n.sourcePoint,t=n.targetPoint;null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.beginPath(),null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.moveTo(e.x,e.y),null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.lineTo(t.x,t.y),s.current.push({shape:v.current,sourcePoint:e,targetPoint:t}),y({lineWidth:null==c?void 0:c.current,strokeStyle:null==a?void 0:a.current}),null!==(t=null==o?void 0:o.current)&&void 0!==t&&t.stroke()},drawStack:function(n){var e;null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.beginPath(),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.moveTo(n.sourcePoint.x,n.sourcePoint.y),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.lineTo(n.targetPoint.x,n.targetPoint.y),y({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.stroke()},mouseup:function(n){x({sourcePoint:d.current,targetPoint:n})}}],[Mode.LINE,{draw:function(n){var e,t,r=n.targetPoint;null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.clearRect(0,0,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.width,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.height),P(),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.beginPath(),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.moveTo(null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.x,null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.y),null!==(t=null==o?void 0:o.current)&&void 0!==t&&t.lineTo(r.x,r.y),y({lineWidth:null==c?void 0:c.current,strokeStyle:null==a?void 0:a.current}),null!==(r=null==o?void 0:o.current)&&void 0!==r&&r.stroke()},drawStack:function(n){var e;null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.beginPath(),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.moveTo(n.sourcePoint.x,n.sourcePoint.y),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.lineTo(n.targetPoint.x,n.targetPoint.y),y({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.stroke()},mouseup:function(n){var e;s.current.push({shape:v.current,lineWidth:null===(e=null==o?void 0:o.current)||void 0===e?void 0:e.lineWidth,strokeStyle:null===(e=null==o?void 0:o.current)||void 0===e?void 0:e.strokeStyle,sourcePoint:u.current,targetPoint:n})}}],[Mode.RECTANGLE,{draw:function(n){var e,t,r=n.targetPoint;null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.clearRect(0,0,null===(e=null==i?void 0:i.current)||void 0===e?void 0:e.width,null===(l=null==i?void 0:i.current)||void 0===l?void 0:l.height),P(),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.beginPath();var l=m({startPoint:u.current,targetPoint:r});null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.rect(l.x,l.y,Math.abs(r.x-(null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.x)),Math.abs(r.y-(null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.y))),y({lineWidth:null==c?void 0:c.current,strokeStyle:null==a?void 0:a.current}),null!==(t=null==o?void 0:o.current)&&void 0!==t&&t.stroke()},drawStack:function(n){var e;null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.beginPath(),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.rect(n.x,n.y,n.width,n.height),y({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.stroke()},mouseup:function(n){var e,t=m({startPoint:u.current,targetPoint:n});s.current.push({shape:v.current,lineWidth:null===(e=null==o?void 0:o.current)||void 0===e?void 0:e.lineWidth,strokeStyle:null===(e=null==o?void 0:o.current)||void 0===e?void 0:e.strokeStyle,x:t.x,y:t.y,width:Math.abs(n.x-(null===(t=null==u?void 0:u.current)||void 0===t?void 0:t.x)),height:Math.abs(n.y-(null===(n=null==u?void 0:u.current)||void 0===n?void 0:n.y))})}}],[Mode.CIRCLE,{draw:function(n){var e=n.targetPoint;null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.clearRect(0,0,null===(r=null==i?void 0:i.current)||void 0===r?void 0:r.width,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.height),P(),null!==(r=null==o?void 0:o.current)&&void 0!==r&&r.beginPath();var t=m({startPoint:u.current,targetPoint:e}),r=p({p2:e,p1:u.current});null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.ellipse(t.x,t.y,r,r,45*Math.PI/180,0,2*Math.PI),y({lineWidth:null==c?void 0:c.current,strokeStyle:null==a?void 0:a.current}),null!==(r=null==o?void 0:o.current)&&void 0!==r&&r.stroke()},drawStack:function(n){var e;null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.beginPath(),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.ellipse(n.x,n.y,n.radiusX,n.radiusY,n.rotation,n.startAngle,n.endAngle),y({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.stroke()},mouseup:function(n){var e=m({startPoint:u.current,targetPoint:n}),t=p({p2:n,p1:null==u?void 0:u.current});s.current.push({shape:v.current,lineWidth:null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.lineWidth,strokeStyle:null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.strokeStyle,x:e.x,y:e.y,radiusX:t,radiusY:t,rotation:45*Math.PI/180,startAngle:0,endAngle:2*Math.PI})}}],[Mode.TRIANGLE,{draw:function(n){var e=n.targetPoint;null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.clearRect(0,0,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.width,null===(t=null==i?void 0:i.current)||void 0===t?void 0:t.height),P(),null!==(t=null==o?void 0:o.current)&&void 0!==t&&t.beginPath();var t=f({startPoint:u.current,targetPoint:e});null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.moveTo(t[0].x,t[0].y),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.lineTo(t[1].x,t[1].y),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.lineTo(t[2].x,t[2].y),null!==(t=null==o?void 0:o.current)&&void 0!==t&&t.closePath(),y({lineWidth:null==c?void 0:c.current,strokeStyle:null==a?void 0:a.current}),null!==(t=null==o?void 0:o.current)&&void 0!==t&&t.stroke()},drawStack:function(n){var e;null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.beginPath(),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.moveTo(n.points[0].x,n.points[0].y),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.lineTo(n.points[1].x,n.points[1].y),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.lineTo(n.points[2].x,n.points[2].y),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.closePath(),y({lineWidth:n.lineWidth,strokeStyle:n.strokeStyle}),null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.stroke()},mouseup:function(n){var e=f({startPoint:u.current,targetPoint:n});s.current.push({shape:v.current,lineWidth:null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.lineWidth,strokeStyle:null===(n=null==o?void 0:o.current)||void 0===n?void 0:n.strokeStyle,points:e})}}],[Mode.RUBBER,{draw:function(n){var e=n.sourcePoint,t=n.targetPoint;null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.beginPath(),null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.moveTo(e.x,e.y),null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.lineTo(t.x,t.y),s.current.push({shape:v.current,sourcePoint:e,targetPoint:t}),o.current.lineWidth=15,o.current.strokeStyle="#fff",o.current.lineCap="round",o.current.lineJoin="round",null!==(t=null==o?void 0:o.current)&&void 0!==t&&t.stroke()},drawStack:function(n){var e;null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.beginPath(),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.moveTo(n.sourcePoint.x,n.sourcePoint.y),null!==(e=null==o?void 0:o.current)&&void 0!==e&&e.lineTo(n.targetPoint.x,n.targetPoint.y),o.current.lineWidth=15,o.current.strokeStyle="#fff",o.current.lineCap="round",o.current.lineJoin="round",null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.stroke()},mouseup:function(n){x({sourcePoint:d.current,targetPoint:n})}}]]));function y(n){var e=n.lineWidth,n=n.strokeStyle;o.current.lineWidth=e,o.current.strokeStyle=n,o.current.lineCap="round",o.current.lineJoin="round"}function f(n){var e=n.startPoint,t=n.targetPoint,r=m({startPoint:e,targetPoint:t}),n=Math.abs(t.x-e.x),e=Math.abs(t.y-e.y);return[{x:r.x,y:r.y+e},{x:r.x+n/2,y:r.y},{x:r.x+n,y:r.y+e}]}function g(n){var e=n.clientX,t=n.clientY,n=null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.getBoundingClientRect();return{x:e-n.x,y:t-n.y}}function p(n){var e=n.p1,t=n.p2,r=e.x,n=e.y,e=t.x,t=t.y;return Math.sqrt(Math.pow(e-r,2)+Math.pow(t-n,2))}function P(){for(var n=0;n<s.current.length;n++){var e=s.current[n];h.current.get(e.shape).drawStack(e)}}function m(n){var e=n.startPoint,n=n.targetPoint;return n.x<=e.x&&n.y<=e.y?n:n.x<=e.x&&n.y>=e.y?{x:n.x,y:e.y}:n.x>=e.x&&n.y<=e.y?{x:e.x,y:n.y}:n.x>=e.x&&n.y>=e.y?e:void 0}function x(n){var e=n.sourcePoint,t=n.targetPoint;(null===(n=null==h?void 0:h.current)||void 0===n?void 0:n.get(v.current)).draw({sourcePoint:e,targetPoint:t})}function k(n){w(n)}function S(n){w(__assign(__assign({},n),{clientX:n.targetTouches[0].clientX,clientY:n.targetTouches[0].clientY}))}function R(n){b(n)}function W(n){b(__assign(__assign({},n),{clientX:n.changedTouches[0].clientX,clientY:n.changedTouches[0].clientY}))}function T(n){var e=n.clientX,n=n.clientY;u.current=d.current=g({clientX:e,clientY:n}),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("mousemove",k),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("mouseup",R),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("touchmove",S),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("touchend",W)}function w(n){n=g({clientX:n.clientX,clientY:n.clientY});x({sourcePoint:d.current,targetPoint:n}),d.current=n}function b(n){var e=g({clientX:n.clientX,clientY:n.clientY});null!==(n=null==h?void 0:h.current.get(v.current))&&void 0!==n&&n.mouseup(e),u.current=null,(d.current=null)!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("mousemove",k),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("mouseup",R),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("touchmove",S),null!==(e=null==r?void 0:r.current)&&void 0!==e&&e.removeEventListener("touchend",W)}function E(){var n;null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.clearRect(0,0,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.width,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.height),d.current=u.current=null,s.current=[],e.current=0}return useImperativeHandle(n,function(){return{setMode:function(n){v.current=n},setStrokeStyle:function(n){a.current=n},setLineWidth:function(n){c.current=n},clear:E,toDataURL:function(){var n;return null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.toDataURL("image/png",1)}}}),useLayoutEffect(function(){var n;o.current=null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.getContext("2d");var e=debounce(function(){var n;i.current.width=null===(n=null==r?void 0:r.current)||void 0===n?void 0:n.offsetWidth,i.current.height=null===(n=null==r?void 0:r.current)||void 0===n?void 0:n.offsetHeight,null!==(n=null==o?void 0:o.current)&&void 0!==n&&n.clearRect(0,0,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.width,null===(n=null==i?void 0:i.current)||void 0===n?void 0:n.height),P()},t.resizeTime);return l.current=new ResizeObserver(e),null!==(e=null===(n=null==l?void 0:l.current)||void 0===n?void 0:n.observe)&&void 0!==e&&e.call(n,document.body),function(){var n;return null===(n=null==l?void 0:l.current)||void 0===n?void 0:n.disconnect()}},[]),useLayoutEffect(function(){var n;function e(n){T(n)}function t(n){T(__assign(__assign({},n),{clientX:n.targetTouches[0].clientX,clientY:n.targetTouches[0].clientY}))}return null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("mousedown",e),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.addEventListener("touchstart",t),function(){var n;null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.removeEventListener("mousedown",e),null!==(n=null==r?void 0:r.current)&&void 0!==n&&n.removeEventListener("touchstart",t)}},[]),React.createElement("div",{ref:r,className:classNames(selectorPrefix,t.className||""),style:t.style||{}},React.createElement("canvas",{ref:i}))}var Wrap=forwardRef(WritingBoard);Wrap.defaultProps={className:"",style:{},defaultMode:Mode.FREE,defaultStrokeStyle:"#000",defaultLineWidth:2,resizeTime:300},Wrap.propTypes={className:PropTypes.string,style:PropTypes.object,defaultMode:PropTypes.string.isRequired,defaultStrokeStyle:PropTypes.string.isRequired,defaultLineWidth:PropTypes.number.isRequired,resizeTime:PropTypes.number.isRequired};export default Wrap;
//# sourceMappingURL=writingboard.js.map
