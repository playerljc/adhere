var __spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,r=0,t=arguments.length;r<t;r++)e+=arguments[r].length;for(var o=Array(e),n=0,r=0;r<t;r++)for(var i=arguments[r],l=0,a=i.length;l<a;l++,n++)o[n]=i[l];return o};import cloneDeep from"lodash/cloneDeep";import Emitter from"@baifendian/adhere-util-emitter";import Events from"@baifendian/adhere-util-emitter/lib/events";import Util from"@baifendian/adhere-util";var srcObj={},SPECIAL_SYMBOL="__",PATH_SYMBOLS=[SPECIAL_SYMBOL+"parentName"+SPECIAL_SYMBOL,SPECIAL_SYMBOL+"parent"+SPECIAL_SYMBOL],PRIVATE_SYMBOL="$",CREATE_PROXY_EXCLUDE_PREFIX=[PRIVATE_SYMBOL,SPECIAL_SYMBOL],CREATE_PROXY_EXCLUDE_SUFFIX=[SPECIAL_SYMBOL];function isProxyProperty(r){return!(CREATE_PROXY_EXCLUDE_PREFIX.some(function(e){return r.startsWith(e)})||CREATE_PROXY_EXCLUDE_SUFFIX.some(function(e){return r.endsWith(e)}))}function createProxy(e,s,c){var r,t=new Proxy(e,{set:function(e,r,t,o){if(!isProxyProperty(r))return Reflect.set(e,r,t,o);if(Util.isArray(e)){console.log(e,r),console.log("是数组");var n=e.length,i=Reflect.set(e,r,t,o),l=Util.getPropertyVisitPathStr(e,r);s[l]=cloneDeep(e);var a=e.length;return c.trigger(l,r,t),a<n?console.log("删除","key:"+r,"value:"+t):(n<a?console.log("添加","key:"+r,"value:"+t):console.log("修改","key:"+r,"value:"+t),!Util.isObject(t)&&!Util.isArray(t)||PATH_SYMBOLS[0]in t||((t=createProxy(t,s,c))[PATH_SYMBOLS[0]]="["+r+"]",t[PATH_SYMBOLS[1]]=e,i=Reflect.set(e,r,t,o))),console.log("数组完成"),i}if(Util.isObject(e)){console.log(e,r),console.log("是对象");l=Util.getPropertyVisitPathStr(e,r);console.log("propertyAccessStr",l);a=void 0,i=cloneDeep(t);return console.log("newVal",i),c.trigger(l,t,i),a=a||cloneDeep(t),s[l]=a,console.log("noProxy[propertyAccessStr]",s[l]),!Util.isObject(t)&&!Util.isArray(t)||PATH_SYMBOLS[0]in t||((t=createProxy(t,s,c))[PATH_SYMBOLS[0]]=r,t[PATH_SYMBOLS[1]]=e),console.log("对象完成"),Reflect.set(e,r,t,o)}return console.log("完成"),Reflect.set(e,r,t,o)},deleteProperty:function(e,r){if(!isProxyProperty(r))return Reflect.deleteProperty(e,r);if(Util.isArray(e))return Reflect.deleteProperty(e,r);var t=Util.getPropertyVisitPathStr(e,r);return c.trigger(t,r),delete s[t],Reflect.deleteProperty(e,r)}});for(r in e){var o=e[r];isProxyProperty(r)&&(Util.isObject(o)||Util.isArray(o))&&(e[r]=createProxy(o,s,c),o[PATH_SYMBOLS[0]]=Util.isArray(e)?"["+r+"]":r,o[PATH_SYMBOLS[1]]=e)}return t}var WatchMemoized={createRef:function(e){var t=Symbol.for(Util.uuid()),o=e;return Object.defineProperty(srcObj,t,{enumerable:!0,configurable:!0,set:function(e){var r=o;console.log("preValue",r),o=e,console.log("curValue",e),Emitter.trigger(Symbol.keyFor(t),{oldValue:r,newValue:e})},get:function(){return console.log("get",o),o}}),[function(){return srcObj[t]},function(e){srcObj[t]=e},t]},memoized:{watch:{all:function(e,r){r=Array.from(new Set(__spreadArrays(r)));var t=[],i=[];function l(r){i.find(function(e){return e.type===r}).isChange=!0,i.every(function(e){return e.isChange})&&(i.forEach(function(e){return e.isChange=!1}),e())}return r.forEach(function(o){var n;function e(e){var r,t=e.oldValue,e=e.newValue;Util.isSymbol(o)||"light"===(r=o).mode?t!==e&&l(n):"deep"===r.mode?Util.isRef(t)&&Util.isRef(e)?JSON.stringify(t)!==JSON.stringify(e)&&l(n):t!==e&&l(n):Util.isFunction(r.mode)&&(r.mode({oldValue:t,newValue:e})||l(n))}n=Util.isSymbol(o)?Symbol.keyFor(o):Symbol.keyFor(o.property),i.push({type:n,isChange:!1}),t.push({type:n,handler:e}),Emitter.on(n,e)}),function(){t.forEach(function(e){var r=e.type,e=e.handler;Emitter.remove(r,e)})}},race:function(n,e){e=Array.from(new Set(__spreadArrays(e)));var t=[];return e.forEach(function(o){var e;function r(e){var r,t=e.oldValue,e=e.newValue;Util.isSymbol(o)||"light"===(r=o).mode?t!==e&&n():"deep"===r.mode?Util.isRef(t)&&Util.isRef(e)?JSON.stringify(t)!==JSON.stringify(e)&&n():t!==e&&n():Util.isFunction(r.mode)&&(r.mode({oldValue:t,newValue:e})||n())}e=Util.isSymbol(o)?Symbol.keyFor(o):Symbol.keyFor(o.property),t.push({type:e,handler:r}),Emitter.on(e,r)}),function(){t.forEach(function(e){var r=e.type,e=e.handler;Emitter.remove(r,e)})}}},createMemoFun:function(o,n){void 0===n&&(n=10);var i=[],l=[function(e,r){return e.length===r.length},function(e,r){for(var t=!0,o=0;o<e.length;o++){var n=e[o],i=r[o];if(!(t=Util.isRef(n)&&Util.isRef(i)?JSON.stringify(cloneDeep(n))===JSON.stringify(cloneDeep(i)):n===i))break}return t}];function a(e){void 0===e&&(e=[]);for(var r=null,t=0;t<i.length;t++){var o=i[t],n=o.resultVal;if(function(e,r){for(var t=!0,o=0;o<l.length;o++)if(!(t=(0,l[o])(e,r)))break;return t}(o.depends,e)){r=n;break}}return r}return function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return function(e){var r=a(e=void 0===e?[]:e);if(console.log("find",r),!r){if(r=o.apply(this,e),console.log("callfinish",r),i.length>=n&&i.shift(),r instanceof Promise){console.log("函数返回值是Promise");var t=r.then(function(e){return console.log("返回res",e),e});return i.push({depends:e,resultVal:t}),t}i.push({depends:e,resultVal:r})}return r}.call(this,e||[])}}},watch:{create:function(e,r){var t=new Events;if(!Util.isEmpty(r))for(var o in r)t.on(o,r[o]);return{value:createProxy(e,cloneDeep(e),t),on:function(e,r){t.on(e,r)},remove:function(e,r){t.remove(e,r)}}}}};export default WatchMemoized;
//# sourceMappingURL=watchmemoized.js.map
