"use strict";var __spreadArray=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var a,i=0,n=t.length;i<n;i++)!a&&i in t||((a=a||Array.prototype.slice.call(t,0,i))[i]=t[i]);return e.concat(a||Array.prototype.slice.call(t))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},cloneDeep_1=(Object.defineProperty(exports,"__esModule",{value:!0}),__importDefault(require("lodash/cloneDeep"))),adhere_util_1=__importDefault(require("@baifendian/adhere-util")),adhere_util_emitter_1=__importDefault(require("@baifendian/adhere-util-emitter")),Events=adhere_util_emitter_1.default.Events,srcObj={},SPECIAL_SYMBOL="__",PATH_SYMBOLS=["".concat(SPECIAL_SYMBOL,"parentName").concat(SPECIAL_SYMBOL),"".concat(SPECIAL_SYMBOL,"parent").concat(SPECIAL_SYMBOL)],PRIVATE_SYMBOL="$",CREATE_PROXY_EXCLUDE_PREFIX=[PRIVATE_SYMBOL,SPECIAL_SYMBOL],CREATE_PROXY_EXCLUDE_SUFFIX=[SPECIAL_SYMBOL];function isProxyProperty(t){return!(CREATE_PROXY_EXCLUDE_PREFIX.some(function(e){return t.startsWith(e)})||CREATE_PROXY_EXCLUDE_SUFFIX.some(function(e){return t.endsWith(e)}))}function createProxy(e,o,_){var t,r=new Proxy(e,{set:function(e,t,r,a){if(isProxyProperty(t)){var i,n,u,l;if(adhere_util_1.default.isArray(e))return l=e.length,i=Reflect.set(e,t,r,a),n=adhere_util_1.default.getPropertyVisitPathStr(e,t),o[n]=(0,cloneDeep_1.default)(e),u=e.length,_.trigger(n,t,r),u<l||!adhere_util_1.default.isObject(r)&&!adhere_util_1.default.isArray(r)||PATH_SYMBOLS[0]in r||((r=createProxy(r,o,_))[PATH_SYMBOLS[0]]="[".concat(t,"]"),r[PATH_SYMBOLS[1]]=e,i=Reflect.set(e,t,r,a)),i;adhere_util_1.default.isObject(e)&&(n=adhere_util_1.default.getPropertyVisitPathStr(e,t),l=(u=void 0,cloneDeep_1.default)(r),_.trigger(n,r,l),u=u||(0,cloneDeep_1.default)(r),o[n]=u,!adhere_util_1.default.isObject(r)&&!adhere_util_1.default.isArray(r)||PATH_SYMBOLS[0]in r||((r=createProxy(r,o,_))[PATH_SYMBOLS[0]]=t,r[PATH_SYMBOLS[1]]=e))}return Reflect.set(e,t,r,a)},deleteProperty:function(e,t){var r;return isProxyProperty(t)&&!adhere_util_1.default.isArray(e)&&(r=adhere_util_1.default.getPropertyVisitPathStr(e,t),_.trigger(r,t),delete o[r]),Reflect.deleteProperty(e,t)}});for(t in e){var a=e[t];isProxyProperty(t)&&(adhere_util_1.default.isObject(a)||adhere_util_1.default.isArray(a))&&(e[t]=createProxy(a,o,_),a[PATH_SYMBOLS[0]]=adhere_util_1.default.isArray(e)?"[".concat(t,"]"):t,a[PATH_SYMBOLS[1]]=e)}return r}var WatchMemoized={createRef:function(e){var r=Symbol.for(adhere_util_1.default.uuid()),a=e;return Object.defineProperty(srcObj,r,{enumerable:!0,configurable:!0,set:function(e){var t=a;a=e,adhere_util_emitter_1.default.trigger(Symbol.keyFor(r),{oldValue:t,newValue:e})},get:function(){return a}}),[function(){return srcObj[r]},function(e){srcObj[r]=e},r]},memoized:{watch:{all:function(r,e){e=Array.from(new Set(__spreadArray([],e,!0)));var t=[],n=[];function u(t){var e=n.find(function(e){return e.type===t});e&&(e.isChange=!0),n.every(function(e){return e.isChange})&&(n.forEach(function(e){return e.isChange=!1}),r())}return e.forEach(function(a){var i;function e(e){var t,r=e.oldValue,e=e.newValue;adhere_util_1.default.isSymbol(a)?r!==e&&u(i):"light"===(t=a).mode?Object.is(r,e)||u(i):"deep"===t.mode?adhere_util_1.default.isRef(r)&&adhere_util_1.default.isRef(e)?JSON.stringify(r)!==JSON.stringify(e)&&u(i):Object.is(r,e)||u(i):adhere_util_1.default.isFunction(t.mode)&&!t.mode(r,e)&&u(i)}i=adhere_util_1.default.isSymbol(a)?Symbol.keyFor(a):Symbol.keyFor(a.property),n.push({type:i,isChange:!1}),t.push({type:i,handler:e}),adhere_util_emitter_1.default.on(i,e)}),function(){t.forEach(function(e){var t=e.type,e=e.handler;adhere_util_emitter_1.default.remove(t,e)})}},race:function(i,e){e=Array.from(new Set(__spreadArray([],e,!0)));var r=[];return e.forEach(function(a){var e;function t(e){var t,r=e.oldValue,e=e.newValue;adhere_util_1.default.isSymbol(a)?r!==e&&i():"light"===(t=a).mode?Object.is(r,e)||i():"deep"===t.mode?adhere_util_1.default.isRef(r)&&adhere_util_1.default.isRef(e)?JSON.stringify(r)!==JSON.stringify(e)&&i():Object.is(r,e)||i():adhere_util_1.default.isFunction(t.mode)&&!t.mode(r,e)&&i()}e=adhere_util_1.default.isSymbol(a)?Symbol.keyFor(a):Symbol.keyFor(a.property),r.push({type:e,handler:t}),adhere_util_emitter_1.default.on(e,t)}),function(){r.forEach(function(e){var t=e.type,e=e.handler;adhere_util_emitter_1.default.remove(t,e)})}}},createMemoFun:function(a,i){void 0===i&&(i=10);var n=[],u=[function(e,t){return e.length===t.length},function(e,t){for(var r=!0,a=0;a<e.length;a++){var i=e[a],n=t[a];if(!(r=adhere_util_1.default.isRef(i)&&adhere_util_1.default.isRef(n)?JSON.stringify((0,cloneDeep_1.default)(i))===JSON.stringify((0,cloneDeep_1.default)(n)):i===n))break}return r}];function l(e){void 0===e&&(e=[]);for(var t=null,r=0;r<n.length;r++){var a=n[r],i=a.resultVal;if(function(e,t){for(var r=!0,a=0;a<u.length&&(r=(0,u[a])(e,t));a++);return r}(a.depends,e)){t=i;break}}return t}return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(e){if(!(r=l(e=void 0===e?[]:e))){var t,r=a.apply(this,e);if(n.length>=i&&n.shift(),r instanceof Promise)return t=r.then(function(e){return e}),n.push({depends:e,resultVal:t}),t;n.push({depends:e,resultVal:r})}return r}.call(this,e||[])}}},watch:{create:function(e,t){var r=new Events;if(!adhere_util_1.default.isEmpty(t))for(var a in t)r.on(a,t[a]);return{value:createProxy(e,(0,cloneDeep_1.default)(e),r),on:function(e,t){r.on(e,t)},remove:function(e,t){r.remove(e,t)}}}}};exports.default=WatchMemoized;
//# sourceMappingURL=watchmemoized.js.map
