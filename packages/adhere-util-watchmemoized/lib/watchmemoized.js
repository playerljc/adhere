"use strict";var __spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,r=0,t=arguments.length;r<t;r++)e+=arguments[r].length;for(var l=Array(e),o=0,r=0;r<t;r++)for(var n=arguments[r],a=0,i=n.length;a<i;a++,o++)l[o]=n[a];return l},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var cloneDeep_1=__importDefault(require("lodash/cloneDeep")),adhere_util_emitter_1=__importDefault(require("@baifendian/adhere-util-emitter")),events_1=__importDefault(require("@baifendian/adhere-util-emitter/lib/events")),adhere_util_1=__importDefault(require("@baifendian/adhere-util")),srcObj={},SPECIAL_SYMBOL="__",PATH_SYMBOLS=[SPECIAL_SYMBOL+"parentName"+SPECIAL_SYMBOL,SPECIAL_SYMBOL+"parent"+SPECIAL_SYMBOL],PRIVATE_SYMBOL="$",CREATE_PROXY_EXCLUDE_PREFIX=[PRIVATE_SYMBOL,SPECIAL_SYMBOL],CREATE_PROXY_EXCLUDE_SUFFIX=[SPECIAL_SYMBOL];function isProxyProperty(r){return!(CREATE_PROXY_EXCLUDE_PREFIX.some(function(e){return r.startsWith(e)})||CREATE_PROXY_EXCLUDE_SUFFIX.some(function(e){return r.endsWith(e)}))}function createProxy(e,u,f){var r,t=new Proxy(e,{set:function(e,r,t,l){if(!isProxyProperty(r))return Reflect.set(e,r,t,l);if(adhere_util_1.default.isArray(e)){console.log(e,r),console.log("是数组");var o=e.length,n=Reflect.set(e,r,t,l),a=adhere_util_1.default.getPropertyVisitPathStr(e,r);u[a]=cloneDeep_1.default(e);var i=e.length;return f.trigger(a,r,t),i<o?console.log("删除","key:"+r,"value:"+t):(o<i?console.log("添加","key:"+r,"value:"+t):console.log("修改","key:"+r,"value:"+t),!adhere_util_1.default.isObject(t)&&!adhere_util_1.default.isArray(t)||PATH_SYMBOLS[0]in t||((t=createProxy(t,u,f))[PATH_SYMBOLS[0]]="["+r+"]",t[PATH_SYMBOLS[1]]=e,n=Reflect.set(e,r,t,l))),console.log("数组完成"),n}if(adhere_util_1.default.isObject(e)){console.log(e,r),console.log("是对象");a=adhere_util_1.default.getPropertyVisitPathStr(e,r);console.log("propertyAccessStr",a);i=void 0,n=cloneDeep_1.default(t);return console.log("newVal",n),f.trigger(a,t,n),i=i||cloneDeep_1.default(t),u[a]=i,console.log("noProxy[propertyAccessStr]",u[a]),!adhere_util_1.default.isObject(t)&&!adhere_util_1.default.isArray(t)||PATH_SYMBOLS[0]in t||((t=createProxy(t,u,f))[PATH_SYMBOLS[0]]=r,t[PATH_SYMBOLS[1]]=e),console.log("对象完成"),Reflect.set(e,r,t,l)}return console.log("完成"),Reflect.set(e,r,t,l)},deleteProperty:function(e,r){if(!isProxyProperty(r))return Reflect.deleteProperty(e,r);if(adhere_util_1.default.isArray(e))return Reflect.deleteProperty(e,r);var t=adhere_util_1.default.getPropertyVisitPathStr(e,r);return f.trigger(t,r),delete u[t],Reflect.deleteProperty(e,r)}});for(r in e){var l=e[r];isProxyProperty(r)&&(adhere_util_1.default.isObject(l)||adhere_util_1.default.isArray(l))&&(e[r]=createProxy(l,u,f),l[PATH_SYMBOLS[0]]=adhere_util_1.default.isArray(e)?"["+r+"]":r,l[PATH_SYMBOLS[1]]=e)}return t}var WatchMemoized={createRef:function(e){var t=Symbol.for(adhere_util_1.default.uuid()),l=e;return Object.defineProperty(srcObj,t,{enumerable:!0,configurable:!0,set:function(e){var r=l;console.log("preValue",r),l=e,console.log("curValue",e),adhere_util_emitter_1.default.trigger(Symbol.keyFor(t),{oldValue:r,newValue:e})},get:function(){return console.log("get",l),l}}),[function(){return srcObj[t]},function(e){srcObj[t]=e},t]},memoized:{watch:{all:function(e,r){r=Array.from(new Set(__spreadArrays(r)));var t=[],n=[];function a(r){n.find(function(e){return e.type===r}).isChange=!0,n.every(function(e){return e.isChange})&&(n.forEach(function(e){return e.isChange=!1}),e())}return r.forEach(function(l){var o;function e(e){var r,t=e.oldValue,e=e.newValue;adhere_util_1.default.isSymbol(l)||"light"===(r=l).mode?t!==e&&a(o):"deep"===r.mode?adhere_util_1.default.isRef(t)&&adhere_util_1.default.isRef(e)?JSON.stringify(t)!==JSON.stringify(e)&&a(o):t!==e&&a(o):adhere_util_1.default.isFunction(r.mode)&&(r.mode({oldValue:t,newValue:e})||a(o))}o=adhere_util_1.default.isSymbol(l)?Symbol.keyFor(l):Symbol.keyFor(l.property),n.push({type:o,isChange:!1}),t.push({type:o,handler:e}),adhere_util_emitter_1.default.on(o,e)}),function(){t.forEach(function(e){var r=e.type,e=e.handler;adhere_util_emitter_1.default.remove(r,e)})}},race:function(o,e){e=Array.from(new Set(__spreadArrays(e)));var t=[];return e.forEach(function(l){var e;function r(e){var r,t=e.oldValue,e=e.newValue;adhere_util_1.default.isSymbol(l)||"light"===(r=l).mode?t!==e&&o():"deep"===r.mode?adhere_util_1.default.isRef(t)&&adhere_util_1.default.isRef(e)?JSON.stringify(t)!==JSON.stringify(e)&&o():t!==e&&o():adhere_util_1.default.isFunction(r.mode)&&(r.mode({oldValue:t,newValue:e})||o())}e=adhere_util_1.default.isSymbol(l)?Symbol.keyFor(l):Symbol.keyFor(l.property),t.push({type:e,handler:r}),adhere_util_emitter_1.default.on(e,r)}),function(){t.forEach(function(e){var r=e.type,e=e.handler;adhere_util_emitter_1.default.remove(r,e)})}}},createMemoFun:function(l,o){void 0===o&&(o=10);var n=[],a=[function(e,r){return e.length===r.length},function(e,r){for(var t=!0,l=0;l<e.length;l++){var o=e[l],n=r[l];if(!(t=adhere_util_1.default.isRef(o)&&adhere_util_1.default.isRef(n)?JSON.stringify(cloneDeep_1.default(o))===JSON.stringify(cloneDeep_1.default(n)):o===n))break}return t}];function i(e){void 0===e&&(e=[]);for(var r=null,t=0;t<n.length;t++){var l=n[t],o=l.resultVal;if(function(e,r){for(var t=!0,l=0;l<a.length;l++)if(!(t=(0,a[l])(e,r)))break;return t}(l.depends,e)){r=o;break}}return r}return function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return function(e){var r=i(e=void 0===e?[]:e);if(console.log("find",r),!r){if(r=l.apply(this,e),console.log("callfinish",r),n.length>=o&&n.shift(),r instanceof Promise){console.log("函数返回值是Promise");var t=r.then(function(e){return console.log("返回res",e),e});return n.push({depends:e,resultVal:t}),t}n.push({depends:e,resultVal:r})}return r}.call(this,e||[])}}},watch:{create:function(e,r){var t=new events_1.default;if(!adhere_util_1.default.isEmpty(r))for(var l in r)t.on(l,r[l]);return{value:createProxy(e,cloneDeep_1.default(e),t),on:function(e,r){t.on(e,r)},remove:function(e,r){t.remove(e,r)}}}}};exports.default=WatchMemoized;
//# sourceMappingURL=watchmemoized.js.map
