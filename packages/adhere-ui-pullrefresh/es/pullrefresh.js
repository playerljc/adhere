import{useUpdate}from"ahooks";import classNames from"classnames";import dayjs from"dayjs";import debounce from"lodash.debounce";import React,{forwardRef,memo,useCallback,useEffect,useImperativeHandle,useLayoutEffect,useRef}from"react";import ConditionalRender from"@baifendian/adhere-ui-conditionalrender";import Hooks from"@baifendian/adhere-ui-hooks";import Util from"@baifendian/adhere-util";import Intl from"@baifendian/adhere-util-intl";import Resource from"@baifendian/adhere-util-resource";import{ResizeObserver}from"@juggle/resize-observer";var selectorPrefix="adhere-ui-pull-refresh",defaultImg="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHN0eWxlPSJ3aWR0aDozMDhweDtoZWlnaHQ6MzA4cHg7IiB2ZXJzaW9uPSIxLjEiIGlkPSLlm77lvaIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IiB3aWR0aD0iMTAyNHB4IiBoZWlnaHQ9IjEwMjRweCIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTAyNCAxMDI0IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCiAgPHBhdGggY2xhc3M9InN2Z3BhdGgiIGRhdGEtaW5kZXg9InBhdGhfMCIgZmlsbD0iI2VjZjBmMSIgZD0iTTc5Ny43NjQ0MiAzMjYuNTU4NDFjLTguODg0MTk5LTE1LjU2MzMyNy0yNTIuODgwMS0yODYuODE5MDE5LTI2OC4zNzk1MTItMzEzLjU2NzQ4OS0xMC4xMzA1NDQtMTcuNDQ4ODIzLTM0LjI1ODQ5NS0xNy4xOTMxNjItNDQuMzg5MDM4IDBDNDczLjY1MDkzOSAzMi4yNjEzMjQgMjMwLjk5NzI1NSAzMDQuNjM1NTMgMjE4LjM3NDAyMyAzMjcuNDIxMjY0Yy05LjIzNTczMiAxNi41NTQwMTEgMC45NTg3MjcgMzguMzgxMDE5IDIxLjk1NDgzNyAzOC4zODEwMTlsMTE5LjkwNDczMSAwIDAgMjU2LjQ5MTMwMyAwIDM2Ljc4MzE0MSAyOTEuODM2MzU0IDAgMC0yOTMuMzA2NDAyIDEyMy41Nzk4NDkgMEM3OTQuNjk2NDk1IDM2NS43NzAzMjUgODA4Ljk0OTU2MiAzNDYuMTE2NDMxIDc5Ny43NjQ0MiAzMjYuNTU4NDF6IiAvPg0KPHBhdGggY2xhc3M9InN2Z3BhdGgiIGRhdGEtaW5kZXg9InBhdGhfMSIgZmlsbD0iI2VjZjBmMSIgZD0iTTM2MC4yMDE2MzMgNjg5LjY5MjA2MWwyOTIuMzE1NzE4IDAgMCA5MC45MTkyMzItMjkyLjMxNTcxOCAwIDAtOTAuOTE5MjMyWiIgLz4NCjxwYXRoIGNsYXNzPSJzdmdwYXRoIiBkYXRhLWluZGV4PSJwYXRoXzIiIGZpbGw9IiNlY2YwZjEiIGQ9Ik0zNjAuMjAxNjMzIDg0MC45MTUxOTFsMjkyLjMxNTcxOCAwIDAgNjAuNTkxNTE2LTI5Mi4zMTU3MTggMCAwLTYwLjU5MTUxNloiIC8+DQo8cGF0aCBjbGFzcz0ic3ZncGF0aCIgZGF0YS1pbmRleD0icGF0aF8zIiBmaWxsPSIjZWNmMGYxIiBkPSJNMzYwLjIwMTYzMyA5OTIuMzkzOTgybDI5MC40MzAyMjIgMCAwIDMwLjI5NTc1OC0yOTAuNDMwMjIyIDAgMC0zMC4yOTU3NThaIiAvPg0KDQo8L3N2Zz4NCg==",useSetState=Hooks.useSetState,PullRefresh=memo(forwardRef(function(n,O){var e=n.className,e=void 0===e?"":e,t=n.style,t=void 0===t?{}:t,r=n.scrollClassName,r=void 0===r?"":r,c=n.scrollStyle,c=void 0===c?{}:c,l=n.renderIcon,u=n.renderLabel,a=void 0===u?function(){return Intl.v("下拉刷新")}:u,u=n.renderCanLabel,i=void 0===u?function(){return Intl.v("松开刷新")}:u,u=n.renderLoadingAnimation,o=void 0===u?"la-ball-circus la-dark":u,u=n.isShowUpdateTime,s=void 0===u||u,u=n.updateTimeFormat,S=void 0===u?Resource.Dict.value.ResourceMomentFormat18.value():u,u=n.children,Y=useUpdate(),d=useRef({}),f=useSetState(!1),Z=f[0],m=f[1],f=useSetState(dayjs().valueOf()),M=f[0],v=f[1],B=useRef(null),G=useRef(null),U=useRef(null),g=useRef(null),I=useRef(null),H=useRef(null),N=useRef(null),y=useRef(null),E=useRef(null),R=useRef(null),h=useRef(null),T=useRef(!0),j=useRef(200),L=useRef(-1),z=useRef(!1),D=useRef(0),f=useCallback(function(){return React.createElement(ConditionalRender,{conditional:!!l,noMatch:function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-trigger-icon")},React.createElement("img",{className:"".concat(selectorPrefix,"-trigger-icon-inner"),src:defaultImg,alt:"",ref:g}))}},function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-trigger-icon")},React.createElement("div",{className:"".concat(selectorPrefix,"-trigger-icon-inner"),ref:g},null==l?void 0:l()))})},[l]),Q=useCallback(function(){return React.createElement("p",{className:"".concat(selectorPrefix,"-trigger-label")},React.createElement(ConditionalRender,{conditional:Z.current,noMatch:function(){return null==a?void 0:a()}},function(){return null==i?void 0:i()}))},[Z.current,a,i]),W=useCallback(function(){return React.createElement(ConditionalRender,{conditional:s},function(){return React.createElement("p",{className:"".concat(selectorPrefix,"-trigger-update")},Intl.v("更新时间"),"：",React.createElement("span",{className:"".concat(selectorPrefix,"-trigger-update-label")},dayjs(M.current).format(S)))})},[s,M.current,S]),F=useCallback(function(){return React.createElement(ConditionalRender,{conditional:!!o},function(){return React.createElement(ConditionalRender,{conditional:Util.isString(o),noMatch:function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-trigger-refresh"),ref:I},o())}},function(){return React.createElement("div",{className:classNames("".concat(selectorPrefix,"-trigger-refresh"),o),ref:I},React.createElement("div",null),React.createElement("div",null),React.createElement("div",null),React.createElement("div",null),React.createElement("div",null))})})},[o]);function x(e,t){n[e]&&n[e](t)}function p(e,t,n){e.style.transition=e.style.transition="transform ".concat(n=void 0===n?0:n,"ms ease"),e.style.transform=e.style.transform="translate3d(0,".concat(t,",0)")}function A(){C(),z.current=!1,T.current=!0,N.current.style.display="flex",I.current.style.display="none",R.current.style.display="flex",b(E.current,180,0),y.current.style.overflowY="auto",h.current.style.display="none"}function C(){var e;null!=(e=y.current)&&e.removeEventListener("mousemove",P),null!=(e=y.current)&&e.removeEventListener("mouseup",k),null!=(e=y.current)&&e.removeEventListener("touchmove",P),null!=(e=y.current)&&e.removeEventListener("touchend",k)}function X(){var e,t;h.current.style.display="block",C(),null!=(t=null==(e=y.current)?void 0:e.addEventListener)&&t.call(e,"transitionend",function e(){var t;R.current.style.display="none",I.current.style.display="block",x("onPullRefresh"),null!=(t=y.current)&&t.removeEventListener("transitionend",e),v(dayjs().valueOf())}),p(y.current,"".concat(D.current,"px"),500),p(N.current,"calc(-100% + ".concat(D.current,"px)"),500),b(E.current,180,300)}function J(){var e,t;A(),null!=(t=null==(e=y.current)?void 0:e.addEventListener)&&t.call(e,"transitionend",function e(){var t,n;null!=(n=null==(t=y.current)?void 0:t.removeEventListener)&&n.call(t,"transitionend",e),R.current.style.display="flex"}),p(y.current,"0px",200),p(N.current,"calc(-100% + 0px)",200)}function V(t){return new Promise(function(e){return v(t||dayjs().valueOf(),function(){return e()})})}function K(){return M.current}function b(e,t,n){e.style.transition=e.style.transition="transform ".concat(n=void 0===n?0:n,"ms linear"),e.style.transform=e.style.transform="rotate(".concat(t,"deg)")}function w(e){x("onPullStart"),L.current=(e.changedTouches?e.changedTouches[0]:e).pageY,null!=(e=y.current)&&e.addEventListener("touchmove",P),null!=(e=y.current)&&e.addEventListener("mousemove",P),null!=(e=y.current)&&e.addEventListener("touchend",k),null!=(e=y.current)&&e.addEventListener("mouseup",k)}function P(e){y.current.style.overflow="hidden";var t=(e.changedTouches?e.changedTouches[0]:e).pageY-L.current,n=Math.abs(t);0<t?(e.preventDefault(),z.current=!0,n<j.current?(p(y.current,"".concat(n,"px"),0),p(N.current,"calc(-100% + ".concat(n,"px)"),0),n>=D.current+80?(b(E.current,0,150),m(!0,function(){return x("onPullCanRefresh")})):(b(E.current,180,150),m(!1)),N.current.style.display="flex"):(p(y.current,"".concat(j.current,"px"),0),p(N.current,"calc(-100% + ".concat(j.current,"px)"),0),b(E.current,0,150),m(!0,function(){return x("onPullBottom")}))):z.current?(e.preventDefault(),p(y.current,"0px",0),p(N.current,"calc(-100% + 0px)",0),b(E.current,180,0)):A()}function k(e){var e=(e.changedTouches?e.changedTouches[0]:e).pageY-L.current,t=Math.abs(e);(0<e?!(t<j.current)||t>=D.current+80?X:(x("onPullRebound"),J):A)()}function q(e){var t;0===e.target.scrollTop?(T.current=!0,null!=(t=null==(e=y.current)?void 0:e.addEventListener)&&t.call(e,"touchstart",w),null!=(e=null==(t=y.current)?void 0:t.addEventListener)&&e.call(t,"mousedown",w)):T.current&&(T.current=!1,null!=(t=null==(e=y.current)?void 0:e.removeEventListener)&&t.call(e,"touchstart",w),null!=(e=null==(t=y.current)?void 0:t.removeEventListener))&&e.call(t,"mousedown",w)}function $(){var e;j.current=((e=void 0===(e=n.pullHeight)?200:e)||200)<=0?200:(e||200)>y.current.clientHeight?y.current.clientHeight:e||200,D.current=N.current.clientHeight}return useImperativeHandle(O,function(){return{refresh:X,reset:J,resetUpdateTime:V,getUpdateTime:K}}),useEffect(function(){v(n.updateTime||dayjs().valueOf())},[n.updateTime]),useEffect(function(){h.current=document.querySelector(".".concat(selectorPrefix,"-mask")),h.current||(h.current=document.createElement("div"),h.current.className="".concat(selectorPrefix,"-mask"),document.body.appendChild(h.current))},[]),useLayoutEffect(function(){N.current=G.current,E.current=g.current,y.current=U.current,R.current=H.current,$()},[]),useLayoutEffect(function(){var e,t;return null!=(t=null==(e=y.current)?void 0:e.addEventListener)&&t.call(e,"touchstart",w),null!=(e=null==(t=y.current)?void 0:t.addEventListener)&&e.call(t,"mousedown",w),null!=(t=null==(e=y.current)?void 0:e.addEventListener)&&t.call(e,"scroll",q),C}),useLayoutEffect(function(){var e=debounce(function(){$(),Y()},300);return d.current=new ResizeObserver(e),d.current.observe(B.current),function(){var e;null!=(e=null==d?void 0:d.current)&&e.disconnect()}},[]),React.createElement("div",{className:classNames(selectorPrefix,null!=e?e:""),style:null!=t?t:{},ref:B},React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll"),null!=r?r:""),style:null!=c?c:{},ref:U},u),React.createElement("div",{className:"".concat(selectorPrefix,"-trigger"),ref:G},React.createElement("div",{className:"".concat(selectorPrefix,"-trigger-inner"),ref:H},f(),Q(),W()),F()))}));PullRefresh.displayName="PullRefresh";export default PullRefresh;
//# sourceMappingURL=PullRefresh.js.map
