import classNames from"classnames";import moment from"moment";import React,{forwardRef,memo,useCallback,useEffect,useImperativeHandle,useLayoutEffect,useRef}from"react";import ConditionalRender from"@baifendian/adhere-ui-conditionalrender";import Hooks from"@baifendian/adhere-ui-hooks";import Util from"@baifendian/adhere-util";import Intl from"@baifendian/adhere-util-intl";import Resource from"@baifendian/adhere-util-resource";var selectorPrefix="adhere-ui-pullrefresh",defaultImg="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHN0eWxlPSJ3aWR0aDozMDhweDtoZWlnaHQ6MzA4cHg7IiB2ZXJzaW9uPSIxLjEiIGlkPSLlm77lvaIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IiB3aWR0aD0iMTAyNHB4IiBoZWlnaHQ9IjEwMjRweCIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTAyNCAxMDI0IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCiAgPHBhdGggY2xhc3M9InN2Z3BhdGgiIGRhdGEtaW5kZXg9InBhdGhfMCIgZmlsbD0iI2VjZjBmMSIgZD0iTTc5Ny43NjQ0MiAzMjYuNTU4NDFjLTguODg0MTk5LTE1LjU2MzMyNy0yNTIuODgwMS0yODYuODE5MDE5LTI2OC4zNzk1MTItMzEzLjU2NzQ4OS0xMC4xMzA1NDQtMTcuNDQ4ODIzLTM0LjI1ODQ5NS0xNy4xOTMxNjItNDQuMzg5MDM4IDBDNDczLjY1MDkzOSAzMi4yNjEzMjQgMjMwLjk5NzI1NSAzMDQuNjM1NTMgMjE4LjM3NDAyMyAzMjcuNDIxMjY0Yy05LjIzNTczMiAxNi41NTQwMTEgMC45NTg3MjcgMzguMzgxMDE5IDIxLjk1NDgzNyAzOC4zODEwMTlsMTE5LjkwNDczMSAwIDAgMjU2LjQ5MTMwMyAwIDM2Ljc4MzE0MSAyOTEuODM2MzU0IDAgMC0yOTMuMzA2NDAyIDEyMy41Nzk4NDkgMEM3OTQuNjk2NDk1IDM2NS43NzAzMjUgODA4Ljk0OTU2MiAzNDYuMTE2NDMxIDc5Ny43NjQ0MiAzMjYuNTU4NDF6IiAvPg0KPHBhdGggY2xhc3M9InN2Z3BhdGgiIGRhdGEtaW5kZXg9InBhdGhfMSIgZmlsbD0iI2VjZjBmMSIgZD0iTTM2MC4yMDE2MzMgNjg5LjY5MjA2MWwyOTIuMzE1NzE4IDAgMCA5MC45MTkyMzItMjkyLjMxNTcxOCAwIDAtOTAuOTE5MjMyWiIgLz4NCjxwYXRoIGNsYXNzPSJzdmdwYXRoIiBkYXRhLWluZGV4PSJwYXRoXzIiIGZpbGw9IiNlY2YwZjEiIGQ9Ik0zNjAuMjAxNjMzIDg0MC45MTUxOTFsMjkyLjMxNTcxOCAwIDAgNjAuNTkxNTE2LTI5Mi4zMTU3MTggMCAwLTYwLjU5MTUxNloiIC8+DQo8cGF0aCBjbGFzcz0ic3ZncGF0aCIgZGF0YS1pbmRleD0icGF0aF8zIiBmaWxsPSIjZWNmMGYxIiBkPSJNMzYwLjIwMTYzMyA5OTIuMzkzOTgybDI5MC40MzAyMjIgMCAwIDMwLjI5NTc1OC0yOTAuNDMwMjIyIDAgMC0zMC4yOTU3NThaIiAvPg0KDQo8L3N2Zz4NCg==",useSetState=Hooks.useSetState,PullRefresh=function(r,S){var e=r.className,e=void 0===e?"":e,t=r.style,t=void 0===t?{}:t,n=r.scrollClassName,n=void 0===n?"":n,c=r.scrollStyle,c=void 0===c?{}:c,u=r.renderIcon,l=r.renderLabel,a=void 0===l?function(){return Intl.v("下拉刷新")}:l,l=r.renderCanLabel,i=void 0===l?function(){return Intl.v("松开刷新")}:l,l=r.renderLoadingAnimation,o=void 0===l?"la-ball-circus la-dark":l,l=r.isShowUpdateTime,s=void 0===l||l,l=r.updateTimeFormat,d=void 0===l?Resource.Dict.value.ResourceMomentFormat18.value():l,l=r.children,m=useSetState(!1),O=m[0],f=m[1],m=useSetState(moment().valueOf()),M=m[0],g=m[1],Y=useRef(null),Z=useRef(null),v=useRef(null),I=useRef(null),B=useRef(null),N=useRef(null),y=useRef(null),E=useRef(null),R=useRef(null),T=useRef(null),D=useRef(!0),L=useRef(200),h=useRef(-1),z=useRef(!1),x=useRef(0),m=useCallback(function(){return React.createElement(ConditionalRender,{conditional:!!u,noMatch:function(){return React.createElement("div",{className:selectorPrefix+"-trigger-icon"},React.createElement("img",{className:selectorPrefix+"-trigger-icon-inner",src:defaultImg,alt:"",ref:v}))}},function(){return React.createElement("div",{className:selectorPrefix+"-trigger-icon"},React.createElement("div",{className:selectorPrefix+"-trigger-icon-inner",ref:v},null==u?void 0:u()))})},[u]),G=useCallback(function(){return React.createElement("p",{className:selectorPrefix+"-trigger-label"},React.createElement(ConditionalRender,{conditional:O,noMatch:function(){return null==a?void 0:a()}},function(){return null==i?void 0:i()}))},[O,a,i]),H=useCallback(function(){return React.createElement(ConditionalRender,{conditional:s},function(){return React.createElement("p",{className:selectorPrefix+"-trigger-update"},Intl.v("更新时间"),"：",React.createElement("span",{className:selectorPrefix+"-trigger-update-label"},moment(M).format(d)))})},[s,M,d]),Q=useCallback(function(){return React.createElement(ConditionalRender,{conditional:!!o},function(){return React.createElement(ConditionalRender,{conditional:Util.isString(o),noMatch:function(){return React.createElement("div",{className:selectorPrefix+"-trigger-refresh",ref:I},o())}},function(){return React.createElement("div",{className:classNames(selectorPrefix+"-trigger-refresh",o),ref:I},React.createElement("div",null),React.createElement("div",null),React.createElement("div",null),React.createElement("div",null),React.createElement("div",null))})})},[o]);function j(e,t){r[e]&&r[e](t)}function p(e,t,r){e.style.transition=e.style.webkitTransition="transform "+(r=void 0===r?0:r)+"ms ease",e.style.transform=e.style.webkitTransform="translate3d(0,"+t+",0)"}function A(){w(),z.current=!1,D.current=!0,N.current.style.display="flex",I.current.style.display="none",R.current.style.display="flex",C(E.current,180,0),y.current.style.overflowY="auto",T.current.style.display="none"}function w(){var e;null!=(e=y.current)&&e.removeEventListener("mousemove",k),null!=(e=y.current)&&e.removeEventListener("mouseup",P),null!=(e=y.current)&&e.removeEventListener("touchmove",k),null!=(e=y.current)&&e.removeEventListener("touchend",P)}function U(){var e;T.current.style.display="block",w(),null!=(e=y.current)&&e.addEventListener("transitionend",function e(){var t;R.current.style.display="none",I.current.style.display="block",j("onPullRefresh"),null!=(t=y.current)&&t.removeEventListener("transitionend",e),g(moment().valueOf())}),p(y.current,x.current+"px",500),p(N.current,"calc(-100% + "+x.current+"px)",500),C(E.current,180,300)}function W(){var e;A(),null!=(e=y.current)&&e.addEventListener("transitionend",function e(){var t;null!=(t=y.current)&&t.removeEventListener("transitionend",e),R.current.style.display="flex"}),p(y.current,"0px",200),p(N.current,"calc(-100% + 0px)",200)}function F(t){return new Promise(function(e){return g(t||moment().valueOf(),function(){return e()})})}function X(){return M}function C(e,t,r){e.style.transition=e.style.webkitTransition="transform "+(r=void 0===r?0:r)+"ms linear",e.style.transform=e.style.webkitTransform="rotate("+t+"deg)"}function b(e){j("onPullStart"),h.current=(e.changedTouches?e.changedTouches[0]:e).pageY,null!=(e=y.current)&&e.addEventListener("touchmove",k),null!=(e=y.current)&&e.addEventListener("mousemove",k),null!=(e=y.current)&&e.addEventListener("touchend",P),null!=(e=y.current)&&e.addEventListener("mouseup",P)}function k(e){y.current.style.overflow="hidden";var t=(e.changedTouches?e.changedTouches[0]:e).pageY-h.current,r=Math.abs(t);0<t?(e.preventDefault(),z.current=!0,r<L.current?(p(y.current,r+"px",0),p(N.current,"calc(-100% + "+r+"px)",0),r>=x.current+80?(C(E.current,0,150),f(!0,function(){return j("onPullCanRefresh")})):(C(E.current,180,150),f(!1)),N.current.style.display="flex"):(p(y.current,L.current+"px",0),p(N.current,"calc(-100% + "+L.current+"px)",0),C(E.current,0,150),f(!0,function(){return j("onPullBottom")}))):z.current?(e.preventDefault(),p(y.current,"0px",0),p(N.current,"calc(-100% + 0px)",0),C(E.current,180,0)):A()}function P(e){var e=(e.changedTouches?e.changedTouches[0]:e).pageY-h.current,t=Math.abs(e);(0<e?!(t<L.current)||t>=x.current+80?U:(j("onPullRebound"),W):A)()}function J(e){0===e.target.scrollTop?(D.current=!0,null!=(e=y.current)&&e.addEventListener("touchstart",b),null!=(e=y.current)&&e.addEventListener("mousedown",b)):D.current&&(D.current=!1,null!=(e=y.current)&&e.removeEventListener("touchstart",b),null!=(e=y.current)&&e.removeEventListener("mousedown",b))}return useImperativeHandle(S,function(){return{refresh:U,reset:W,resetUpdateTime:F,getUpdateTime:X}}),useEffect(function(){g(r.updateTime||moment().valueOf())},[r.updateTime]),useEffect(function(){T.current=document.querySelector("."+selectorPrefix+"-mask"),T.current||(T.current=document.createElement("div"),T.current.className=selectorPrefix+"-mask",document.body.appendChild(T.current))},[]),useLayoutEffect(function(){var e;N.current=Y.current,E.current=v.current,y.current=Z.current,R.current=B.current,L.current=((e=void 0===(e=r.pullHeight)?200:e)||200)<=0?200:(e||200)>y.current.clientHeight?y.current.clientHeight:e||200,x.current=N.current.clientHeight},[]),useLayoutEffect(function(){var e;return null!=(e=y.current)&&e.addEventListener("touchstart",b),null!=(e=y.current)&&e.addEventListener("mousedown",b),null!=(e=y.current)&&e.addEventListener("scroll",J),w}),React.createElement("div",{className:classNames(selectorPrefix,e||""),style:t||{}},React.createElement("div",{className:classNames(selectorPrefix+"-scroll",n||""),style:c||{},ref:Z},l),React.createElement("div",{className:selectorPrefix+"-trigger",ref:Y},React.createElement("div",{className:selectorPrefix+"-trigger-inner",ref:B},m(),G(),H()),Q()))};export default memo(forwardRef(PullRefresh));
//# sourceMappingURL=pullrefresh.js.map
