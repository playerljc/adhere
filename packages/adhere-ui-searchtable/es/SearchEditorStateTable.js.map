{"version":3,"file":"SearchEditorStateTable.js","sources":["SearchEditorStateTable.js"],"sourcesContent":["import _Form from \"antd/es/form\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/es.promise.js\";\nimport \"core-js/modules/web.dom-collections.for-each.js\";\nimport \"core-js/modules/es.object.keys.js\";\nimport \"core-js/modules/es.array.find.js\";\nimport \"core-js/modules/es.array.map.js\";\nimport \"core-js/modules/es.array.reduce.js\";\nimport { __assign, __extends, __spreadArray } from \"tslib\";\nimport cloneDeep from 'lodash.clonedeep';\nimport moment from 'moment';\nimport React, { createRef } from 'react';\nimport SearchEditorCellStateTable from './SearchEditorCellStateTable';\nimport { SearchTableContext, selectorPrefix } from './SearchTable';\n/**\n * SearchEditorStateTable\n * @class\n * @classdesc 可编辑的表格(表格进行整体编辑)\n */\n\nvar SearchEditorStateTable =\n/** @class */\nfunction (_super) {\n  __extends(SearchEditorStateTable, _super);\n\n  function SearchEditorStateTable(props) {\n    var _this = _super.call(this, props) || this;\n\n    _this.formRef = /*#__PURE__*/createRef();\n    _this.state = __assign(__assign({}, _this.state), {\n      isTableEditor: false\n    });\n    _this.rowConfigReducers = __spreadArray(__spreadArray([], _this.rowConfigReducers, true), [_this.rowEditableReducer], false);\n    return _this;\n  }\n\n  SearchEditorStateTable.prototype.onTableRowComponentReducers = function (columns) {\n    var existsEditor = columns.some(function (column) {\n      var _a;\n\n      return '$editable' in column && ((_a = column.$editable) === null || _a === void 0 ? void 0 : _a.editable);\n    });\n\n    if (existsEditor) {\n      return __spreadArray(__spreadArray([], this.tableRowComponentReducers, true), ['useEditableTableRow'], false);\n    }\n\n    return this.tableRowComponentReducers;\n  };\n\n  SearchEditorStateTable.prototype.onTableCellComponentReducers = function (columns) {\n    var existsEditor = columns.some(function (column) {\n      var _a;\n\n      return '$editable' in column && ((_a = column.$editable) === null || _a === void 0 ? void 0 : _a.editable);\n    });\n\n    if (existsEditor) {\n      return __spreadArray(__spreadArray([], this.tableCellComponentReducers, true), ['useEditableTableCell'], false);\n    }\n\n    return this.tableCellComponentReducers;\n  };\n  /**\n   * updateEditorData\n   * @description 更新可编辑的所有单元格\n   * @return Promise<void>\n   */\n\n\n  SearchEditorStateTable.prototype.updateEditorData = function (changeData) {\n    var _this = this;\n\n    return new Promise(function (resolve) {\n      var _a;\n\n      var listData = cloneDeep(_this.state[_this.getServiceName()]); // 所有的数据\n\n      var dataSource = listData[_this.getFetchListPropName()][_this.getDataKey()] || [];\n\n      var rowKey = _this.getRowKey();\n\n      changeData.forEach(function (record) {\n        var keys = Object.keys(record);\n        keys.forEach(function (dataIndex) {\n          var value = record[dataIndex];\n\n          if (value instanceof moment) {\n            value = value.valueOf();\n          }\n\n          var recordItem = dataSource.find(function (t) {\n            return t[rowKey] === record[rowKey];\n          });\n\n          if (recordItem) {\n            recordItem[dataIndex] = value;\n          }\n        });\n      });\n\n      _this.setState((_a = {}, _a[_this.getServiceName()] = listData, _a), function () {\n        return resolve();\n      });\n    });\n  };\n  /**\n   * rowEditableReducer\n   * @description 可编辑row的处理\n   * @param params\n   */\n\n\n  SearchEditorStateTable.prototype.rowEditableReducer = function (params) {\n    var rowConfig = params.rowConfig,\n        rowIndex = params.rowIndex,\n        columns = params.columns,\n        record = params.record;\n\n    if (this.onEditorRow) {\n      rowConfig.$editable = this.onEditorRow({\n        rowIndex: rowIndex,\n        record: record,\n        columns: columns\n      });\n    }\n\n    return rowConfig;\n  };\n  /**\n   * onEditorRow\n   * @param params\n   */\n\n\n  SearchEditorStateTable.prototype.onEditorRow = function (params) {\n    return {\n      editable: true\n    };\n  };\n  /**\n   * onEditorCell\n   * @param record\n   * @param editorConfig\n   */\n\n\n  SearchEditorStateTable.prototype.onEditorCell = function (_a) {\n    var record = _a.record,\n        editorConfig = _a.editorConfig;\n\n    if (editorConfig) {\n      editorConfig.useTrigger = false;\n\n      if (this.state.isTableEditor) {\n        editorConfig.defaultStatus = 'edit';\n      }\n    }\n  };\n  /**\n   * fetchData\n   */\n\n\n  SearchEditorStateTable.prototype.fetchData = function () {\n    var _this = this;\n\n    return _super.prototype.fetchData.call(this).then(function (res) {\n      var _a, _b, _c;\n\n      var dataSource = _this.getData();\n\n      var columns = _this.getTableColumns();\n\n      (_c = (_b = (_a = _this.formRef) === null || _a === void 0 ? void 0 : _a.current) === null || _b === void 0 ? void 0 : _b.setFieldValue) === null || _c === void 0 ? void 0 : _c.call(_b, 'dataSource', (dataSource || []).map(function (_record) {\n        var _a;\n\n        return (columns || []).reduce(function (_r, _a) {\n          var dataIndex = _a.dataIndex,\n              $editable = _a.$editable;\n\n          if (dataIndex in _record && $editable && 'type' in $editable) {\n            _r[dataIndex] = _this.valueToFormItemValue({\n              type: $editable.type,\n              record: _record,\n              dataIndex: dataIndex\n            });\n          }\n\n          return _r;\n        }, (_a = {}, _a[_this.getRowKey()] = _record[_this.getRowKey()], _a));\n      }));\n\n      _this.setState({\n        isTableEditor: false\n      });\n\n      return res;\n    });\n  };\n  /**\n   * render\n   * @protected\n   */\n\n\n  SearchEditorStateTable.prototype.render = function () {\n    var _this = this;\n\n    return /*#__PURE__*/React.createElement(\"div\", {\n      className: \"\".concat(selectorPrefix, \"-wrap\")\n    }, /*#__PURE__*/React.createElement(_Form, {\n      // @ts-ignore\n      ref: this.formRef,\n      className: \"\".concat(selectorPrefix, \"-form\"),\n      component: false\n    }, /*#__PURE__*/React.createElement(_Form.List, {\n      name: \"dataSource\"\n    }, function (fields, operation, meta) {\n      var _a;\n\n      return /*#__PURE__*/React.createElement(SearchTableContext.Provider, {\n        value: {\n          context: _this,\n          // @ts-ignore\n          form: (_a = _this.formRef) === null || _a === void 0 ? void 0 : _a.current,\n          formList: {\n            fields: fields,\n            operation: operation,\n            meta: meta\n          }\n        }\n      }, _this.renderChildren());\n    })));\n  };\n\n  return SearchEditorStateTable;\n}(SearchEditorCellStateTable);\n\nexport default SearchEditorStateTable;"],"names":["_Form","__assign","__extends","__spreadArray","cloneDeep","moment","React","createRef","SearchEditorCellStateTable","SearchTableContext","selectorPrefix","SearchEditorStateTable","_super","props","_this","call","this","formRef","state","isTableEditor","rowConfigReducers","rowEditableReducer","prototype","onTableRowComponentReducers","columns","some","column","_a","$editable","editable","tableRowComponentReducers","onTableCellComponentReducers","tableCellComponentReducers","updateEditorData","changeData","Promise","resolve","listData","getServiceName","dataSource","getFetchListPropName","getDataKey","rowKey","getRowKey","forEach","record","Object","keys","dataIndex","value","recordItem","valueOf","find","t","setState","params","rowConfig","rowIndex","onEditorRow","onEditorCell","editorConfig","useTrigger","defaultStatus","fetchData","then","res","_b","_c","getData","getTableColumns","current","setFieldValue","map","_record","reduce","_r","valueToFormItemValue","type","render","createElement","className","concat","ref","component","List","name","fields","operation","meta","Provider","context","form","formList","renderChildren"],"mappings":"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"}