{"version":3,"file":"index.js","sources":["Extension/ExportExcel/index.js"],"sourcesContent":["import _FileExcelOutlined from \"@ant-design/icons/es/icons/FileExcelOutlined\";\nimport ExcelJS from 'exceljs';\nimport FileSaver from 'file-saver';\nimport React from 'react';\nimport GlobalIndicator from '@baifendian/adhere-ui-globalindicator';\nimport ErrorPrompt from '@baifendian/adhere-ui-prompt-errorprompt';\nimport SuccessPrompt from '@baifendian/adhere-ui-prompt-successprompt';\nimport Util from '@baifendian/adhere-util';\nimport { selectorPrefix } from '../../SearchTable';\n/**\n * isLeaf\n * @param column\n */\nfunction isLeaf(column) {\n  return !('children' in column) || Array.isArray(column.children) && !column.children.length;\n}\n/**\n * renderTitle\n * @param worksheet\n * @param title\n * @param columnsLength\n */\nfunction renderTitle(_a) {\n  var worksheet = _a.worksheet,\n    title = _a.title,\n    columnsLength = _a.columnsLength;\n  worksheet.mergeCells(1, 1, 1, columnsLength);\n  var mergedCell = worksheet.getCell('A1');\n  mergedCell.value = title;\n  mergedCell.alignment = {\n    vertical: 'middle',\n    horizontal: 'center'\n  };\n  mergedCell.font = {\n    bold: true,\n    size: 14\n  };\n  mergedCell.fill = {\n    type: 'pattern',\n    pattern: 'solid',\n    fgColor: {\n      argb: '8DB4E2'\n    }\n  };\n  mergedCell.border = {\n    top: {\n      style: 'thin'\n    },\n    left: {\n      style: 'thin'\n    },\n    bottom: {\n      style: 'thin'\n    },\n    right: {\n      style: 'thin'\n    }\n  };\n}\n/**\n * renderColumns\n * @description\n *   // getTreeLevel 获取Tree层级\n *   // getLeafNodes 获取所有叶子节点\n *   // 是否是叶子节点\n *   // 当前几点在第几层\n *   // 是叶子节点竖着合并\n *   // 不是叶子节点横着合并\n * @param worksheet\n * @param leafNodes\n * @param columns\n * @param level\n */\nfunction renderColumns(_a) {\n  var worksheet = _a.worksheet,\n    columns = _a.columns,\n    leafNodes = _a.leafNodes,\n    level = _a.level;\n  var startRowNumber = 1;\n  function addColumnToWorksheet(_columns) {\n    var _a;\n    var _loop_1 = function _loop_1(i) {\n      var column = _columns[i];\n      // 当前节点所在的层级(从1开始)\n      var currentLevel = Util.getNodeLevel(columns, column, 'key');\n      var cell = void 0;\n      var mergeCellsData = void 0;\n      if (isLeaf(column)) {\n        // 竖着合并\n        // 按开始行，开始列，结束行，结束列合并（相当于 K10:M12）\n        var position = leafNodes.findIndex(function (node) {\n          return node.key === column.key;\n        }) + 1;\n        mergeCellsData = {\n          startRow: startRowNumber + currentLevel,\n          startCell: position,\n          endRow: startRowNumber + level,\n          endCell: position\n        };\n      } else {\n        // 横着合并\n        var _leafNodes_1 = Util.getLeafNodes(column.children);\n        var position = leafNodes.findIndex(function (node) {\n          return node.key === _leafNodes_1[0].key;\n        }) + 1;\n        mergeCellsData = {\n          startRow: startRowNumber + currentLevel,\n          startCell: position,\n          endRow: startRowNumber + currentLevel,\n          endCell: position + _leafNodes_1.length - 1\n        };\n      }\n      if (mergeCellsData) {\n        worksheet.mergeCells(mergeCellsData.startRow, mergeCellsData.startCell, mergeCellsData.endRow, mergeCellsData.endCell);\n        cell = worksheet.getRow(mergeCellsData.startRow).getCell(mergeCellsData.startCell);\n      }\n      if (cell) {\n        cell.value = column.title;\n        cell.font = {\n          bold: true,\n          size: 12\n        };\n        cell.alignment = {\n          vertical: 'middle',\n          horizontal: 'center'\n        };\n        cell.border = {\n          top: {\n            style: 'thin'\n          },\n          left: {\n            style: 'thin'\n          },\n          bottom: {\n            style: 'thin'\n          },\n          right: {\n            style: 'thin'\n          }\n        };\n        cell.fill = {\n          type: 'pattern',\n          pattern: 'solid',\n          fgColor: {\n            argb: 'C5D9F1'\n          }\n        };\n      }\n      addColumnToWorksheet((_a = column.children) !== null && _a !== void 0 ? _a : []);\n    };\n    for (var i = 0; i < _columns.length; i++) {\n      _loop_1(i);\n    }\n  }\n  addColumnToWorksheet(columns);\n}\n/**\n * renderData\n * @param worksheet\n * @param leafNodes\n * @param level\n * @param dataSource\n */\nfunction renderData(_a) {\n  var worksheet = _a.worksheet,\n    leafNodes = _a.leafNodes,\n    level = _a.level,\n    dataSource = _a.dataSource;\n  var rowCount = 0;\n  var addDataToWorksheet = function addDataToWorksheet(data, currentLevel, parentRow) {\n    // 数据\n    data.forEach(function (record, _index) {\n      var row = worksheet.getRow(1 + level + 1 + rowCount++);\n      row.indent = currentLevel * 2; // 设置缩进以表示层级\n      if (parentRow) {\n        row.outlineLevel = currentLevel; // 创建分组以表示层次结构\n      }\n\n      leafNodes.forEach(function (_a, _columnIndex) {\n        var dataIndex = _a.dataIndex;\n        var cell = row.getCell(_columnIndex + 1);\n        cell.value = record[dataIndex];\n        cell.font = {\n          bold: false,\n          size: 10\n        };\n        cell.alignment = {\n          vertical: 'middle',\n          horizontal: 'center'\n        };\n        cell.border = {\n          top: {\n            style: 'thin'\n          },\n          left: {\n            style: 'thin'\n          },\n          bottom: {\n            style: 'thin'\n          },\n          right: {\n            style: 'thin'\n          }\n        };\n      });\n      if ('children' in record && Array.isArray(record.children) && !!record.children.length) {\n        addDataToWorksheet(record.children, currentLevel + 1, row);\n      }\n    });\n  };\n  addDataToWorksheet(dataSource, 0);\n}\n/**\n * columnsAdaption\n * @param worksheet\n */\nfunction columnsAdaption(worksheet) {\n  // 自适应列宽度\n  worksheet.columns.forEach(function (column) {\n    var _a;\n    var maxLength = 0;\n    (_a = column === null || column === void 0 ? void 0 : column.eachCell) === null || _a === void 0 ? void 0 : _a.call(column, {\n      includeEmpty: true\n    }, function (cell) {\n      var length = cell.value ? cell.value.toString().length : 10;\n      if (length > maxLength) {\n        maxLength = length;\n      }\n    });\n    column.width = maxLength < 10 ? 10 : maxLength + 2; // 适当增加列宽度\n  });\n}\n/**\n * download\n * @param workbook\n * @param title\n */\nfunction download(_a) {\n  var workbook = _a.workbook,\n    title = _a.title;\n  return workbook.xlsx.writeBuffer().then(function (buffer) {\n    FileSaver(new Blob([buffer], {\n      type: 'application/octet-stream'\n    }), \"\".concat(title, \".xlsx\"));\n  });\n}\n/**\n * exportExcel\n * @param dataSource\n * @param columns\n * @param title\n */\nfunction exportExcel(_a) {\n  var dataSource = _a.dataSource,\n    columns = _a.columns,\n    title = _a.title;\n  var workbook = new ExcelJS.Workbook();\n  var worksheet = workbook.addWorksheet(title);\n  var leafNodes = Util.getLeafNodes(columns);\n  var level = Util.getTreeLevel(columns, 'key');\n  // 标题\n  renderTitle({\n    worksheet: worksheet,\n    title: title,\n    columnsLength: leafNodes.length\n  });\n  // 列\n  renderColumns({\n    worksheet: worksheet,\n    leafNodes: leafNodes,\n    columns: columns,\n    level: level\n  });\n  // 数据\n  renderData({\n    worksheet: worksheet,\n    leafNodes: leafNodes,\n    level: level,\n    dataSource: dataSource\n  });\n  // 列宽自适应\n  columnsAdaption(worksheet);\n  // 导出\n  return download({\n    workbook: workbook,\n    title: title\n  });\n}\n/**\n * ExportExcel\n * @description 导出excel\n * @param {String} name\n * @param {Function} getColumns\n * @constructor\n */\nvar ExportExcel = function ExportExcel(_a) {\n  var _b = _a.title,\n    title = _b === void 0 ? 'excel' : _b,\n    getDataSource = _a.getDataSource,\n    getColumns = _a.getColumns;\n  function onExportExcel() {\n    var indicator = GlobalIndicator.show();\n    var columns = getColumns();\n    var dataSource = getDataSource();\n    return exportExcel({\n      dataSource: dataSource,\n      columns: columns,\n      title: title\n    }).then(function () {\n      GlobalIndicator.hide(indicator);\n      SuccessPrompt.openSuccessMessage();\n    }).catch(function (err) {\n      GlobalIndicator.hide(indicator);\n      ErrorPrompt.openErrorMessage(err);\n    });\n  }\n  return /*#__PURE__*/React.createElement(_FileExcelOutlined, {\n    onClick: onExportExcel,\n    className: \"\".concat(selectorPrefix, \"-export-excel\")\n  });\n};\nexport default ExportExcel;"],"names":["_FileExcelOutlined","ExcelJS","FileSaver","React","GlobalIndicator","ErrorPrompt","SuccessPrompt","Util","selectorPrefix","isLeaf","column","Array","isArray","children","length","renderTitle","_a","worksheet","title","columnsLength","mergedCell","mergeCells","getCell","value","alignment","vertical","horizontal","font","bold","size","fill","type","pattern","fgColor","argb","border","top","style","left","bottom","right","renderColumns","columns","leafNodes","level","addColumnToWorksheet","_columns","i","_loop_1","_leafNodes_1","position","currentLevel","getNodeLevel","cell","mergeCellsData","startRow","startCell","findIndex","node","key","endRow","endCell","getLeafNodes","getRow","renderData","dataSource","rowCount","addDataToWorksheet","data","parentRow","forEach","record","_index","row","indent","outlineLevel","_columnIndex","dataIndex","columnsAdaption","maxLength","eachCell","call","includeEmpty","toString","width","download","workbook","xlsx","writeBuffer","then","buffer","Blob","concat","exportExcel","Workbook","addWorksheet","getTreeLevel","ExportExcel","_b","getDataSource","getColumns","createElement","onClick","indicator","show","hide","openSuccessMessage","catch","err","openErrorMessage","className"],"mappings":"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"}