{"version":3,"file":"index.js","sources":["Extension/ExportExcel/index.js"],"sourcesContent":["import _FileExcelOutlined from \"@ant-design/icons/es/icons/FileExcelOutlined\";\nimport _Tooltip from \"antd/es/tooltip\";\nimport ExcelJS from 'exceljs';\nimport FileSaver from 'file-saver';\nimport React from 'react';\nimport GlobalIndicator from '@baifendian/adhere-ui-globalindicator';\nimport ErrorPrompt from '@baifendian/adhere-ui-prompt-errorprompt';\nimport SuccessPrompt from '@baifendian/adhere-ui-prompt-successprompt';\nimport Util from '@baifendian/adhere-util';\nimport Intl from '@baifendian/adhere-util-intl';\nimport { selectorPrefix } from '../../SearchTable';\n/**\n * isLeaf\n * @param column\n */\nfunction isLeaf(column) {\n  return !('children' in column) || Array.isArray(column.children) && !column.children.length;\n}\n/**\n * renderTitle\n * @param worksheet\n * @param title\n * @param columnsLength\n */\nfunction renderTitle(_a) {\n  var worksheet = _a.worksheet,\n    title = _a.title,\n    columnsLength = _a.columnsLength;\n  worksheet.mergeCells(1, 1, 1, columnsLength);\n  var mergedCell = worksheet.getCell('A1');\n  mergedCell.value = getTitleByTitle(title);\n  mergedCell.alignment = {\n    vertical: 'middle',\n    horizontal: 'center'\n  };\n  mergedCell.font = {\n    bold: true,\n    size: 14\n  };\n  mergedCell.fill = {\n    type: 'pattern',\n    pattern: 'solid',\n    fgColor: {\n      argb: '8DB4E2'\n    }\n  };\n  mergedCell.border = {\n    top: {\n      style: 'thin'\n    },\n    left: {\n      style: 'thin'\n    },\n    bottom: {\n      style: 'thin'\n    },\n    right: {\n      style: 'thin'\n    }\n  };\n}\n/**\n * renderColumns\n * @description\n *   // getTreeLevel 获取Tree层级\n *   // getLeafNodes 获取所有叶子节点\n *   // 是否是叶子节点\n *   // 当前几点在第几层\n *   // 是叶子节点竖着合并\n *   // 不是叶子节点横着合并\n * @param worksheet\n * @param leafNodes\n * @param columns\n * @param level\n */\nfunction renderColumns(_a) {\n  var worksheet = _a.worksheet,\n    columns = _a.columns,\n    leafNodes = _a.leafNodes,\n    level = _a.level;\n  var startRowNumber = 1;\n  function addColumnToWorksheet(_columns) {\n    var _a;\n    var _loop_1 = function (i) {\n      var column = _columns[i];\n      // 当前节点所在的层级(从1开始)\n      var currentLevel = Util.getNodeLevel(columns, column, 'key');\n      var cell = void 0;\n      var mergeCellsData = void 0;\n      if (isLeaf(column)) {\n        // 竖着合并\n        var position = leafNodes.findIndex(function (node) {\n          return node.key === column.key;\n        }) + 1;\n        mergeCellsData = {\n          startRow: startRowNumber + currentLevel,\n          startCell: position,\n          endRow: startRowNumber + level,\n          endCell: position\n        };\n      } else {\n        // 横着合并\n        var _leafNodes_1 = Util.getLeafNodes(column.children);\n        var position = leafNodes.findIndex(function (node) {\n          return node.key === _leafNodes_1[0].key;\n        }) + 1;\n        mergeCellsData = {\n          startRow: startRowNumber + currentLevel,\n          startCell: position,\n          endRow: startRowNumber + currentLevel,\n          endCell: position + _leafNodes_1.length - 1\n        };\n      }\n      if (mergeCellsData) {\n        worksheet.mergeCells(mergeCellsData.startRow, mergeCellsData.startCell, mergeCellsData.endRow, mergeCellsData.endCell);\n        cell = worksheet.getRow(mergeCellsData.startRow).getCell(mergeCellsData.startCell);\n      }\n      if (cell) {\n        cell.value = column.title;\n        cell.font = {\n          bold: true,\n          size: 12\n        };\n        cell.alignment = {\n          vertical: 'middle',\n          horizontal: 'center'\n        };\n        cell.border = {\n          top: {\n            style: 'thin'\n          },\n          left: {\n            style: 'thin'\n          },\n          bottom: {\n            style: 'thin'\n          },\n          right: {\n            style: 'thin'\n          }\n        };\n        cell.fill = {\n          type: 'pattern',\n          pattern: 'solid',\n          fgColor: {\n            argb: 'C5D9F1'\n          }\n        };\n      }\n      addColumnToWorksheet((_a = column.children) !== null && _a !== void 0 ? _a : []);\n    };\n    for (var i = 0; i < _columns.length; i++) {\n      _loop_1(i);\n    }\n  }\n  addColumnToWorksheet(columns);\n}\n/**\n * renderData\n * @param worksheet\n * @param leafNodes\n * @param level\n * @param dataSource\n */\nfunction renderData(_a) {\n  var worksheet = _a.worksheet,\n    leafNodes = _a.leafNodes,\n    level = _a.level,\n    dataSource = _a.dataSource;\n  var rowCount = 0;\n  var addDataToWorksheet = function (data, currentLevel, parentRow) {\n    // 数据\n    data.forEach(function (record, _index) {\n      var row = worksheet.getRow(1 + level + 1 + rowCount++);\n      row.indent = currentLevel * 2; // 设置缩进以表示层级\n      if (parentRow) {\n        row.outlineLevel = currentLevel; // 创建分组以表示层次结构\n      }\n      leafNodes.forEach(function (_a, _columnIndex) {\n        var dataIndex = _a.dataIndex;\n        var cell = row.getCell(_columnIndex + 1);\n        cell.value = record[dataIndex];\n        cell.font = {\n          bold: false,\n          size: 10\n        };\n        cell.alignment = {\n          vertical: 'middle',\n          horizontal: 'center'\n        };\n        cell.border = {\n          top: {\n            style: 'thin'\n          },\n          left: {\n            style: 'thin'\n          },\n          bottom: {\n            style: 'thin'\n          },\n          right: {\n            style: 'thin'\n          }\n        };\n      });\n      if ('children' in record && Array.isArray(record.children) && !!record.children.length) {\n        addDataToWorksheet(record.children, currentLevel + 1, row);\n      }\n    });\n  };\n  addDataToWorksheet(dataSource, 0);\n}\n/**\n * columnsAdaption\n * @param worksheet\n */\nfunction columnsAdaption(worksheet) {\n  // 自适应列宽度\n  worksheet.columns.forEach(function (column) {\n    var _a;\n    var maxLength = 0;\n    (_a = column === null || column === void 0 ? void 0 : column.eachCell) === null || _a === void 0 ? void 0 : _a.call(column, {\n      includeEmpty: true\n    }, function (cell) {\n      var length = cell.value ? cell.value.toString().length : 10;\n      if (length > maxLength) {\n        maxLength = length;\n      }\n    });\n    column.width = maxLength < 10 ? 10 : maxLength + 2; // 适当增加列宽度\n  });\n}\n/**\n * download\n * @param workbook\n * @param title\n */\nfunction download(_a) {\n  var workbook = _a.workbook,\n    title = _a.title;\n  return workbook.xlsx.writeBuffer().then(function (buffer) {\n    FileSaver(new Blob([buffer], {\n      type: 'application/octet-stream'\n    }), \"\".concat(title, \".xlsx\"));\n  });\n}\n/**\n * getTitleByTitle\n * @description 获取excel的title\n * @param title\n */\nfunction getTitleByTitle(title) {\n  if (!title) return 'excel';\n  if (typeof title === 'string') return title;\n  return 'excel';\n}\n/**\n * exportExcel\n * @param dataSource\n * @param columns\n * @param title\n */\nfunction exportExcel(_a) {\n  var dataSource = _a.dataSource,\n    columns = _a.columns,\n    title = _a.title;\n  var workbook = new ExcelJS.Workbook();\n  var targetTitle = getTitleByTitle(title);\n  var worksheet = workbook.addWorksheet(targetTitle);\n  var leafNodes = Util.getLeafNodes(columns);\n  var level = Util.getTreeLevel(columns, 'key');\n  // 标题\n  renderTitle({\n    worksheet: worksheet,\n    title: targetTitle,\n    columnsLength: leafNodes.length\n  });\n  // 列\n  renderColumns({\n    worksheet: worksheet,\n    leafNodes: leafNodes,\n    columns: columns,\n    level: level\n  });\n  // 数据\n  renderData({\n    worksheet: worksheet,\n    leafNodes: leafNodes,\n    level: level,\n    dataSource: dataSource\n  });\n  // 列宽自适应\n  columnsAdaption(worksheet);\n  // 导出\n  return download({\n    workbook: workbook,\n    title: targetTitle\n  });\n}\n/**\n * ExportExcel\n * @description 导出excel\n * @param {String} name\n * @param {Function} getColumns\n * @constructor\n */\nvar ExportExcel = function (_a) {\n  var _b = _a.title,\n    title = _b === void 0 ? 'excel' : _b,\n    getDataSource = _a.getDataSource,\n    getColumns = _a.getColumns,\n    renderExportExcelBtn = _a.renderExportExcelBtn;\n  function onExportExcel() {\n    var indicator = GlobalIndicator.show(document.body, \"\".concat(Intl.v('正在导出'), \"...\"), 19999, 'default');\n    var columns = getColumns();\n    var dataSource = getDataSource();\n    return exportExcel({\n      dataSource: dataSource,\n      columns: columns,\n      title: getTitleByTitle(title)\n    }).then(function () {\n      GlobalIndicator.hide(indicator);\n      SuccessPrompt.openSuccessMessage();\n    }).catch(function (err) {\n      GlobalIndicator.hide(indicator);\n      ErrorPrompt.openErrorMessage(err);\n    });\n  }\n  return /*#__PURE__*/React.createElement(_Tooltip, {\n    title: \"\".concat(Intl.v('导出excel'))\n  }, renderExportExcelBtn && renderExportExcelBtn(onExportExcel), !renderExportExcelBtn && ( /*#__PURE__*/React.createElement(_FileExcelOutlined, {\n    onClick: onExportExcel,\n    className: \"\".concat(selectorPrefix, \"-export-excel-btn\")\n  })));\n};\nExportExcel.displayName = 'ExportExcel';\nexport default ExportExcel;"],"names":["_FileExcelOutlined","_Tooltip","ExcelJS","FileSaver","React","GlobalIndicator","ErrorPrompt","SuccessPrompt","Util","Intl","selectorPrefix","isLeaf","column","Array","isArray","children","length","renderTitle","_a","worksheet","title","columnsLength","mergedCell","mergeCells","getCell","value","getTitleByTitle","alignment","vertical","horizontal","font","bold","size","fill","type","pattern","fgColor","argb","border","top","style","left","bottom","right","renderColumns","columns","leafNodes","level","addColumnToWorksheet","_columns","i","_loop_1","_leafNodes_1","position","currentLevel","getNodeLevel","cell","mergeCellsData","startRow","startCell","findIndex","node","key","endRow","endCell","getLeafNodes","getRow","renderData","addDataToWorksheet","data","parentRow","forEach","record","_index","row","rowCount","indent","outlineLevel","_columnIndex","dataIndex","dataSource","columnsAdaption","maxLength","eachCell","call","includeEmpty","toString","width","download","workbook","xlsx","writeBuffer","then","buffer","Blob","concat","exportExcel","Workbook","targetTitle","addWorksheet","getTreeLevel","ExportExcel","_b","getDataSource","getColumns","renderExportExcelBtn","onExportExcel","indicator","show","document","body","v","hide","openSuccessMessage","catch","err","openErrorMessage","createElement","onClick","className","displayName"],"mappings":"OAAOA,uBAAwB,sDACxBC,aAAc,yBACdC,YAAa,iBACbC,cAAe,oBACfC,UAAW,eACXC,oBAAqB,+CACrBC,gBAAiB,kDACjBC,kBAAmB,oDACnBC,SAAU,iCACVC,SAAU,sCACRC,cAAyC,KAAnB,oBAK/B,SAASC,OAAOC,GACd,MAAO,EAAE,aAAcA,IAAWC,MAAMC,QAAQF,EAAOG,QAAQ,GAAK,CAACH,EAAOG,SAASC,MACvF,CAOA,SAASC,YAAYC,GACnB,IAAIC,EAAYD,EAAGC,UACjBC,EAAQF,EAAGE,MACXC,EAAgBH,EAAGG,cAEjBC,GADJH,EAAUI,WAAW,EAAG,EAAG,EAAGF,CAAa,EAC1BF,EAAUK,QAAQ,IAAI,GACvCF,EAAWG,MAAQC,gBAAgBN,CAAK,EACxCE,EAAWK,UAAY,CACrBC,SAAU,SACVC,WAAY,QACd,EACAP,EAAWQ,KAAO,CAChBC,KAAM,CAAA,EACNC,KAAM,EACR,EACAV,EAAWW,KAAO,CAChBC,KAAM,UACNC,QAAS,QACTC,QAAS,CACPC,KAAM,QACR,CACF,EACAf,EAAWgB,OAAS,CAClBC,IAAK,CACHC,MAAO,MACT,EACAC,KAAM,CACJD,MAAO,MACT,EACAE,OAAQ,CACNF,MAAO,MACT,EACAG,MAAO,CACLH,MAAO,MACT,CACF,CACF,CAeA,SAASI,cAAc1B,GACrB,IAAIC,EAAYD,EAAGC,UACjB0B,EAAU3B,EAAG2B,QACbC,EAAY5B,EAAG4B,UACfC,EAAQ7B,EAAG6B,MA4EbC,CA1EA,SAASA,EAAqBC,GAsE5B,IArEA,IAAI/B,EAqEKgC,EAAI,EAAGA,EAAID,EAASjC,OAAQkC,CAAC,GACpCC,CArEY,SAAUD,GACtB,IAkBME,EACAC,EAnBFzC,EAASqC,EAASC,GAElBI,EAAe9C,KAAK+C,aAAaV,EAASjC,EAAQ,KAAK,EACvD4C,EAAO,KAAA,EACPC,EAAiB,KAAA,GAMnBA,EALE9C,OAAOC,CAAM,EAKE,CACf8C,SAfa,EAecJ,EAC3BK,UAAWN,EALEP,EAAUc,UAAU,SAAUC,GAC3C,OAAOA,EAAKC,MAAQlD,EAAOkD,GAC7B,CAAC,EAAI,EAIHC,OAjBa,EAiBYhB,EACzBiB,QAASX,CACX,GAGID,EAAe5C,KAAKyD,aAAarD,EAAOG,QAAQ,EAInC,CACf2C,SA3Ba,EA2BcJ,EAC3BK,UAAWN,EALEP,EAAUc,UAAU,SAAUC,GAC3C,OAAOA,EAAKC,MAAQV,EAAa,GAAGU,GACtC,CAAC,EAAI,EAIHC,OA7Ba,EA6BYT,EACzBU,QAASX,EAAWD,EAAapC,OAAS,CAC5C,MAGAG,EAAUI,WAAWkC,EAAeC,SAAUD,EAAeE,UAAWF,EAAeM,OAAQN,EAAeO,OAAO,EACrHR,EAAOrC,EAAU+C,OAAOT,EAAeC,QAAQ,EAAElC,QAAQiC,EAAeE,SAAS,GAE/EH,IACFA,EAAK/B,MAAQb,EAAOQ,MACpBoC,EAAK1B,KAAO,CACVC,KAAM,CAAA,EACNC,KAAM,EACR,EACAwB,EAAK7B,UAAY,CACfC,SAAU,SACVC,WAAY,QACd,EACA2B,EAAKlB,OAAS,CACZC,IAAK,CACHC,MAAO,MACT,EACAC,KAAM,CACJD,MAAO,MACT,EACAE,OAAQ,CACNF,MAAO,MACT,EACAG,MAAO,CACLH,MAAO,MACT,CACF,EACAgB,EAAKvB,KAAO,CACVC,KAAM,UACNC,QAAS,QACTC,QAAS,CACPC,KAAM,QACR,CACF,GAEFW,EAAqB,OAAC9B,EAAKN,EAAOG,UAAsCG,EAAK,EAAE,CACjF,EAEUgC,CAAC,CAEb,EACqBL,CAAO,CAC9B,CAQA,SAASsB,WAAWjD,GAMO,SAArBkD,EAA+BC,EAAMf,EAAcgB,GAErDD,EAAKE,QAAQ,SAAUC,EAAQC,GAC7B,IAAIC,EAAMvD,EAAU+C,OAAO,EAAInB,EAAQ,EAAI4B,CAAQ,EAAE,EACrDD,EAAIE,OAAwB,EAAftB,EACTgB,IACFI,EAAIG,aAAevB,GAErBR,EAAUyB,QAAQ,SAAUrD,EAAI4D,GAC1BC,EAAY7D,EAAG6D,UACfvB,EAAOkB,EAAIlD,QAAQsD,EAAe,CAAC,EACvCtB,EAAK/B,MAAQ+C,EAAOO,GACpBvB,EAAK1B,KAAO,CACVC,KAAM,CAAA,EACNC,KAAM,EACR,EACAwB,EAAK7B,UAAY,CACfC,SAAU,SACVC,WAAY,QACd,EACA2B,EAAKlB,OAAS,CACZC,IAAK,CACHC,MAAO,MACT,EACAC,KAAM,CACJD,MAAO,MACT,EACAE,OAAQ,CACNF,MAAO,MACT,EACAG,MAAO,CACLH,MAAO,MACT,CACF,CACF,CAAC,EACG,aAAcgC,GAAU3D,MAAMC,QAAQ0D,EAAOzD,QAAQ,GAAOyD,EAAOzD,SAASC,QAC9EoD,EAAmBI,EAAOzD,SAAUuC,EAAe,EAAGoB,CAAG,CAE7D,CAAC,CACH,CA5CA,IAAIvD,EAAYD,EAAGC,UACjB2B,EAAY5B,EAAG4B,UACfC,EAAQ7B,EAAG6B,MACXiC,EAAa9D,EAAG8D,WACdL,EAAW,EAyCfP,EAAmBY,EAAY,CAAC,CAClC,CAKA,SAASC,gBAAgB9D,GAEvBA,EAAU0B,QAAQ0B,QAAQ,SAAU3D,GAClC,IAAIM,EACAgE,EAAY,EAChB,OAAChE,EAAKN,MAAAA,EAAuC,KAAA,EAASA,EAAOuE,WAA+CjE,EAAGkE,KAAKxE,EAAQ,CAC1HyE,aAAc,CAAA,CAChB,EAAG,SAAU7B,GACPxC,EAASwC,EAAK/B,MAAQ+B,EAAK/B,MAAM6D,SAAS,EAAEtE,OAAS,GAC5CkE,EAATlE,IACFkE,EAAYlE,EAEhB,CAAC,EACDJ,EAAO2E,MAAQL,EAAY,GAAK,GAAKA,EAAY,CACnD,CAAC,CACH,CAMA,SAASM,SAAStE,GAChB,IAAIuE,EAAWvE,EAAGuE,SAChBrE,EAAQF,EAAGE,MACb,OAAOqE,EAASC,KAAKC,YAAY,EAAEC,KAAK,SAAUC,GAChD1F,UAAU,IAAI2F,KAAK,CAACD,GAAS,CAC3B3D,KAAM,0BACR,CAAC,EAAG,GAAG6D,OAAO3E,EAAO,OAAO,CAAC,CAC/B,CAAC,CACH,CAMA,SAASM,gBAAgBN,GACvB,OAAKA,GACgB,UAAjB,OAAOA,EAA2BA,EADnB,OAGrB,CAOA,SAAS4E,YAAY9E,GACnB,IAAI8D,EAAa9D,EAAG8D,WAClBnC,EAAU3B,EAAG2B,QACbzB,EAAQF,EAAGE,MACTqE,EAAW,IAAIvF,QAAQ+F,SACvBC,EAAcxE,gBAAgBN,CAAK,EACnCD,EAAYsE,EAASU,aAAaD,CAAW,EAC7CpD,EAAYtC,KAAKyD,aAAapB,CAAO,EACrCE,EAAQvC,KAAK4F,aAAavD,EAAS,KAAK,EAwB5C,OAtBA5B,YAAY,CACVE,UAAWA,EACXC,MAAO8E,EACP7E,cAAeyB,EAAU9B,MAC3B,CAAC,EAED4B,cAAc,CACZzB,UAAWA,EACX2B,UAAWA,EACXD,QAASA,EACTE,MAAOA,CACT,CAAC,EAEDoB,WAAW,CACThD,UAAWA,EACX2B,UAAWA,EACXC,MAAOA,EACPiC,WAAYA,CACd,CAAC,EAEDC,gBAAgB9D,CAAS,EAElBqE,SAAS,CACdC,SAAUA,EACVrE,MAAO8E,CACT,CAAC,CACH,CAQA,IAAIG,YAAc,SAAUnF,GAC1B,IAAIoF,EAAKpF,EAAGE,MACVA,EAAe,KAAA,IAAPkF,EAAgB,QAAUA,EAClCC,EAAgBrF,EAAGqF,cACnBC,EAAatF,EAAGsF,WAChBC,EAAuBvF,EAAGuF,qBAC5B,SAASC,IACP,IAAIC,EAAYtG,gBAAgBuG,KAAKC,SAASC,KAAM,GAAGf,OAAOtF,KAAKsG,EAAE,MAAM,EAAG,KAAK,EAAG,MAAO,SAAS,EAClGlE,EAAU2D,EAAW,EAEzB,OAAOR,YAAY,CACjBhB,WAFeuB,EAAc,EAG7B1D,QAASA,EACTzB,MAAOM,gBAAgBN,CAAK,CAC9B,CAAC,EAAEwE,KAAK,WACNvF,gBAAgB2G,KAAKL,CAAS,EAC9BpG,cAAc0G,mBAAmB,CACnC,CAAC,EAAEC,MAAM,SAAUC,GACjB9G,gBAAgB2G,KAAKL,CAAS,EAC9BrG,YAAY8G,iBAAiBD,CAAG,CAClC,CAAC,CACH,CACA,OAAoB/G,MAAMiH,cAAcpH,SAAU,CAChDmB,MAAO,GAAG2E,OAAOtF,KAAKsG,EAAE,SAAS,CAAC,CACpC,EAAGN,GAAwBA,EAAqBC,CAAa,EAAG,CAACD,GAAuCrG,MAAMiH,cAAcrH,mBAAoB,CAC9IsH,QAASZ,EACTa,UAAW,GAAGxB,OAAOrF,eAAgB,mBAAmB,CAC1D,CAAE,CAAC,CACL,EACA2F,YAAYmB,YAAc,6BACXnB"}