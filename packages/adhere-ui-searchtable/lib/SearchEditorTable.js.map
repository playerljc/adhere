{"version":3,"file":"SearchEditorTable.js","sources":["SearchEditorTable.js"],"sourcesContent":["\"use strict\";\n\nrequire(\"core-js/modules/es.object.define-property.js\");\n\nrequire(\"core-js/modules/es.object.to-string.js\");\n\nrequire(\"core-js/modules/es.promise.js\");\n\nrequire(\"core-js/modules/web.dom-collections.for-each.js\");\n\nrequire(\"core-js/modules/es.object.keys.js\");\n\nrequire(\"core-js/modules/es.array.find.js\");\n\nrequire(\"core-js/modules/es.array.map.js\");\n\nrequire(\"core-js/modules/es.array.reduce.js\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar tslib_1 = require(\"tslib\");\n\nvar antd_1 = require(\"antd\");\n\nvar lodash_clonedeep_1 = tslib_1.__importDefault(require(\"lodash.clonedeep\"));\n\nvar moment_1 = tslib_1.__importDefault(require(\"moment\"));\n\nvar react_1 = tslib_1.__importStar(require(\"react\"));\n\nvar SearchEditorCellTable_1 = tslib_1.__importDefault(require(\"./SearchEditorCellTable\"));\n\nvar SearchTable_1 = require(\"./SearchTable\");\n/**\n * SearchEditorTable\n * @class\n * @classdesc 可编辑的表格(表格进行整体编辑)\n */\n\n\nvar SearchEditorTable =\n/** @class */\nfunction (_super) {\n  tslib_1.__extends(SearchEditorTable, _super);\n\n  function SearchEditorTable(props) {\n    var _this = _super.call(this, props) || this;\n\n    _this.formRef = (0, react_1.createRef)();\n    _this.state = tslib_1.__assign(tslib_1.__assign({}, _this.state), {\n      isTableEditor: false\n    });\n    _this.rowConfigReducers = tslib_1.__spreadArray(tslib_1.__spreadArray([], _this.rowConfigReducers, true), [_this.rowEditableReducer], false);\n    return _this;\n  }\n\n  SearchEditorTable.prototype.onTableRowComponentReducers = function (columns) {\n    var existsEditor = columns.some(function (column) {\n      var _a;\n\n      return '$editable' in column && ((_a = column.$editable) === null || _a === void 0 ? void 0 : _a.editable);\n    });\n\n    if (existsEditor) {\n      return tslib_1.__spreadArray(tslib_1.__spreadArray([], this.tableRowComponentReducers, true), ['useEditableTableRow'], false);\n    }\n\n    return this.tableRowComponentReducers;\n  };\n\n  SearchEditorTable.prototype.onTableCellComponentReducers = function (columns) {\n    var existsEditor = columns.some(function (column) {\n      var _a;\n\n      return '$editable' in column && ((_a = column.$editable) === null || _a === void 0 ? void 0 : _a.editable);\n    });\n\n    if (existsEditor) {\n      return tslib_1.__spreadArray(tslib_1.__spreadArray([], this.tableCellComponentReducers, true), ['useEditableTableCell'], false);\n    }\n\n    return this.tableCellComponentReducers;\n  };\n  /**\n   * updateEditorData\n   * @description 更新可编辑的所有单元格\n   * @return Promise<void>\n   */\n\n\n  SearchEditorTable.prototype.updateEditorData = function (changeData) {\n    var _this = this;\n\n    return new Promise(function (resolve) {\n      var _a;\n\n      var listData = (0, lodash_clonedeep_1.default)(_this.props[_this.getServiceName()]);\n      var dataSource = listData[_this.getFetchListPropName()][_this.getDataKey()] || [];\n\n      var rowKey = _this.getRowKey();\n\n      changeData.forEach(function (record) {\n        var keys = Object.keys(record);\n        keys.forEach(function (dataIndex) {\n          var value = record[dataIndex];\n\n          if (value instanceof moment_1.default) {\n            value = value.valueOf();\n          }\n\n          var recordItem = dataSource.find(function (t) {\n            return t[rowKey] === record[rowKey];\n          });\n\n          if (recordItem) {\n            recordItem[dataIndex] = value;\n          }\n        });\n      });\n\n      _this.props.dispatch((_a = {\n        type: \"\".concat(_this.getServiceName(), \"/receive\")\n      }, _a[_this.getServiceName()] = listData, _a)).then(function () {\n        return resolve();\n      });\n    });\n  };\n  /**\n   * rowEditableReducer\n   * @description 可编辑row的处理\n   * @param params\n   */\n\n\n  SearchEditorTable.prototype.rowEditableReducer = function (params) {\n    var rowConfig = params.rowConfig,\n        rowIndex = params.rowIndex,\n        columns = params.columns,\n        record = params.record;\n\n    if (this.onEditorRow) {\n      rowConfig.$editable = this.onEditorRow({\n        rowIndex: rowIndex,\n        record: record,\n        columns: columns\n      });\n    }\n\n    return rowConfig;\n  };\n  /**\n   * onEditorRow\n   * @param params\n   */\n\n\n  SearchEditorTable.prototype.onEditorRow = function (params) {\n    return {\n      editable: true\n    };\n  };\n  /**\n   * onEditorCell\n   * @param record\n   * @param editorConfig\n   */\n\n\n  SearchEditorTable.prototype.onEditorCell = function (_a) {\n    var record = _a.record,\n        editorConfig = _a.editorConfig;\n\n    if (editorConfig) {\n      editorConfig.useTrigger = false;\n\n      if (this.state.isTableEditor) {\n        editorConfig.defaultStatus = 'edit';\n      }\n    }\n  };\n  /**\n   * fetchData\n   */\n\n\n  SearchEditorTable.prototype.fetchData = function () {\n    var _this = this;\n\n    return _super.prototype.fetchData.call(this).then(function (res) {\n      var _a, _b, _c;\n\n      var dataSource = _this.getData();\n\n      var columns = _this.getTableColumns();\n\n      (_c = (_b = (_a = _this.formRef) === null || _a === void 0 ? void 0 : _a.current) === null || _b === void 0 ? void 0 : _b.setFieldValue) === null || _c === void 0 ? void 0 : _c.call(_b, 'dataSource', (dataSource || []).map(function (_record) {\n        var _a;\n\n        return (columns || []).reduce(function (_r, _a) {\n          var dataIndex = _a.dataIndex,\n              $editable = _a.$editable;\n\n          if (dataIndex in _record && $editable && 'type' in $editable) {\n            _r[dataIndex] = _this.valueToFormItemValue({\n              type: $editable.type,\n              record: _record,\n              dataIndex: dataIndex\n            });\n          }\n\n          return _r;\n        }, (_a = {}, _a[_this.getRowKey()] = _record[_this.getRowKey()], _a));\n      }));\n\n      _this.setState({\n        isTableEditor: false\n      });\n\n      return res;\n    });\n  };\n  /**\n   * render\n   * @protected\n   */\n\n\n  SearchEditorTable.prototype.render = function () {\n    var _this = this;\n\n    return react_1.default.createElement(\"div\", {\n      className: \"\".concat(SearchTable_1.selectorPrefix, \"-wrap\")\n    }, react_1.default.createElement(antd_1.Form // @ts-ignore\n    , {\n      // @ts-ignore\n      ref: this.formRef,\n      className: \"\".concat(SearchTable_1.selectorPrefix, \"-form\"),\n      component: false\n    }, react_1.default.createElement(antd_1.Form.List, {\n      name: \"dataSource\"\n    }, function (fields, operation, meta) {\n      var _a;\n\n      return react_1.default.createElement(SearchTable_1.SearchTableContext.Provider, {\n        value: {\n          context: _this,\n          // @ts-ignore\n          form: (_a = _this.formRef) === null || _a === void 0 ? void 0 : _a.current,\n          formList: {\n            fields: fields,\n            operation: operation,\n            meta: meta\n          }\n        }\n      }, _this.renderChildren());\n    })));\n  };\n\n  return SearchEditorTable;\n}(SearchEditorCellTable_1.default);\n\nexports.default = SearchEditorTable;"],"names":["require","Object","defineProperty","exports","value","tslib_1","antd_1","lodash_clonedeep_1","__importDefault","moment_1","react_1","__importStar","SearchEditorCellTable_1","SearchTable_1","SearchEditorTable","_super","props","_this","call","this","formRef","createRef","state","__assign","isTableEditor","rowConfigReducers","__spreadArray","rowEditableReducer","__extends","prototype","onTableRowComponentReducers","columns","some","column","_a","$editable","editable","tableRowComponentReducers","onTableCellComponentReducers","tableCellComponentReducers","updateEditorData","changeData","Promise","resolve","listData","default","getServiceName","dataSource","getFetchListPropName","getDataKey","rowKey","getRowKey","forEach","record","keys","dataIndex","recordItem","valueOf","find","t","dispatch","type","concat","then","params","rowConfig","rowIndex","onEditorRow","onEditorCell","editorConfig","useTrigger","defaultStatus","fetchData","res","_b","_c","getData","getTableColumns","current","setFieldValue","map","_record","reduce","_r","valueToFormItemValue","setState","render","createElement","className","selectorPrefix","Form","ref","component","List","name","fields","operation","meta","SearchTableContext","Provider","context","form","formList","renderChildren"],"mappings":"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"}