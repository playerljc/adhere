{"version":3,"file":"index.js","sources":["Extension/ExportExcel/index.js"],"sourcesContent":["\"use strict\";\n\nvar __importDefault = void 0 && (void 0).__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar exceljs_1 = __importDefault(require(\"exceljs\"));\nvar file_saver_1 = __importDefault(require(\"file-saver\"));\nvar react_1 = __importDefault(require(\"react\"));\nvar icons_1 = require(\"@ant-design/icons\");\nvar adhere_ui_globalindicator_1 = __importDefault(require(\"@baifendian/adhere-ui-globalindicator\"));\nvar adhere_ui_prompt_errorprompt_1 = __importDefault(require(\"@baifendian/adhere-ui-prompt-errorprompt\"));\nvar adhere_ui_prompt_successprompt_1 = __importDefault(require(\"@baifendian/adhere-ui-prompt-successprompt\"));\nvar adhere_util_1 = __importDefault(require(\"@baifendian/adhere-util\"));\nvar SearchTable_1 = require(\"../../SearchTable\");\n/**\n * isLeaf\n * @param column\n */\nfunction isLeaf(column) {\n  return !('children' in column) || Array.isArray(column.children) && !column.children.length;\n}\n/**\n * renderTitle\n * @param worksheet\n * @param title\n * @param columnsLength\n */\nfunction renderTitle(_a) {\n  var worksheet = _a.worksheet,\n    title = _a.title,\n    columnsLength = _a.columnsLength;\n  worksheet.mergeCells(1, 1, 1, columnsLength);\n  var mergedCell = worksheet.getCell('A1');\n  mergedCell.value = title;\n  mergedCell.alignment = {\n    vertical: 'middle',\n    horizontal: 'center'\n  };\n  mergedCell.font = {\n    bold: true,\n    size: 14\n  };\n  mergedCell.fill = {\n    type: 'pattern',\n    pattern: 'solid',\n    fgColor: {\n      argb: '8DB4E2'\n    }\n  };\n  mergedCell.border = {\n    top: {\n      style: 'thin'\n    },\n    left: {\n      style: 'thin'\n    },\n    bottom: {\n      style: 'thin'\n    },\n    right: {\n      style: 'thin'\n    }\n  };\n}\n/**\n * renderColumns\n * @description\n *   // getTreeLevel 获取Tree层级\n *   // getLeafNodes 获取所有叶子节点\n *   // 是否是叶子节点\n *   // 当前几点在第几层\n *   // 是叶子节点竖着合并\n *   // 不是叶子节点横着合并\n * @param worksheet\n * @param leafNodes\n * @param columns\n * @param level\n */\nfunction renderColumns(_a) {\n  var worksheet = _a.worksheet,\n    columns = _a.columns,\n    leafNodes = _a.leafNodes,\n    level = _a.level;\n  var startRowNumber = 1;\n  function addColumnToWorksheet(_columns) {\n    var _a;\n    var _loop_1 = function _loop_1(i) {\n      var column = _columns[i];\n      // 当前节点所在的层级(从1开始)\n      var currentLevel = adhere_util_1.default.getNodeLevel(columns, column, 'key');\n      var cell = void 0;\n      var mergeCellsData = void 0;\n      if (isLeaf(column)) {\n        // 竖着合并\n        // 按开始行，开始列，结束行，结束列合并（相当于 K10:M12）\n        var position = leafNodes.findIndex(function (node) {\n          return node.key === column.key;\n        }) + 1;\n        mergeCellsData = {\n          startRow: startRowNumber + currentLevel,\n          startCell: position,\n          endRow: startRowNumber + level,\n          endCell: position\n        };\n      } else {\n        // 横着合并\n        var _leafNodes_1 = adhere_util_1.default.getLeafNodes(column.children);\n        var position = leafNodes.findIndex(function (node) {\n          return node.key === _leafNodes_1[0].key;\n        }) + 1;\n        mergeCellsData = {\n          startRow: startRowNumber + currentLevel,\n          startCell: position,\n          endRow: startRowNumber + currentLevel,\n          endCell: position + _leafNodes_1.length - 1\n        };\n      }\n      if (mergeCellsData) {\n        worksheet.mergeCells(mergeCellsData.startRow, mergeCellsData.startCell, mergeCellsData.endRow, mergeCellsData.endCell);\n        cell = worksheet.getRow(mergeCellsData.startRow).getCell(mergeCellsData.startCell);\n      }\n      if (cell) {\n        cell.value = column.title;\n        cell.font = {\n          bold: true,\n          size: 12\n        };\n        cell.alignment = {\n          vertical: 'middle',\n          horizontal: 'center'\n        };\n        cell.border = {\n          top: {\n            style: 'thin'\n          },\n          left: {\n            style: 'thin'\n          },\n          bottom: {\n            style: 'thin'\n          },\n          right: {\n            style: 'thin'\n          }\n        };\n        cell.fill = {\n          type: 'pattern',\n          pattern: 'solid',\n          fgColor: {\n            argb: 'C5D9F1'\n          }\n        };\n      }\n      addColumnToWorksheet((_a = column.children) !== null && _a !== void 0 ? _a : []);\n    };\n    for (var i = 0; i < _columns.length; i++) {\n      _loop_1(i);\n    }\n  }\n  addColumnToWorksheet(columns);\n}\n/**\n * renderData\n * @param worksheet\n * @param leafNodes\n * @param level\n * @param dataSource\n */\nfunction renderData(_a) {\n  var worksheet = _a.worksheet,\n    leafNodes = _a.leafNodes,\n    level = _a.level,\n    dataSource = _a.dataSource;\n  var rowCount = 0;\n  var addDataToWorksheet = function addDataToWorksheet(data, currentLevel, parentRow) {\n    // 数据\n    data.forEach(function (record, _index) {\n      var row = worksheet.getRow(1 + level + 1 + rowCount++);\n      row.indent = currentLevel * 2; // 设置缩进以表示层级\n      if (parentRow) {\n        row.outlineLevel = currentLevel; // 创建分组以表示层次结构\n      }\n\n      leafNodes.forEach(function (_a, _columnIndex) {\n        var dataIndex = _a.dataIndex;\n        var cell = row.getCell(_columnIndex + 1);\n        cell.value = record[dataIndex];\n        cell.font = {\n          bold: false,\n          size: 10\n        };\n        cell.alignment = {\n          vertical: 'middle',\n          horizontal: 'center'\n        };\n        cell.border = {\n          top: {\n            style: 'thin'\n          },\n          left: {\n            style: 'thin'\n          },\n          bottom: {\n            style: 'thin'\n          },\n          right: {\n            style: 'thin'\n          }\n        };\n      });\n      if ('children' in record && Array.isArray(record.children) && !!record.children.length) {\n        addDataToWorksheet(record.children, currentLevel + 1, row);\n      }\n    });\n  };\n  addDataToWorksheet(dataSource, 0);\n}\n/**\n * columnsAdaption\n * @param worksheet\n */\nfunction columnsAdaption(worksheet) {\n  // 自适应列宽度\n  worksheet.columns.forEach(function (column) {\n    var _a;\n    var maxLength = 0;\n    (_a = column === null || column === void 0 ? void 0 : column.eachCell) === null || _a === void 0 ? void 0 : _a.call(column, {\n      includeEmpty: true\n    }, function (cell) {\n      var length = cell.value ? cell.value.toString().length : 10;\n      if (length > maxLength) {\n        maxLength = length;\n      }\n    });\n    column.width = maxLength < 10 ? 10 : maxLength + 2; // 适当增加列宽度\n  });\n}\n/**\n * download\n * @param workbook\n * @param title\n */\nfunction download(_a) {\n  var workbook = _a.workbook,\n    title = _a.title;\n  return workbook.xlsx.writeBuffer().then(function (buffer) {\n    (0, file_saver_1.default)(new Blob([buffer], {\n      type: 'application/octet-stream'\n    }), \"\".concat(title, \".xlsx\"));\n  });\n}\n/**\n * exportExcel\n * @param dataSource\n * @param columns\n * @param title\n */\nfunction exportExcel(_a) {\n  var dataSource = _a.dataSource,\n    columns = _a.columns,\n    title = _a.title;\n  var workbook = new exceljs_1.default.Workbook();\n  var worksheet = workbook.addWorksheet(title);\n  var leafNodes = adhere_util_1.default.getLeafNodes(columns);\n  var level = adhere_util_1.default.getTreeLevel(columns, 'key');\n  // 标题\n  renderTitle({\n    worksheet: worksheet,\n    title: title,\n    columnsLength: leafNodes.length\n  });\n  // 列\n  renderColumns({\n    worksheet: worksheet,\n    leafNodes: leafNodes,\n    columns: columns,\n    level: level\n  });\n  // 数据\n  renderData({\n    worksheet: worksheet,\n    leafNodes: leafNodes,\n    level: level,\n    dataSource: dataSource\n  });\n  // 列宽自适应\n  columnsAdaption(worksheet);\n  // 导出\n  return download({\n    workbook: workbook,\n    title: title\n  });\n}\n/**\n * ExportExcel\n * @description 导出excel\n * @param {String} name\n * @param {Function} getColumns\n * @constructor\n */\nvar ExportExcel = function ExportExcel(_a) {\n  var _b = _a.title,\n    title = _b === void 0 ? 'excel' : _b,\n    getDataSource = _a.getDataSource,\n    getColumns = _a.getColumns;\n  function onExportExcel() {\n    var indicator = adhere_ui_globalindicator_1.default.show();\n    var columns = getColumns();\n    var dataSource = getDataSource();\n    return exportExcel({\n      dataSource: dataSource,\n      columns: columns,\n      title: title\n    }).then(function () {\n      adhere_ui_globalindicator_1.default.hide(indicator);\n      adhere_ui_prompt_successprompt_1.default.openSuccessMessage();\n    }).catch(function (err) {\n      adhere_ui_globalindicator_1.default.hide(indicator);\n      adhere_ui_prompt_errorprompt_1.default.openErrorMessage(err);\n    });\n  }\n  return react_1.default.createElement(icons_1.FileExcelOutlined, {\n    onClick: onExportExcel,\n    className: \"\".concat(SearchTable_1.selectorPrefix, \"-export-excel\")\n  });\n};\nexports.default = ExportExcel;"],"names":["__importDefault","mod","__esModule","default","exceljs_1","Object","defineProperty","exports","value","require","file_saver_1","react_1","icons_1","adhere_ui_globalindicator_1","adhere_ui_prompt_errorprompt_1","adhere_ui_prompt_successprompt_1","adhere_util_1","SearchTable_1","isLeaf","column","Array","isArray","children","length","renderTitle","_a","worksheet","title","columnsLength","mergedCell","mergeCells","getCell","alignment","vertical","horizontal","font","bold","size","fill","type","pattern","fgColor","argb","border","top","style","left","bottom","right","renderColumns","columns","leafNodes","level","addColumnToWorksheet","_columns","i","_loop_1","_leafNodes_1","position","currentLevel","getNodeLevel","cell","mergeCellsData","startRow","startCell","findIndex","node","key","endRow","endCell","getLeafNodes","getRow","renderData","dataSource","rowCount","addDataToWorksheet","data","parentRow","forEach","record","_index","row","indent","outlineLevel","_columnIndex","dataIndex","columnsAdaption","maxLength","eachCell","call","includeEmpty","toString","width","download","workbook","xlsx","writeBuffer","then","buffer","Blob","concat","exportExcel","Workbook","addWorksheet","getTreeLevel","ExportExcel","_b","getDataSource","getColumns","createElement","FileExcelOutlined","onClick","indicator","show","hide","openSuccessMessage","catch","err","openErrorMessage","className","selectorPrefix"],"mappings":"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"}