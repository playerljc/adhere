{"version":3,"file":"StickUpLayout.js","sources":["StickUpLayout.js"],"sourcesContent":["import classNames from 'classnames';\nimport debounce from 'lodash.debounce';\nimport React, { forwardRef, memo, useImperativeHandle, useLayoutEffect, useRef, } from 'react';\nimport { ResizeObserver } from '@juggle/resize-observer';\nimport StickupLayoutItem from './Item';\nvar selectorPrefix = 'adhere-ui-stickup-layout';\nvar InternalStickupLayout = memo(forwardRef(function (props, ref) {\n    var className = props.className, style = props.style, fixedClassName = props.fixedClassName, fixedStyle = props.fixedStyle, innerClassName = props.innerClassName, innerStyle = props.innerStyle, onChange = props.onChange, children = props.children;\n    var ro = useRef({});\n    var el = useRef(null);\n    var fixedEl = useRef(null);\n    var innerEl = useRef(null);\n    var key = useRef(false);\n    var index = useRef([]);\n    var headerEls = useRef();\n    var preScrollObj = useRef(null);\n    var maskEl = useRef();\n    /**\n     * updateInterval\n     */\n    function updateInterval() {\n        return 'updateInterval' in screen ? screen['updateInterval'] : 16.7;\n    }\n    /**\n     * createIndex\n     */\n    function createIndex() {\n        var pre = 0;\n        index.current = [];\n        preScrollObj.current = null;\n        for (var i = 0, len = headerEls.current.length; i < len; i++) {\n            var header = headerEls.current[i];\n            var rangeStart = pre;\n            var rangeEnd = void 0;\n            if (i !== len - 1) {\n                rangeEnd = headerEls.current[i + 1].offsetTop - header.offsetHeight;\n            }\n            else {\n                rangeEnd = innerEl.current.scrollHeight;\n            }\n            index.current.push({\n                start: rangeStart,\n                end: rangeEnd,\n                dom: header,\n                index: i,\n            });\n            pre = rangeEnd;\n            if (pre > innerEl.current.scrollHeight - innerEl.current.offsetHeight) {\n                break;\n            }\n        }\n    }\n    /**\n     * position\n     */\n    function position() {\n        var _a;\n        var val = innerEl.current.scrollTop;\n        var low = 0, high = index.current.length - 1, middle, target;\n        while (low <= high && low <= index.current.length - 1 && high <= index.current.length - 1) {\n            middle = (high + low) >> 1;\n            var targetVal = index.current[middle];\n            if (val >= targetVal.start && val < targetVal.end) {\n                target = targetVal;\n                break;\n            }\n            else if (val < targetVal.start) {\n                high = middle - 1;\n            }\n            else {\n                low = middle + 1;\n            }\n        }\n        if (target) {\n            if (preScrollObj.current && ((_a = preScrollObj.current) === null || _a === void 0 ? void 0 : _a.index) === target.index) {\n                return false;\n            }\n            else {\n                preScrollObj.current = target;\n                fixedEl.current.innerHTML = target.dom.outerHTML;\n                if (onChange) {\n                    onChange(target.index);\n                }\n            }\n        }\n    }\n    /**\n     * initial\n     */\n    function initial() {\n        var _a, _b, _c, _d, _e;\n        key.current = false;\n        index.current = [];\n        headerEls.current = (_a = el.current) === null || _a === void 0 ? void 0 : _a.querySelectorAll(\".\".concat(selectorPrefix, \"-item-header\"));\n        createIndex();\n        position();\n        (_c = (_b = innerEl.current) === null || _b === void 0 ? void 0 : _b.removeEventListener) === null || _c === void 0 ? void 0 : _c.call(_b, 'scroll', onScroll);\n        (_e = (_d = innerEl.current) === null || _d === void 0 ? void 0 : _d.addEventListener) === null || _e === void 0 ? void 0 : _e.call(_d, 'scroll', onScroll);\n    }\n    /**\n     * initMask\n     */\n    function initMask() {\n        if (typeof window === 'undefined')\n            return;\n        if (!maskEl.current) {\n            maskEl.current = document.createElement('div');\n            maskEl.current.className = \"\".concat(selectorPrefix, \"-mask\");\n            window.document.body.appendChild(maskEl.current);\n        }\n    }\n    /**\n     * scrollAnimationTo\n     * @access private\n     * @param {number} targetTop\n     * @param {number} duration\n     */\n    function scrollAnimationTo(targetTop, duration) {\n        if (targetTop === void 0) { targetTop = 0; }\n        if (duration === void 0) { duration = 300; }\n        if (key.current)\n            return;\n        initMask();\n        key.current = true;\n        maskEl.current.style.display = 'block';\n        var srcTop = innerEl.current.scrollTop, scrollVal = srcTop, \n        /**\n         * 一次滚动的步进\n         * @type {number}\n         */\n        setp = innerEl.current.scrollHeight /\n            // @ts-ignore\n            (duration / updateInterval() + (duration % updateInterval() !== 0 ? 1 : 0));\n        /** *\n         * 动画的滚动\n         */\n        function scrollAnimation() {\n            if (srcTop < targetTop) {\n                if (scrollVal + setp > targetTop) {\n                    scrollVal = targetTop;\n                }\n                else {\n                    scrollVal += setp;\n                }\n            }\n            else if (scrollVal - setp < targetTop) {\n                scrollVal = targetTop;\n            }\n            else {\n                scrollVal -= setp;\n            }\n            innerEl.current.scrollTop = scrollVal;\n            if (srcTop < targetTop) {\n                if (scrollVal >= targetTop) {\n                    clear();\n                }\n                else {\n                    typeof window !== 'undefined' && window.requestAnimationFrame(scrollAnimation);\n                }\n            }\n            else if (scrollVal <= targetTop) {\n                clear();\n            }\n            else {\n                typeof window !== 'undefined' && window.requestAnimationFrame(scrollAnimation);\n            }\n            function clear() {\n                key.current = false;\n                maskEl.current.style.display = 'none';\n            }\n        }\n        /** *\n         * 滚动core\n         */\n        typeof window !== 'undefined' && window.requestAnimationFrame(scrollAnimation);\n    }\n    /**\n     * scrollTo\n     * @param item\n     * @param duration\n     */\n    function scrollTo(item, duration) {\n        if (duration === void 0) { duration = 300; }\n        var targetTop = item.start + headerEls.current[item.index].offsetHeight;\n        if (duration === 0) {\n            innerEl.current.scrollTop = targetTop;\n        }\n        else {\n            scrollAnimationTo(targetTop, duration);\n        }\n    }\n    /**\n     * onScroll\n     */\n    function onScroll() {\n        position();\n    }\n    useImperativeHandle(ref, function () { return ({\n        /**\n         * refresh\n         */\n        refresh: function () { return initial(); },\n        /**\n         * scrollToByIndex\n         * @param {number} _index\n         * @param {number} _duration\n         * @return {boolean}\n         */\n        scrollToByIndex: function (_index, _duration) {\n            if (_duration === void 0) { _duration = 300; }\n            var i = 0, item;\n            for (; i < index.current.length; i++) {\n                if (index.current[i].index === _index) {\n                    item = index.current[i];\n                    break;\n                }\n            }\n            if (!item) {\n                item = index.current[index.current.length - 1];\n            }\n            scrollTo(item, _duration);\n        },\n        /**\n         * scrollToByHeaderEl\n         * @param {HtmlElement} _headerEl\n         * @param {number} _duration\n         * @return {boolean}\n         */\n        scrollToByHeaderEl: function (_headerEl, _duration) {\n            if (_duration === void 0) { _duration = 300; }\n            var i = 0, item, current = -1;\n            for (; i < index.current.length; i++) {\n                if (index.current[i].dom === _headerEl) {\n                    item = index.current[i];\n                    current = i;\n                    break;\n                }\n            }\n            if (!item) {\n                item = index.current[index.current.length - 1];\n            }\n            scrollTo(item, _duration);\n        },\n    }); });\n    useLayoutEffect(function () {\n        initial();\n        return function () {\n            var _a, _b;\n            if (maskEl.current) {\n                (_b = (_a = maskEl.current) === null || _a === void 0 ? void 0 : _a.parentElement) === null || _b === void 0 ? void 0 : _b.removeChild(maskEl.current);\n            }\n        };\n    }, []);\n    useLayoutEffect(function () {\n        var onResize = debounce(function () {\n            initial();\n        }, 300);\n        ro.current = new ResizeObserver(onResize);\n        ro.current.observe(el.current);\n        return function () {\n            var _a, _b, _c;\n            (_a = ro === null || ro === void 0 ? void 0 : ro.current) === null || _a === void 0 ? void 0 : _a.disconnect();\n            if (maskEl.current) {\n                (_c = (_b = maskEl.current) === null || _b === void 0 ? void 0 : _b.parentElement) === null || _c === void 0 ? void 0 : _c.removeChild(maskEl.current);\n            }\n        };\n    }, []);\n    return (React.createElement(\"div\", { className: classNames(selectorPrefix, className !== null && className !== void 0 ? className : ''), style: style !== null && style !== void 0 ? style : {}, ref: el },\n        React.createElement(\"div\", { className: classNames(\"\".concat(selectorPrefix, \"-fixed\"), fixedClassName !== null && fixedClassName !== void 0 ? fixedClassName : ''), style: fixedStyle !== null && fixedStyle !== void 0 ? fixedStyle : {}, ref: fixedEl }),\n        React.createElement(\"div\", { className: classNames(\"\".concat(selectorPrefix, \"-inner\"), innerClassName !== null && innerClassName !== void 0 ? innerClassName : ''), style: innerStyle !== null && innerStyle !== void 0 ? innerStyle : {}, ref: innerEl }, children)));\n}));\nvar StickupLayout = InternalStickupLayout;\nStickupLayout.displayName = 'StickupLayout';\nStickupLayout.Item = StickupLayoutItem;\nexport default StickupLayout;\n"],"names":["classNames","debounce","React","forwardRef","memo","useImperativeHandle","useLayoutEffect","useRef","ResizeObserver","StickupLayoutItem","selectorPrefix","InternalStickupLayout","props","ref","className","style","fixedClassName","fixedStyle","innerClassName","innerStyle","onChange","children","ro","el","fixedEl","innerEl","key","index","headerEls","preScrollObj","maskEl","updateInterval","screen","position","_a","target","val","current","scrollTop","low","high","length","middle","targetVal","start","end","innerHTML","dom","outerHTML","initial","querySelectorAll","concat","_d","_e","pre","i","len","header","rangeStart","rangeEnd","offsetTop","offsetHeight","scrollHeight","push","_c","_b","removeEventListener","call","onScroll","addEventListener","scrollAnimationTo","targetTop","duration","srcTop","scrollVal","setp","window","document","createElement","body","appendChild","display","requestAnimationFrame","scrollAnimation","clear","scrollTo","item","refresh","scrollToByIndex","_index","_duration","scrollToByHeaderEl","_headerEl","parentElement","removeChild","onResize","observe","disconnect","StickupLayout","displayName","Item"],"mappings":"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"}