{"version":3,"file":"stickuplayout.js","sources":["stickuplayout.js"],"sourcesContent":["import React, { forwardRef, useImperativeHandle, useLayoutEffect, useRef, } from 'react';\r\nimport classNames from 'classnames';\r\nimport StickupLayoutItem from './item';\r\nvar selectorPrefix = 'adhere-ui-stickuplayout';\r\nvar StickupLayout = function (props, ref) {\r\n    var className = props.className, style = props.style, fixedClassName = props.fixedClassName, fixedStyle = props.fixedStyle, innerClassName = props.innerClassName, innerStyle = props.innerStyle, onChange = props.onChange, children = props.children;\r\n    var el = useRef(null);\r\n    var fixedEl = useRef(null);\r\n    var innerEl = useRef(null);\r\n    var key = useRef(false);\r\n    var index = useRef([]);\r\n    var headerEls = useRef();\r\n    var preScrollObj = useRef(null);\r\n    var maskEl = useRef();\r\n    /**\r\n     * updateInterval\r\n     */\r\n    function updateInterval() {\r\n        return 'updateInterval' in screen ? screen['updateInterval'] : 16.7;\r\n    }\r\n    /**\r\n     * createIndex\r\n     */\r\n    function createIndex() {\r\n        var pre = 0;\r\n        index.current = [];\r\n        preScrollObj.current = null;\r\n        for (var i = 0, len = headerEls.current.length; i < len; i++) {\r\n            var header = headerEls.current[i];\r\n            var rangeStart = pre;\r\n            var rangeEnd = void 0;\r\n            if (i !== len - 1) {\r\n                rangeEnd = headerEls.current[i + 1].offsetTop - header.offsetHeight;\r\n            }\r\n            else {\r\n                rangeEnd = innerEl.current.scrollHeight;\r\n            }\r\n            index.current.push({\r\n                start: rangeStart,\r\n                end: rangeEnd,\r\n                dom: header,\r\n                index: i,\r\n            });\r\n            pre = rangeEnd;\r\n            if (pre > innerEl.current.scrollHeight - innerEl.current.offsetHeight) {\r\n                break;\r\n            }\r\n        }\r\n    }\r\n    /**\r\n     * position\r\n     */\r\n    function position() {\r\n        var val = innerEl.current.scrollTop;\r\n        var low = 0, high = index.current.length - 1, middle, target;\r\n        while (low <= high && low <= index.current.length - 1 && high <= index.current.length - 1) {\r\n            middle = (high + low) >> 1;\r\n            var targetVal = index.current[middle];\r\n            if (val >= targetVal.start && val < targetVal.end) {\r\n                target = targetVal;\r\n                break;\r\n            }\r\n            else if (val < targetVal.start) {\r\n                high = middle - 1;\r\n            }\r\n            else {\r\n                low = middle + 1;\r\n            }\r\n        }\r\n        if (target) {\r\n            if (preScrollObj.current && preScrollObj.current.index === target.index) {\r\n                return false;\r\n            }\r\n            else {\r\n                preScrollObj.current = target;\r\n                fixedEl.current.innerHTML = target.dom.outerHTML;\r\n                if (onChange) {\r\n                    onChange(target.index);\r\n                }\r\n            }\r\n        }\r\n    }\r\n    /**\r\n     * initial\r\n     */\r\n    function initial() {\r\n        key.current = false;\r\n        index.current = [];\r\n        headerEls.current = el.current.querySelectorAll(\".\" + selectorPrefix + \"-item-header\");\r\n        createIndex();\r\n        position();\r\n        innerEl.current.removeEventListener('scroll', onScroll);\r\n        innerEl.current.addEventListener('scroll', onScroll);\r\n    }\r\n    /**\r\n     * initMask\r\n     */\r\n    function initMask() {\r\n        if (typeof window === 'undefined')\r\n            return;\r\n        if (!maskEl.current) {\r\n            maskEl.current = document.createElement('div');\r\n            maskEl.current.className = selectorPrefix + \"-mask\";\r\n            window.document.body.appendChild(maskEl.current);\r\n        }\r\n    }\r\n    /**\r\n     * scrollAnimationTo\r\n     * @access private\r\n     * @param {number} targetTop\r\n     * @param {number} duration\r\n     */\r\n    function scrollAnimationTo(targetTop, duration) {\r\n        if (targetTop === void 0) { targetTop = 0; }\r\n        if (duration === void 0) { duration = 300; }\r\n        if (key.current)\r\n            return;\r\n        initMask();\r\n        key.current = true;\r\n        maskEl.current.style.display = 'block';\r\n        var srcTop = innerEl.current.scrollTop, scrollVal = srcTop, \r\n        /**\r\n         * 一次滚动的步进\r\n         * @type {number}\r\n         */\r\n        setp = innerEl.current.scrollHeight /\r\n            (duration / updateInterval() + (duration % updateInterval() !== 0 ? 1 : 0));\r\n        /** *\r\n         * 动画的滚动\r\n         */\r\n        function scrollAnimation() {\r\n            if (srcTop < targetTop) {\r\n                if (scrollVal + setp > targetTop) {\r\n                    scrollVal = targetTop;\r\n                }\r\n                else {\r\n                    scrollVal += setp;\r\n                }\r\n            }\r\n            else if (scrollVal - setp < targetTop) {\r\n                scrollVal = targetTop;\r\n            }\r\n            else {\r\n                scrollVal -= setp;\r\n            }\r\n            innerEl.current.scrollTop = scrollVal;\r\n            if (srcTop < targetTop) {\r\n                if (scrollVal >= targetTop) {\r\n                    clear();\r\n                }\r\n                else {\r\n                    typeof window !== 'undefined' && window.requestAnimationFrame(scrollAnimation);\r\n                }\r\n            }\r\n            else if (scrollVal <= targetTop) {\r\n                clear();\r\n            }\r\n            else {\r\n                typeof window !== 'undefined' && window.requestAnimationFrame(scrollAnimation);\r\n            }\r\n            function clear() {\r\n                key.current = false;\r\n                maskEl.current.style.display = 'none';\r\n            }\r\n        }\r\n        /** *\r\n         * 滚动core\r\n         */\r\n        typeof window !== 'undefined' && window.requestAnimationFrame(scrollAnimation);\r\n    }\r\n    /**\r\n     * scrollTo\r\n     * @param item\r\n     * @param duration\r\n     */\r\n    function scrollTo(item, duration) {\r\n        if (duration === void 0) { duration = 300; }\r\n        var targetTop = item.start + headerEls.current[item.index].offsetHeight;\r\n        if (duration === 0) {\r\n            innerEl.current.scrollTop = targetTop;\r\n        }\r\n        else {\r\n            scrollAnimationTo(targetTop, duration);\r\n        }\r\n    }\r\n    /**\r\n     * onScroll\r\n     */\r\n    function onScroll() {\r\n        position();\r\n    }\r\n    useImperativeHandle(ref, function () { return ({\r\n        /**\r\n         * refresh\r\n         */\r\n        refresh: function () { return initial(); },\r\n        /**\r\n         * scrollToByIndex\r\n         * @param {number} _index\r\n         * @param {number} _duration\r\n         * @return {boolean}\r\n         */\r\n        scrollToByIndex: function (_index, _duration) {\r\n            if (_duration === void 0) { _duration = 300; }\r\n            var i = 0, item;\r\n            for (; i < index.current.length; i++) {\r\n                if (index.current[i].index === _index) {\r\n                    item = index.current[i];\r\n                    break;\r\n                }\r\n            }\r\n            if (!item)\r\n                return false;\r\n            scrollTo(item, _duration);\r\n        },\r\n        /**\r\n         * scrollToByHeaderEl\r\n         * @param {HtmlElement} _headerEl\r\n         * @param {number} _duration\r\n         * @return {boolean}\r\n         */\r\n        scrollToByHeaderEl: function (_headerEl, _duration) {\r\n            if (_duration === void 0) { _duration = 300; }\r\n            var i = 0, item, current = -1;\r\n            for (; i < index.current.length; i++) {\r\n                if (index.current[i].dom === _headerEl) {\r\n                    item = index.current[i];\r\n                    current = i;\r\n                    break;\r\n                }\r\n            }\r\n            if (!item)\r\n                return false;\r\n            scrollTo(item, _duration);\r\n        },\r\n    }); });\r\n    useLayoutEffect(function () {\r\n        initial();\r\n        return function () {\r\n            var _a;\r\n            if (maskEl.current) {\r\n                (_a = maskEl.current.parentElement) === null || _a === void 0 ? void 0 : _a.removeChild(maskEl.current);\r\n            }\r\n        };\r\n    }, []);\r\n    return (React.createElement(\"div\", { className: classNames(selectorPrefix, className), style: style || {}, ref: el },\r\n        React.createElement(\"div\", { className: classNames(selectorPrefix + \"-fixed\", fixedClassName), style: fixedStyle || {}, ref: fixedEl }),\r\n        React.createElement(\"div\", { className: classNames(selectorPrefix + \"-inner\", innerClassName), style: innerStyle || {}, ref: innerEl }, children)));\r\n};\r\n// @ts-ignore\r\nvar StickupLayoutHOC = forwardRef(StickupLayout);\r\nStickupLayoutHOC.Item = StickupLayoutItem;\r\nexport default StickupLayoutHOC;\r\n"],"names":["React","forwardRef","useImperativeHandle","useLayoutEffect","useRef","classNames","StickupLayoutItem","selectorPrefix","StickupLayout","props","ref","className","style","fixedClassName","fixedStyle","innerClassName","innerStyle","onChange","children","el","fixedEl","innerEl","key","index","headerEls","preScrollObj","maskEl","updateInterval","screen","position","target","val","current","scrollTop","low","high","length","middle","targetVal","start","end","innerHTML","dom","outerHTML","initial","querySelectorAll","pre","i","len","header","rangeStart","rangeEnd","offsetTop","offsetHeight","scrollHeight","push","createIndex","removeEventListener","onScroll","addEventListener","scrollAnimationTo","targetTop","duration","srcTop","scrollVal","setp","window","document","createElement","body","appendChild","display","requestAnimationFrame","scrollAnimation","clear","scrollTo","item","refresh","scrollToByIndex","_index","_duration","scrollToByHeaderEl","_headerEl","_a","parentElement","removeChild","StickupLayoutHOC","Item"],"mappings":"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"}