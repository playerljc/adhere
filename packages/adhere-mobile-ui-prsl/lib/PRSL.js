"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),__assign=function(){return(__assign=Object.assign||function(e){for(var r,t=1,a=arguments.length;t<a;t++)for(var n in r=arguments[t])Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n]);return e}).apply(this,arguments)},__createBinding=Object.create?function(e,r,t,a){void 0===a&&(a=t);var n=Object.getOwnPropertyDescriptor(r,t);n&&("get"in n?r.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,a,n)}:function(e,r,t,a){e[a=void 0===a?t:a]=r[t]},__setModuleDefault=Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r},__importStar=function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__spreadArray=function(e,r,t){if(t||2===arguments.length)for(var a,n=0,o=r.length;n<o;n++)!a&&n in r||((a=a||Array.prototype.slice.call(r,0,n))[n]=r[n]);return e.concat(a||Array.prototype.slice.call(r))},__importDefault=function(e){return e&&e.__esModule?e:{default:e}},ahooks_1=(Object.defineProperty(exports,"__esModule",{value:!0}),require("ahooks")),antd_mobile_1=require("antd-mobile"),classnames_1=__importDefault(require("classnames")),lodash_isempty_1=__importDefault(require("lodash.isempty")),react_1=__importStar(require("react")),use_immer_1=require("use-immer"),adhere_ui_backtopanimation_1=__importDefault(require("@baifendian/adhere-ui-backtopanimation")),adhere_ui_scrollload_1=__importDefault(require("@baifendian/adhere-ui-scrollload")),adhere_util_intl_1=__importDefault(require("@baifendian/adhere-util-intl")),Context_1=__importDefault(require("./Context")),DND_1=require("./DND"),PRSLItem_1=__importDefault(require("./PRSLItem")),SearchKeyWord_1=__importDefault(require("./SearchKeyWord")),Selection_1=require("./Selection"),Toolbar_1=__importDefault(require("./Toolbar")),selectorPrefix="adhere-mobile-ui-prsl",DEFAULT_PAGING_SIZE=30,DEFAULT_PAGING_PAGE=1,DEFAULT_DISTANCE=50,DEFAULT_TOOLBAR_COLLAPSE_COUNT=3,DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE="session",DEFAULT_ROW_KEY="id",DEFAULT_MODE="normal",DEFAULT_SEARCH_KEY_WORD_MODE="normal",InternalPRSL=(0,react_1.memo)((0,react_1.forwardRef)(function(e){var r=e.className,r=void 0===r?"":r,W=e.style,t=e.innerClassName,U=void 0===t?"":t,F=e.innerStyle,t=e.isLoading,t=void 0===t||t,B=e.isUseFirstLoading,B=void 0===B||B,x=e.firstLoading,k=e.pullToRefreshProps,I=e.onRefreshBefore,a=e.paging,q=e.onRefresh,G=e.rowKey,n=e.showKeyWordSearchBar,j=void 0===n||n,H=e.searchKeyWordBarProps,n=e.searchKeyWordWrapperClassName,Y=void 0===n?"":n,z=e.searchKeyWordWrapperStyle,Z=e.searchKeyWordMode,J=e.searchKeyWordHistoryMaxSize,Q=e.isSearchKeyWordHistoryIntoStore,X=e.searchKeyWordHistoryStoreType,o=e.defaultSearchKeyWord,n=e.showToolBar,$=void 0===n||n,n=e.showTotal,ee=e.renderToolBar,re=e.afterToolBarRender,te=e.beforeToolBarRender,ae=e.beforeToolBarRenderClassName,ae=void 0===ae?"":ae,ne=e.beforeToolBarRenderStyle,oe=e.afterToolBarRenderClassName,oe=void 0===oe?"":oe,le=e.afterToolBarRenderStyle,l=e.toolbarWrapperClassName,l=void 0===l?"":l,ie=e.toolbarWrapperStyle,ue=e.toolbarCollapseCount,ue=void 0===ue?DEFAULT_TOOLBAR_COLLAPSE_COUNT:ue,se=e.toolbarConfig,i=e.scrollLoadProps,ce=e.onLoadMore,de=e.loadMoreLoading,u=e.showBackTopAnimation,_e=void 0===u||u,fe=e.backTopAnimationProps,ge=e.scrollLoadBeforeRender,me=e.scrollLoadAfterRender,u=e.scrollLoadBeforeRenderClassName,pe=void 0===u?"":u,Se=e.scrollLoadBeforeRenderStyle,u=e.scrollLoadAfterRenderClassName,he=void 0===u?"":u,ve=e.scrollLoadAfterRenderStyle,ye=e.beforeRender,Ee=e.afterRender,u=e.beforeRenderClassName,Te=void 0===u?"":u,Re=e.beforeRenderStyle,u=e.afterRenderClassName,De=void 0===u?"":u,Pe=e.afterRenderStyle,u=e.isShowFilterTrigger,be=e.renderFilterTrigger,Me=e.isShowSortTrigger,Ne=e.renderSortTrigger,Ae=e.isShowViewSettingTrigger,Ce=e.renderViewSettingTrigger,Le=e.viewSettingTriggerMode,we=e.viewSettingTriggerProps,Ke=e.renderViewSetting,Oe=e.viewSettingConfig,Ve=e.defaultViewSettingValue,We=e.onViewSetting,Ue=e.onViewSettingReset,Fe=e.loadData,Be=e.renderEmpty,xe=e.renderOffLine,ke=e.filterTriggerMode,Ie=e.filterTriggerProps,qe=e.renderFilter,Ge=e.filterFormProps,je=e.filterConfig,s=e.defaultFilterValues,He=e.sortTriggerMode,Ye=e.sortTriggerProps,ze=e.renderSort,Ze=e.sortConfig,c=e.defaultSortValues,Je=e.isUseLocal,Qe=(e.isUseSelection,e.selectedRowKeys),Xe=e.selectionMultiple,$e=e.onSelectChange,er=(e.isUseDND,e.dndDragHandle,e.onDNDChange),d=e.children,e=(0,ahooks_1.useNetwork)(),rr=(0,ahooks_1.useUpdate)(),_=(0,react_1.useState)({data:[],total:0}),f=_[0],g=_[1],_=(0,react_1.useState)(DEFAULT_MODE),m=_[0],tr=_[1],p=(0,react_1.useMemo)(function(){return"normal"===m},[m]),S=(0,react_1.useMemo)(function(){return null!=G?G:DEFAULT_ROW_KEY},[G]),_=(0,Selection_1.useSelection)({selectedRowKeys:Qe,selectionMultiple:Xe,mode:m,dataSource:f.data,rowKey:S}),ar=_.optionSelectedRowKeys,h=_.isUseSelectionMode,v=_.isSelectionMultiple,nr=_.finish,or=_.cancel,Qe=_.selectionChange,Xe=_.selectionAllChange,_=(0,DND_1.useDND)({mode:m,dataSource:f.data,rowKey:S,reset:function(){g(__assign({},f))}}),y=_.optionDataSource,E=_.isUseDNDMode,lr=_.finish,ir=_.cancel,ur=_.move,_=(0,use_immer_1.useImmer)({searchKeyWord:null!=o?o:"",filterValues:null!=s?s:{},sortValues:null!=c?c:[]}),T=_[0],R=_[1],_=(0,react_1.useRef)(!0),D=(0,react_1.useRef)(!1),P=(0,react_1.useRef)({page:void 0!==a&&"object"===(0,_typeof2.default)(a)&&null!=(C=a.page)?C:DEFAULT_PAGING_PAGE,pageSize:void 0!==a&&"object"===(0,_typeof2.default)(a)&&null!=(C=a.defaultPageSize)?C:DEFAULT_PAGING_SIZE}),b=(0,react_1.useMemo)(function(){return"boolean"!=typeof a||a},[a]),M=(0,react_1.useRef)(),sr=(0,react_1.useRef)(void 0),N=(0,react_1.useRef)(null),A=(0,react_1.useRef)(adhere_ui_scrollload_1.default.NORMAL),C=(0,react_1.useCallback)(function(){var e;return null!=(e=null==x?void 0:x())?e:fr},[x]),cr=(0,react_1.useCallback)(function(){var e;return null!=(e=null==de?void 0:de())?e:gr},[de]),L=(0,react_1.useMemo)(function(){return"boolean"!=typeof Je||Je},[Je]),w=(0,react_1.useMemo)(function(){var e,r=T.searchKeyWord,t=void 0===r?"":r,r=T.filterValues,a=void 0===r?{}:r,r=T.sortValues,r=void 0===r?[]:r,n=null!=(n=f.data)?n:[];return E&&(n=y.data),(null!=r?r:[]).length&&(n=r.reduce(function(e,r){var t=r.order,a=r.name;return e=e.sort(function(e,r){return"asc"===t?e[a]>r[a]?1:e[a]<r[a]?-1:0:e[a]<r[a]?1:e[a]>r[a]?-1:0}),__spreadArray([],e,!0)},null!=(e=f.data)?e:[])),n=!t&&(0,lodash_isempty_1.default)(a)&&!r.length?n:n.filter(function(r){return t?Object.keys(r).some(function(e){return-1!==r[e].indexOf(t)}):!!(0,lodash_isempty_1.default)(a)||Object.keys(a).filter(function(e){return!!a[e]}).every(function(e){return-1!==r[e].indexOf(a[e])})})},[T,f,E,y]),K=(0,react_1.useMemo)(function(){var e,r;return L?(r=w,b&&(e=(P.current.page-1)*P.current.pageSize,r=w.slice(e,P.current.page*P.current.pageSize),1!==P.current.page)&&(r=__spreadArray(__spreadArray([],w.slice(0,e),!0),r,!0)),{total:w.length,data:r}):E?y:f},[f,w,y,E,L,b,P.current.page,P.current.pageSize]),dr=(0,react_1.useCallback)(function(){return!K.data.length},[K.data]),_r=(0,react_1.useMemo)(function(){var e;return(null!=(e=null==K?void 0:K.total)?e:0)/P.current.pageSize},[P.current.pageSize,K.total]),fr=(0,react_1.useMemo)(function(){return react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-first-loading")},react_1.default.createElement(antd_mobile_1.Skeleton.Title,{animated:!0}),react_1.default.createElement(antd_mobile_1.Skeleton.Paragraph,{lineCount:25,animated:!0}))},[]),gr=(0,react_1.useMemo)(function(){return react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading")},react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading-dot")},react_1.default.createElement(antd_mobile_1.DotLoading,{color:"primary"})),react_1.default.createElement("div",null,"".concat(adhere_util_intl_1.default.v("数据加载中")),"..."))},[]),mr=(0,react_1.useMemo)(function(){var e;return null!=(e=null==xe?void 0:xe())?e:react_1.default.createElement(antd_mobile_1.ErrorBlock,{status:"disconnected"},react_1.default.createElement(antd_mobile_1.Button,{color:"primary",onClick:function(){rr()}},adhere_util_intl_1.default.v("点击重试")))},[xe]),pr=(0,react_1.useMemo)(function(){var e;return react_1.default.createElement(SearchKeyWord_1.default,{className:null!=Y?Y:"",style:null!=z?z:{},searchKeyWordBarProps:H,searchKeyWordMode:null!=Z?Z:DEFAULT_SEARCH_KEY_WORD_MODE,searchKeyWordHistoryMaxSize:null!=J?J:DEFAULT_DISTANCE,isSearchKeyWordHistoryIntoStore:null==Q||Q,searchKeyWordHistoryStoreType:null!=X?X:DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE,disabled:!p,defaultSearchKeyWord:null!=(e=T.searchKeyWord)?e:"",onSearch:Nr,onSearchClear:Ar})},[Y,z,H,Z,J,T.searchKeyWord,p]),Sr=react_1.default.createElement(Toolbar_1.default,{className:l,style:ie,showTotal:n,renderToolBar:ee,afterToolBarRender:re,beforeToolBarRender:te,beforeToolBarRenderClassName:ae,beforeToolBarRenderStyle:ne,afterToolBarRenderClassName:oe,afterToolBarRenderStyle:le,isShowFilterTrigger:u,renderFilterTrigger:be,isShowSortTrigger:Me,renderSortTrigger:Ne,isShowViewSettingTrigger:Ae,renderViewSettingTrigger:Ce,viewSettingTriggerMode:Le,viewSettingTriggerProps:we,renderViewSetting:Ke,viewSettingConfig:Oe,defaultViewSettingValue:Ve,onViewSetting:We,onViewSettingReset:Ue,toolbarCollapseCount:ue,toolbarConfig:se,total:null!=(l=null==K?void 0:K.total)?l:0,filterTriggerMode:ke,filterTriggerProps:Ie,renderFilter:qe,filterFormProps:Ge,filterConfig:je,defaultFilterValues:T.filterValues,onFilter:function(r){if(V(),R(function(e){e.filterValues=r}),L)return Promise.resolve();return O(__assign(__assign({},T),{filterValues:r}))},onFilterReset:function(){if(V(),R(function(e){e.filterValues={}}),L)return Promise.resolve();return O(__assign(__assign({},T),{filterValues:{}}))},sortTriggerMode:He,sortTriggerProps:Ye,renderSort:ze,sortConfig:Ze,defaultSortValues:T.sortValues,disabled:!p,onSort:function(r){if(V(),R(function(e){e.sortValues=r}),L)return Promise.resolve();return O(__assign(__assign({},T),{sortValues:r}))},onSortReset:function(){if(V(),R(function(e){e.sortValues=[]}),L)return Promise.resolve();return O(__assign(__assign({},T),{sortValues:[]}))}}),hr=(0,react_1.useMemo)(function(){var e=null==ye?void 0:ye();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-inner-before"),null!=Te?Te:""),style:null!=Re?Re:{}},e)},[ye,Te,Re]),vr=(0,react_1.useMemo)(function(){var e=null==Ee?void 0:Ee();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-inner-after"),null!=De?De:""),style:null!=Pe?Pe:{}},e)},[Ee,De,Pe]),yr=(0,react_1.useMemo)(function(){var e=null==ge?void 0:ge();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-scroll-before"),null!=pe?pe:""),style:null!=Se?Se:{}},e)},[ge,pe,Se]),Er=(0,react_1.useMemo)(function(){var e=null==me?void 0:me();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-scroll-after"),null!=he?he:""),style:null!=ve?ve:{}},e)},[me,he,ve]),Tr=(0,react_1.useMemo)(function(){var e;return react_1.default.createElement(adhere_ui_scrollload_1.default,__assign({ref:M,renderLoading:cr,distance:(null==i?void 0:i.distance)||50,onScrollBottom:wr},i||{},{disabled:!p,className:(0,classnames_1.default)("".concat(selectorPrefix,"-scroll-load"),null!=(e=null==i?void 0:i.className)?e:"")}),function(){var e=null==d?void 0:d(K.data);if(h&&!v)return function(e){return!h||v?e:react_1.default.createElement(antd_mobile_1.Radio.Group,null,e)}(e);if(E)return react_1.default.createElement(DND_1.SortableContainer,{onSortEnd:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];ur.apply(void 0,e)},useDragHandle:!0},e);return e}())},[E,h,v,p,K.data,cr,i,d]),Rr=(0,react_1.useMemo)(function(){return react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-scroll"),ref:sr},null==d?void 0:d(K.data))},[d,K.data]),Dr=(0,react_1.useMemo)(function(){return react_1.default.createElement(adhere_ui_backtopanimation_1.default,__assign({},null!=fe?fe:{},{getContainer:Cr,onTrigger:function(){return Promise.resolve()}}))},[fe]),Pr=(0,react_1.useMemo)(function(){var e;return react_1.default.createElement(antd_mobile_1.PullToRefresh,__assign({},null!=k?k:{},{onRefresh:Lr,disabled:!p}),yr,dr()&&(null!=(e=null==Be?void 0:Be())?e:react_1.default.createElement(antd_mobile_1.ErrorBlock,{status:"empty"})),!dr()&&b&&Tr,!dr()&&!b&&Rr,Er,_e&&Dr)},[a,k,yr,Er,Tr,Rr,_e,Dr,p,Be,b]),ie=(0,react_1.useCallback)(function(){return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-header")},react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-header-main")},j&&pr),react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-header-extra")},react_1.default.createElement(DND_1.DNDManageButton,{isUseDNDMode:E,isUseNormalMode:p,onChange:function(e){e?tr("dnd"):br()},onFinish:function(){g(y);var e=lr();null!=er&&er(e)},onCancel:ir}),react_1.default.createElement(Selection_1.SelectionManageButton,{isUseSelectionMode:h,isUseNormalMode:p,onChange:function(e){e?tr("selection"):br()},onFinish:function(){var e=nr(),r=e.selectedRows,t=e.selectedRowKeys,a=e.changeRowKeys,e=e.info;null!=$e&&$e(t,r,a,e)},onCancel:or}))),$&&Sr,react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-inner"),null!=U?U:""),style:null!=F?F:{}},hr,Pr,vr),h&&v&&react_1.default.createElement(Selection_1.SelectionCheckAllManage,null))},[j,pr,$,Sr,U,F,hr,Pr,vr,h,v,p,E]);function br(){tr("normal")}function O(e){return Fe?Fe(__assign(__assign({},P.current),e)).then(function(e){return g(e),e}):Promise.resolve()}function V(){var e,r,t=null===Cr?void 0:Cr();t&&(t.scrollTop=0),null!=(e=null==(t=null==M?void 0:M.current)?void 0:t.hideAll)&&e.call(t),N.current=null,A.current=adhere_ui_scrollload_1.default.NORMAL,P.current.page=void 0!==a&&"object"===(0,_typeof2.default)(a)&&null!=(r=a.page)?r:DEFAULT_PAGING_PAGE,P.current.pageSize=void 0!==a&&"object"===(0,_typeof2.default)(a)&&null!=(r=a.defaultPageSize)?r:DEFAULT_PAGING_SIZE}function Mr(){V(),R(function(e){e.searchKeyWord=o,e.filterValues=s,e.sortValues=c})}function Nr(r){V(),R(function(e){e.searchKeyWord=r}),L||O(__assign(__assign({},T),{searchKeyWord:r}))}function Ar(){V(),R(function(e){e.searchKeyWord=""}),L||O(__assign(__assign({},T),{searchKeyWord:""}))}function Cr(){var e;return null!=(e=null!=(e=null==(e=M.current)?void 0:e.getScrollContainer())?e:sr.current)?e:document.body}function Lr(){var e={searchKeyWord:o,filterValues:s,sortValues:c},r=I?I(__assign(__assign({},P.current),e)):Promise.resolve();return q?r.then(function(){return Mr(),L||null==q?void 0:q(__assign(__assign({},P.current),e)).then(function(e){g(e)})}):Promise.resolve(f)}function wr(e){if(A.current===adhere_ui_scrollload_1.default.EMPTY)A.current=adhere_ui_scrollload_1.default.EMPTY,e(adhere_ui_scrollload_1.default.EMPTY);else{if(N.current=e,!L)return null==ce?void 0:ce(__assign({page:P.current.page+1,pageSize:P.current.pageSize},T)).then(function(r){P.current.page+=1,g(function(e){return e.total=r.total,e.data=__spreadArray(__spreadArray([],e.data,!0),r.data,!0),__assign({},e)})});P.current.page+=1,rr()}}return(0,ahooks_1.useMount)(function(){O({searchKeyWord:o,filterValues:s,sortValues:c})}),(0,ahooks_1.useUpdateEffect)(function(){N.current&&(A.current=P.current.page<_r?adhere_ui_scrollload_1.default.NORMAL:adhere_ui_scrollload_1.default.EMPTY,N.current(A.current))},[f.data,_r,P.current.page]),(0,ahooks_1.useUpdateEffect)(function(){Mr(),O({searchKeyWord:o,filterValues:s,sortValues:c})},[o,c,s,L]),react_1.default.createElement(Context_1.default.Provider,{value:{isUseSelectionMode:function(){return h},isUseDNDMode:function(){return E},isUseNormalMode:function(){return p},getRowKey:function(){return S},getOptionSelectedRowKeys:function(){return null!=ar?ar:[]},selectionChange:Qe,selectionAllChange:Xe,getDatasourceLength:function(){return f.data.length},getSelectionMultiple:function(){return v},getIndexByIdFormOptionDataSource:function(r){return y.data.findIndex(function(e){return e[S]===r})}}},react_1.default.createElement("div",{className:(0,classnames_1.default)(selectorPrefix,null!=r?r:""),style:null!=W?W:{}},e.online&&(B&&(_.current&&!D.current&&t&&(D.current=!0),_.current&&D.current&&!t&&(_.current=!1,D.current=!1),_.current)?C:ie)(),!e.online&&mr))})),PRSL=InternalPRSL;PRSL.displayName="PRSL",PRSL.Item=PRSLItem_1.default,exports.default=PRSL;
//# sourceMappingURL=PRSL.js.map
