"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),__assign=function(){return(__assign=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e}).apply(this,arguments)},__createBinding=Object.create?function(e,r,t,n){void 0===n&&(n=t);var a=Object.getOwnPropertyDescriptor(r,t);a&&("get"in a?r.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,n,a)}:function(e,r,t,n){e[n=void 0===n?t:n]=r[t]},__setModuleDefault=Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r},__importStar=function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__spreadArray=function(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||((n=n||Array.prototype.slice.call(r,0,a))[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))},__importDefault=function(e){return e&&e.__esModule?e:{default:e}},ahooks_1=(Object.defineProperty(exports,"__esModule",{value:!0}),require("ahooks")),antd_mobile_1=require("antd-mobile"),classnames_1=__importDefault(require("classnames")),lodash_isempty_1=__importDefault(require("lodash.isempty")),react_1=__importStar(require("react")),use_immer_1=require("use-immer"),adhere_ui_backtopanimation_1=__importDefault(require("@baifendian/adhere-ui-backtopanimation")),adhere_ui_scrollload_1=__importDefault(require("@baifendian/adhere-ui-scrollload")),adhere_util_intl_1=__importDefault(require("@baifendian/adhere-util-intl")),Context_1=__importDefault(require("./Context")),DND_1=require("./DND"),PRSLItem_1=__importDefault(require("./PRSLItem")),SearchKeyWord_1=__importDefault(require("./SearchKeyWord")),Selection_1=require("./Selection"),Toolbar_1=__importDefault(require("./Toolbar")),selectorPrefix="adhere-mobile-ui-prsl",DEFAULT_PAGING_SIZE=30,DEFAULT_PAGING_PAGE=1,DEFAULT_DISTANCE=50,DEFAULT_TOOLBAR_COLLAPSE_COUNT=3,DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE="session",DEFAULT_ROW_KEY="id",DEFAULT_MODE="normal",DEFAULT_SEARCH_KEY_WORD_MODE="normal",DEFAULT_IS_USE_DND=!0,DEFAULT_IS_USE_SELECTION=!0,DEFAULT_ACTION_TRIGGER_MODE="ActionSheet",InternalPRSL=(0,react_1.memo)((0,react_1.forwardRef)(function(e){var r=e.className,r=void 0===r?"":r,F=e.style,t=e.innerClassName,V=void 0===t?"":t,W=e.innerStyle,t=e.isLoading,t=void 0===t||t,I=e.isUseFirstLoading,I=void 0===I||I,B=e.firstLoading,x=e.pullToRefreshProps,k=e.onRefreshBefore,n=e.paging,q=e.onRefresh,G=e.rowKey,a=e.showKeyWordSearchBar,j=void 0===a||a,H=e.searchKeyWordBarProps,a=e.searchKeyWordWrapperClassName,Y=void 0===a?"":a,z=e.searchKeyWordWrapperStyle,Z=e.searchKeyWordMode,J=e.searchKeyWordHistoryMaxSize,Q=e.isSearchKeyWordHistoryIntoStore,X=e.searchKeyWordHistoryStoreType,o=e.defaultSearchKeyWord,a=e.showToolBar,$=void 0===a||a,a=e.showTotal,ee=e.renderToolBar,re=e.afterToolBarRender,te=e.beforeToolBarRender,ne=e.beforeToolBarRenderClassName,ne=void 0===ne?"":ne,ae=e.beforeToolBarRenderStyle,oe=e.afterToolBarRenderClassName,oe=void 0===oe?"":oe,le=e.afterToolBarRenderStyle,l=e.toolbarWrapperClassName,l=void 0===l?"":l,ie=e.toolbarWrapperStyle,ue=e.toolbarCollapseCount,ue=void 0===ue?DEFAULT_TOOLBAR_COLLAPSE_COUNT:ue,se=e.toolbarConfig,i=e.scrollLoadProps,ce=e.onLoadMore,de=e.loadMoreLoading,u=e.showBackTopAnimation,_e=void 0===u||u,fe=e.backTopAnimationProps,ge=e.scrollLoadBeforeRender,me=e.scrollLoadAfterRender,u=e.scrollLoadBeforeRenderClassName,Se=void 0===u?"":u,pe=e.scrollLoadBeforeRenderStyle,u=e.scrollLoadAfterRenderClassName,he=void 0===u?"":u,ve=e.scrollLoadAfterRenderStyle,ye=e.beforeRender,Ee=e.afterRender,u=e.beforeRenderClassName,Te=void 0===u?"":u,De=e.beforeRenderStyle,u=e.afterRenderClassName,Re=void 0===u?"":u,Pe=e.afterRenderStyle,u=e.isShowFilterTrigger,be=e.renderFilterTrigger,Me=e.isShowSortTrigger,Ae=e.renderSortTrigger,Ne=e.isShowViewSettingTrigger,Le=e.renderViewSettingTrigger,Ce=e.viewSettingTriggerMode,Oe=e.viewSettingTriggerProps,we=e.renderViewSetting,Ke=e.viewSettingConfig,Ue=e.defaultViewSettingValue,Fe=e.onViewSetting,Ve=e.onViewSettingReset,We=e.loadData,Ie=e.renderEmpty,Be=e.renderOffLine,xe=e.filterTriggerMode,ke=e.filterTriggerProps,qe=e.renderFilter,Ge=e.filterFormProps,je=e.filterConfig,s=e.defaultFilterValues,He=e.sortTriggerMode,Ye=e.sortTriggerProps,ze=e.renderSort,Ze=e.sortConfig,c=e.defaultSortValues,Je=e.isUseLocal,Qe=e.isUseSelection,Xe=e.selectedRowKeys,$e=e.selectionMultiple,er=e.onSelectChange,rr=e.isUseDND,tr=e.dndDragHandle,nr=e.onDNDChange,ar=e.actionTriggerMode,or=e.onAction,lr=e.children,e=(0,ahooks_1.useNetwork)(),ir=(0,ahooks_1.useUpdate)(),d=(0,react_1.useState)({data:[],total:0}),_=d[0],f=d[1],d=(0,react_1.useState)(DEFAULT_MODE),g=d[0],ur=d[1],m=(0,react_1.useMemo)(function(){return"normal"===g},[g]),sr=(0,react_1.useMemo)(function(){return null!=ar?ar:DEFAULT_ACTION_TRIGGER_MODE},[ar]),cr=(0,react_1.useMemo)(function(){return null!=rr?rr:DEFAULT_IS_USE_DND},[rr]),dr=(0,react_1.useMemo)(function(){return null!=Qe?Qe:DEFAULT_IS_USE_SELECTION},[Qe]),S=(0,react_1.useMemo)(function(){return null!=G?G:DEFAULT_ROW_KEY},[G]),d=(0,Selection_1.useSelection)({selectedRowKeys:Xe,selectionMultiple:$e,mode:g,dataSource:_.data,rowKey:S}),_r=d.optionSelectedRowKeys,p=d.isUseSelectionMode,h=d.isSelectionMultiple,fr=d.finish,gr=d.cancel,Xe=d.selectionChange,$e=d.selectionAllChange,d=(0,DND_1.useDND)({mode:g,dataSource:_.data,rowKey:S,reset:function(){f(__assign({},_))}}),v=d.optionDataSource,y=d.isUseDNDMode,mr=d.finish,Sr=d.cancel,pr=d.move,d=(0,use_immer_1.useImmer)({searchKeyWord:null!=o?o:"",filterValues:null!=s?s:{},sortValues:null!=c?c:[]}),E=d[0],T=d[1],d=(0,react_1.useRef)(!0),D=(0,react_1.useRef)(!1),R=(0,react_1.useRef)({page:void 0!==n&&"object"===(0,_typeof2.default)(n)&&null!=(N=n.page)?N:DEFAULT_PAGING_PAGE,pageSize:void 0!==n&&"object"===(0,_typeof2.default)(n)&&null!=(N=n.defaultPageSize)?N:DEFAULT_PAGING_SIZE}),P=(0,react_1.useMemo)(function(){return"boolean"!=typeof n||n},[n]),b=(0,react_1.useRef)(),hr=(0,react_1.useRef)(void 0),M=(0,react_1.useRef)(null),A=(0,react_1.useRef)(adhere_ui_scrollload_1.default.NORMAL),N=(0,react_1.useCallback)(function(){var e;return null!=(e=null==B?void 0:B())?e:Tr},[B]),vr=(0,react_1.useCallback)(function(){var e;return null!=(e=null==de?void 0:de())?e:Dr},[de]),L=(0,react_1.useMemo)(function(){return"boolean"!=typeof Je||Je},[Je]),C=(0,react_1.useMemo)(function(){var e,r=E.searchKeyWord,t=void 0===r?"":r,r=E.filterValues,n=void 0===r?{}:r,r=E.sortValues,r=void 0===r?[]:r,a=null!=(a=_.data)?a:[];return y&&(a=v.data),(null!=r?r:[]).length&&(a=r.reduce(function(e,r){var t=r.order,n=r.name;return e=e.sort(function(e,r){return"asc"===t?e[n]>r[n]?1:e[n]<r[n]?-1:0:e[n]<r[n]?1:e[n]>r[n]?-1:0}),__spreadArray([],e,!0)},null!=(e=_.data)?e:[])),a=!t&&(0,lodash_isempty_1.default)(n)&&!r.length?a:a.filter(function(r){return t?Object.keys(r).some(function(e){return-1!==r[e].indexOf(t)}):!!(0,lodash_isempty_1.default)(n)||Object.keys(n).filter(function(e){return!!n[e]}).every(function(e){return-1!==r[e].indexOf(n[e])})})},[E,_,y,v]),O=(0,react_1.useMemo)(function(){var e,r;return L?(r=C,P&&(e=(R.current.page-1)*R.current.pageSize,r=C.slice(e,R.current.page*R.current.pageSize),1!==R.current.page)&&(r=__spreadArray(__spreadArray([],C.slice(0,e),!0),r,!0)),{total:C.length,data:r}):y?v:_},[_,C,v,y,L,P,R.current.page,R.current.pageSize]),w=(0,react_1.useMemo)(function(){return null==lr?void 0:lr({dataSource:O.data})},[lr,O.data]),yr=(0,react_1.useCallback)(function(){return!O.data.length},[O.data]),Er=(0,react_1.useMemo)(function(){var e;return(null!=(e=null==O?void 0:O.total)?e:0)/R.current.pageSize},[R.current.pageSize,O.total]),Tr=(0,react_1.useMemo)(function(){return react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-first-loading")},react_1.default.createElement(antd_mobile_1.Skeleton.Title,{animated:!0}),react_1.default.createElement(antd_mobile_1.Skeleton.Paragraph,{lineCount:25,animated:!0}))},[]),Dr=(0,react_1.useMemo)(function(){return react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading")},react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading-dot")},react_1.default.createElement(antd_mobile_1.DotLoading,{color:"primary"})),react_1.default.createElement("div",null,"".concat(adhere_util_intl_1.default.v("数据加载中")),"..."))},[]),Rr=(0,react_1.useMemo)(function(){var e;return null!=(e=null==Be?void 0:Be())?e:react_1.default.createElement(antd_mobile_1.ErrorBlock,{status:"disconnected"},react_1.default.createElement(antd_mobile_1.Button,{color:"primary",onClick:function(){ir()}},adhere_util_intl_1.default.v("点击重试")))},[Be]),Pr=(0,react_1.useMemo)(function(){var e;return react_1.default.createElement(SearchKeyWord_1.default,{className:null!=Y?Y:"",style:null!=z?z:{},searchKeyWordBarProps:H,searchKeyWordMode:null!=Z?Z:DEFAULT_SEARCH_KEY_WORD_MODE,searchKeyWordHistoryMaxSize:null!=J?J:DEFAULT_DISTANCE,isSearchKeyWordHistoryIntoStore:null==Q||Q,searchKeyWordHistoryStoreType:null!=X?X:DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE,disabled:!m,defaultSearchKeyWord:null!=(e=E.searchKeyWord)?e:"",onSearch:Vr,onSearchClear:Wr})},[Y,z,H,Z,J,E.searchKeyWord,m]),br=react_1.default.createElement(Toolbar_1.default,{className:l,style:ie,showTotal:a,renderToolBar:ee,afterToolBarRender:re,beforeToolBarRender:te,beforeToolBarRenderClassName:ne,beforeToolBarRenderStyle:ae,afterToolBarRenderClassName:oe,afterToolBarRenderStyle:le,isShowFilterTrigger:u,renderFilterTrigger:be,isShowSortTrigger:Me,renderSortTrigger:Ae,isShowViewSettingTrigger:Ne,renderViewSettingTrigger:Le,viewSettingTriggerMode:Ce,viewSettingTriggerProps:Oe,renderViewSetting:we,viewSettingConfig:Ke,defaultViewSettingValue:Ue,onViewSetting:Fe,onViewSettingReset:Ve,toolbarCollapseCount:ue,toolbarConfig:se,total:null!=(l=null==O?void 0:O.total)?l:0,filterTriggerMode:xe,filterTriggerProps:ke,renderFilter:qe,filterFormProps:Ge,filterConfig:je,defaultFilterValues:E.filterValues,onFilter:function(r){if(U(),T(function(e){e.filterValues=r}),L)return Promise.resolve();return K(__assign(__assign({},E),{filterValues:r}))},onFilterReset:function(){if(U(),T(function(e){e.filterValues={}}),L)return Promise.resolve();return K(__assign(__assign({},E),{filterValues:{}}))},sortTriggerMode:He,sortTriggerProps:Ye,renderSort:ze,sortConfig:Ze,defaultSortValues:E.sortValues,disabled:!m,onSort:function(r){if(U(),T(function(e){e.sortValues=r}),L)return Promise.resolve();return K(__assign(__assign({},E),{sortValues:r}))},onSortReset:function(){if(U(),T(function(e){e.sortValues=[]}),L)return Promise.resolve();return K(__assign(__assign({},E),{sortValues:[]}))}}),Mr=(0,react_1.useMemo)(function(){var e=null==ye?void 0:ye();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-inner-before"),null!=Te?Te:""),style:null!=De?De:{}},e)},[ye,Te,De]),Ar=(0,react_1.useMemo)(function(){var e=null==Ee?void 0:Ee();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-inner-after"),null!=Re?Re:""),style:null!=Pe?Pe:{}},e)},[Ee,Re,Pe]),Nr=(0,react_1.useMemo)(function(){var e=null==ge?void 0:ge();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-scroll-before"),null!=Se?Se:""),style:null!=pe?pe:{}},e)},[ge,Se,pe]),Lr=(0,react_1.useMemo)(function(){var e=null==me?void 0:me();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-scroll-after"),null!=he?he:""),style:null!=ve?ve:{}},e)},[me,he,ve]),Cr=(0,react_1.useMemo)(function(){var e;return react_1.default.createElement(adhere_ui_scrollload_1.default,__assign({ref:b,renderLoading:vr,distance:(null==i?void 0:i.distance)||50,onScrollBottom:xr},i||{},{disabled:!m,className:(0,classnames_1.default)("".concat(selectorPrefix,"-scroll-load"),null!=(e=null==i?void 0:i.className)?e:"")}),function(){if(p&&!h)return function(e){return!p||h?e:react_1.default.createElement(antd_mobile_1.Radio.Group,null,e)}(w);if(y)return react_1.default.createElement(DND_1.SortableContainer,{onSortEnd:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];pr.apply(void 0,e)},useDragHandle:!0},w);return w}())},[y,p,h,m,O.data,vr,i,w]),Or=(0,react_1.useMemo)(function(){return react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-scroll"),ref:hr},w)},[w]),wr=(0,react_1.useMemo)(function(){return react_1.default.createElement(adhere_ui_backtopanimation_1.default,__assign({},null!=fe?fe:{},{getContainer:Ir,onTrigger:function(){return Promise.resolve()}}))},[fe]),Kr=(0,react_1.useMemo)(function(){var e;return react_1.default.createElement(antd_mobile_1.PullToRefresh,__assign({},null!=x?x:{},{onRefresh:Br,disabled:!m}),Nr,yr()&&(null!=(e=null==Ie?void 0:Ie())?e:react_1.default.createElement(antd_mobile_1.ErrorBlock,{status:"empty"})),!yr()&&P&&Cr,!yr()&&!P&&Or,Lr,_e&&wr)},[n,x,Nr,Lr,Cr,Or,_e,wr,m,Ie,P]),ie=(0,react_1.useCallback)(function(){return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-header")},react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-header-main")},j&&Pr),react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-header-extra")},cr&&react_1.default.createElement(DND_1.DNDManageButton,{isUseDNDMode:y,isUseNormalMode:m,onChange:function(e){e?ur("dnd"):Ur()},onFinish:function(){f(v);var e=mr();null!=nr&&nr(e)},onCancel:Sr}),dr&&react_1.default.createElement(Selection_1.SelectionManageButton,{isUseSelectionMode:p,isUseNormalMode:m,onChange:function(e){e?ur("selection"):Ur()},onFinish:function(){var e=fr(),r=e.selectedRows,t=e.selectedRowKeys,n=e.changeRowKeys,e=e.info;null!=er&&er(t,r,n,e)},onCancel:gr}))),$&&br,react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-inner"),null!=V?V:""),style:null!=W?W:{}},Mr,Kr,Ar),p&&h&&react_1.default.createElement(Selection_1.SelectionCheckAllManage,null))},[j,Pr,$,br,V,W,Mr,Kr,Ar,p,h,m,y,cr,dr]);function Ur(){ur("normal")}function K(e){return We?We(__assign(__assign({},R.current),e)).then(function(e){return f(e),e}):Promise.resolve()}function U(){var e,r,t=null===Ir?void 0:Ir();t&&(t.scrollTop=0),null!=(e=null==(t=null==b?void 0:b.current)?void 0:t.hideAll)&&e.call(t),M.current=null,A.current=adhere_ui_scrollload_1.default.NORMAL,R.current.page=void 0!==n&&"object"===(0,_typeof2.default)(n)&&null!=(r=n.page)?r:DEFAULT_PAGING_PAGE,R.current.pageSize=void 0!==n&&"object"===(0,_typeof2.default)(n)&&null!=(r=n.defaultPageSize)?r:DEFAULT_PAGING_SIZE}function Fr(){U(),T(function(e){e.searchKeyWord=o,e.filterValues=s,e.sortValues=c})}function Vr(r){U(),T(function(e){e.searchKeyWord=r}),L||K(__assign(__assign({},E),{searchKeyWord:r}))}function Wr(){U(),T(function(e){e.searchKeyWord=""}),L||K(__assign(__assign({},E),{searchKeyWord:""}))}function Ir(){var e;return null!=(e=null!=(e=null==(e=b.current)?void 0:e.getScrollContainer())?e:hr.current)?e:document.body}function Br(){var e={searchKeyWord:o,filterValues:s,sortValues:c},r=k?k(__assign(__assign({},R.current),e)):Promise.resolve();return q?r.then(function(){return Fr(),L||null==q?void 0:q(__assign(__assign({},R.current),e)).then(function(e){f(e)})}):Promise.resolve(_)}function xr(e){if(A.current===adhere_ui_scrollload_1.default.EMPTY)A.current=adhere_ui_scrollload_1.default.EMPTY,e(adhere_ui_scrollload_1.default.EMPTY);else{if(M.current=e,!L)return null==ce?void 0:ce(__assign({page:R.current.page+1,pageSize:R.current.pageSize},E)).then(function(r){R.current.page+=1,f(function(e){return e.total=r.total,e.data=__spreadArray(__spreadArray([],e.data,!0),r.data,!0),__assign({},e)})});R.current.page+=1,ir()}}return(0,ahooks_1.useMount)(function(){K({searchKeyWord:o,filterValues:s,sortValues:c})}),(0,ahooks_1.useUpdateEffect)(function(){M.current&&(A.current=R.current.page<Er?adhere_ui_scrollload_1.default.NORMAL:adhere_ui_scrollload_1.default.EMPTY,M.current(A.current))},[_.data,Er,R.current.page]),(0,ahooks_1.useUpdateEffect)(function(){Fr(),K({searchKeyWord:o,filterValues:s,sortValues:c})},[o,c,s,L]),react_1.default.createElement(Context_1.default.Provider,{value:{isUseSelectionMode:function(){return p},isUseDNDMode:function(){return y},isUseNormalMode:function(){return m},selectionChange:Xe,selectionAllChange:$e,getRowKey:function(){return S},getOptionSelectedRowKeys:function(){return null!=_r?_r:[]},getDatasourceLength:function(){return _.data.length},getSelectionMultiple:function(){return h},getIndexByIdFormOptionDataSource:function(r){return v.data.findIndex(function(e){return e[S]===r})},getDndDragHandle:function(){return tr},getActionTriggerMode:function(){return sr},onAction:function(e,r){return null!=(e=null==or?void 0:or(e,r))?e:[]}}},react_1.default.createElement("div",{className:(0,classnames_1.default)(selectorPrefix,null!=r?r:""),style:null!=F?F:{}},e.online&&(I&&(d.current&&!D.current&&t&&(D.current=!0),d.current&&D.current&&!t&&(d.current=!1,D.current=!1),d.current)?N:ie)(),!e.online&&Rr))})),PRSL=InternalPRSL;PRSL.displayName="PRSL",PRSL.Item=PRSLItem_1.default,exports.default=PRSL;
//# sourceMappingURL=PRSL.js.map
