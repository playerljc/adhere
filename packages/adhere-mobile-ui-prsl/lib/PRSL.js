"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),__assign=function(){return(__assign=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e}).apply(this,arguments)},__createBinding=Object.create?function(e,r,t,n){void 0===n&&(n=t);var a=Object.getOwnPropertyDescriptor(r,t);a&&("get"in a?r.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,n,a)}:function(e,r,t,n){e[n=void 0===n?t:n]=r[t]},__setModuleDefault=Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r},__importStar=function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__spreadArray=function(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||((n=n||Array.prototype.slice.call(r,0,a))[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))},__importDefault=function(e){return e&&e.__esModule?e:{default:e}},ahooks_1=(Object.defineProperty(exports,"__esModule",{value:!0}),require("ahooks")),antd_mobile_1=require("antd-mobile"),classnames_1=__importDefault(require("classnames")),lodash_isempty_1=__importDefault(require("lodash.isempty")),react_1=__importStar(require("react")),use_immer_1=require("use-immer"),adhere_ui_backtopanimation_1=__importDefault(require("@baifendian/adhere-ui-backtopanimation")),adhere_ui_scrollload_1=__importDefault(require("@baifendian/adhere-ui-scrollload")),adhere_util_intl_1=__importDefault(require("@baifendian/adhere-util-intl")),Context_1=__importDefault(require("./Context")),DND_1=require("./DND"),PRSLItem_1=__importDefault(require("./PRSLItem")),SearchKeyWord_1=__importDefault(require("./SearchKeyWord")),Selection_1=require("./Selection"),Toolbar_1=__importDefault(require("./Toolbar")),selectorPrefix="adhere-mobile-ui-prsl",DEFAULT_PAGING_SIZE=30,DEFAULT_PAGING_PAGE=1,DEFAULT_DISTANCE=50,DEFAULT_TOOLBAR_COLLAPSE_COUNT=3,DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE="session",DEFAULT_ROW_KEY="id",DEFAULT_MODE="normal",DEFAULT_SEARCH_KEY_WORD_MODE="normal",DEFAULT_IS_USE_DND=!0,DEFAULT_IS_USE_SELECTION=!0,DEFAULT_ACTION_TRIGGER_MODE="ActionSheet",InternalPRSL=(0,react_1.memo)((0,react_1.forwardRef)(function(e,F){var r=e.className,r=void 0===r?"":r,V=e.style,t=e.innerClassName,W=void 0===t?"":t,I=e.innerStyle,t=e.isLoading,t=void 0===t||t,B=e.isUseFirstLoading,B=void 0===B||B,x=e.firstLoading,k=e.pullToRefreshProps,q=e.onRefreshBefore,n=e.paging,G=e.onRefresh,H=e.rowKey,a=e.showKeyWordSearchBar,j=void 0===a||a,Y=e.searchKeyWordBarProps,a=e.searchKeyWordWrapperClassName,z=void 0===a?"":a,Z=e.searchKeyWordWrapperStyle,J=e.searchKeyWordMode,Q=e.searchKeyWordHistoryMaxSize,X=e.isSearchKeyWordHistoryIntoStore,$=e.searchKeyWordHistoryStoreType,o=e.defaultSearchKeyWord,a=e.showToolBar,ee=void 0===a||a,a=e.showTotal,re=e.renderToolBar,te=e.afterToolBarRender,ne=e.beforeToolBarRender,ae=e.beforeToolBarRenderClassName,ae=void 0===ae?"":ae,oe=e.beforeToolBarRenderStyle,le=e.afterToolBarRenderClassName,le=void 0===le?"":le,ie=e.afterToolBarRenderStyle,l=e.toolbarWrapperClassName,l=void 0===l?"":l,ue=e.toolbarWrapperStyle,ce=e.toolbarCollapseCount,ce=void 0===ce?DEFAULT_TOOLBAR_COLLAPSE_COUNT:ce,se=e.toolbarConfig,i=e.scrollLoadProps,de=e.onLoadMore,_e=e.loadMoreLoading,u=e.showBackTopAnimation,fe=void 0===u||u,ge=e.backTopAnimationProps,me=e.scrollLoadBeforeRender,Se=e.scrollLoadAfterRender,u=e.scrollLoadBeforeRenderClassName,pe=void 0===u?"":u,he=e.scrollLoadBeforeRenderStyle,u=e.scrollLoadAfterRenderClassName,ve=void 0===u?"":u,ye=e.scrollLoadAfterRenderStyle,Ee=e.beforeRender,Te=e.afterRender,u=e.beforeRenderClassName,De=void 0===u?"":u,Re=e.beforeRenderStyle,u=e.afterRenderClassName,be=void 0===u?"":u,Le=e.afterRenderStyle,u=e.isShowFilterTrigger,Me=e.renderFilterTrigger,Pe=e.isShowSortTrigger,Ae=e.renderSortTrigger,Ce=e.isShowViewSettingTrigger,Ne=e.renderViewSettingTrigger,Oe=e.viewSettingTriggerMode,we=e.viewSettingTriggerProps,Ke=e.renderViewSetting,Ue=e.viewSettingConfig,Fe=e.defaultViewSettingValue,Ve=e.onViewSetting,We=e.onViewSettingReset,Ie=e.loadData,Be=e.renderEmpty,xe=e.renderOffLine,ke=e.filterTriggerMode,qe=e.filterTriggerProps,Ge=e.renderFilter,He=e.filterFormProps,je=e.filterConfig,c=e.defaultFilterValues,Ye=e.sortTriggerMode,ze=e.sortTriggerProps,Ze=e.renderSort,Je=e.sortConfig,s=e.defaultSortValues,Qe=e.isUseLocal,Xe=e.selectionLabel,$e=e.selectionFinishLabel,er=e.selectionCancelLabel,rr=e.isUseSelection,d=e.selectedRowKeys,tr=e.selectionMultiple,nr=e.onSelectChange,ar=e.isUseDND,or=e.dndDragHandle,lr=e.dndLabel,ir=e.dndFinishLabel,ur=e.dndCancelLabel,cr=e.onDNDChange,sr=e.actionTriggerMode,dr=e.renderActionSheetTrigger,_r=e.onAction,fr=e.headerExtra,gr=e.children,e=(0,react_1.useRef)(!0),_=(0,react_1.useRef)(!1),mr=(0,react_1.useRef)(void 0),f=(0,react_1.useRef)(null),g=(0,react_1.useRef)(adhere_ui_scrollload_1.default.NORMAL),m=(0,react_1.useRef)(),S=(0,react_1.useRef)({page:void 0!==n&&"object"===(0,_typeof2.default)(n)&&null!=(p=n.page)?p:DEFAULT_PAGING_PAGE,pageSize:void 0!==n&&"object"===(0,_typeof2.default)(n)&&null!=(p=n.defaultPageSize)?p:DEFAULT_PAGING_SIZE}),p=(0,react_1.useState)({data:[],total:0}),h=p[0],v=p[1],p=(0,react_1.useState)(DEFAULT_MODE),y=p[0],Sr=p[1],p=(0,ahooks_1.useNetwork)(),pr=(0,ahooks_1.useUpdate)(),E=(0,react_1.useMemo)(function(){return"normal"===y},[y]),hr=(0,react_1.useMemo)(function(){return null!=sr?sr:DEFAULT_ACTION_TRIGGER_MODE},[sr]),vr=(0,react_1.useMemo)(function(){return null!=ar?ar:DEFAULT_IS_USE_DND},[ar]),yr=(0,react_1.useMemo)(function(){return null!=rr?rr:DEFAULT_IS_USE_SELECTION},[rr]),Er=(0,react_1.useMemo)(function(){return null!=H?H:DEFAULT_ROW_KEY},[H]),d=(0,Selection_1.useSelection)({selectedRowKeys:d,selectionMultiple:tr,mode:y,dataSource:h.data,rowKey:Er}),Tr=d.optionSelectedRowKeys,T=d.isUseSelectionMode,D=d.isSelectionMultiple,Dr=d.finish,Rr=d.cancel,tr=d.selectionChange,d=d.selectionAllChange,R=(0,DND_1.useDND)({mode:y,dataSource:h.data,total:h.total,rowKey:Er,reset:function(){v(__assign({},h))}}),b=R.optionDataSource,L=R.isUseDNDMode,br=R.finish,Lr=R.cancel,Mr=R.move,R=(0,use_immer_1.useImmer)({searchKeyWord:null!=o?o:"",filterValues:null!=c?c:{},sortValues:null!=s?s:[]}),M=R[0],P=R[1],A=(0,react_1.useMemo)(function(){return"boolean"!=typeof n||n},[n]),C=(0,react_1.useMemo)(function(){return"boolean"!=typeof Qe||Qe},[Qe]),N=(0,react_1.useMemo)(function(){var e,r=M.searchKeyWord,t=void 0===r?"":r,r=M.filterValues,n=void 0===r?{}:r,r=M.sortValues,r=void 0===r?[]:r,a=null!=(a=h.data)?a:[];return L&&(a=b.data),(null!=r?r:[]).length&&(a=r.reduce(function(e,r){var t=r.order,n=r.name;return e=e.sort(function(e,r){return"asc"===t?e[n]>r[n]?1:e[n]<r[n]?-1:0:e[n]<r[n]?1:e[n]>r[n]?-1:0}),__spreadArray([],e,!0)},null!=(e=h.data)?e:[])),a=!t&&(0,lodash_isempty_1.default)(n)&&!r.length?a:a.filter(function(r){return t?Object.keys(r).some(function(e){return-1!==r[e].indexOf(t)}):!!(0,lodash_isempty_1.default)(n)||Object.keys(n).filter(function(e){return!!n[e]}).every(function(e){return-1!==r[e].indexOf(n[e])})})},[M,h,L,b]),O=(0,react_1.useMemo)(function(){var e,r;return C?(r=N,A&&(e=(S.current.page-1)*S.current.pageSize,r=N.slice(e,S.current.page*S.current.pageSize),1!==S.current.page)&&(r=__spreadArray(__spreadArray([],N.slice(0,e),!0),r,!0)),{total:N.length,data:r}):L?b:h},[h,N,b,L,C,A]),w=(0,react_1.useMemo)(function(){return null==gr?void 0:gr({dataSource:O.data})},[gr,O.data]),Pr=react_1.default.createElement(Toolbar_1.default,{className:l,style:ue,showTotal:a,renderToolBar:re,afterToolBarRender:te,beforeToolBarRender:ne,beforeToolBarRenderClassName:ae,beforeToolBarRenderStyle:oe,afterToolBarRenderClassName:le,afterToolBarRenderStyle:ie,isShowFilterTrigger:u,renderFilterTrigger:Me,isShowSortTrigger:Pe,renderSortTrigger:Ae,isShowViewSettingTrigger:Ce,renderViewSettingTrigger:Ne,viewSettingTriggerMode:Oe,viewSettingTriggerProps:we,renderViewSetting:Ke,viewSettingConfig:Ue,defaultViewSettingValue:Fe,onViewSetting:Ve,onViewSettingReset:We,toolbarCollapseCount:ce,toolbarConfig:se,total:null!=(R=null==O?void 0:O.total)?R:0,filterTriggerMode:ke,filterTriggerProps:qe,renderFilter:Ge,filterFormProps:He,filterConfig:je,defaultFilterValues:M.filterValues,onFilter:function(r){if(U(),P(function(e){e.filterValues=r}),C)return Promise.resolve();return K(__assign(__assign({},M),{filterValues:r}))},onFilterReset:function(){if(U(),P(function(e){e.filterValues={}}),C)return Promise.resolve();return K(__assign(__assign({},M),{filterValues:{}}))},sortTriggerMode:Ye,sortTriggerProps:ze,renderSort:Ze,sortConfig:Je,defaultSortValues:M.sortValues,disabled:!E,onSort:function(r){if(U(),P(function(e){e.sortValues=r}),C)return Promise.resolve();return K(__assign(__assign({},M),{sortValues:r}))},onSortReset:function(){if(U(),P(function(e){e.sortValues=[]}),C)return Promise.resolve();return K(__assign(__assign({},M),{sortValues:[]}))}}),Ar=(0,react_1.useMemo)(function(){var e;return(null!=(e=null==O?void 0:O.total)?e:0)/S.current.pageSize},[O.total]),Cr=(0,react_1.useMemo)(function(){return react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-first-loading")},react_1.default.createElement(antd_mobile_1.Skeleton.Title,{animated:!0}),react_1.default.createElement(antd_mobile_1.Skeleton.Paragraph,{lineCount:25,animated:!0}))},[]),Nr=(0,react_1.useMemo)(function(){return react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading")},react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading-dot")},react_1.default.createElement(antd_mobile_1.DotLoading,{color:"primary"})),react_1.default.createElement("div",null,"".concat(adhere_util_intl_1.default.v("数据加载中")),"..."))},[]),l=(0,react_1.useMemo)(function(){var e;return null!=(e=null==xe?void 0:xe())?e:react_1.default.createElement(antd_mobile_1.ErrorBlock,{status:"disconnected"},react_1.default.createElement(antd_mobile_1.Button,{color:"primary",onClick:function(){pr()}},adhere_util_intl_1.default.v("点击重试")))},[xe]),Or=(0,react_1.useMemo)(function(){var e;return react_1.default.createElement(SearchKeyWord_1.default,{className:null!=z?z:"",style:null!=Z?Z:{},searchKeyWordBarProps:Y,searchKeyWordMode:null!=J?J:DEFAULT_SEARCH_KEY_WORD_MODE,searchKeyWordHistoryMaxSize:null!=Q?Q:DEFAULT_DISTANCE,isSearchKeyWordHistoryIntoStore:null==X||X,searchKeyWordHistoryStoreType:null!=$?$:DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE,disabled:!E,defaultSearchKeyWord:null!=(e=M.searchKeyWord)?e:"",onSearch:Yr,onSearchClear:zr})},[z,Z,Y,J,Q,M.searchKeyWord,E]),wr=(0,react_1.useMemo)(function(){var e=null==Ee?void 0:Ee();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-inner-before"),null!=De?De:""),style:null!=Re?Re:{}},e)},[Ee,De,Re]),Kr=(0,react_1.useMemo)(function(){var e=null==Te?void 0:Te();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-inner-after"),null!=be?be:""),style:null!=Le?Le:{}},e)},[Te,be,Le]),Ur=(0,react_1.useMemo)(function(){var e=null==me?void 0:me();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-scroll-before"),null!=pe?pe:""),style:null!=he?he:{}},e)},[me,pe,he]),Fr=(0,react_1.useMemo)(function(){var e=null==Se?void 0:Se();return e&&react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-scroll-after"),null!=ve?ve:""),style:null!=ye?ye:{}},e)},[Se,ve,ye]),Vr=(0,react_1.useCallback)(function(){return!O.data.length},[O.data]),ue=(0,react_1.useCallback)(function(){var e;return null!=(e=null==x?void 0:x())?e:Cr},[x]),Wr=(0,react_1.useCallback)(function(){var e;return null!=(e=null==_e?void 0:_e())?e:Nr},[_e]),Ir=(0,react_1.useMemo)(function(){var e;return react_1.default.createElement(adhere_ui_scrollload_1.default,__assign({ref:m,renderLoading:Wr,distance:(null==i?void 0:i.distance)||50,onScrollBottom:$r},i||{},{disabled:!E,className:(0,classnames_1.default)("".concat(selectorPrefix,"-scroll-load"),null!=(e=null==i?void 0:i.className)?e:"")}),function(){if(T&&!D)return function(e){return!T||D?e:react_1.default.createElement(antd_mobile_1.Radio.Group,null,e)}(w);if(L)return react_1.default.createElement(DND_1.SortableContainer,{onSortEnd:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];Mr.apply(void 0,e)},useDragHandle:!0},w);return w}())},[L,T,D,E,O.data,Wr,i,w]),Br=(0,react_1.useMemo)(function(){return react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-scroll"),ref:mr},w)},[w]),xr=(0,react_1.useMemo)(function(){return react_1.default.createElement(adhere_ui_backtopanimation_1.default,__assign({},null!=ge?ge:{},{getContainer:Zr,onTrigger:function(){return Promise.resolve()}}))},[ge]),kr=(0,react_1.useMemo)(function(){return vr&&react_1.default.createElement(DND_1.DNDManageButton,{dndLabel:lr,dndFinishLabel:ir,dndCancelLabel:ur,isUseDNDMode:L,isUseNormalMode:E,onChange:function(e){e?Sr("dnd"):Hr()},onFinish:function(){v(b);var e=br();null!=cr&&cr(e)},onCancel:Lr})},[vr,L,E,b,lr,ir,ur]),qr=(0,react_1.useMemo)(function(){return yr&&react_1.default.createElement(Selection_1.SelectionManageButton,{selectionLabel:Xe,selectionFinishLabel:$e,selectionCancelLabel:er,isUseSelectionMode:T,isUseNormalMode:E,onChange:function(e){e?Sr("selection"):Hr()},onFinish:function(){var e=Dr(),r=e.selectedRows,t=e.selectedRowKeys,n=e.changeRowKeys,e=e.info;null!=nr&&nr(t,r,n,e)},onCancel:Rr})},[yr,Xe,$e,er,T,E]),Gr=(0,react_1.useMemo)(function(){var e;return react_1.default.createElement(antd_mobile_1.PullToRefresh,__assign({},null!=k?k:{},{onRefresh:Xr,disabled:!E}),Ur,Vr()&&(null!=(e=null==Be?void 0:Be())?e:react_1.default.createElement(antd_mobile_1.ErrorBlock,{status:"empty"})),!Vr()&&A&&Ir,!Vr()&&!A&&Br,Fr,fe&&xr)},[n,k,Ur,Fr,Ir,Br,fe,xr,E,Be,A]),a=(0,react_1.useCallback)(function(){var e;return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-header")},react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-header-main")},j&&Or),react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-header-extra")},null!=(e=null==fr?void 0:fr([kr,qr].filter(function(e){return!!e}),y))?e:[kr,qr].filter(function(e){return!!e}))),ee&&Pr,react_1.default.createElement("div",{className:(0,classnames_1.default)("".concat(selectorPrefix,"-inner"),null!=W?W:""),style:null!=I?I:{}},wr,Gr,Kr),T&&D&&react_1.default.createElement(Selection_1.SelectionCheckAllManage,null))},[j,Or,ee,Pr,W,I,wr,Gr,Kr,T,D,kr,qr,fr,y]);function Hr(){Sr("normal")}function K(e){return Ie?Ie(__assign(__assign({},S.current),e)).then(function(e){return v(e),e}):Promise.resolve()}function U(){var e,r,t=null===Zr?void 0:Zr();t&&(t.scrollTop=0),null!=(e=null==(t=null==m?void 0:m.current)?void 0:t.hideAll)&&e.call(t),f.current=null,g.current=adhere_ui_scrollload_1.default.NORMAL,S.current.page=void 0!==n&&"object"===(0,_typeof2.default)(n)&&null!=(r=n.page)?r:DEFAULT_PAGING_PAGE,S.current.pageSize=void 0!==n&&"object"===(0,_typeof2.default)(n)&&null!=(r=n.defaultPageSize)?r:DEFAULT_PAGING_SIZE}function jr(){U(),P(function(e){e.searchKeyWord=o,e.filterValues=c,e.sortValues=s})}function Yr(r){U(),P(function(e){e.searchKeyWord=r}),C||K(__assign(__assign({},M),{searchKeyWord:r}))}function zr(){U(),P(function(e){e.searchKeyWord=""}),C||K(__assign(__assign({},M),{searchKeyWord:""}))}function Zr(){var e;return null!=(e=null!=(e=null==(e=m.current)?void 0:e.getScrollContainer())?e:mr.current)?e:document.body}function Jr(e){var r={searchKeyWord:o,filterValues:c,sortValues:s},t=q?q(__assign(__assign({},S.current),r)):Promise.resolve();return G?t.then(function(){return e(),C||null==G?void 0:G(__assign(__assign({},S.current),r)).then(function(e){v(e)})}):Promise.resolve(h)}function Qr(){return Jr(jr)}function Xr(){return Qr()}function $r(e){if(g.current===adhere_ui_scrollload_1.default.EMPTY)g.current=adhere_ui_scrollload_1.default.EMPTY,e(adhere_ui_scrollload_1.default.EMPTY);else{if(f.current=e,!C)return null==de?void 0:de(__assign({page:S.current.page+1,pageSize:S.current.pageSize},M)).then(function(r){S.current.page+=1,v(function(e){return e.total=r.total,e.data=__spreadArray(__spreadArray([],e.data,!0),r.data,!0),__assign({},e)})});S.current.page+=1,pr()}}return(0,ahooks_1.useMount)(function(){K({searchKeyWord:o,filterValues:c,sortValues:s})}),(0,ahooks_1.useUpdateEffect)(function(){f.current&&(g.current=S.current.page<Ar?adhere_ui_scrollload_1.default.NORMAL:adhere_ui_scrollload_1.default.EMPTY,f.current(g.current))},[h.data,Ar]),(0,ahooks_1.useUpdateEffect)(function(){jr(),K({searchKeyWord:o,filterValues:c,sortValues:s})},[o,s,c,C]),(0,react_1.useImperativeHandle)(F,function(){return{getScrollEl:Zr,scrollLoadHideAll:function(){var e,r;return null==(r=null==(e=null==m?void 0:m.current)?void 0:e.hideAll)?void 0:r.call(e)},resetPagination:Qr,resetAll:function(){return Jr(U)}}}),react_1.default.createElement(Context_1.default.Provider,{value:{isUseSelectionMode:function(){return T},isUseDNDMode:function(){return L},isUseNormalMode:function(){return E},selectionChange:tr,selectionAllChange:d,getRowKey:function(){return Er},getOptionSelectedRowKeys:function(){return null!=Tr?Tr:[]},getDatasourceLength:function(){return h.data.length},getSelectionMultiple:function(){return D},getIndexByIdFormOptionDataSource:function(r){return b.data.findIndex(function(e){return e[Er]===r})},getDndDragHandle:function(){return or},getActionTriggerMode:function(){return hr},getRenderActionSheetTrigger:function(){return null==dr?void 0:dr()},onAction:function(e,r){return null!=(e=null==_r?void 0:_r(e,r))?e:[]}}},react_1.default.createElement("div",{className:(0,classnames_1.default)(selectorPrefix,null!=r?r:""),style:null!=V?V:{}},p.online&&(B&&(e.current&&!_.current&&t&&(_.current=!0),e.current&&_.current&&!t&&(e.current=!1,_.current=!1),e.current)?ue:a)(),!p.online&&l))})),PRSL=InternalPRSL;PRSL.displayName="PRSL",PRSL.Item=PRSLItem_1.default,exports.default=PRSL;
//# sourceMappingURL=PRSL.js.map
