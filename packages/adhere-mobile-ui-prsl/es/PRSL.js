import _Radio from"antd-mobile/es/components/radio";import _PullToRefresh from"antd-mobile/es/components/pull-to-refresh";import _Button from"antd-mobile/es/components/button";import _ErrorBlock from"antd-mobile/es/components/error-block";import _DotLoading from"antd-mobile/es/components/dot-loading";import _Skeleton from"antd-mobile/es/components/skeleton";import _typeof from"@babel/runtime/helpers/typeof";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(e,r,t){if(t||2===arguments.length)for(var n,o=0,a=r.length;o<a;o++)!n&&o in r||((n=n||Array.prototype.slice.call(r,0,o))[o]=r[o]);return e.concat(n||Array.prototype.slice.call(r))};import{useMount,useNetwork,useUpdate,useUpdateEffect}from"ahooks";import classNames from"classnames";import isPrimaryEmpty from"lodash.isempty";import React,{forwardRef,memo,useCallback,useImperativeHandle,useMemo,useRef,useState}from"react";import{useImmer}from"use-immer";import BackTopAnimation from"@baifendian/adhere-ui-backtopanimation";import ScrollLoad from"@baifendian/adhere-ui-scrollload";import Intl from"@baifendian/adhere-util-intl";import Context from"./Context";import{DNDManageButton,SortableContainer,useDND}from"./DND";import PRSLItem from"./PRSLItem";import SearchKeyWord from"./SearchKeyWord";import{SelectionCheckAllManage,SelectionManageButton,useSelection}from"./Selection";import ToolBar from"./Toolbar";var selectorPrefix="adhere-mobile-ui-prsl",DEFAULT_PAGING_SIZE=30,DEFAULT_PAGING_PAGE=1,DEFAULT_DISTANCE=50,DEFAULT_TOOLBAR_COLLAPSE_COUNT=3,DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE="session",DEFAULT_ROW_KEY="id",DEFAULT_MODE="normal",DEFAULT_SEARCH_KEY_WORD_MODE="normal",DEFAULT_IS_USE_DND=!0,DEFAULT_IS_USE_SELECTION=!0,DEFAULT_ACTION_TRIGGER_MODE="ActionSheet",InternalPRSL=memo(forwardRef(function(e,I){var r=e.className,r=void 0===r?"":r,O=e.style,t=e.innerClassName,B=void 0===t?"":t,V=e.innerStyle,t=e.isLoading,t=void 0===t||t,W=e.isUseFirstLoading,W=void 0===W||W,x=e.firstLoading,k=e.pullToRefreshProps,G=e.onRefreshBefore,n=e.paging,H=e.onRefresh,Y=e.rowKey,o=e.showKeyWordSearchBar,z=void 0===o||o,j=e.searchKeyWordBarProps,o=e.searchKeyWordWrapperClassName,Z=void 0===o?"":o,q=e.searchKeyWordWrapperStyle,J=e.searchKeyWordMode,Q=e.searchKeyWordHistoryMaxSize,X=e.isSearchKeyWordHistoryIntoStore,$=e.searchKeyWordHistoryStoreType,a=e.defaultSearchKeyWord,o=e.showToolBar,ee=void 0===o||o,o=e.showTotal,re=e.renderToolBar,te=e.afterToolBarRender,ne=e.beforeToolBarRender,oe=e.beforeToolBarRenderClassName,oe=void 0===oe?"":oe,ae=e.beforeToolBarRenderStyle,le=e.afterToolBarRenderClassName,le=void 0===le?"":le,ie=e.afterToolBarRenderStyle,l=e.toolbarWrapperClassName,l=void 0===l?"":l,se=e.toolbarWrapperStyle,ce=e.toolbarCollapseCount,ce=void 0===ce?DEFAULT_TOOLBAR_COLLAPSE_COUNT:ce,ue=e.toolbarConfig,i=e.scrollLoadProps,de=e.onLoadMore,fe=e.loadMoreLoading,s=e.showBackTopAnimation,me=void 0===s||s,ge=e.backTopAnimationProps,_e=e.scrollLoadBeforeRender,Se=e.scrollLoadAfterRender,s=e.scrollLoadBeforeRenderClassName,pe=void 0===s?"":s,Re=e.scrollLoadBeforeRenderStyle,s=e.scrollLoadAfterRenderClassName,ve=void 0===s?"":s,Ee=e.scrollLoadAfterRenderStyle,ye=e.beforeRender,he=e.afterRender,s=e.beforeRenderClassName,Te=void 0===s?"":s,Le=e.beforeRenderStyle,s=e.afterRenderClassName,Ae=void 0===s?"":s,Me=e.afterRenderStyle,s=e.isShowFilterTrigger,Pe=e.renderFilterTrigger,Ne=e.isShowSortTrigger,De=e.renderSortTrigger,be=e.isShowViewSettingTrigger,Ce=e.renderViewSettingTrigger,Ue=e.viewSettingTriggerMode,Ke=e.viewSettingTriggerProps,we=e.renderViewSetting,Fe=e.viewSettingConfig,Ie=e.defaultViewSettingValue,Oe=e.onViewSetting,Be=e.onViewSettingReset,Ve=e.loadData,We=e.renderEmpty,xe=e.renderOffLine,ke=e.filterTriggerMode,Ge=e.filterTriggerProps,He=e.renderFilter,Ye=e.filterFormProps,ze=e.filterConfig,c=e.defaultFilterValues,je=e.sortTriggerMode,Ze=e.sortTriggerProps,qe=e.renderSort,Je=e.sortConfig,u=e.defaultSortValues,Qe=e.isUseLocal,Xe=e.selectionLabel,$e=e.selectionFinishLabel,er=e.selectionCancelLabel,rr=e.isUseSelection,d=e.selectedRowKeys,tr=e.selectionMultiple,nr=e.onSelectChange,or=e.isUseDND,ar=e.dndDragHandle,lr=e.dndLabel,ir=e.dndFinishLabel,sr=e.dndCancelLabel,cr=e.onDNDChange,ur=e.actionTriggerMode,dr=e.renderActionSheetTrigger,fr=e.onAction,mr=e.headerExtra,gr=e.children,e=useRef(!0),f=useRef(!1),_r=useRef(void 0),m=useRef(null),g=useRef(ScrollLoad.NORMAL),_=useRef(),S=useRef({page:void 0!==n&&"object"===_typeof(n)&&null!=(p=n.page)?p:DEFAULT_PAGING_PAGE,pageSize:void 0!==n&&"object"===_typeof(n)&&null!=(p=n.defaultPageSize)?p:DEFAULT_PAGING_SIZE}),p=useState({data:[],total:0}),R=p[0],v=p[1],p=useState(DEFAULT_MODE),E=p[0],Sr=p[1],p=useNetwork(),pr=useUpdate(),y=useMemo(function(){return"normal"===E},[E]),Rr=useMemo(function(){return null!=ur?ur:DEFAULT_ACTION_TRIGGER_MODE},[ur]),vr=useMemo(function(){return null!=or?or:DEFAULT_IS_USE_DND},[or]),Er=useMemo(function(){return null!=rr?rr:DEFAULT_IS_USE_SELECTION},[rr]),yr=useMemo(function(){return null!=Y?Y:DEFAULT_ROW_KEY},[Y]),d=useSelection({selectedRowKeys:d,selectionMultiple:tr,mode:E,dataSource:R.data,rowKey:yr}),hr=d.optionSelectedRowKeys,h=d.isUseSelectionMode,T=d.isSelectionMultiple,Tr=d.finish,Lr=d.cancel,tr=d.selectionChange,d=d.selectionAllChange,L=useDND({mode:E,dataSource:R.data,total:R.total,rowKey:yr,reset:function(){v(__assign({},R))}}),A=L.optionDataSource,M=L.isUseDNDMode,Ar=L.finish,Mr=L.cancel,Pr=L.move,L=useImmer({searchKeyWord:null!=a?a:"",filterValues:null!=c?c:{},sortValues:null!=u?u:[]}),P=L[0],N=L[1],D=useMemo(function(){return"boolean"!=typeof n||n},[n]),b=useMemo(function(){return"boolean"!=typeof Qe||Qe},[Qe]),C=useMemo(function(){var e,r=P.searchKeyWord,t=void 0===r?"":r,r=P.filterValues,n=void 0===r?{}:r,r=P.sortValues,r=void 0===r?[]:r,o=null!=(o=R.data)?o:[];return M&&(o=A.data),(null!=r?r:[]).length&&(o=r.reduce(function(e,r){var t=r.order,n=r.name;return e=e.sort(function(e,r){return"asc"===t?e[n]>r[n]?1:e[n]<r[n]?-1:0:e[n]<r[n]?1:e[n]>r[n]?-1:0}),__spreadArray([],e,!0)},null!=(e=R.data)?e:[])),o=!t&&isPrimaryEmpty(n)&&!r.length?o:o.filter(function(r){return t?Object.keys(r).some(function(e){return-1!==r[e].indexOf(t)}):!!isPrimaryEmpty(n)||Object.keys(n).filter(function(e){return!!n[e]}).every(function(e){return-1!==r[e].indexOf(n[e])})})},[P,R,M,A]),U=useMemo(function(){var e,r;return b?(r=C,D&&(e=(S.current.page-1)*S.current.pageSize,r=C.slice(e,S.current.page*S.current.pageSize),1!==S.current.page)&&(r=__spreadArray(__spreadArray([],C.slice(0,e),!0),r,!0)),{total:C.length,data:r}):M?A:R},[R,C,A,M,b,D]),K=useMemo(function(){return null==gr?void 0:gr({dataSource:U.data})},[gr,U.data]),Nr=React.createElement(ToolBar,{className:l,style:se,showTotal:o,renderToolBar:re,afterToolBarRender:te,beforeToolBarRender:ne,beforeToolBarRenderClassName:oe,beforeToolBarRenderStyle:ae,afterToolBarRenderClassName:le,afterToolBarRenderStyle:ie,isShowFilterTrigger:s,renderFilterTrigger:Pe,isShowSortTrigger:Ne,renderSortTrigger:De,isShowViewSettingTrigger:be,renderViewSettingTrigger:Ce,viewSettingTriggerMode:Ue,viewSettingTriggerProps:Ke,renderViewSetting:we,viewSettingConfig:Fe,defaultViewSettingValue:Ie,onViewSetting:Oe,onViewSettingReset:Be,toolbarCollapseCount:ce,toolbarConfig:ue,total:null!=(L=null==U?void 0:U.total)?L:0,filterTriggerMode:ke,filterTriggerProps:Ge,renderFilter:He,filterFormProps:Ye,filterConfig:ze,defaultFilterValues:P.filterValues,onFilter:function(r){if(F(),N(function(e){e.filterValues=r}),b)return Promise.resolve();return w(__assign(__assign({},P),{filterValues:r}))},onFilterReset:function(){if(F(),N(function(e){e.filterValues={}}),b)return Promise.resolve();return w(__assign(__assign({},P),{filterValues:{}}))},sortTriggerMode:je,sortTriggerProps:Ze,renderSort:qe,sortConfig:Je,defaultSortValues:P.sortValues,disabled:!y,onSort:function(r){if(F(),N(function(e){e.sortValues=r}),b)return Promise.resolve();return w(__assign(__assign({},P),{sortValues:r}))},onSortReset:function(){if(F(),N(function(e){e.sortValues=[]}),b)return Promise.resolve();return w(__assign(__assign({},P),{sortValues:[]}))}}),Dr=useMemo(function(){var e;return(null!=(e=null==U?void 0:U.total)?e:0)/S.current.pageSize},[U.total]),br=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-first-loading")},React.createElement(_Skeleton.Title,{animated:!0}),React.createElement(_Skeleton.Paragraph,{lineCount:25,animated:!0}))},[]),Cr=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading")},React.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading-dot")},React.createElement(_DotLoading,{color:"primary"})),React.createElement("div",null,"".concat(Intl.v("数据加载中")),"..."))},[]),l=useMemo(function(){var e;return null!=(e=null==xe?void 0:xe())?e:React.createElement(_ErrorBlock,{status:"disconnected"},React.createElement(_Button,{color:"primary",onClick:function(){pr()}},Intl.v("点击重试")))},[xe]),Ur=useMemo(function(){var e;return React.createElement(SearchKeyWord,{className:null!=Z?Z:"",style:null!=q?q:{},searchKeyWordBarProps:j,searchKeyWordMode:null!=J?J:DEFAULT_SEARCH_KEY_WORD_MODE,searchKeyWordHistoryMaxSize:null!=Q?Q:DEFAULT_DISTANCE,isSearchKeyWordHistoryIntoStore:null==X||X,searchKeyWordHistoryStoreType:null!=$?$:DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE,disabled:!y,defaultSearchKeyWord:null!=(e=P.searchKeyWord)?e:"",onSearch:jr,onSearchClear:Zr})},[Z,q,j,J,Q,P.searchKeyWord,y]),Kr=useMemo(function(){var e=null==ye?void 0:ye();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner-before"),null!=Te?Te:""),style:null!=Le?Le:{}},e)},[ye,Te,Le]),wr=useMemo(function(){var e=null==he?void 0:he();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner-after"),null!=Ae?Ae:""),style:null!=Me?Me:{}},e)},[he,Ae,Me]),Fr=useMemo(function(){var e=null==_e?void 0:_e();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll-before"),null!=pe?pe:""),style:null!=Re?Re:{}},e)},[_e,pe,Re]),Ir=useMemo(function(){var e=null==Se?void 0:Se();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll-after"),null!=ve?ve:""),style:null!=Ee?Ee:{}},e)},[Se,ve,Ee]),Or=useCallback(function(){return!U.data.length},[U.data]),se=useCallback(function(){var e;return null!=(e=null==x?void 0:x())?e:br},[x]),Br=useCallback(function(){var e;return null!=(e=null==fe?void 0:fe())?e:Cr},[fe]),Vr=useMemo(function(){var e;return React.createElement(ScrollLoad,__assign({ref:_,renderLoading:Br,distance:(null==i?void 0:i.distance)||50,onScrollBottom:$r},i||{},{disabled:!y,className:classNames("".concat(selectorPrefix,"-scroll-load"),null!=(e=null==i?void 0:i.className)?e:"")}),function(){if(h&&!T)return function(e){return!h||T?e:React.createElement(_Radio.Group,null,e)}(K);if(M)return React.createElement(SortableContainer,{onSortEnd:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];Pr.apply(void 0,e)},useDragHandle:!0},K);return K}())},[M,h,T,y,U.data,Br,i,K]),Wr=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-scroll"),ref:_r},K)},[K]),xr=useMemo(function(){return React.createElement(BackTopAnimation,__assign({},null!=ge?ge:{},{getContainer:qr,onTrigger:function(){return Promise.resolve()}}))},[ge]),kr=useMemo(function(){return vr&&React.createElement(DNDManageButton,{dndLabel:lr,dndFinishLabel:ir,dndCancelLabel:sr,isUseDNDMode:M,isUseNormalMode:y,onChange:function(e){e?Sr("dnd"):Yr()},onFinish:function(){v(A);var e=Ar();null!=cr&&cr(e)},onCancel:Mr})},[vr,M,y,A,lr,ir,sr]),Gr=useMemo(function(){return Er&&React.createElement(SelectionManageButton,{selectionLabel:Xe,selectionFinishLabel:$e,selectionCancelLabel:er,isUseSelectionMode:h,isUseNormalMode:y,onChange:function(e){e?Sr("selection"):Yr()},onFinish:function(){var e=Tr(),r=e.selectedRows,t=e.selectedRowKeys,n=e.changeRowKeys,e=e.info;null!=nr&&nr(t,r,n,e)},onCancel:Lr})},[Er,Xe,$e,er,h,y]),Hr=useMemo(function(){var e;return React.createElement(_PullToRefresh,__assign({},null!=k?k:{},{onRefresh:Xr,disabled:!y}),Fr,Or()&&(null!=(e=null==We?void 0:We())?e:React.createElement(_ErrorBlock,{status:"empty"})),!Or()&&D&&Vr,!Or()&&!D&&Wr,Ir,me&&xr)},[n,k,Fr,Ir,Vr,Wr,me,xr,y,We,D]),o=useCallback(function(){var e;return React.createElement(React.Fragment,null,React.createElement("div",{className:"".concat(selectorPrefix,"-header")},React.createElement("div",{className:"".concat(selectorPrefix,"-header-main")},z&&Ur),React.createElement("div",{className:"".concat(selectorPrefix,"-header-extra")},null!=(e=null==mr?void 0:mr([kr,Gr].filter(function(e){return!!e}),E))?e:[kr,Gr].filter(function(e){return!!e}))),ee&&Nr,React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner"),null!=B?B:""),style:null!=V?V:{}},Kr,Hr,wr),h&&T&&React.createElement(SelectionCheckAllManage,null))},[z,Ur,ee,Nr,B,V,Kr,Hr,wr,h,T,kr,Gr,mr,E]);function Yr(){Sr("normal")}function w(e){return Ve?Ve(__assign(__assign({},S.current),e)).then(function(e){return v(e),e}):Promise.resolve()}function F(){var e,r,t=null===qr?void 0:qr();t&&(t.scrollTop=0),null!=(e=null==(t=null==_?void 0:_.current)?void 0:t.hideAll)&&e.call(t),m.current=null,g.current=ScrollLoad.NORMAL,S.current.page=void 0!==n&&"object"===_typeof(n)&&null!=(r=n.page)?r:DEFAULT_PAGING_PAGE,S.current.pageSize=void 0!==n&&"object"===_typeof(n)&&null!=(r=n.defaultPageSize)?r:DEFAULT_PAGING_SIZE}function zr(){F(),N(function(e){e.searchKeyWord=a,e.filterValues=c,e.sortValues=u})}function jr(r){F(),N(function(e){e.searchKeyWord=r}),b||w(__assign(__assign({},P),{searchKeyWord:r}))}function Zr(){F(),N(function(e){e.searchKeyWord=""}),b||w(__assign(__assign({},P),{searchKeyWord:""}))}function qr(){var e;return null!=(e=null!=(e=null==(e=_.current)?void 0:e.getScrollContainer())?e:_r.current)?e:document.body}function Jr(e){var r={searchKeyWord:a,filterValues:c,sortValues:u},t=G?G(__assign(__assign({},S.current),r)):Promise.resolve();return H?t.then(function(){return e(),b||null==H?void 0:H(__assign(__assign({},S.current),r)).then(function(e){v(e)})}):Promise.resolve(R)}function Qr(){return Jr(zr)}function Xr(){return Qr()}function $r(e){if(g.current===ScrollLoad.EMPTY)g.current=ScrollLoad.EMPTY,e(ScrollLoad.EMPTY);else{if(m.current=e,!b)return null==de?void 0:de(__assign({page:S.current.page+1,pageSize:S.current.pageSize},P)).then(function(r){S.current.page+=1,v(function(e){return e.total=r.total,e.data=__spreadArray(__spreadArray([],e.data,!0),r.data,!0),__assign({},e)})});S.current.page+=1,pr()}}return useMount(function(){w({searchKeyWord:a,filterValues:c,sortValues:u})}),useUpdateEffect(function(){m.current&&(g.current=S.current.page<Dr?ScrollLoad.NORMAL:ScrollLoad.EMPTY,m.current(g.current))},[R.data,Dr]),useUpdateEffect(function(){zr(),w({searchKeyWord:a,filterValues:c,sortValues:u})},[a,u,c,b]),useImperativeHandle(I,function(){return{getScrollEl:qr,scrollLoadHideAll:function(){var e,r;return null==(r=null==(e=null==_?void 0:_.current)?void 0:e.hideAll)?void 0:r.call(e)},resetPagination:Qr,resetAll:function(){return Jr(F)}}}),React.createElement(Context.Provider,{value:{isUseSelectionMode:function(){return h},isUseDNDMode:function(){return M},isUseNormalMode:function(){return y},selectionChange:tr,selectionAllChange:d,getRowKey:function(){return yr},getOptionSelectedRowKeys:function(){return null!=hr?hr:[]},getDatasourceLength:function(){return R.data.length},getSelectionMultiple:function(){return T},getIndexByIdFormOptionDataSource:function(r){return A.data.findIndex(function(e){return e[yr]===r})},getDndDragHandle:function(){return ar},getActionTriggerMode:function(){return Rr},getRenderActionSheetTrigger:function(){return null==dr?void 0:dr()},onAction:function(e,r){return null!=(e=null==fr?void 0:fr(e,r))?e:[]}}},React.createElement("div",{className:classNames(selectorPrefix,null!=r?r:""),style:null!=O?O:{}},p.online&&(W&&(e.current&&!f.current&&t&&(f.current=!0),e.current&&f.current&&!t&&(e.current=!1,f.current=!1),e.current)?se:o)(),!p.online&&l))})),PRSL=InternalPRSL;PRSL.displayName="PRSL",PRSL.Item=PRSLItem;export default PRSL;
//# sourceMappingURL=PRSL.js.map
