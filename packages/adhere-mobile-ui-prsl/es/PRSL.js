import _Radio from"antd-mobile/es/components/radio";import _PullToRefresh from"antd-mobile/es/components/pull-to-refresh";import _Button from"antd-mobile/es/components/button";import _ErrorBlock from"antd-mobile/es/components/error-block";import _DotLoading from"antd-mobile/es/components/dot-loading";import _Skeleton from"antd-mobile/es/components/skeleton";import _typeof from"@babel/runtime/helpers/typeof";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(e,r,t){if(t||2===arguments.length)for(var n,o=0,a=r.length;o<a;o++)!n&&o in r||((n=n||Array.prototype.slice.call(r,0,o))[o]=r[o]);return e.concat(n||Array.prototype.slice.call(r))};import{useMount,useNetwork,useUpdate,useUpdateEffect}from"ahooks";import classNames from"classnames";import isPrimaryEmpty from"lodash.isempty";import React,{forwardRef,memo,useCallback,useMemo,useRef,useState}from"react";import{useImmer}from"use-immer";import BackTopAnimation from"@baifendian/adhere-ui-backtopanimation";import ScrollLoad from"@baifendian/adhere-ui-scrollload";import Intl from"@baifendian/adhere-util-intl";import Context from"./Context";import{DNDManageButton,SortableContainer,useDND}from"./DND";import PRSLItem from"./PRSLItem";import SearchKeyWord from"./SearchKeyWord";import{SelectionCheckAllManage,SelectionManageButton,useSelection}from"./Selection";import ToolBar from"./Toolbar";var selectorPrefix="adhere-mobile-ui-prsl",DEFAULT_PAGING_SIZE=30,DEFAULT_PAGING_PAGE=1,DEFAULT_DISTANCE=50,DEFAULT_TOOLBAR_COLLAPSE_COUNT=3,DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE="session",DEFAULT_ROW_KEY="id",DEFAULT_MODE="normal",DEFAULT_SEARCH_KEY_WORD_MODE="normal",DEFAULT_IS_USE_DND=!0,DEFAULT_IS_USE_SELECTION=!0,DEFAULT_ACTION_TRIGGER_MODE="ActionSheet",InternalPRSL=memo(forwardRef(function(e){var r=e.className,r=void 0===r?"":r,O=e.style,t=e.innerClassName,B=void 0===t?"":t,V=e.innerStyle,t=e.isLoading,t=void 0===t||t,W=e.isUseFirstLoading,W=void 0===W||W,I=e.firstLoading,k=e.pullToRefreshProps,x=e.onRefreshBefore,n=e.paging,G=e.onRefresh,H=e.rowKey,o=e.showKeyWordSearchBar,Y=void 0===o||o,z=e.searchKeyWordBarProps,o=e.searchKeyWordWrapperClassName,j=void 0===o?"":o,Z=e.searchKeyWordWrapperStyle,q=e.searchKeyWordMode,J=e.searchKeyWordHistoryMaxSize,Q=e.isSearchKeyWordHistoryIntoStore,X=e.searchKeyWordHistoryStoreType,a=e.defaultSearchKeyWord,o=e.showToolBar,$=void 0===o||o,o=e.showTotal,ee=e.renderToolBar,re=e.afterToolBarRender,te=e.beforeToolBarRender,ne=e.beforeToolBarRenderClassName,ne=void 0===ne?"":ne,oe=e.beforeToolBarRenderStyle,ae=e.afterToolBarRenderClassName,ae=void 0===ae?"":ae,le=e.afterToolBarRenderStyle,l=e.toolbarWrapperClassName,l=void 0===l?"":l,ie=e.toolbarWrapperStyle,se=e.toolbarCollapseCount,se=void 0===se?DEFAULT_TOOLBAR_COLLAPSE_COUNT:se,ce=e.toolbarConfig,i=e.scrollLoadProps,ue=e.onLoadMore,de=e.loadMoreLoading,s=e.showBackTopAnimation,fe=void 0===s||s,me=e.backTopAnimationProps,ge=e.scrollLoadBeforeRender,_e=e.scrollLoadAfterRender,s=e.scrollLoadBeforeRenderClassName,Se=void 0===s?"":s,pe=e.scrollLoadBeforeRenderStyle,s=e.scrollLoadAfterRenderClassName,Re=void 0===s?"":s,Ee=e.scrollLoadAfterRenderStyle,ye=e.beforeRender,ve=e.afterRender,s=e.beforeRenderClassName,Te=void 0===s?"":s,he=e.beforeRenderStyle,s=e.afterRenderClassName,Pe=void 0===s?"":s,Ae=e.afterRenderStyle,s=e.isShowFilterTrigger,Le=e.renderFilterTrigger,Ne=e.isShowSortTrigger,Me=e.renderSortTrigger,De=e.isShowViewSettingTrigger,Ce=e.renderViewSettingTrigger,be=e.viewSettingTriggerMode,Ue=e.viewSettingTriggerProps,Ke=e.renderViewSetting,we=e.viewSettingConfig,Fe=e.defaultViewSettingValue,Oe=e.onViewSetting,Be=e.onViewSettingReset,Ve=e.loadData,We=e.renderEmpty,Ie=e.renderOffLine,ke=e.filterTriggerMode,xe=e.filterTriggerProps,Ge=e.renderFilter,He=e.filterFormProps,Ye=e.filterConfig,c=e.defaultFilterValues,ze=e.sortTriggerMode,je=e.sortTriggerProps,Ze=e.renderSort,qe=e.sortConfig,u=e.defaultSortValues,Je=e.isUseLocal,Qe=e.isUseSelection,Xe=e.selectedRowKeys,$e=e.selectionMultiple,er=e.onSelectChange,rr=e.isUseDND,tr=e.dndDragHandle,nr=e.onDNDChange,or=e.actionTriggerMode,ar=e.onAction,lr=e.children,e=useNetwork(),ir=useUpdate(),d=useState({data:[],total:0}),f=d[0],m=d[1],d=useState(DEFAULT_MODE),g=d[0],sr=d[1],_=useMemo(function(){return"normal"===g},[g]),cr=(useMemo(function(){return null!=or?or:DEFAULT_ACTION_TRIGGER_MODE},[or]),useMemo(function(){return null!=rr?rr:DEFAULT_IS_USE_DND},[rr])),ur=useMemo(function(){return null!=Qe?Qe:DEFAULT_IS_USE_SELECTION},[Qe]),S=useMemo(function(){return null!=H?H:DEFAULT_ROW_KEY},[H]),d=useSelection({selectedRowKeys:Xe,selectionMultiple:$e,mode:g,dataSource:f.data,rowKey:S}),dr=d.optionSelectedRowKeys,p=d.isUseSelectionMode,R=d.isSelectionMultiple,fr=d.finish,mr=d.cancel,Xe=d.selectionChange,$e=d.selectionAllChange,d=useDND({mode:g,dataSource:f.data,rowKey:S,reset:function(){m(__assign({},f))}}),E=d.optionDataSource,y=d.isUseDNDMode,gr=d.finish,_r=d.cancel,Sr=d.move,d=useImmer({searchKeyWord:null!=a?a:"",filterValues:null!=c?c:{},sortValues:null!=u?u:[]}),v=d[0],T=d[1],d=useRef(!0),h=useRef(!1),P=useRef({page:void 0!==n&&"object"===_typeof(n)&&null!=(D=n.page)?D:DEFAULT_PAGING_PAGE,pageSize:void 0!==n&&"object"===_typeof(n)&&null!=(D=n.defaultPageSize)?D:DEFAULT_PAGING_SIZE}),A=useMemo(function(){return"boolean"!=typeof n||n},[n]),L=useRef(),pr=useRef(void 0),N=useRef(null),M=useRef(ScrollLoad.NORMAL),D=useCallback(function(){var e;return null!=(e=null==I?void 0:I())?e:vr},[I]),Rr=useCallback(function(){var e;return null!=(e=null==de?void 0:de())?e:Tr},[de]),C=useMemo(function(){return"boolean"!=typeof Je||Je},[Je]),b=useMemo(function(){var e,r=v.searchKeyWord,t=void 0===r?"":r,r=v.filterValues,n=void 0===r?{}:r,r=v.sortValues,r=void 0===r?[]:r,o=null!=(o=f.data)?o:[];return y&&(o=E.data),(null!=r?r:[]).length&&(o=r.reduce(function(e,r){var t=r.order,n=r.name;return e=e.sort(function(e,r){return"asc"===t?e[n]>r[n]?1:e[n]<r[n]?-1:0:e[n]<r[n]?1:e[n]>r[n]?-1:0}),__spreadArray([],e,!0)},null!=(e=f.data)?e:[])),o=!t&&isPrimaryEmpty(n)&&!r.length?o:o.filter(function(r){return t?Object.keys(r).some(function(e){return-1!==r[e].indexOf(t)}):!!isPrimaryEmpty(n)||Object.keys(n).filter(function(e){return!!n[e]}).every(function(e){return-1!==r[e].indexOf(n[e])})})},[v,f,y,E]),U=useMemo(function(){var e,r;return C?(r=b,A&&(e=(P.current.page-1)*P.current.pageSize,r=b.slice(e,P.current.page*P.current.pageSize),1!==P.current.page)&&(r=__spreadArray(__spreadArray([],b.slice(0,e),!0),r,!0)),{total:b.length,data:r}):y?E:f},[f,b,E,y,C,A,P.current.page,P.current.pageSize]),K=useMemo(function(){return null==lr?void 0:lr({dataSource:U.data})},[lr,U.data]),Er=useCallback(function(){return!U.data.length},[U.data]),yr=useMemo(function(){var e;return(null!=(e=null==U?void 0:U.total)?e:0)/P.current.pageSize},[P.current.pageSize,U.total]),vr=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-first-loading")},React.createElement(_Skeleton.Title,{animated:!0}),React.createElement(_Skeleton.Paragraph,{lineCount:25,animated:!0}))},[]),Tr=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading")},React.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading-dot")},React.createElement(_DotLoading,{color:"primary"})),React.createElement("div",null,"".concat(Intl.v("数据加载中")),"..."))},[]),hr=useMemo(function(){var e;return null!=(e=null==Ie?void 0:Ie())?e:React.createElement(_ErrorBlock,{status:"disconnected"},React.createElement(_Button,{color:"primary",onClick:function(){ir()}},Intl.v("点击重试")))},[Ie]),Pr=useMemo(function(){var e;return React.createElement(SearchKeyWord,{className:null!=j?j:"",style:null!=Z?Z:{},searchKeyWordBarProps:z,searchKeyWordMode:null!=q?q:DEFAULT_SEARCH_KEY_WORD_MODE,searchKeyWordHistoryMaxSize:null!=J?J:DEFAULT_DISTANCE,isSearchKeyWordHistoryIntoStore:null==Q||Q,searchKeyWordHistoryStoreType:null!=X?X:DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE,disabled:!_,defaultSearchKeyWord:null!=(e=v.searchKeyWord)?e:"",onSearch:Or,onSearchClear:Br})},[j,Z,z,q,J,v.searchKeyWord,_]),Ar=React.createElement(ToolBar,{className:l,style:ie,showTotal:o,renderToolBar:ee,afterToolBarRender:re,beforeToolBarRender:te,beforeToolBarRenderClassName:ne,beforeToolBarRenderStyle:oe,afterToolBarRenderClassName:ae,afterToolBarRenderStyle:le,isShowFilterTrigger:s,renderFilterTrigger:Le,isShowSortTrigger:Ne,renderSortTrigger:Me,isShowViewSettingTrigger:De,renderViewSettingTrigger:Ce,viewSettingTriggerMode:be,viewSettingTriggerProps:Ue,renderViewSetting:Ke,viewSettingConfig:we,defaultViewSettingValue:Fe,onViewSetting:Oe,onViewSettingReset:Be,toolbarCollapseCount:se,toolbarConfig:ce,total:null!=(l=null==U?void 0:U.total)?l:0,filterTriggerMode:ke,filterTriggerProps:xe,renderFilter:Ge,filterFormProps:He,filterConfig:Ye,defaultFilterValues:v.filterValues,onFilter:function(r){if(F(),T(function(e){e.filterValues=r}),C)return Promise.resolve();return w(__assign(__assign({},v),{filterValues:r}))},onFilterReset:function(){if(F(),T(function(e){e.filterValues={}}),C)return Promise.resolve();return w(__assign(__assign({},v),{filterValues:{}}))},sortTriggerMode:ze,sortTriggerProps:je,renderSort:Ze,sortConfig:qe,defaultSortValues:v.sortValues,disabled:!_,onSort:function(r){if(F(),T(function(e){e.sortValues=r}),C)return Promise.resolve();return w(__assign(__assign({},v),{sortValues:r}))},onSortReset:function(){if(F(),T(function(e){e.sortValues=[]}),C)return Promise.resolve();return w(__assign(__assign({},v),{sortValues:[]}))}}),Lr=useMemo(function(){var e=null==ye?void 0:ye();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner-before"),null!=Te?Te:""),style:null!=he?he:{}},e)},[ye,Te,he]),Nr=useMemo(function(){var e=null==ve?void 0:ve();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner-after"),null!=Pe?Pe:""),style:null!=Ae?Ae:{}},e)},[ve,Pe,Ae]),Mr=useMemo(function(){var e=null==ge?void 0:ge();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll-before"),null!=Se?Se:""),style:null!=pe?pe:{}},e)},[ge,Se,pe]),Dr=useMemo(function(){var e=null==_e?void 0:_e();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll-after"),null!=Re?Re:""),style:null!=Ee?Ee:{}},e)},[_e,Re,Ee]),Cr=useMemo(function(){var e;return React.createElement(ScrollLoad,__assign({ref:L,renderLoading:Rr,distance:(null==i?void 0:i.distance)||50,onScrollBottom:Ir},i||{},{disabled:!_,className:classNames("".concat(selectorPrefix,"-scroll-load"),null!=(e=null==i?void 0:i.className)?e:"")}),function(){if(p&&!R)return function(e){return!p||R?e:React.createElement(_Radio.Group,null,e)}(K);if(y)return React.createElement(SortableContainer,{onSortEnd:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];Sr.apply(void 0,e)},useDragHandle:!0},K);return K}())},[y,p,R,_,U.data,Rr,i,K]),br=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-scroll"),ref:pr},K)},[K]),Ur=useMemo(function(){return React.createElement(BackTopAnimation,__assign({},null!=me?me:{},{getContainer:Vr,onTrigger:function(){return Promise.resolve()}}))},[me]),Kr=useMemo(function(){var e;return React.createElement(_PullToRefresh,__assign({},null!=k?k:{},{onRefresh:Wr,disabled:!_}),Mr,Er()&&(null!=(e=null==We?void 0:We())?e:React.createElement(_ErrorBlock,{status:"empty"})),!Er()&&A&&Cr,!Er()&&!A&&br,Dr,fe&&Ur)},[n,k,Mr,Dr,Cr,br,fe,Ur,_,We,A]),ie=useCallback(function(){return React.createElement(React.Fragment,null,React.createElement("div",{className:"".concat(selectorPrefix,"-header")},React.createElement("div",{className:"".concat(selectorPrefix,"-header-main")},Y&&Pr),React.createElement("div",{className:"".concat(selectorPrefix,"-header-extra")},cr&&React.createElement(DNDManageButton,{isUseDNDMode:y,isUseNormalMode:_,onChange:function(e){e?sr("dnd"):wr()},onFinish:function(){m(E);var e=gr();null!=nr&&nr(e)},onCancel:_r}),ur&&React.createElement(SelectionManageButton,{isUseSelectionMode:p,isUseNormalMode:_,onChange:function(e){e?sr("selection"):wr()},onFinish:function(){var e=fr(),r=e.selectedRows,t=e.selectedRowKeys,n=e.changeRowKeys,e=e.info;null!=er&&er(t,r,n,e)},onCancel:mr}))),$&&Ar,React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner"),null!=B?B:""),style:null!=V?V:{}},Lr,Kr,Nr),p&&R&&React.createElement(SelectionCheckAllManage,null))},[Y,Pr,$,Ar,B,V,Lr,Kr,Nr,p,R,_,y,cr,ur]);function wr(){sr("normal")}function w(e){return Ve?Ve(__assign(__assign({},P.current),e)).then(function(e){return m(e),e}):Promise.resolve()}function F(){var e,r,t=null===Vr?void 0:Vr();t&&(t.scrollTop=0),null!=(e=null==(t=null==L?void 0:L.current)?void 0:t.hideAll)&&e.call(t),N.current=null,M.current=ScrollLoad.NORMAL,P.current.page=void 0!==n&&"object"===_typeof(n)&&null!=(r=n.page)?r:DEFAULT_PAGING_PAGE,P.current.pageSize=void 0!==n&&"object"===_typeof(n)&&null!=(r=n.defaultPageSize)?r:DEFAULT_PAGING_SIZE}function Fr(){F(),T(function(e){e.searchKeyWord=a,e.filterValues=c,e.sortValues=u})}function Or(r){F(),T(function(e){e.searchKeyWord=r}),C||w(__assign(__assign({},v),{searchKeyWord:r}))}function Br(){F(),T(function(e){e.searchKeyWord=""}),C||w(__assign(__assign({},v),{searchKeyWord:""}))}function Vr(){var e;return null!=(e=null!=(e=null==(e=L.current)?void 0:e.getScrollContainer())?e:pr.current)?e:document.body}function Wr(){var e={searchKeyWord:a,filterValues:c,sortValues:u},r=x?x(__assign(__assign({},P.current),e)):Promise.resolve();return G?r.then(function(){return Fr(),C||null==G?void 0:G(__assign(__assign({},P.current),e)).then(function(e){m(e)})}):Promise.resolve(f)}function Ir(e){if(M.current===ScrollLoad.EMPTY)M.current=ScrollLoad.EMPTY,e(ScrollLoad.EMPTY);else{if(N.current=e,!C)return null==ue?void 0:ue(__assign({page:P.current.page+1,pageSize:P.current.pageSize},v)).then(function(r){P.current.page+=1,m(function(e){return e.total=r.total,e.data=__spreadArray(__spreadArray([],e.data,!0),r.data,!0),__assign({},e)})});P.current.page+=1,ir()}}return useMount(function(){w({searchKeyWord:a,filterValues:c,sortValues:u})}),useUpdateEffect(function(){N.current&&(M.current=P.current.page<yr?ScrollLoad.NORMAL:ScrollLoad.EMPTY,N.current(M.current))},[f.data,yr,P.current.page]),useUpdateEffect(function(){Fr(),w({searchKeyWord:a,filterValues:c,sortValues:u})},[a,u,c,C]),React.createElement(Context.Provider,{value:{isUseSelectionMode:function(){return p},isUseDNDMode:function(){return y},isUseNormalMode:function(){return _},getRowKey:function(){return S},getOptionSelectedRowKeys:function(){return null!=dr?dr:[]},selectionChange:Xe,selectionAllChange:$e,getDatasourceLength:function(){return f.data.length},getSelectionMultiple:function(){return R},getIndexByIdFormOptionDataSource:function(r){return E.data.findIndex(function(e){return e[S]===r})},getDndDragHandle:function(){return tr},onAction:function(e,r){return null!=(e=null==ar?void 0:ar(e,r))?e:[]}}},React.createElement("div",{className:classNames(selectorPrefix,null!=r?r:""),style:null!=O?O:{}},e.online&&(W&&(d.current&&!h.current&&t&&(h.current=!0),d.current&&h.current&&!t&&(d.current=!1,h.current=!1),d.current)?D:ie)(),!e.online&&hr))})),PRSL=InternalPRSL;PRSL.displayName="PRSL",PRSL.Item=PRSLItem;export default PRSL;
//# sourceMappingURL=PRSL.js.map
