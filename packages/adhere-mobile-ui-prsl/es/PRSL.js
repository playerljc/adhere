import _Radio from"antd-mobile/es/components/radio";import _PullToRefresh from"antd-mobile/es/components/pull-to-refresh";import _Button from"antd-mobile/es/components/button";import _ErrorBlock from"antd-mobile/es/components/error-block";import _DotLoading from"antd-mobile/es/components/dot-loading";import _Skeleton from"antd-mobile/es/components/skeleton";import _typeof from"@babel/runtime/helpers/typeof";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var r,t=1,o=arguments.length;t<o;t++)for(var n in r=arguments[t])Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n]);return e}).apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(e,r,t){if(t||2===arguments.length)for(var o,n=0,a=r.length;n<a;n++)!o&&n in r||((o=o||Array.prototype.slice.call(r,0,n))[n]=r[n]);return e.concat(o||Array.prototype.slice.call(r))};import{useMount,useNetwork,useUpdate,useUpdateEffect}from"ahooks";import classNames from"classnames";import isPrimaryEmpty from"lodash.isempty";import React,{forwardRef,memo,useCallback,useMemo,useRef,useState}from"react";import{useImmer}from"use-immer";import BackTopAnimation from"@baifendian/adhere-ui-backtopanimation";import ScrollLoad from"@baifendian/adhere-ui-scrollload";import Intl from"@baifendian/adhere-util-intl";import Context from"./Context";import PRSLItem from"./PRSLItem";import SearchKeyWord from"./SearchKeyWord";import{SelectionCheckAllManage,SelectionManageButton,useSelection}from"./Selection";import ToolBar from"./Toolbar";var selectorPrefix="adhere-mobile-ui-prsl",DEFAULT_PAGING_SIZE=30,DEFAULT_PAGING_PAGE=1,DEFAULT_DISTANCE=50,DEFAULT_TOOLBAR_COLLAPSE_COUNT=3,DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE="session",DEFAULT_ROW_KEY="id",InternalPRSL=memo(forwardRef(function(e){var r=e.className,r=void 0===r?"":r,F=e.style,t=e.innerClassName,o=void 0===t?"":t,n=e.innerStyle,t=e.isLoading,t=void 0===t||t,a=e.isUseFirstLoading,a=void 0===a||a,l=e.firstLoading,i=e.pullToRefreshProps,O=e.onRefreshBefore,s=e.paging,c=e.onRefresh,u=e.rowKey,d=e.showKeyWordSearchBar,k=void 0===d||d,I=e.searchKeyWordBarProps,d=e.searchKeyWordWrapperClassName,U=void 0===d?"":d,x=e.searchKeyWordWrapperStyle,D=e.searchKeyWordMode,G=e.searchKeyWordHistoryMaxSize,z=e.isSearchKeyWordHistoryIntoStore,Y=e.searchKeyWordHistoryStoreType,f=e.defaultSearchKeyWord,d=e.showToolBar,H=void 0===d||d,d=e.showTotal,j=e.renderToolBar,Z=e.afterToolBarRender,q=e.beforeToolBarRender,J=e.beforeToolBarRenderClassName,J=void 0===J?"":J,Q=e.beforeToolBarRenderStyle,X=e.afterToolBarRenderClassName,X=void 0===X?"":X,$=e.afterToolBarRenderStyle,m=e.toolbarWrapperClassName,m=void 0===m?"":m,ee=e.toolbarWrapperStyle,re=e.toolbarCollapseCount,re=void 0===re?DEFAULT_TOOLBAR_COLLAPSE_COUNT:re,te=e.toolbarConfig,g=e.scrollLoadProps,oe=e.onLoadMore,ne=e.loadMoreLoading,p=e.showBackTopAnimation,ae=void 0===p||p,le=e.backTopAnimationProps,ie=e.scrollLoadBeforeRender,se=e.scrollLoadAfterRender,p=e.scrollLoadBeforeRenderClassName,ce=void 0===p?"":p,ue=e.scrollLoadBeforeRenderStyle,p=e.scrollLoadAfterRenderClassName,de=void 0===p?"":p,fe=e.scrollLoadAfterRenderStyle,me=e.beforeRender,ge=e.afterRender,p=e.beforeRenderClassName,pe=void 0===p?"":p,Se=e.beforeRenderStyle,p=e.afterRenderClassName,_e=void 0===p?"":p,Re=e.afterRenderStyle,p=e.isShowFilterTrigger,ye=e.renderFilterTrigger,ve=e.isShowSortTrigger,he=e.renderSortTrigger,Te=e.isShowViewSettingTrigger,Ee=e.renderViewSettingTrigger,Pe=e.viewSettingTriggerMode,Le=e.viewSettingTriggerProps,Ae=e.renderViewSetting,be=e.viewSettingConfig,Ce=e.defaultViewSettingValue,Ne=e.onViewSetting,Me=e.onViewSettingReset,we=e.loadData,Ke=e.renderEmpty,Ve=e.renderOffLine,We=e.filterTriggerMode,Be=e.filterTriggerProps,Fe=e.renderFilter,Oe=e.filterFormProps,ke=e.filterConfig,S=e.defaultFilterValues,Ie=e.sortTriggerMode,Ue=e.sortTriggerProps,xe=e.renderSort,De=e.sortConfig,_=e.defaultSortValues,Ge=e.isUseLocal,ze=e.selectedRowKeys,Ye=e.selectionMultiple,He=e.onSelectChange,R=e.children,e=useNetwork(),je=useUpdate(),y=useState({data:[],total:0}),v=y[0],Ze=y[1],y=useState("normal"),h=y[0],qe=y[1],Je=useMemo(function(){return null!=u?u:DEFAULT_ROW_KEY},[u]),y=useSelection({selectedRowKeys:ze,selectionMultiple:Ye,mode:h,dataSource:v.data,rowKey:Je}),Qe=y.optionSelectedRowKeys,T=y.isUseSelectionMode,Xe=y.isSelectionMultiple,$e=y.finish,er=y.cancel,ze=y.selectionChange,Ye=y.selectionAllChange,h=useImmer({searchKeyWord:null!=f?f:"",filterValues:null!=S?S:{},sortValues:null!=_?_:[]}),E=h[0],P=h[1],y=useRef(!0),h=useRef(!1),L=useRef({page:void 0!==s&&"object"===_typeof(s)&&null!=(M=s.page)?M:DEFAULT_PAGING_PAGE,pageSize:void 0!==s&&"object"===_typeof(s)&&null!=(M=s.defaultPageSize)?M:DEFAULT_PAGING_SIZE}),A=useMemo(function(){return"boolean"!=typeof s||s},[s]),b=useRef(),rr=useRef(void 0),C=useRef(null),N=useRef(ScrollLoad.NORMAL),M=useCallback(function(){var e;return null!=(e=null==l?void 0:l())?e:ar},[l]),tr=useCallback(function(){var e;return null!=(e=null==ne?void 0:ne())?e:lr},[ne]),w=useMemo(function(){return"boolean"!=typeof Ge||Ge},[Ge]),K=useMemo(function(){var e,r=E.searchKeyWord,t=void 0===r?"":r,r=E.filterValues,o=void 0===r?{}:r,r=E.sortValues,r=void 0===r?[]:r,n=null!=(n=v.data)?n:[];return(null!=r?r:[]).length&&(n=r.reduce(function(e,r){var t=r.order,o=r.name;return e=e.sort(function(e,r){return"asc"===t?e[o]>r[o]?1:e[o]<r[o]?-1:0:e[o]<r[o]?1:e[o]>r[o]?-1:0}),__spreadArray([],e,!0)},null!=(e=v.data)?e:[])),n=!t&&isPrimaryEmpty(o)&&!r.length?n:n.filter(function(r){return t?Object.keys(r).some(function(e){return-1!==r[e].indexOf(t)}):!!isPrimaryEmpty(o)||Object.keys(o).filter(function(e){return!!o[e]}).every(function(e){return-1!==r[e].indexOf(o[e])})})},[E,v]),V=useMemo(function(){var e,r;return w?(r=K,A&&(e=(L.current.page-1)*L.current.pageSize,r=K.slice(e,L.current.page*L.current.pageSize),1!==L.current.page)&&(r=__spreadArray(__spreadArray([],K.slice(0,e),!0),r,!0)),{total:K.length,data:r}):v},[v,K,w,A,L.current.page,L.current.pageSize]),or=useCallback(function(){return!V.data.length},[V.data]),nr=useMemo(function(){var e;return(null!=(e=null==V?void 0:V.total)?e:0)/L.current.pageSize},[L.current.pageSize,V.total]),ar=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-first-loading")},React.createElement(_Skeleton.Title,{animated:!0}),React.createElement(_Skeleton.Paragraph,{lineCount:25,animated:!0}))},[]),lr=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading")},React.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading-dot")},React.createElement(_DotLoading,{color:"primary"})),React.createElement("div",null,"".concat(Intl.v("数据加载中")),"..."))},[]),ir=useMemo(function(){var e;return null!=(e=null==Ve?void 0:Ve())?e:React.createElement(_ErrorBlock,{status:"disconnected"},React.createElement(_Button,{color:"primary",onClick:function(){je()}},Intl.v("点击重试")))},[Ve]),sr=useMemo(function(){var e;return React.createElement(SearchKeyWord,{className:null!=U?U:"",style:null!=x?x:{},searchKeyWordBarProps:I,searchKeyWordMode:null!=D?D:"normal",searchKeyWordHistoryMaxSize:null!=G?G:DEFAULT_DISTANCE,isSearchKeyWordHistoryIntoStore:null==z||z,searchKeyWordHistoryStoreType:null!=Y?Y:DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE,disabled:T,defaultSearchKeyWord:null!=(e=E.searchKeyWord)?e:"",onSearch:yr,onSearchClear:vr})},[U,x,I,D,G,E.searchKeyWord,T]),cr=React.createElement(ToolBar,{className:m,style:ee,showTotal:d,renderToolBar:j,afterToolBarRender:Z,beforeToolBarRender:q,beforeToolBarRenderClassName:J,beforeToolBarRenderStyle:Q,afterToolBarRenderClassName:X,afterToolBarRenderStyle:$,isShowFilterTrigger:p,renderFilterTrigger:ye,isShowSortTrigger:ve,renderSortTrigger:he,isShowViewSettingTrigger:Te,renderViewSettingTrigger:Ee,viewSettingTriggerMode:Pe,viewSettingTriggerProps:Le,renderViewSetting:Ae,viewSettingConfig:be,defaultViewSettingValue:Ce,onViewSetting:Ne,onViewSettingReset:Me,toolbarCollapseCount:re,toolbarConfig:te,total:null!=(m=null==V?void 0:V.total)?m:0,filterTriggerMode:We,filterTriggerProps:Be,renderFilter:Fe,filterFormProps:Oe,filterConfig:ke,defaultFilterValues:E.filterValues,onFilter:function(r){if(B(),P(function(e){e.filterValues=r}),w)return Promise.resolve();return W(__assign(__assign({},E),{filterValues:r}))},onFilterReset:function(){if(B(),P(function(e){e.filterValues={}}),w)return Promise.resolve();return W(__assign(__assign({},E),{filterValues:{}}))},sortTriggerMode:Ie,sortTriggerProps:Ue,renderSort:xe,sortConfig:De,defaultSortValues:E.sortValues,disabled:T,onSort:function(r){if(B(),P(function(e){e.sortValues=r}),w)return Promise.resolve();return W(__assign(__assign({},E),{sortValues:r}))},onSortReset:function(){if(B(),P(function(e){e.sortValues=[]}),w)return Promise.resolve();return W(__assign(__assign({},E),{sortValues:[]}))}}),ur=useMemo(function(){var e=null==me?void 0:me();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner-before"),null!=pe?pe:""),style:null!=Se?Se:{}},e)},[me,pe,Se]),dr=useMemo(function(){var e=null==ge?void 0:ge();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner-after"),null!=_e?_e:""),style:null!=Re?Re:{}},e)},[ge,_e,Re]),fr=useMemo(function(){var e=null==ie?void 0:ie();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll-before"),null!=ce?ce:""),style:null!=ue?ue:{}},e)},[ie,ce,ue]),mr=useMemo(function(){var e=null==se?void 0:se();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll-after"),null!=de?de:""),style:null!=fe?fe:{}},e)},[se,de,fe]),gr=useMemo(function(){var e;return React.createElement(ScrollLoad,__assign({ref:b,renderLoading:tr,distance:(null==g?void 0:g.distance)||50,onScrollBottom:Er},g||{},{disabled:T,className:classNames("".concat(selectorPrefix,"-scroll-load"),null!=(e=null==g?void 0:g.className)?e:"")}),(e=null==R?void 0:R(V.data),!T||Xe?e:React.createElement(_Radio.Group,null,e)))},[tr,g,R,T,V.data]),pr=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-scroll"),ref:rr},null==R?void 0:R(V.data))},[R,V.data]),Sr=useMemo(function(){return React.createElement(BackTopAnimation,__assign({},null!=le?le:{},{getContainer:hr,onTrigger:function(){return Promise.resolve()}}))},[le]),_r=useMemo(function(){var e;return React.createElement(_PullToRefresh,__assign({},null!=i?i:{},{onRefresh:Tr,disabled:T}),fr,or()&&(null!=(e=null==Ke?void 0:Ke())?e:React.createElement(_ErrorBlock,{status:"empty"})),!or()&&A&&gr,!or()&&!A&&pr,mr,ae&&Sr)},[s,i,fr,mr,gr,pr,ae,Sr,T,Ke,A]),ee=useCallback(function(){return React.createElement(React.Fragment,null,React.createElement("div",{className:"".concat(selectorPrefix,"-header")},React.createElement("div",{className:"".concat(selectorPrefix,"-header-main")},k&&sr),React.createElement("div",{className:"".concat(selectorPrefix,"-header-extra")},React.createElement(SelectionManageButton,{isUseSelectionMode:T,onChange:function(e){qe(e?"selection":"normal")},onFinish:function(){var e=$e(),r=e.selectedRows,t=e.selectedRowKeys,o=e.changeRowKeys,e=e.info;null!=He&&He(t,r,o,e)},onCancel:er}))),H&&cr,React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner"),null!=o?o:""),style:null!=n?n:{}},ur,_r,dr),T&&Xe&&React.createElement(SelectionCheckAllManage,null))},[k,sr,H,cr,o,n,ur,_r,dr,T]);function W(e){return we?we(__assign(__assign({},L.current),e)).then(function(e){return Ze(e),e}):Promise.resolve()}function B(){var e,r,t=null===hr?void 0:hr();t&&(t.scrollTop=0),null!=(e=null==(t=null==b?void 0:b.current)?void 0:t.hideAll)&&e.call(t),C.current=null,N.current=ScrollLoad.NORMAL,L.current.page=void 0!==s&&"object"===_typeof(s)&&null!=(r=s.page)?r:DEFAULT_PAGING_PAGE,L.current.pageSize=void 0!==s&&"object"===_typeof(s)&&null!=(r=s.defaultPageSize)?r:DEFAULT_PAGING_SIZE}function Rr(){B(),P(function(e){e.searchKeyWord=f,e.filterValues=S,e.sortValues=_})}function yr(r){B(),P(function(e){e.searchKeyWord=r}),w||W(__assign(__assign({},E),{searchKeyWord:r}))}function vr(){B(),P(function(e){e.searchKeyWord=""}),w||W(__assign(__assign({},E),{searchKeyWord:""}))}function hr(){var e;return null!=(e=null!=(e=null==(e=b.current)?void 0:e.getScrollContainer())?e:rr.current)?e:document.body}function Tr(){var e={searchKeyWord:f,filterValues:S,sortValues:_},r=O?O(__assign(__assign({},L.current),e)):Promise.resolve();return c?r.then(function(){return Rr(),w||null==c?void 0:c(__assign(__assign({},L.current),e)).then(function(e){Ze(e)})}):Promise.resolve(v)}function Er(e){if(N.current===ScrollLoad.EMPTY)N.current=ScrollLoad.EMPTY,e(ScrollLoad.EMPTY);else{if(C.current=e,!w)return null==oe?void 0:oe(__assign({page:L.current.page+1,pageSize:L.current.pageSize},E)).then(function(r){L.current.page+=1,Ze(function(e){return e.total=r.total,e.data=__spreadArray(__spreadArray([],e.data,!0),r.data,!0),__assign({},e)})});L.current.page+=1,je()}}return useMount(function(){W({searchKeyWord:f,filterValues:S,sortValues:_})}),useUpdateEffect(function(){C.current&&(N.current=L.current.page<nr?ScrollLoad.NORMAL:ScrollLoad.EMPTY,C.current(N.current))},[v.data,nr,L.current.page]),useUpdateEffect(function(){Rr(),W({searchKeyWord:f,filterValues:S,sortValues:_})},[f,_,S,w]),React.createElement(Context.Provider,{value:{isUseSelectionMode:function(){return T},getRowKey:function(){return Je},getOptionSelectedRowKeys:function(){return null!=Qe?Qe:[]},selectionChange:ze,selectionAllChange:Ye,getDatasourceLength:function(){return v.data.length},getSelectionMultiple:function(){return Xe}}},React.createElement("div",{className:classNames(selectorPrefix,null!=r?r:""),style:null!=F?F:{}},e.online&&(a&&(y.current&&!h.current&&t&&(h.current=!0),y.current&&h.current&&!t&&(y.current=!1,h.current=!1),y.current)?M:ee)(),!e.online&&ir))})),PRSL=InternalPRSL;PRSL.displayName="PRSL",PRSL.Item=PRSLItem;export default PRSL;
//# sourceMappingURL=PRSL.js.map
