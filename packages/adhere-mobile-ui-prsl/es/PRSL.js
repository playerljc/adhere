import _Radio from"antd-mobile/es/components/radio";import _PullToRefresh from"antd-mobile/es/components/pull-to-refresh";import _Button from"antd-mobile/es/components/button";import _ErrorBlock from"antd-mobile/es/components/error-block";import _DotLoading from"antd-mobile/es/components/dot-loading";import _Skeleton from"antd-mobile/es/components/skeleton";import _typeof from"@babel/runtime/helpers/typeof";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var r,t=1,o=arguments.length;t<o;t++)for(var n in r=arguments[t])Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n]);return e}).apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(e,r,t){if(t||2===arguments.length)for(var o,n=0,a=r.length;n<a;n++)!o&&n in r||((o=o||Array.prototype.slice.call(r,0,n))[n]=r[n]);return e.concat(o||Array.prototype.slice.call(r))};import{useMount,useNetwork,useUpdate,useUpdateEffect}from"ahooks";import classNames from"classnames";import isPrimaryEmpty from"lodash.isempty";import React,{forwardRef,memo,useCallback,useMemo,useRef,useState}from"react";import{useImmer}from"use-immer";import BackTopAnimation from"@baifendian/adhere-ui-backtopanimation";import ScrollLoad from"@baifendian/adhere-ui-scrollload";import Intl from"@baifendian/adhere-util-intl";import Context from"./Context";import{DNDManageButton,SortableContainer,useDND}from"./DND";import PRSLItem from"./PRSLItem";import SearchKeyWord from"./SearchKeyWord";import{SelectionCheckAllManage,SelectionManageButton,useSelection}from"./Selection";import ToolBar from"./Toolbar";var selectorPrefix="adhere-mobile-ui-prsl",DEFAULT_PAGING_SIZE=30,DEFAULT_PAGING_PAGE=1,DEFAULT_DISTANCE=50,DEFAULT_TOOLBAR_COLLAPSE_COUNT=3,DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE="session",DEFAULT_ROW_KEY="id",DEFAULT_MODE="normal",DEFAULT_SEARCH_KEY_WORD_MODE="normal",InternalPRSL=memo(forwardRef(function(e){var r=e.className,r=void 0===r?"":r,W=e.style,t=e.innerClassName,U=void 0===t?"":t,F=e.innerStyle,t=e.isLoading,t=void 0===t||t,O=e.isUseFirstLoading,O=void 0===O||O,I=e.firstLoading,k=e.pullToRefreshProps,x=e.onRefreshBefore,o=e.paging,G=e.onRefresh,H=e.rowKey,n=e.showKeyWordSearchBar,Y=void 0===n||n,z=e.searchKeyWordBarProps,n=e.searchKeyWordWrapperClassName,j=void 0===n?"":n,Z=e.searchKeyWordWrapperStyle,q=e.searchKeyWordMode,J=e.searchKeyWordHistoryMaxSize,Q=e.isSearchKeyWordHistoryIntoStore,X=e.searchKeyWordHistoryStoreType,a=e.defaultSearchKeyWord,n=e.showToolBar,$=void 0===n||n,n=e.showTotal,ee=e.renderToolBar,re=e.afterToolBarRender,te=e.beforeToolBarRender,oe=e.beforeToolBarRenderClassName,oe=void 0===oe?"":oe,ne=e.beforeToolBarRenderStyle,ae=e.afterToolBarRenderClassName,ae=void 0===ae?"":ae,le=e.afterToolBarRenderStyle,l=e.toolbarWrapperClassName,l=void 0===l?"":l,ie=e.toolbarWrapperStyle,se=e.toolbarCollapseCount,se=void 0===se?DEFAULT_TOOLBAR_COLLAPSE_COUNT:se,ce=e.toolbarConfig,i=e.scrollLoadProps,ue=e.onLoadMore,de=e.loadMoreLoading,s=e.showBackTopAnimation,fe=void 0===s||s,me=e.backTopAnimationProps,ge=e.scrollLoadBeforeRender,pe=e.scrollLoadAfterRender,s=e.scrollLoadBeforeRenderClassName,Se=void 0===s?"":s,_e=e.scrollLoadBeforeRenderStyle,s=e.scrollLoadAfterRenderClassName,Re=void 0===s?"":s,ye=e.scrollLoadAfterRenderStyle,ve=e.beforeRender,he=e.afterRender,s=e.beforeRenderClassName,Ee=void 0===s?"":s,Te=e.beforeRenderStyle,s=e.afterRenderClassName,Pe=void 0===s?"":s,Ne=e.afterRenderStyle,s=e.isShowFilterTrigger,Le=e.renderFilterTrigger,Me=e.isShowSortTrigger,Ae=e.renderSortTrigger,Ce=e.isShowViewSettingTrigger,be=e.renderViewSettingTrigger,De=e.viewSettingTriggerMode,Ke=e.viewSettingTriggerProps,we=e.renderViewSetting,Be=e.viewSettingConfig,Ve=e.defaultViewSettingValue,We=e.onViewSetting,Ue=e.onViewSettingReset,Fe=e.loadData,Oe=e.renderEmpty,Ie=e.renderOffLine,ke=e.filterTriggerMode,xe=e.filterTriggerProps,Ge=e.renderFilter,He=e.filterFormProps,Ye=e.filterConfig,c=e.defaultFilterValues,ze=e.sortTriggerMode,je=e.sortTriggerProps,Ze=e.renderSort,qe=e.sortConfig,u=e.defaultSortValues,Je=e.isUseLocal,Qe=(e.isUseSelection,e.selectedRowKeys),Xe=e.selectionMultiple,$e=e.onSelectChange,er=(e.isUseDND,e.dndDragHandle,e.onDNDChange),d=e.children,e=useNetwork(),rr=useUpdate(),f=useState({data:[],total:0}),m=f[0],g=f[1],f=useState(DEFAULT_MODE),p=f[0],tr=f[1],S=useMemo(function(){return"normal"===p},[p]),_=useMemo(function(){return null!=H?H:DEFAULT_ROW_KEY},[H]),f=useSelection({selectedRowKeys:Qe,selectionMultiple:Xe,mode:p,dataSource:m.data,rowKey:_}),or=f.optionSelectedRowKeys,R=f.isUseSelectionMode,y=f.isSelectionMultiple,nr=f.finish,ar=f.cancel,Qe=f.selectionChange,Xe=f.selectionAllChange,f=useDND({mode:p,dataSource:m.data,rowKey:_,reset:function(){g(__assign({},m))}}),v=f.optionDataSource,h=f.isUseDNDMode,lr=f.finish,ir=f.cancel,sr=f.move,f=useImmer({searchKeyWord:null!=a?a:"",filterValues:null!=c?c:{},sortValues:null!=u?u:[]}),E=f[0],T=f[1],f=useRef(!0),P=useRef(!1),N=useRef({page:void 0!==o&&"object"===_typeof(o)&&null!=(b=o.page)?b:DEFAULT_PAGING_PAGE,pageSize:void 0!==o&&"object"===_typeof(o)&&null!=(b=o.defaultPageSize)?b:DEFAULT_PAGING_SIZE}),L=useMemo(function(){return"boolean"!=typeof o||o},[o]),M=useRef(),cr=useRef(void 0),A=useRef(null),C=useRef(ScrollLoad.NORMAL),b=useCallback(function(){var e;return null!=(e=null==I?void 0:I())?e:mr},[I]),ur=useCallback(function(){var e;return null!=(e=null==de?void 0:de())?e:gr},[de]),D=useMemo(function(){return"boolean"!=typeof Je||Je},[Je]),K=useMemo(function(){var e,r=E.searchKeyWord,t=void 0===r?"":r,r=E.filterValues,o=void 0===r?{}:r,r=E.sortValues,r=void 0===r?[]:r,n=null!=(n=m.data)?n:[];return h&&(n=v.data),(null!=r?r:[]).length&&(n=r.reduce(function(e,r){var t=r.order,o=r.name;return e=e.sort(function(e,r){return"asc"===t?e[o]>r[o]?1:e[o]<r[o]?-1:0:e[o]<r[o]?1:e[o]>r[o]?-1:0}),__spreadArray([],e,!0)},null!=(e=m.data)?e:[])),n=!t&&isPrimaryEmpty(o)&&!r.length?n:n.filter(function(r){return t?Object.keys(r).some(function(e){return-1!==r[e].indexOf(t)}):!!isPrimaryEmpty(o)||Object.keys(o).filter(function(e){return!!o[e]}).every(function(e){return-1!==r[e].indexOf(o[e])})})},[E,m,h,v]),w=useMemo(function(){var e,r;return D?(r=K,L&&(e=(N.current.page-1)*N.current.pageSize,r=K.slice(e,N.current.page*N.current.pageSize),1!==N.current.page)&&(r=__spreadArray(__spreadArray([],K.slice(0,e),!0),r,!0)),{total:K.length,data:r}):h?v:m},[m,K,v,h,D,L,N.current.page,N.current.pageSize]),dr=useCallback(function(){return!w.data.length},[w.data]),fr=useMemo(function(){var e;return(null!=(e=null==w?void 0:w.total)?e:0)/N.current.pageSize},[N.current.pageSize,w.total]),mr=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-first-loading")},React.createElement(_Skeleton.Title,{animated:!0}),React.createElement(_Skeleton.Paragraph,{lineCount:25,animated:!0}))},[]),gr=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading")},React.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading-dot")},React.createElement(_DotLoading,{color:"primary"})),React.createElement("div",null,"".concat(Intl.v("数据加载中")),"..."))},[]),pr=useMemo(function(){var e;return null!=(e=null==Ie?void 0:Ie())?e:React.createElement(_ErrorBlock,{status:"disconnected"},React.createElement(_Button,{color:"primary",onClick:function(){rr()}},Intl.v("点击重试")))},[Ie]),Sr=useMemo(function(){var e;return React.createElement(SearchKeyWord,{className:null!=j?j:"",style:null!=Z?Z:{},searchKeyWordBarProps:z,searchKeyWordMode:null!=q?q:DEFAULT_SEARCH_KEY_WORD_MODE,searchKeyWordHistoryMaxSize:null!=J?J:DEFAULT_DISTANCE,isSearchKeyWordHistoryIntoStore:null==Q||Q,searchKeyWordHistoryStoreType:null!=X?X:DEFAULT_SEARCH_KEY_WORD_HISTORY_STORE_TYPE,disabled:!S,defaultSearchKeyWord:null!=(e=E.searchKeyWord)?e:"",onSearch:Ar,onSearchClear:Cr})},[j,Z,z,q,J,E.searchKeyWord,S]),_r=React.createElement(ToolBar,{className:l,style:ie,showTotal:n,renderToolBar:ee,afterToolBarRender:re,beforeToolBarRender:te,beforeToolBarRenderClassName:oe,beforeToolBarRenderStyle:ne,afterToolBarRenderClassName:ae,afterToolBarRenderStyle:le,isShowFilterTrigger:s,renderFilterTrigger:Le,isShowSortTrigger:Me,renderSortTrigger:Ae,isShowViewSettingTrigger:Ce,renderViewSettingTrigger:be,viewSettingTriggerMode:De,viewSettingTriggerProps:Ke,renderViewSetting:we,viewSettingConfig:Be,defaultViewSettingValue:Ve,onViewSetting:We,onViewSettingReset:Ue,toolbarCollapseCount:se,toolbarConfig:ce,total:null!=(l=null==w?void 0:w.total)?l:0,filterTriggerMode:ke,filterTriggerProps:xe,renderFilter:Ge,filterFormProps:He,filterConfig:Ye,defaultFilterValues:E.filterValues,onFilter:function(r){if(V(),T(function(e){e.filterValues=r}),D)return Promise.resolve();return B(__assign(__assign({},E),{filterValues:r}))},onFilterReset:function(){if(V(),T(function(e){e.filterValues={}}),D)return Promise.resolve();return B(__assign(__assign({},E),{filterValues:{}}))},sortTriggerMode:ze,sortTriggerProps:je,renderSort:Ze,sortConfig:qe,defaultSortValues:E.sortValues,disabled:!S,onSort:function(r){if(V(),T(function(e){e.sortValues=r}),D)return Promise.resolve();return B(__assign(__assign({},E),{sortValues:r}))},onSortReset:function(){if(V(),T(function(e){e.sortValues=[]}),D)return Promise.resolve();return B(__assign(__assign({},E),{sortValues:[]}))}}),Rr=useMemo(function(){var e=null==ve?void 0:ve();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner-before"),null!=Ee?Ee:""),style:null!=Te?Te:{}},e)},[ve,Ee,Te]),yr=useMemo(function(){var e=null==he?void 0:he();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner-after"),null!=Pe?Pe:""),style:null!=Ne?Ne:{}},e)},[he,Pe,Ne]),vr=useMemo(function(){var e=null==ge?void 0:ge();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll-before"),null!=Se?Se:""),style:null!=_e?_e:{}},e)},[ge,Se,_e]),hr=useMemo(function(){var e=null==pe?void 0:pe();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll-after"),null!=Re?Re:""),style:null!=ye?ye:{}},e)},[pe,Re,ye]),Er=useMemo(function(){var e;return React.createElement(ScrollLoad,__assign({ref:M,renderLoading:ur,distance:(null==i?void 0:i.distance)||50,onScrollBottom:Kr},i||{},{disabled:!S,className:classNames("".concat(selectorPrefix,"-scroll-load"),null!=(e=null==i?void 0:i.className)?e:"")}),function(){var e=null==d?void 0:d(w.data);if(R&&!y)return function(e){return!R||y?e:React.createElement(_Radio.Group,null,e)}(e);if(h)return React.createElement(SortableContainer,{onSortEnd:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];sr.apply(void 0,e)},useDragHandle:!0},e);return e}())},[h,R,y,S,w.data,ur,i,d]),Tr=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-scroll"),ref:cr},null==d?void 0:d(w.data))},[d,w.data]),Pr=useMemo(function(){return React.createElement(BackTopAnimation,__assign({},null!=me?me:{},{getContainer:br,onTrigger:function(){return Promise.resolve()}}))},[me]),Nr=useMemo(function(){var e;return React.createElement(_PullToRefresh,__assign({},null!=k?k:{},{onRefresh:Dr,disabled:!S}),vr,dr()&&(null!=(e=null==Oe?void 0:Oe())?e:React.createElement(_ErrorBlock,{status:"empty"})),!dr()&&L&&Er,!dr()&&!L&&Tr,hr,fe&&Pr)},[o,k,vr,hr,Er,Tr,fe,Pr,S,Oe,L]),ie=useCallback(function(){return React.createElement(React.Fragment,null,React.createElement("div",{className:"".concat(selectorPrefix,"-header")},React.createElement("div",{className:"".concat(selectorPrefix,"-header-main")},Y&&Sr),React.createElement("div",{className:"".concat(selectorPrefix,"-header-extra")},React.createElement(DNDManageButton,{isUseDNDMode:h,isUseNormalMode:S,onChange:function(e){e?tr("dnd"):Lr()},onFinish:function(){g(v);var e=lr();null!=er&&er(e)},onCancel:ir}),React.createElement(SelectionManageButton,{isUseSelectionMode:R,isUseNormalMode:S,onChange:function(e){e?tr("selection"):Lr()},onFinish:function(){var e=nr(),r=e.selectedRows,t=e.selectedRowKeys,o=e.changeRowKeys,e=e.info;null!=$e&&$e(t,r,o,e)},onCancel:ar}))),$&&_r,React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner"),null!=U?U:""),style:null!=F?F:{}},Rr,Nr,yr),R&&y&&React.createElement(SelectionCheckAllManage,null))},[Y,Sr,$,_r,U,F,Rr,Nr,yr,R,y,S,h]);function Lr(){tr("normal")}function B(e){return Fe?Fe(__assign(__assign({},N.current),e)).then(function(e){return g(e),e}):Promise.resolve()}function V(){var e,r,t=null===br?void 0:br();t&&(t.scrollTop=0),null!=(e=null==(t=null==M?void 0:M.current)?void 0:t.hideAll)&&e.call(t),A.current=null,C.current=ScrollLoad.NORMAL,N.current.page=void 0!==o&&"object"===_typeof(o)&&null!=(r=o.page)?r:DEFAULT_PAGING_PAGE,N.current.pageSize=void 0!==o&&"object"===_typeof(o)&&null!=(r=o.defaultPageSize)?r:DEFAULT_PAGING_SIZE}function Mr(){V(),T(function(e){e.searchKeyWord=a,e.filterValues=c,e.sortValues=u})}function Ar(r){V(),T(function(e){e.searchKeyWord=r}),D||B(__assign(__assign({},E),{searchKeyWord:r}))}function Cr(){V(),T(function(e){e.searchKeyWord=""}),D||B(__assign(__assign({},E),{searchKeyWord:""}))}function br(){var e;return null!=(e=null!=(e=null==(e=M.current)?void 0:e.getScrollContainer())?e:cr.current)?e:document.body}function Dr(){var e={searchKeyWord:a,filterValues:c,sortValues:u},r=x?x(__assign(__assign({},N.current),e)):Promise.resolve();return G?r.then(function(){return Mr(),D||null==G?void 0:G(__assign(__assign({},N.current),e)).then(function(e){g(e)})}):Promise.resolve(m)}function Kr(e){if(C.current===ScrollLoad.EMPTY)C.current=ScrollLoad.EMPTY,e(ScrollLoad.EMPTY);else{if(A.current=e,!D)return null==ue?void 0:ue(__assign({page:N.current.page+1,pageSize:N.current.pageSize},E)).then(function(r){N.current.page+=1,g(function(e){return e.total=r.total,e.data=__spreadArray(__spreadArray([],e.data,!0),r.data,!0),__assign({},e)})});N.current.page+=1,rr()}}return useMount(function(){B({searchKeyWord:a,filterValues:c,sortValues:u})}),useUpdateEffect(function(){A.current&&(C.current=N.current.page<fr?ScrollLoad.NORMAL:ScrollLoad.EMPTY,A.current(C.current))},[m.data,fr,N.current.page]),useUpdateEffect(function(){Mr(),B({searchKeyWord:a,filterValues:c,sortValues:u})},[a,u,c,D]),React.createElement(Context.Provider,{value:{isUseSelectionMode:function(){return R},isUseDNDMode:function(){return h},isUseNormalMode:function(){return S},getRowKey:function(){return _},getOptionSelectedRowKeys:function(){return null!=or?or:[]},selectionChange:Qe,selectionAllChange:Xe,getDatasourceLength:function(){return m.data.length},getSelectionMultiple:function(){return y},getIndexByIdFormOptionDataSource:function(r){return v.data.findIndex(function(e){return e[_]===r})}}},React.createElement("div",{className:classNames(selectorPrefix,null!=r?r:""),style:null!=W?W:{}},e.online&&(O&&(f.current&&!P.current&&t&&(P.current=!0),f.current&&P.current&&!t&&(f.current=!1,P.current=!1),f.current)?b:ie)(),!e.online&&pr))})),PRSL=InternalPRSL;PRSL.displayName="PRSL",PRSL.Item=PRSLItem;export default PRSL;
//# sourceMappingURL=PRSL.js.map
