import _PullToRefresh from"antd-mobile/es/components/pull-to-refresh";import _ErrorBlock from"antd-mobile/es/components/error-block";import _DotLoading from"antd-mobile/es/components/dot-loading";import _Skeleton from"antd-mobile/es/components/skeleton";import _typeof from"@babel/runtime/helpers/typeof";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var r,o=1,t=arguments.length;o<t;o++)for(var a in r=arguments[o])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e}).apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(e,r,o){if(o||2===arguments.length)for(var t,a=0,n=r.length;a<n;a++)!t&&a in r||((t=t||Array.prototype.slice.call(r,0,a))[a]=r[a]);return e.concat(t||Array.prototype.slice.call(r))};import{useMount,useNetwork,useUpdate,useUpdateEffect}from"ahooks";import classNames from"classnames";import isPrimaryEmpty from"lodash.isempty";import React,{forwardRef,memo,useCallback,useMemo,useRef,useState}from"react";import{useImmer}from"use-immer";import BackTopAnimation from"@baifendian/adhere-ui-backtopanimation";import ScrollLoad from"@baifendian/adhere-ui-scrollload";import Intl from"@baifendian/adhere-util-intl";import SearchKeyWord from"./SearchKeyWord";import ToolBar from"./Toolbar";var selectorPrefix="adhere-mobile-ui-prsl",DEFAULT_PAGING_SIZE=30,DEFAULT_PAGING_PAGE=1,DEFAULT_DISTANCE=50,DEFAULT_TOOLBAR_COLLAPSE_COUNT=3,PRSL=memo(forwardRef(function(e){var r=e.className,r=void 0===r?"":r,o=e.style,o=void 0===o?{}:o,t=e.innerClassName,a=void 0===t?"":t,t=e.innerStyle,n=void 0===t?{}:t,t=e.isLoading,t=void 0===t||t,l=e.isUseFirstLoading,l=void 0===l||l,s=e.firstLoading,i=e.pullToRefreshProps,c=void 0===i?{}:i,k=e.onRefreshBefore,u=e.paging,d=e.onRefresh,i=e.showKeyWordSearchBar,w=void 0===i||i,U=e.searchKeyWordBarProps,i=e.searchKeyWordWrapperClassName,f=void 0===i?"":i,i=e.searchKeyWordWrapperStyle,m=void 0===i?{}:i,g=e.searchKeyWordMode,i=e.searchKeyWordHistoryMaxSize,O=void 0===i?DEFAULT_DISTANCE:i,p=e.defaultSearchKeyWord,i=e.showToolBar,D=void 0===i||i,i=e.showTotal,x=e.renderToolBar,I=e.afterToolBarRender,G=e.beforeToolBarRender,z=e.beforeToolBarRenderClassName,z=void 0===z?"":z,j=e.beforeToolBarRenderStyle,j=void 0===j?{}:j,Y=e.afterToolBarRenderClassName,Y=void 0===Y?"":Y,Z=e.afterToolBarRenderStyle,Z=void 0===Z?{}:Z,_=e.toolbarWrapperClassName,_=void 0===_?"":_,v=e.toolbarWrapperStyle,v=void 0===v?{}:v,H=e.toolbarCollapseCount,H=void 0===H?DEFAULT_TOOLBAR_COLLAPSE_COUNT:H,q=e.toolbarConfig,y=e.scrollLoadProps,J=e.onLoadMore,Q=e.loadMoreLoading,S=e.showBackTopAnimation,X=void 0===S||S,$=e.backTopAnimationProps,ee=e.scrollLoadBeforeRender,re=e.scrollLoadAfterRender,S=e.scrollLoadBeforeRenderClassName,oe=void 0===S?"":S,S=e.scrollLoadBeforeRenderStyle,te=void 0===S?{}:S,S=e.scrollLoadAfterRenderClassName,ae=void 0===S?"":S,S=e.scrollLoadAfterRenderStyle,ne=void 0===S?{}:S,le=e.beforeRender,se=e.afterRender,S=e.beforeRenderClassName,ie=void 0===S?"":S,S=e.beforeRenderStyle,ce=void 0===S?{}:S,S=e.afterRenderClassName,ue=void 0===S?"":S,S=e.afterRenderStyle,de=void 0===S?{}:S,S=e.isShowFilterTrigger,fe=e.renderFilterTrigger,me=e.isShowSortTrigger,ge=e.renderSortTrigger,pe=e.isShowViewSettingTrigger,_e=e.renderViewSettingTrigger,ve=e.loadData,ye=e.renderEmpty,Se=(e.renderOffLine,e.filterTriggerMode),Re=e.filterTriggerProps,he=e.renderFilter,Te=e.filterFormProps,Pe=e.filterConfig,R=e.defaultFilterValues,Ee=e.sortTriggerMode,Le=e.sortTriggerProps,Ne=e.renderSort,Ae=e.sortConfig,h=e.defaultSortValues,be=e.isUseLocal,Ce=e.children,Me=(useNetwork(),useUpdate()),e=useState({data:[],total:0}),T=e[0],Be=e[1],e=useImmer({searchKeyWord:null!=p?p:"",filterValues:null!=R?R:{},sortValues:null!=h?h:[]}),P=e[0],E=e[1],e=useRef(!0),L=useRef(!1),N=useRef({page:void 0!==u&&"object"===_typeof(u)&&null!=(M=u.page)?M:DEFAULT_PAGING_PAGE,pageSize:void 0!==u&&"object"===_typeof(u)&&null!=(M=u.defaultPageSize)?M:DEFAULT_PAGING_SIZE}),A=useRef(),b=useRef(null),C=useRef(ScrollLoad.NORMAL),M=useCallback(function(){var e;return null!=(e=null==s?void 0:s())?e:Ke},[s]),Ve=useCallback(function(){var e;return null!=(e=null==Q?void 0:Q())?e:ke},[Q]),B=useMemo(function(){return"boolean"!=typeof be||B},[be]),V=useMemo(function(){var e=P.searchKeyWord,o=void 0===e?"":e,e=P.filterValues,t=void 0===e?{}:e,e=P.sortValues,e=void 0===e?[]:e,r=null!=(r=T.data)?r:[];return(null!=e?e:[]).length&&(r=e.reduce(function(e,r){var o=r.order,t=r.name;return e=e.sort(function(e,r){return"asc"===o?e[t]>r[t]?1:e[t]<r[t]?-1:0:e[t]<r[t]?1:e[t]>r[t]?-1:0}),__spreadArray([],e,!0)},T.data)),r=!o&&isPrimaryEmpty(t)&&!e.length?r:r.filter(function(r){return o?Object.keys(r).some(function(e){return-1!==r[e].indexOf(o)}):!!isPrimaryEmpty(t)||Object.keys(t).every(function(e){return-1!==r[e].indexOf(t[e])})})},[P,T]),W=useMemo(function(){var e,r;return B?(e=(N.current.page-1)*N.current.pageSize,r=V.slice(e,N.current.page*N.current.pageSize),1!==N.current.page&&(r=__spreadArray(__spreadArray([],V.slice(0,e),!0),r,!0)),{total:V.length,data:r}):T},[T,V,B,N.current.page,N.current.pageSize]),We=useCallback(function(){return!W.data.length},[W.data]),Fe=useMemo(function(){var e;return(null!=(e=null==W?void 0:W.total)?e:0)/N.current.pageSize},[N.current.pageSize,W.total]),Ke=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-first-loading")},React.createElement(_Skeleton.Title,{animated:!0}),React.createElement(_Skeleton.Paragraph,{lineCount:25,animated:!0}))},[]),ke=useMemo(function(){return React.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading")},React.createElement("div",{className:"".concat(selectorPrefix,"-load-more-loading-dot")},React.createElement(_DotLoading,{color:"primary"})),React.createElement("div",null,"".concat(Intl.v("数据加载中")),"..."))},[]),we=useMemo(function(){var e;return React.createElement(SearchKeyWord,{className:null!=f?f:"",style:null!=m?m:{},searchKeyWordBarProps:U,searchKeyWordMode:null!=g?g:"normal",searchKeyWordHistoryMaxSize:null!=O?O:DEFAULT_DISTANCE,defaultSearchKeyWord:null!=(e=P.searchKeyWord)?e:"",onSearch:Ze,onSearchClear:He})},[f,m,U,g,O,P.searchKeyWord]),Ue=React.createElement(ToolBar,{className:_,style:v,showTotal:i,renderToolBar:x,afterToolBarRender:I,beforeToolBarRender:G,beforeToolBarRenderClassName:z,beforeToolBarRenderStyle:j,afterToolBarRenderClassName:Y,afterToolBarRenderStyle:Z,isShowFilterTrigger:S,renderFilterTrigger:fe,isShowSortTrigger:me,renderSortTrigger:ge,isShowViewSettingTrigger:pe,renderViewSettingTrigger:_e,toolbarCollapseCount:H,toolbarConfig:q,total:null!=(_=null==W?void 0:W.total)?_:0,filterTriggerMode:Se,filterTriggerProps:Re,renderFilter:he,filterFormProps:Te,filterConfig:Pe,defaultFilterValues:P.filterValues,onFilter:function(r){if(K(),E(function(e){e.filterValues=r}),B)return Promise.resolve();return F(__assign(__assign({},P),{filterValues:r}))},onFilterReset:function(){if(K(),E(function(e){e.filterValues={}}),B)return Promise.resolve();return F(__assign(__assign({},P),{filterValues:{}}))},sortTriggerMode:Ee,sortTriggerProps:Le,renderSort:Ne,sortConfig:Ae,defaultSortValues:P.sortValues,onSort:function(r){if(K(),E(function(e){e.sortValues=r}),B)return Promise.resolve();return F(__assign(__assign({},P),{sortValues:r}))},onSortReset:function(){if(K(),E(function(e){e.sortValues=[]}),B)return Promise.resolve();return F(__assign(__assign({},P),{sortValues:[]}))}}),Oe=useMemo(function(){var e=null==le?void 0:le();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner-before"),null!=ie?ie:""),style:null!=ce?ce:{}},e)},[le,ie,ce]),De=useMemo(function(){var e=null==se?void 0:se();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner-after"),null!=ue?ue:""),style:null!=de?de:{}},e)},[se,ue,de]),xe=useMemo(function(){var e=null==ee?void 0:ee();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll-before"),null!=oe?oe:""),style:null!=te?te:{}},e)},[ee,oe,te]),Ie=useMemo(function(){var e=null==re?void 0:re();return e&&React.createElement("div",{className:classNames("".concat(selectorPrefix,"-scroll-after"),null!=ae?ae:""),style:null!=ne?ne:{}},e)},[re,ae,ne]),Ge=useMemo(function(){var e;return React.createElement(React.Fragment,null,We()&&(null!=(e=null==ye?void 0:ye())?e:React.createElement(_ErrorBlock,{status:"empty"})),!We()&&React.createElement(ScrollLoad,__assign({ref:A,renderLoading:Ve,distance:(null==y?void 0:y.distance)||50,onScrollBottom:Qe},y||{},{className:classNames("".concat(selectorPrefix,"-scroll-load"),null!=(e=null==y?void 0:y.className)?e:"")}),null==Ce?void 0:Ce(W.data)))},[Ve,y,Ce,W.data,We,ye]),ze=useMemo(function(){return React.createElement(BackTopAnimation,__assign({},null!=$?$:{},{getContainer:qe,onTrigger:function(){return Promise.resolve()}}))},[$]),je=useMemo(function(){return React.createElement(_PullToRefresh,__assign({},null!=c?c:{},{onRefresh:Je}),xe,Ge,Ie,X&&ze)},[c,xe,Ie,Ge,X,ze]),v=useCallback(function(){return React.createElement(React.Fragment,null,w&&we,D&&Ue,React.createElement("div",{className:classNames("".concat(selectorPrefix,"-inner"),null!=a?a:""),style:null!=n?n:{}},Oe,je,De))},[w,we,D,Ue,a,n,Oe,je,De]);function F(e){return ve?ve(__assign(__assign({},N.current),e)).then(function(e){return Be(e),e}):Promise.resolve()}function K(){var e,r,o=null===qe?void 0:qe();o&&(o.scrollTop=0),null!=(e=null==(o=null==A?void 0:A.current)?void 0:o.hideAll)&&e.call(o),b.current=null,C.current=ScrollLoad.NORMAL,N.current.page=void 0!==u&&"object"===_typeof(u)&&null!=(r=u.page)?r:DEFAULT_PAGING_PAGE,N.current.pageSize=void 0!==u&&"object"===_typeof(u)&&null!=(r=u.defaultPageSize)?r:DEFAULT_PAGING_SIZE}function Ye(){K(),E(function(e){e.searchKeyWord=p,e.filterValues=R,e.sortValues=h})}function Ze(r){K(),E(function(e){e.searchKeyWord=r}),B||F(__assign(__assign({},P),{searchKeyWord:r}))}function He(){K(),E(function(e){e.searchKeyWord=""}),B||F(__assign(__assign({},P),{searchKeyWord:""}))}function qe(){var e;return null!=(e=null==(e=A.current)?void 0:e.getScrollContainer())?e:document.body}function Je(){var e={searchKeyWord:p,filterValues:R,sortValues:h},r=k?k(__assign(__assign({},N.current),e)):Promise.resolve();return d?r.then(function(){return Ye(),B||null==d?void 0:d(__assign(__assign({},N.current),e)).then(function(e){Be(e)})}):Promise.resolve(T)}function Qe(e){if(C.current===ScrollLoad.EMPTY)C.current=ScrollLoad.EMPTY,e(ScrollLoad.EMPTY);else{if(b.current=e,!B)return null==J?void 0:J(__assign({page:N.current.page+1,pageSize:N.current.pageSize},P)).then(function(r){N.current.page+=1,Be(function(e){return e.total=r.total,e.data=__spreadArray(__spreadArray([],e.data,!0),r.data,!0),__assign({},e)})});N.current.page+=1,Me()}}return useMount(function(){F({searchKeyWord:p,filterValues:R,sortValues:h})}),useUpdateEffect(function(){b.current&&(C.current=N.current.page<Fe?ScrollLoad.NORMAL:ScrollLoad.EMPTY,b.current(C.current))},[T.data,Fe,N.current.page]),useUpdateEffect(function(){Ye(),F({searchKeyWord:p,filterValues:R,sortValues:h})},[p,h,R,B]),React.createElement("div",{className:classNames(selectorPrefix,null!=r?r:""),style:null!=o?o:{}},(l&&(e.current&&!L.current&&t&&(L.current=!0),e.current&&L.current&&!t&&(e.current=!1,L.current=!1),e.current)?M:v)())}));PRSL.displayName="PRSL";export default PRSL;
//# sourceMappingURL=PRSL.js.map
