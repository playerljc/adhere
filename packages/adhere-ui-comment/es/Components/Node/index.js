import{__assign,__read,__spreadArray}from"tslib";import classNames from"classnames";import React,{memo,useCallback,useEffect,useRef,useState}from"react";import ConditionalRender from"@baifendian/adhere-ui-conditionalrender";import FlexLayout from"@baifendian/adhere-ui-flexlayout";import Util from"@baifendian/adhere-util";import Intl from"@baifendian/adhere-util-intl";import ReplyInfo from"../../Reply/Info";import ReplySubmit from"../../Reply/Submit";var selectorPrefix="adhere-ui-comment-node",Node=function(n){var e=n.isReply,e=void 0!==e&&e,t=n.dataKeys,o=void 0===t?{current:"current",totalPage:"totalPage",list:"list",totalCount:"totalCount"}:t,t=n.limit,a=void 0===t?10:t,l=n.keyProp,r=n.children,i=n.isMoreProp,c=n.renderAuthor,u=n.renderAvatar,s=n.renderContent,d=n.renderDateTime,m=n.renderLoading,f=n.showReplyText,R=n.hideReplyText,p=n.loadMoreReplyText,v=n.showReplyTextIcon,h=n.loadMoreCollapseTextIcon,_=n.hideReplyTextIcon,y=n.fetchReply,x=n.emojiPickerProps,t=n.local,E=void 0===t?"zh":t,t=__read(useState(((t={})[o.current]=1,t[o.list]=[],t[o.totalCount]=0,t[o.totalPage]=0,t)),2),C=t[0],P=t[1],t=__read(useState(null==n?void 0:n.data),2),F=t[0],g=t[1],t=__read(useState(!1),2),N=t[0],k=t[1],t=__read(useState(!1),2),b=t[0],M=t[1],t=__read(useState(!1),2),T=t[0],A=t[1],I=useRef({page:1,limit:a}),t=useCallback(function(){var e=__spreadArray([],__read(((null==(e=null==n?void 0:n.renderActions)?void 0:e.call(n,__assign({},F),function(e){return g(e)}))||[]).map(function(e,t){var n;return ConditionalRender.conditionalRender({conditional:!(null!=(n=null==(n=null==e?void 0:e.props)?void 0:n.className)&&n.endsWith("-actions-action")),noMatch:e,match:React.createElement("li",{key:t,className:"".concat(selectorPrefix,"-actions-action")},e)})})),!1);return e.find(function(e){return"reply"===(null==(e=null==(e=null==e?void 0:e.props)?void 0:e.children)?void 0:e.key)})||e.push(React.createElement("li",{key:"reply",className:classNames("".concat(selectorPrefix,"-actions-action"),"".concat(selectorPrefix,"-actions-action-reply-btn")),onClick:function(){return A(!0)}},Intl.v("回复"))),e},[null==n?void 0:n.renderActions,F,T]),L=useCallback(function(){var e,t;return React.createElement("ul",{className:"".concat(selectorPrefix,"-children")},null==(t=null===(e=C[o.list]||[])?void 0:e.map)?void 0:t.call(e,function(e){return React.createElement("li",{className:"".concat(selectorPrefix,"-children-item"),key:e[l]},React.createElement(ConditionalRender,{conditional:!r,noMatch:function(){return null==r?void 0:r(e)}},function(){return React.createElement(ReplyInfo,{isReply:!0,data:e,dataKeys:o,limit:a,keyProp:l,isMoreProp:i,fetchData:null==n?void 0:n.fetchData,fetchReply:null==n?void 0:n.fetchReply,renderActions:null==n?void 0:n.renderActions,renderAuthor:c,renderAvatar:u,renderContent:s,renderDateTime:d,renderLoading:m,showReplyText:f,hideReplyText:R,loadMoreReplyText:p,showReplyTextIcon:v,hideReplyTextIcon:_,loadMoreCollapseTextIcon:h,local:E,emojiPickerProps:x})}))}),React.createElement(ConditionalRender,{conditional:!b&&D()},function(){return React.createElement("li",{className:classNames("".concat(selectorPrefix,"-children-item"),"more")},React.createElement("a",{onClick:j},React.createElement("span",null,React.createElement(ConditionalRender,{conditional:Util.isFunction(h),noMatch:function(){return h}},function(){return h instanceof Function?h():h})),React.createElement("span",null,React.createElement(ConditionalRender,{conditional:Util.isFunction(p),noMatch:function(){return p}},function(){return p instanceof Function?p():p}))))}))},[C,o.list,l,i,t,c,u,s,d,m,f,R,p,v,_,h,b]),U=useCallback(function(){return React.createElement(ConditionalRender,{conditional:!N,noMatch:function(){return React.createElement("a",{className:"".concat(selectorPrefix,"-collapse"),onClick:function(){return k(!1)}},React.createElement("span",null,React.createElement(ConditionalRender,{conditional:Util.isFunction(_),noMatch:function(){return _}},function(){return _ instanceof Function?_():_})),React.createElement("span",null,React.createElement(ConditionalRender,{conditional:Util.isFunction(R),noMatch:function(){return R}},function(){return R instanceof Function?R():R})))}},function(){return React.createElement("a",{className:"".concat(selectorPrefix,"-collapse"),onClick:function(){var e;C[o.list].length?k(!0):null!=(e=S())&&e.then(function(){return k(!0)})}},React.createElement("span",null,React.createElement(ConditionalRender,{conditional:Util.isFunction(v),noMatch:function(){return v}},function(){return v instanceof Function?v():v})),React.createElement("span",null,React.createElement(ConditionalRender,{conditional:Util.isFunction(f),noMatch:function(){return f}},function(){return f instanceof Function?f():f})))})},[N,C,o.list,R,_,f,v]),D=useCallback(function(){return C[o.list].length<=C[o.totalCount]},[C,o.list,o.totalCount]),w=useCallback(function(){var e;return null==(e=null==(e=null==(e=null==n?void 0:n.fetchData)?void 0:e.call(n,__assign(__assign({},I.current),{record:__assign({},F)})))?void 0:e.then(function(e){return M(!1),e}))?void 0:e.catch(function(e){return M(!1),e})},[null==n?void 0:n.fetchData,I.current.page,I.current.limit,F]);function S(){var e;return M(!0),I.current={page:1,limit:a},null==(e=w())?void 0:e.then(function(e){P(e)})}function j(){M(!0),I.current.page=I.current.page+1;var e,a=o.list;return null==(e=w())?void 0:e.then(function(n){P(function(e){var t;return __assign(__assign({},n),((t={})[o.list]=__spreadArray(__spreadArray([],__read(e[a]),!1),__read(n[a]),!1),t))})})}return useEffect(function(){return g(n.data)},[null==n?void 0:n.data]),React.createElement(FlexLayout,{direction:"horizontal",className:classNames(selectorPrefix,e?"".concat(selectorPrefix,"-reply"):null)},React.createElement(FlexLayout.Fixed,{className:"".concat(selectorPrefix,"-avatar-wrap")},null==u?void 0:u(__assign({},F))),React.createElement(FlexLayout.Auto,{autoFixed:!0,fit:!0},React.createElement(FlexLayout,{direction:"vertical"},React.createElement(FlexLayout.Fixed,{className:"".concat(selectorPrefix,"-title-row"),fit:!1},React.createElement("div",{className:"".concat(selectorPrefix,"-title-row-author")},null==c?void 0:c(__assign({},F))),React.createElement("div",{className:"".concat(selectorPrefix,"-title-row-date-time")},null==d?void 0:d(__assign({},F)))),React.createElement(FlexLayout.Auto,{className:"".concat(selectorPrefix,"-content-wrap")},null==s?void 0:s(__assign({},F))),React.createElement(FlexLayout.Fixed,null,React.createElement("ul",{className:"".concat(selectorPrefix,"-actions")},t())),React.createElement(ConditionalRender,{conditional:T},function(){return React.createElement(FlexLayout.Fixed,{style:{marginTop:15}},React.createElement(ReplySubmit,{onCancel:function(){return A(!1)},onResult:function(e){null!=(e=null==y?void 0:y({id:null==F?void 0:F[l],record:__assign({},F),reply:e}))&&e.then(function(){A(!1),S()})},local:E,emojiPickerProps:x}))}),React.createElement(ConditionalRender,{conditional:null==F?void 0:F[i]},function(){return React.createElement(React.Fragment,null,React.createElement(ConditionalRender,{conditional:!b},function(){return U()}),React.createElement(ConditionalRender.Show,{conditional:N},L()),React.createElement(ConditionalRender,{conditional:b},function(){return null==m?void 0:m()}))}))))};export default memo(Node);
//# sourceMappingURL=index.js.map
