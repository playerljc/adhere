import Util from"@baifendian/adhere-util";import{ERROR_MESSAGE,OK_MESSAGE}from"../Constent";import Context from"../Context";import Request from"../Request";import Response from"../Response";import Compose from"./compose";var Server=function(){function e(e,t,s){void 0===e&&(e=[]),this.whitelist=[],this.middleWareQueue=[],this.whitelist=e,this.source=t,this.sourceOrigin=s,this.onMessage=this.onMessage.bind(this)}return e.prototype.onMessage=function(e){try{var t=JSON.parse(e.data);this.whitelist.includes(e.origin)&&e.source&&!Util.isEmpty(t)&&Util.isObject(t)&&"requestId"in t&&!Util.isEmpty(t.requestId)&&this.service(e,t)}catch(e){console.warn(e)}},e.prototype.middleWareQueueReduce=function(e){return Compose(this.middleWareQueue)(e)},e.prototype.service=function(s,e){var r,t=new Request(e);t.setRequestId(e.requestId),t.setStatusCode(200),t.setStatusMessage(OK_MESSAGE),this.middleWareQueue.length&&(r=new Context({request:t,response:new Response({requestId:t.getRequestId(),statusCode:0,stateMessage:ERROR_MESSAGE,headers:{pathname:t.getPathname(),date:(new Date).toString(),origin:this.sourceOrigin,referer:this.source instanceof Window?this.source.location.href:""},body:null})}),this.middleWareQueueReduce(r).then(function(){var e,t;null!=(t=null==(e=null==s?void 0:s.source)?void 0:e.postMessage)&&t.call(e,JSON.stringify(r.response),s.origin)}))},e.prototype.start=function(){var t=this;return new Promise(function(e){t.source.addEventListener("message",t.onMessage),e()})},e.prototype.close=function(){var t=this;return new Promise(function(e){t.source.removeEventListener("message",t.onMessage),e()})},e.prototype.use=function(e){var t;return Array.isArray(e)?(t=this.middleWareQueue).push.apply(t,e):this.middleWareQueue.push(e),this},e}();export default Server;
//# sourceMappingURL=index.js.map
