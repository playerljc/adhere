import Util from"@baifendian/adhere-util";import Request from"../Request";import Context from"../Context";import Response from"../Response";import Compose from"./compose";import{ERROR_MESSAGE,OK_MESSAGE}from"../Constent";var Server=function(){function e(e,t,s){void 0===e&&(e=[]),this.whitelist=[],this.middleWareQueue=[],this.whitelist=e,this.source=t,this.sourceOrigin=s,this.onMessage=this.onMessage.bind(this)}return e.prototype.onMessage=function(e){this.whitelist.includes(e.origin)&&e.source&&!Util.isEmpty(e.data)&&Util.isObject(e.data)&&"requestId"in e.data&&!Util.isEmpty(e.data.requestId)&&this.service(e)},e.prototype.middleWareQueueReduce=function(e){return Compose(this.middleWareQueue)(e)},e.prototype.service=function(s){var i,e=new Request(s.data);e.setRequestId(s.data.requestId),e.setStatusCode(200),e.setStatusMessage(OK_MESSAGE),this.middleWareQueue.length&&(i=new Context({request:e,response:new Response({requestId:e.getRequestId(),statusCode:0,stateMessage:ERROR_MESSAGE,headers:{pathname:e.getPathname(),date:(new Date).toString(),origin:this.sourceOrigin,referer:this.source instanceof Window?this.source.location.href:""},body:null})}),this.middleWareQueueReduce(i).then(function(){var e,t;null!==(t=null===(e=null==s?void 0:s.source)||void 0===e?void 0:e.postMessage)&&void 0!==t&&t.call(e,i.response,s.origin)}))},e.prototype.start=function(){var t=this;return new Promise(function(e){t.source.addEventListener("message",t.onMessage),e()})},e.prototype.close=function(){var t=this;return new Promise(function(e){t.source.removeEventListener("message",t.onMessage),e()})},e.prototype.use=function(e){var t;return Array.isArray(e)?(t=this.middleWareQueue).push.apply(t,e):this.middleWareQueue.push(e),this},e}();export default Server;
//# sourceMappingURL=index.js.map
