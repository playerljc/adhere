{"version":3,"file":"index.js","sources":["server/index.js"],"sourcesContent":["\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar adhere_util_1 = __importDefault(require(\"@baifendian/adhere-util\"));\nvar Constent_1 = require(\"../Constent\");\nvar Context_1 = __importDefault(require(\"../Context\"));\nvar Request_1 = __importDefault(require(\"../Request\"));\nvar Response_1 = __importDefault(require(\"../Response\"));\nvar compose_1 = __importDefault(require(\"./compose\"));\n/**\n * Server\n * @class Server\n * @classdesc iframe postMessage 服务端\n */\nvar Server = /** @class */ (function () {\n    function Server(whitelist, source, sourceOrigin) {\n        if (whitelist === void 0) { whitelist = []; }\n        // 白名单\n        this.whitelist = [];\n        // 中间件队列\n        this.middleWareQueue = [];\n        this.whitelist = whitelist;\n        this.source = source;\n        this.sourceOrigin = sourceOrigin;\n        this.onMessage = this.onMessage.bind(this);\n    }\n    /**\n     * onMessage\n     * @description 接收到消息\n     * @param evt\n     */\n    Server.prototype.onMessage = function (evt) {\n        try {\n            var data = JSON.parse(evt.data);\n            // 略掉不是白名单中的请求，或没有request的请求\n            if (!this.whitelist.includes(evt.origin) ||\n                !evt.source ||\n                adhere_util_1.default.isEmpty(data) ||\n                !adhere_util_1.default.isObject(data) ||\n                !('requestId' in data) ||\n                adhere_util_1.default.isEmpty(data.requestId)) {\n                return;\n            }\n            this.service(evt, data);\n        }\n        catch (e) {\n            console.warn(e);\n        }\n    };\n    /**\n     * middleWareQueueReduce\n     * @description 对中间件进行迭代\n     * @private\n     * @param ctx 上下文对象\n     */\n    Server.prototype.middleWareQueueReduce = function (ctx) {\n        var middleWareCompose = (0, compose_1.default)(this.middleWareQueue);\n        return middleWareCompose(ctx);\n    };\n    /**\n     * service\n     * @description 具体的请求处理\n     * @param {MessageEvent} evt\n     * @param {any} data\n     * @private\n     */\n    Server.prototype.service = function (evt, data) {\n        // 设置request的statusCode和statusMessage\n        var request = new Request_1.default(data);\n        request.setRequestId(data.requestId);\n        request.setStatusCode(200);\n        request.setStatusMessage(Constent_1.OK_MESSAGE);\n        // 如果中间件为空\n        if (!this.middleWareQueue.length) {\n            return;\n        }\n        // 迭代middleWareQueue\n        // 如果中间件队列不为空则创建上下文对象\n        var context = new Context_1.default({\n            request: request,\n            response: new Response_1.default({\n                requestId: request.getRequestId(),\n                statusCode: 0,\n                stateMessage: Constent_1.ERROR_MESSAGE,\n                headers: {\n                    pathname: request.getPathname(),\n                    date: new Date().toString(),\n                    origin: this.sourceOrigin,\n                    referer: this.source instanceof Window ? this.source.location.href : '',\n                },\n                body: null,\n            }),\n        });\n        this.middleWareQueueReduce(context).then(function () {\n            var _a, _b;\n            // 返回响应\n            try {\n                // @ts-ignore\n                (_b = (_a = evt === null || evt === void 0 ? void 0 : evt.source) === null || _a === void 0 ? void 0 : _a.postMessage) === null || _b === void 0 ? void 0 : _b.call(_a, JSON.stringify(context.response), evt.origin);\n            }\n            catch (e) {\n                console.log(e);\n            }\n        });\n    };\n    /**\n     * start\n     * @description 启动服务\n     */\n    Server.prototype.start = function () {\n        var _this = this;\n        return new Promise(function (resolve) {\n            _this.source.addEventListener('message', _this.onMessage);\n            resolve();\n        });\n    };\n    /**\n     * close\n     * @description 关闭服务\n     */\n    Server.prototype.close = function () {\n        var _this = this;\n        return new Promise(function (resolve) {\n            _this.source.removeEventListener('message', _this.onMessage);\n            resolve();\n        });\n    };\n    /**\n     * use\n     * @description 添加中间件\n     * @param middleWare\n     */\n    Server.prototype.use = function (middleWare) {\n        var _a;\n        if (Array.isArray(middleWare)) {\n            (_a = this.middleWareQueue).push.apply(_a, middleWare);\n        }\n        else {\n            this.middleWareQueue.push(middleWare);\n        }\n        return this;\n    };\n    return Server;\n}());\nexports.default = Server;\n"],"names":["__importDefault","this","mod","__esModule","default","adhere_util_1","Object","defineProperty","exports","value","require","Constent_1","Context_1","Request_1","Response_1","compose_1","Server","whitelist","source","sourceOrigin","middleWareQueue","onMessage","bind","prototype","evt","data","JSON","parse","includes","origin","isEmpty","isObject","requestId","service","e","console","warn","middleWareQueueReduce","ctx","context","request","setRequestId","setStatusCode","setStatusMessage","OK_MESSAGE","length","response","getRequestId","statusCode","stateMessage","ERROR_MESSAGE","headers","pathname","getPathname","date","Date","toString","referer","Window","location","href","body","then","_a","_b","postMessage","call","stringify","log","start","_this","Promise","resolve","addEventListener","close","removeEventListener","use","middleWare","Array","isArray","push","apply"],"mappings":"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"}