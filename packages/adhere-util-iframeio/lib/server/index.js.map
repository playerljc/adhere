{"version":3,"file":"index.js","sources":["server/index.js"],"sourcesContent":["\"use strict\";\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar adhere_util_1 = __importDefault(require(\"@baifendian/adhere-util\"));\r\nvar Request_1 = __importDefault(require(\"../Request\"));\r\nvar Context_1 = __importDefault(require(\"../Context\"));\r\nvar Response_1 = __importDefault(require(\"../Response\"));\r\nvar compose_1 = __importDefault(require(\"./compose\"));\r\nvar Constent_1 = require(\"../Constent\");\r\n/**\r\n * Server\r\n * @class Server\r\n * @classdesc iframe postMessage 服务端\r\n */\r\nvar Server = /** @class */ (function () {\r\n    function Server(whitelist, source, sourceOrigin) {\r\n        if (whitelist === void 0) { whitelist = []; }\r\n        // 白名单\r\n        this.whitelist = [];\r\n        // 中间件队列\r\n        this.middleWareQueue = [];\r\n        this.whitelist = whitelist;\r\n        this.source = source;\r\n        this.sourceOrigin = sourceOrigin;\r\n        this.onMessage = this.onMessage.bind(this);\r\n    }\r\n    /**\r\n     * onMessage\r\n     * @description 接收到消息\r\n     * @param evt\r\n     */\r\n    Server.prototype.onMessage = function (evt) {\r\n        // 略掉不是白名单中的请求，或没有request的请求\r\n        if (!this.whitelist.includes(evt.origin) ||\r\n            !evt.source ||\r\n            adhere_util_1.default.isEmpty(evt.data) ||\r\n            !adhere_util_1.default.isObject(evt.data) ||\r\n            !('requestId' in evt.data) ||\r\n            adhere_util_1.default.isEmpty(evt.data.requestId)) {\r\n            return;\r\n        }\r\n        this.service(evt);\r\n    };\r\n    /**\r\n     * middleWareQueueReduce\r\n     * @description 对中间件进行迭代\r\n     * @private\r\n     * @param ctx 上下文对象\r\n     */\r\n    Server.prototype.middleWareQueueReduce = function (ctx) {\r\n        var middleWareCompose = compose_1.default(this.middleWareQueue);\r\n        return middleWareCompose(ctx);\r\n    };\r\n    /**\r\n     * service\r\n     * @description 具体的请求处理\r\n     * @param evt\r\n     * @private\r\n     */\r\n    Server.prototype.service = function (evt) {\r\n        // 设置request的statusCode和statusMessage\r\n        var request = new Request_1.default(evt.data);\r\n        request.setRequestId(evt.data.requestId);\r\n        request.setStatusCode(200);\r\n        request.setStatusMessage(Constent_1.OK_MESSAGE);\r\n        // 如果中间件为空\r\n        if (!this.middleWareQueue.length) {\r\n            return;\r\n        }\r\n        // 迭代middleWareQueue\r\n        // 如果中间件队列不为空则创建上下文对象\r\n        var context = new Context_1.default({\r\n            request: request,\r\n            response: new Response_1.default({\r\n                requestId: request.getRequestId(),\r\n                statusCode: 0,\r\n                stateMessage: Constent_1.ERROR_MESSAGE,\r\n                headers: {\r\n                    pathname: request.getPathname(),\r\n                    date: new Date().toString(),\r\n                    origin: this.sourceOrigin,\r\n                    referer: this.source instanceof Window ? this.source.location.href : '',\r\n                },\r\n                body: null,\r\n            }),\r\n        });\r\n        this.middleWareQueueReduce(context).then(function () {\r\n            var _a, _b;\r\n            // @ts-ignore\r\n            // 返回响应\r\n            (_b = (_a = evt === null || evt === void 0 ? void 0 : evt.source) === null || _a === void 0 ? void 0 : _a.postMessage) === null || _b === void 0 ? void 0 : _b.call(_a, context.response, evt.origin);\r\n        });\r\n    };\r\n    /**\r\n     * start\r\n     * @description 启动服务\r\n     */\r\n    Server.prototype.start = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve) {\r\n            // @ts-ignore\r\n            _this.source.addEventListener('message', _this.onMessage);\r\n            resolve();\r\n        });\r\n    };\r\n    /**\r\n     * close\r\n     * @description 关闭服务\r\n     */\r\n    Server.prototype.close = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve) {\r\n            // @ts-ignore\r\n            _this.source.removeEventListener('message', _this.onMessage);\r\n            resolve();\r\n        });\r\n    };\r\n    /**\r\n     * use\r\n     * @description 添加中间件\r\n     * @param middleWare\r\n     */\r\n    Server.prototype.use = function (middleWare) {\r\n        var _a;\r\n        if (Array.isArray(middleWare)) {\r\n            (_a = this.middleWareQueue).push.apply(_a, middleWare);\r\n        }\r\n        else {\r\n            this.middleWareQueue.push(middleWare);\r\n        }\r\n        return this;\r\n    };\r\n    return Server;\r\n}());\r\nexports.default = Server;\r\n"],"names":["__importDefault","this","mod","__esModule","default","Object","defineProperty","exports","value","adhere_util_1","require","Request_1","Context_1","Response_1","compose_1","Constent_1","Server","whitelist","source","sourceOrigin","middleWareQueue","onMessage","bind","prototype","evt","includes","origin","isEmpty","data","isObject","requestId","service","middleWareQueueReduce","ctx","middleWareCompose","context","request","setRequestId","setStatusCode","setStatusMessage","OK_MESSAGE","length","response","getRequestId","statusCode","stateMessage","ERROR_MESSAGE","headers","pathname","getPathname","date","Date","toString","referer","Window","location","href","body","then","_a","_b","postMessage","call","start","_this","Promise","resolve","addEventListener","close","removeEventListener","use","middleWare","Array","isArray","push","apply"],"mappings":"aACA,IAAIA,gBAAmBC,MAAQA,KAAKD,iBAAoB,SAAUE,GAC9D,OAAQA,GAAOA,EAAIC,WAAcD,EAAM,CAAEE,QAAWF,IAExDG,OAAOC,eAAeC,QAAS,aAAc,CAAEC,OAAO,IACtD,IAAIC,cAAgBT,gBAAgBU,QAAQ,4BACxCC,UAAYX,gBAAgBU,QAAQ,eACpCE,UAAYZ,gBAAgBU,QAAQ,eACpCG,WAAab,gBAAgBU,QAAQ,gBACrCI,UAAYd,gBAAgBU,QAAQ,cACpCK,WAAaL,QAAQ,eAMrBM,OAAwB,WACxB,SAASA,EAAOC,EAAWC,EAAQC,QACb,IAAdF,IAAwBA,EAAY,IAExChB,KAAKgB,UAAY,GAEjBhB,KAAKmB,gBAAkB,GACvBnB,KAAKgB,UAAYA,EACjBhB,KAAKiB,OAASA,EACdjB,KAAKkB,aAAeA,EACpBlB,KAAKoB,UAAYpB,KAAKoB,UAAUC,KAAKrB,MA4GzC,OArGAe,EAAOO,UAAUF,UAAY,SAAUG,GAE9BvB,KAAKgB,UAAUQ,SAASD,EAAIE,SAC5BF,EAAIN,SACLT,cAAcL,QAAQuB,QAAQH,EAAII,OACjCnB,cAAcL,QAAQyB,SAASL,EAAII,OAClC,cAAeJ,EAAII,OACrBnB,cAAcL,QAAQuB,QAAQH,EAAII,KAAKE,YAG3C7B,KAAK8B,QAAQP,IAQjBR,EAAOO,UAAUS,sBAAwB,SAAUC,GAE/C,OADwBnB,UAAUV,QAAQH,KAAKmB,gBACxCc,CAAkBD,IAQ7BjB,EAAOO,UAAUQ,QAAU,SAAUP,GAEjC,IAUIW,EAVAC,EAAU,IAAIzB,UAAUP,QAAQoB,EAAII,MACxCQ,EAAQC,aAAab,EAAII,KAAKE,WAC9BM,EAAQE,cAAc,KACtBF,EAAQG,iBAAiBxB,WAAWyB,YAE/BvC,KAAKmB,gBAAgBqB,SAKtBN,EAAU,IAAIvB,UAAUR,QAAQ,CAChCgC,QAASA,EACTM,SAAU,IAAI7B,WAAWT,QAAQ,CAC7B0B,UAAWM,EAAQO,eACnBC,WAAY,EACZC,aAAc9B,WAAW+B,cACzBC,QAAS,CACLC,SAAUZ,EAAQa,cAClBC,MAAM,IAAIC,MAAOC,WACjB1B,OAAQzB,KAAKkB,aACbkC,QAASpD,KAAKiB,kBAAkBoC,OAASrD,KAAKiB,OAAOqC,SAASC,KAAO,IAEzEC,KAAM,SAGdxD,KAAK+B,sBAAsBG,GAASuB,KAAK,WACrC,IAAIC,EAAIC,EAGmH,QAA1HA,EAAqE,QAA/DD,EAAKnC,MAAAA,OAAiC,EAASA,EAAIN,cAA2B,IAAPyC,OAAgB,EAASA,EAAGE,mBAAgC,IAAPD,GAAyBA,EAAGE,KAAKH,EAAIxB,EAAQO,SAAUlB,EAAIE,YAOtMV,EAAOO,UAAUwC,MAAQ,WACrB,IAAIC,EAAQ/D,KACZ,OAAO,IAAIgE,QAAQ,SAAUC,GAEzBF,EAAM9C,OAAOiD,iBAAiB,UAAWH,EAAM3C,WAC/C6C,OAORlD,EAAOO,UAAU6C,MAAQ,WACrB,IAAIJ,EAAQ/D,KACZ,OAAO,IAAIgE,QAAQ,SAAUC,GAEzBF,EAAM9C,OAAOmD,oBAAoB,UAAWL,EAAM3C,WAClD6C,OAQRlD,EAAOO,UAAU+C,IAAM,SAAUC,GAC7B,IAAIZ,EAOJ,OANIa,MAAMC,QAAQF,IACbZ,EAAK1D,KAAKmB,iBAAiBsD,KAAKC,MAAMhB,EAAIY,GAG3CtE,KAAKmB,gBAAgBsD,KAAKH,GAEvBtE,MAEJe,EAtHgB,GAwH3BT,QAAQH,QAAUY"}