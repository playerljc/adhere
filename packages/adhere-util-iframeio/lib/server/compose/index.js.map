{"version":3,"file":"index.js","sources":["server/compose/index.js"],"sourcesContent":["\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\n/**\r\n * Compose\r\n * @description 组合中间件\r\n * @param middleWares\r\n * @constructor\r\n */\r\nfunction Compose(middleWares) {\r\n    return function (ctx, next) {\r\n        return new Promise(function (resolve) {\r\n            var index = -1;\r\n            // 中间件的返回值\r\n            var middleWareQueueResults = Array.from({\r\n                length: middleWares.length,\r\n            }).fill(undefined);\r\n            /**\r\n             * loop\r\n             * @description 迭代方法\r\n             */\r\n            var loop = function () {\r\n                // 迭代完成了\r\n                if (index + 1 >= middleWares.length) {\r\n                    Promise.all(middleWareQueueResults.filter(function (t) { return t instanceof Promise; })).then(function () {\r\n                        // 真正的迭代完成\r\n                        if (next) {\r\n                            var p = next();\r\n                            if (p && p.then) {\r\n                                p.then(function () {\r\n                                    resolve();\r\n                                });\r\n                                return;\r\n                            }\r\n                        }\r\n                        resolve();\r\n                    });\r\n                    return;\r\n                }\r\n                index++;\r\n                // 调用中间件方法\r\n                // @ts-ignore\r\n                middleWareQueueResults[index] = middleWares[index](ctx, function () { return loop(); });\r\n                return middleWareQueueResults[index];\r\n            };\r\n            loop();\r\n        });\r\n    };\r\n}\r\nexports.default = Compose;\r\n"],"names":["Compose","middleWares","ctx","next","Promise","resolve","index","middleWareQueueResults","Array","from","length","fill","undefined","loop","all","filter","t","then","p","Object","defineProperty","exports","value","default"],"mappings":"AAAA,aAQA,SAASA,QAAQC,GACb,OAAO,SAAUC,EAAKC,GAClB,OAAO,IAAIC,QAAQ,SAAUC,GACzB,IAAIC,EAAQ,CAAC,EAETC,EAAyBC,MAAMC,KAAK,CACpCC,OAAQT,EAAYS,MACxB,CAAC,EAAEC,KAAKC,KAAAA,CAAS,EAKbC,EAAO,WAEP,GAAIP,EAAAA,EAAQ,GAAKL,EAAYS,QAoB7B,OADAH,EAHAD,EAAAA,GAGgCL,EAAYK,GAAOJ,EAAK,WAAc,OAAOW,EAAK,CAAG,CAAC,EAC/EN,EAAuBD,GAnB1BF,QAAQU,IAAIP,EAAuBQ,OAAO,SAAUC,GAAK,OAAOA,aAAaZ,OAAS,CAAC,CAAC,EAAEa,KAAK,WAE3F,GAAId,EAAM,CACN,IAAIe,EAAIf,EAAK,EACb,GAAIe,GAAKA,EAAED,KAIP,OAHAC,KAAAA,EAAED,KAAK,WACHZ,EAAQ,CACZ,CAAC,CAGT,CACAA,EAAQ,CACZ,CAAC,CAQT,EACAQ,EAAK,CACT,CAAC,CACL,CACJ,CA9CAM,OAAOC,eAAeC,QAAS,aAAc,CAAEC,MAAO,CAAA,CAAK,CAAC,EA+C5DD,QAAQE,QAAUvB"}