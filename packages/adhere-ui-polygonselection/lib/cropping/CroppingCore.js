"use strict";var __assign=function(){return(__assign=Object.assign||function(e){for(var t,n=1,l=arguments.length;n<l;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},__createBinding=Object.create?function(e,t,n,l){void 0===l&&(l=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,l,r)}:function(e,t,n,l){e[l=void 0===l?n:l]=t[n]},__setModuleDefault=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t},__importStar=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=function(e){return e&&e.__esModule?e:{default:e}},ahooks_1=(Object.defineProperty(exports,"__esModule",{value:!0}),require("ahooks")),antd_1=require("antd"),classnames_1=__importDefault(require("classnames")),react_1=__importStar(require("react")),adhere_ui_flexlayout_1=__importDefault(require("@baifendian/adhere-ui-flexlayout")),adhere_util_intl_1=__importDefault(require("@baifendian/adhere-util-intl")),CircleDrawAction_1=__importDefault(require("../draw/CircleDrawAction")),DiamondDrawAction_1=__importDefault(require("../draw/DiamondDrawAction")),PolygonDrawAction_1=__importDefault(require("../draw/PolygonDrawAction")),RectangleDrawAction_1=__importDefault(require("../draw/RectangleDrawAction")),StartDrawAction_1=__importDefault(require("../draw/StartDrawAction")),TriangleDrawAction_1=__importDefault(require("../draw/TriangleDrawAction")),index_1=__importDefault(require("../index")),CircleModifyAction_1=__importDefault(require("../modify/CircleModifyAction")),DiamondModifyAction_1=__importDefault(require("../modify/DiamondModifyAction")),PolygonModifyAction_1=__importDefault(require("../modify/PolygonModifyAction")),RectangleModifyAction_1=__importDefault(require("../modify/RectangleModifyAction")),StartModifyAction_1=__importDefault(require("../modify/StartModifyAction")),TriangleModifyAction_1=__importDefault(require("../modify/TriangleModifyAction")),types_1=require("../types"),util_1=require("./util"),selectorPrefix="adhere-ui-cropping-core",CroppingCore=function(e,t){var n=e.className,l=e.style,r=e.wrapProps,a=e.toolProps,i=e.areaProps,o=e.minHeight,u=void 0===o?200:o,c=e.toolBarConfig,o=(0,react_1.useState)(null),d=o[0],_=o[1],e=(0,react_1.useState)(""),s=e[0],f=e[1],y=(0,react_1.useRef)(null),o=(0,react_1.useRef)(null),p=(0,react_1.useRef)(null),v=(0,react_1.useRef)(null),g=(0,react_1.useRef)(),m=(0,react_1.useRef)(null),h=(0,react_1.useRef)(),D=(0,react_1.useRef)(null),w=(0,react_1.useRef)(null),A=(0,react_1.useRef)(null),e=new Map([["left",function(){return react_1.default.createElement(adhere_ui_flexlayout_1.default.TRBLC.LCLayout,__assign({},k,r,{lProps:__assign(__assign(__assign({},P),a),{render:M}),cProps:__assign(__assign(__assign({},E),i),{render:R})}))}],["right",function(){return react_1.default.createElement(adhere_ui_flexlayout_1.default.TRBLC.CRLayout,__assign({},k,r,{rProps:__assign(__assign(__assign({},P),a),{render:M}),cProps:__assign(__assign(__assign({},E),i),{render:R})}))}],["top",function(){return react_1.default.createElement(adhere_ui_flexlayout_1.default.TRBLC.TCLayout,__assign({},k,r,{tProps:__assign(__assign(__assign({},P),a),{render:M}),cProps:__assign(__assign(__assign({},E),i),{render:R})}))}],["bottom",function(){return react_1.default.createElement(adhere_ui_flexlayout_1.default.TRBLC.CBLayout,__assign({},k,r,{bProps:__assign(__assign(__assign({},P),a),{render:M}),cProps:__assign(__assign(__assign({},E),i),{render:R})}))}]]),S=(0,react_1.useMemo)(function(){return new Map([[types_1.SelectType.Polygon,PolygonModifyAction_1.default],[types_1.SelectType.Circle,CircleModifyAction_1.default],[types_1.SelectType.Rectangle,RectangleModifyAction_1.default],[types_1.SelectType.Triangle,TriangleModifyAction_1.default],[types_1.SelectType.Diamond,DiamondModifyAction_1.default],[types_1.SelectType.Start,StartModifyAction_1.default]])},[]),C=(0,react_1.useMemo)(function(){return{fillStyle:"transparent",strokeStyle:"#fff",lineWidth:1,lineCap:"round",lineJoin:"round",lineDash:[],lineDashOffset:-1,globalAlpha:1}},[]),T={fillStyle:"#fff"},k=(0,react_1.useMemo)(function(){return{gutter:20,wrapClassName:"".concat(selectorPrefix,"-inner")}},[]),P=(0,react_1.useMemo)(function(){return{fit:!0}},[]),E=(0,react_1.useMemo)(function(){return{autoFixed:!0}},[]),M=(0,react_1.useCallback)(function(){var e,t,n=function(e){return e===d?"primary":"default"},l=function(l,r){return function(){var e,t,n;(e=l)!==d&&(q(),null!=(n=null==(t=null==h?void 0:h.current)?void 0:t.clearCanvasAll)&&n.call(t),A.current=null,_(e)),(e!==d?Promise.resolve():Promise.reject()).then(function(){var e,t;D.current=new r,D.current&&(D.current.setAnchorStyle(__assign({},T)),D.current.setMoveGemStyle(__assign({},T)),null!=(e=null==(t=null==D?void 0:D.current)?void 0:t.on)&&e.call(t,types_1.ActionEvents.DrawBeforeStart,function(e){x(e)}),null!=(t=null==(e=null==D?void 0:D.current)?void 0:e.on)&&t.call(e,types_1.ActionEvents.DrawStart,function(e){x(e)}),null!=(e=null==(t=null==D?void 0:D.current)?void 0:t.on)&&e.call(t,types_1.ActionEvents.Drawing,function(e){x(e)}),null!=(t=null==(e=null==D?void 0:D.current)?void 0:e.on)&&t.call(e,types_1.ActionEvents.DrawEnd,function(e){x(e)}),null!=(e=null==(t=null==h?void 0:h.current)?void 0:t.changeAction)&&e.call(t,D.current),null!=(t=null==(e=null==D?void 0:D.current)?void 0:e.start))&&t.call(e,C)})}},r=[{key:"open",value:(null==(r=null==(e=null==c?void 0:c.open)?void 0:e.render)?void 0:r.call(e,function(){var e;null!=(e=w.current)&&e.click()}))||react_1.default.createElement(antd_1.Button,{key:"open",block:!0,size:"large",type:"primary",onClick:function(){var e;null!=(e=w.current)&&e.click()}},adhere_util_intl_1.default.v("打开"))},s?[{key:"rectangle",value:(!c||!("rectangle"in c)||!("hide"in c.rectangle)||!(null!=(t=null==c?void 0:c.rectangle)&&t.hide))&&((null==(a=null==(t=null==c?void 0:c.rectangle)?void 0:t.render)?void 0:a.call(t,l(types_1.SelectType.Rectangle,RectangleDrawAction_1.default)))||react_1.default.createElement(antd_1.Button,{key:"rectangle",block:!0,size:"large",type:n(types_1.SelectType.Rectangle),onClick:l(types_1.SelectType.Rectangle,RectangleDrawAction_1.default)},adhere_util_intl_1.default.v("矩形剪裁")))},{key:"circle",value:(!c||!("circle"in c)||!("hide"in c.circle)||!(null!=(a=null==c?void 0:c.circle)&&a.hide))&&((null==(a=null==(t=null==c?void 0:c.circle)?void 0:t.render)?void 0:a.call(t,l(types_1.SelectType.Circle,CircleDrawAction_1.default)))||react_1.default.createElement(antd_1.Button,{key:"circle",block:!0,size:"large",type:n(types_1.SelectType.Circle),onClick:l(types_1.SelectType.Circle,CircleDrawAction_1.default)},adhere_util_intl_1.default.v("圆形剪裁")))},{key:"start",value:(!c||!("start"in c)||!("hide"in c.start)||!(null!=(a=null==c?void 0:c.start)&&a.hide))&&((null==(a=null==(t=null==c?void 0:c.start)?void 0:t.render)?void 0:a.call(t,l(types_1.SelectType.Start,StartDrawAction_1.default)))||react_1.default.createElement(antd_1.Button,{key:"start",block:!0,size:"large",type:n(types_1.SelectType.Start),onClick:l(types_1.SelectType.Start,StartDrawAction_1.default)},adhere_util_intl_1.default.v("五角星剪裁")))},{key:"triangle",value:(!c||!("triangle"in c)||!("hide"in c.triangle)||!(null!=(a=null==c?void 0:c.triangle)&&a.hide))&&((null==(a=null==(t=null==c?void 0:c.triangle)?void 0:t.render)?void 0:a.call(t,l(types_1.SelectType.Triangle,TriangleDrawAction_1.default)))||react_1.default.createElement(antd_1.Button,{key:"triangle",block:!0,size:"large",type:n(types_1.SelectType.Triangle),onClick:l(types_1.SelectType.Triangle,TriangleDrawAction_1.default)},adhere_util_intl_1.default.v("三角形剪裁")))},{key:"diamond",value:(!c||!("diamond"in c)||!("hide"in c.diamond)||!(null!=(a=null==c?void 0:c.diamond)&&a.hide))&&((null==(a=null==(t=null==c?void 0:c.diamond)?void 0:t.render)?void 0:a.call(t,l(types_1.SelectType.Diamond,DiamondDrawAction_1.default)))||react_1.default.createElement(antd_1.Button,{key:"diamond",block:!0,size:"large",type:n(types_1.SelectType.Diamond),onClick:l(types_1.SelectType.Diamond,DiamondDrawAction_1.default)},adhere_util_intl_1.default.v("菱形剪裁")))},{key:"polygon",value:(!c||!("polygon"in c)||!("hide"in c.polygon)||!(null!=(a=null==c?void 0:c.polygon)&&a.hide))&&((null==(a=null==(t=null==c?void 0:c.polygon)?void 0:t.render)?void 0:a.call(t,l(types_1.SelectType.Polygon,PolygonDrawAction_1.default)))||react_1.default.createElement(antd_1.Button,{key:"polygon",block:!0,size:"large",type:n(types_1.SelectType.Polygon),onClick:l(types_1.SelectType.Polygon,PolygonDrawAction_1.default)},adhere_util_intl_1.default.v("多边形剪裁")))}].filter(function(e){return!!e.value}):[{key:"",value:null}]].flat().filter(function(e){return!!e.value}),r=(0,util_1.sort)(r.map(function(e){var t;return"sort"in(null!=(t=null==c?void 0:c[e.key])?t:{})?__assign(__assign({},e),{sort:null==c?void 0:c[e.key].sort}):e})).map(function(e){return e.value}),a=["left","right"].includes(null!=(e=null==c?void 0:c.direction)?e:"left")?"vertical":"horizontal";return react_1.default.createElement(antd_1.Card,null,react_1.default.createElement(antd_1.Space,{direction:a,size:20},react_1.default.createElement("input",{type:"file",ref:w,accept:"",style:{display:"none"}}),r))},[d,a,s,c]),R=(0,react_1.useCallback)(function(){return react_1.default.createElement(antd_1.Card,null,react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-background"),style:{minHeight:u||200}},s&&react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-background-inner")},react_1.default.createElement("img",{ref:y,src:s,alt:""}),react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-background-mask")}))),react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-geometry"),ref:m}),react_1.default.createElement("div",{className:"".concat(selectorPrefix,"-clip"),ref:p}))},[s,i]),b=(0,react_1.useCallback)(function(){var e=new Image;return e.src=s,e},[s]),x=((0,ahooks_1.useUpdateLayoutEffect)(function(){_(null),y.current&&(y.current.onload=function(){h.current&&(A.current=null,B(),O()),L(),j()})},[s]),(0,react_1.useLayoutEffect)(function(){function t(e){var e=e.target.files[0],t=new FileReader;t.onload=function(e){f(null==(e=e.target)?void 0:e.result)},t.readAsDataURL(e)}var e;return null!=(e=w.current)&&e.addEventListener("change",t),function(){var e;null!=(e=w.current)&&e.removeEventListener("change",t)}},[]),(0,react_1.useImperativeHandle)(t,function(){return{save:function(){return A.current&&A.current.data&&s?(0,util_1.getClipDataUrl)({data:A.current,clipCtx:g.current}):""}}}),function(e){var t,n;e.data&&(A.current=e,null!=(t=null==(n=g.current)?void 0:n.restore)&&t.call(n),null!=(n=null==(t=g.current)?void 0:t.save)&&n.call(t),null!=(n=g.current)&&n.clearRect(0,0,null==(t=v.current)?void 0:t.width,null==(n=v.current)?void 0:n.height),null!=(t=new Map([[types_1.SelectType.Circle,util_1.drawCircle],[types_1.SelectType.Rectangle,util_1.drawRectangle],[types_1.SelectType.Diamond,util_1.drawDiamond],[types_1.SelectType.Start,util_1.drawStart],[types_1.SelectType.Triangle,util_1.drawTriangle],[types_1.SelectType.Polygon,util_1.drawPolygon]]).get(e.selectType))&&t(g.current,e.data),null!=(n=null==g?void 0:g.current)&&n.clip(),null!=(t=null==g?void 0:g.current))&&t.drawImage(b(),0,0,null==(e=v.current)?void 0:e.width,null==(n=v.current)?void 0:n.height)}),q=function(){var e,t;null!=(t=g.current)&&t.restore(),null!=(e=null==(t=g.current)?void 0:t.clearRect)&&e.call(t,0,0,null==(e=v.current)?void 0:e.width,null==(t=v.current)?void 0:t.height)},B=function(){p.current&&(p.current.innerHTML="")},L=function(){var e,t;v.current=document.createElement("canvas"),v.current.width=null==(t=y.current)?void 0:t.offsetWidth,v.current.height=null==(t=y.current)?void 0:t.offsetHeight,g.current=null==(e=null==(t=v.current)?void 0:t.getContext)?void 0:e.call(t,"2d"),null!=(t=null==(e=p.current)?void 0:e.appendChild)&&t.call(e,v.current)},O=function(){var e,t;null!=(t=null==(e=null==h?void 0:h.current)?void 0:e.destroy)&&t.call(e)},j=function(){var e;m.current&&(m.current.style.width="".concat(null==(e=null==y?void 0:y.current)?void 0:e.offsetWidth,"px"),m.current.style.height="".concat(null==(e=null==y?void 0:y.current)?void 0:e.offsetHeight,"px"),h.current=new index_1.default.PolygonSelection(m.current),h.current.on(types_1.PolygonSelectionActions.CanvasClickGeometry,function(e){var t=new(S.get(e.type))({selectType:e.type,actionType:"Draw",data:e});t.setAnchorStyle(__assign({},T)),t.setMoveGemStyle(__assign({},T)),t.on(types_1.ActionEvents.ModifyBeforeStart,function(e){x(e)}),t.on(types_1.ActionEvents.ModifyStart,function(e){x(e)}),t.on(types_1.ActionEvents.Modifying,function(e){x(e)}),t.on(types_1.ActionEvents.ModifyEnd,function(e){x(e),t.start()}),t.on(types_1.ActionEvents.Moving,function(e){x(e)}),t.on(types_1.ActionEvents.MoveEnd,function(e){x(e)}),null!=(e=null==h?void 0:h.current)&&e.changeAction(t),t.start()}),h.current.on(types_1.PolygonSelectionActions.CanvasClickEmpty,function(){var e;null!=(e=null==h?void 0:h.current)&&e.clearDraw(),null!=(e=null==h?void 0:h.current)&&e.clearAssistDraw(),null!=(e=null==h?void 0:h.current)&&e.drawHistoryData()}))},e=null==(t=e.get((null==c?void 0:c.direction)||"left"))?void 0:t();return react_1.default.createElement("div",{ref:o,className:"".concat((0,classnames_1.default)(selectorPrefix,n||"")),style:l||{}},e)},CroppingCoreHOC=(0,react_1.memo)((0,react_1.forwardRef)(CroppingCore));exports.default=CroppingCoreHOC;
//# sourceMappingURL=CroppingCore.js.map
